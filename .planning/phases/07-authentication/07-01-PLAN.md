---
phase: 07-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/auth.ts
  - frontend/src/app/login/page.tsx
  - frontend/src/app/login/actions.ts
  - frontend/src/middleware.ts
  - frontend/src/components/logout-button.tsx
  - frontend/.env.local
  - frontend/package.json
autonomous: true

must_haves:
  truths:
    - "Unauthenticated users are redirected to /login"
    - "Correct password grants access to all routes"
    - "Invalid password shows error message on login page"
    - "Password is read from APP_PASSWORD environment variable"
    - "Session persists across page refreshes"
  artifacts:
    - path: "frontend/src/lib/auth.ts"
      provides: "Session configuration and getSession helper"
      exports: ["getSession", "SessionData", "sessionOptions"]
    - path: "frontend/src/app/login/page.tsx"
      provides: "Login form UI"
      min_lines: 25
    - path: "frontend/src/app/login/actions.ts"
      provides: "Server Actions for auth"
      exports: ["authenticate", "logout"]
    - path: "frontend/src/middleware.ts"
      provides: "Route protection"
      contains: "middleware"
  key_links:
    - from: "frontend/src/middleware.ts"
      to: "frontend/src/lib/auth.ts"
      via: "getSession import"
      pattern: "import.*getSession.*auth"
    - from: "frontend/src/app/login/actions.ts"
      to: "process.env.APP_PASSWORD"
      via: "password comparison"
      pattern: "process\\.env\\.APP_PASSWORD"
    - from: "frontend/src/middleware.ts"
      to: "/login redirect"
      via: "NextResponse.redirect"
      pattern: "redirect.*login"
---

<objective>
Implement simple password gate authentication for the TOITURELV Cortex frontend.

Purpose: Only authorized users (team members) can access the estimate tool and other features. This is an internal tool, so a single shared password is sufficient.

Output: Login page, middleware protection, session management using iron-session.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-authentication/07-RESEARCH.md
@frontend/package.json
@frontend/src/app/layout.tsx
@frontend/src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install iron-session and create auth configuration</name>
  <files>
    frontend/package.json
    frontend/src/lib/auth.ts
    frontend/.env.local
  </files>
  <action>
    1. Install iron-session:
       ```bash
       cd frontend && pnpm add iron-session
       ```

    2. Create session configuration in `frontend/src/lib/auth.ts`:
       - Define SessionData interface with isAuthenticated: boolean
       - Define sessionOptions with:
         - password from process.env.IRON_SESSION_SECRET
         - cookieName: "cortex_auth"
         - cookieOptions: secure in production, httpOnly: true, sameSite: "lax"
       - Export async getSession() function that:
         - Uses `await cookies()` (CRITICAL: Next.js 15 requires await)
         - Returns getIronSession<SessionData>(cookieStore, sessionOptions)
       - Add env var validation at module level (throw if missing or < 32 chars)

    3. Update `.env.local` to add:
       - IRON_SESSION_SECRET (generate 32+ char random string)
       - APP_PASSWORD (set to "toiturelv2026" for dev)

    Reference pattern from 07-RESEARCH.md Pattern 1.
  </action>
  <verify>
    - `pnpm list iron-session` shows ^8.0.1 installed
    - `frontend/src/lib/auth.ts` exports getSession, SessionData, sessionOptions
    - `.env.local` contains IRON_SESSION_SECRET and APP_PASSWORD
  </verify>
  <done>
    iron-session installed, session config created, env vars defined
  </done>
</task>

<task type="auto">
  <name>Task 2: Create login page with Server Actions</name>
  <files>
    frontend/src/app/login/page.tsx
    frontend/src/app/login/actions.ts
  </files>
  <action>
    1. Create `frontend/src/app/login/actions.ts`:
       - "use server" directive at top
       - Import getSession from "@/lib/auth"
       - Import redirect from "next/navigation"

       - authenticate(formData: FormData) function:
         - Get session via getSession()
         - Extract password and redirect from formData
         - Compare password against process.env.APP_PASSWORD
         - If match: set session.isAuthenticated = true, await session.save(), redirect to target
         - If no match: redirect to /login?error=invalid with redirect param preserved

       - logout() function:
         - Get session via getSession()
         - Call session.destroy()
         - Redirect to /login

    2. Create `frontend/src/app/login/page.tsx`:
       - Server Component (no "use client")
       - Interface Props with searchParams: Promise<{ redirect?: string; error?: string }>
       - Check session - if already authenticated, redirect to "/"
       - Render centered login form with:
         - TOITURELV Cortex heading
         - "Enter password to continue" subtext
         - Hidden input for redirect param
         - Error message if params.error exists
         - Password input (type="password", autoFocus, required)
         - Submit button styled with existing button conventions
       - Form action={authenticate}
       - Use await searchParams (Next.js 15 async params)

    Style to match existing dark theme from page.tsx.
  </action>
  <verify>
    - `frontend/src/app/login/page.tsx` exists and is valid TSX
    - `frontend/src/app/login/actions.ts` exports authenticate and logout
    - Visit http://localhost:3000/login shows login form
  </verify>
  <done>
    Login page renders, authenticate action validates password against env var, logout action destroys session
  </done>
</task>

<task type="auto">
  <name>Task 3: Create middleware and logout button</name>
  <files>
    frontend/src/middleware.ts
    frontend/src/components/logout-button.tsx
  </files>
  <action>
    1. Create `frontend/src/middleware.ts`:
       - Import NextRequest, NextResponse from "next/server"
       - Import getSession from "@/lib/auth"

       - export async function middleware(request: NextRequest):
         - Get session via getSession()
         - Get path from request.nextUrl.pathname
         - If path is "/login", return NextResponse.next() (allow)
         - If not authenticated:
           - Create loginUrl pointing to /login
           - Set redirect search param to current path
           - Return NextResponse.redirect(loginUrl)
         - Otherwise return NextResponse.next()

       - export const config with matcher:
         - Protect all routes except: _next/static, _next/image, favicon.ico, api
         - Pattern: ["/((?!_next/static|_next/image|favicon.ico|api).*)"]

    2. Create `frontend/src/components/logout-button.tsx`:
       - "use client" directive
       - Import logout from "@/app/login/actions"
       - Export LogoutButton component:
         - Render form with action={logout}
         - Button type="submit" with "Sign Out" text
         - Style as subtle text link (text-sm text-zinc-500 hover:underline)
  </action>
  <verify>
    - Visit http://localhost:3000/ redirects to /login
    - After login with correct password, home page is accessible
    - LogoutButton component exists and is importable
  </verify>
  <done>
    Middleware protects all routes, unauthenticated users see login page, logout button ready for use in layouts
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Start dev server: `cd frontend && pnpm dev`

2. Test unauthenticated access:
   - Visit http://localhost:3000/ -> should redirect to /login
   - Visit http://localhost:3000/login -> should show login form

3. Test invalid password:
   - Enter wrong password -> should stay on /login with error message

4. Test valid password:
   - Enter "toiturelv2026" (from .env.local) -> should redirect to home
   - Refresh page -> should remain on home (session persists)

5. Test logout (if LogoutButton added to layout):
   - Click "Sign Out" -> should redirect to /login
   - Try accessing / -> should redirect to /login

6. Verify env var usage:
   - grep for hardcoded passwords -> should find none
   - APP_PASSWORD only accessed in actions.ts
</verification>

<success_criteria>
- AUTH-01: Unauthenticated users see password prompt (login page) [PASS when middleware redirects to /login]
- AUTH-02: Password stored as env var, not hardcoded [PASS when grep finds no hardcoded passwords]
- Session persists across page refreshes
- Login/logout flow works end-to-end
- No TypeScript errors, builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/07-authentication/07-01-SUMMARY.md`
</output>
