---
phase: 21-complexity-system-rebuild
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/estimateur/tier-selector.tsx
  - frontend/src/components/estimateur/factor-checklist.tsx
autonomous: true

must_haves:
  truths:
    - "Tier selector displays 6 clickable tier cards in a 2x3 grid with name, score range, and description"
    - "Selected tier card is visually highlighted and onChange callback fires with tier number"
    - "Factor checklist is collapsible (collapsed by default) with 8 factor inputs"
    - "Each factor shows dynamic '+X hours' label as user adjusts values"
    - "Factor checklist displays running total of adjustment hours"
  artifacts:
    - path: "frontend/src/components/estimateur/tier-selector.tsx"
      provides: "TierSelector component with 6-tier visual card grid"
      exports: ["TierSelector"]
    - path: "frontend/src/components/estimateur/factor-checklist.tsx"
      provides: "FactorChecklist component with 8 collapsible factor inputs"
      exports: ["FactorChecklist"]
  key_links:
    - from: "frontend/src/components/estimateur/tier-selector.tsx"
      to: "onChange callback"
      via: "props.onChange(tier) on card click"
      pattern: "onChange.*tier"
    - from: "frontend/src/components/estimateur/factor-checklist.tsx"
      to: "onChange callback"
      via: "props.onChange(factors) on any factor change"
      pattern: "onChange.*factors"
---

<objective>
Build the two new frontend UI components for the tier-based complexity system: a visual tier selector card grid and a collapsible factor checklist panel with 8 granular inputs.

Purpose: These are standalone, controlled components that will be wired into the full quote form in Plan 03. Building them independently enables parallel development with backend work (Plan 01).

Output: tier-selector.tsx, factor-checklist.tsx
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@frontend/src/components/estimateur/complexity-presets.tsx
@frontend/src/components/estimateur/full-quote-form.tsx
@.planning/phases/21-complexity-system-rebuild/21-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build TierSelector visual card component</name>
  <files>frontend/src/components/estimateur/tier-selector.tsx</files>
  <action>
Create `frontend/src/components/estimateur/tier-selector.tsx` as a standalone controlled component.

**Component interface:**
```typescript
interface TierData {
  tier: number;       // 1-6
  name: string;       // Localized tier name
  description: string; // Localized description
  scoreRange: string; // e.g., "0-16"
  hoursAdded: number; // e.g., 0, 4, 8, 16, 24, 40
}

interface TierSelectorProps {
  value: number | null;           // Currently selected tier (1-6) or null
  onChange: (tier: number) => void; // Called when user clicks a tier
  tiers: TierData[];               // Tier data (from config, localized by parent)
}
```

**Visual design (matching existing Lyra theme / shadcn patterns):**
- 2x3 grid (3 columns on sm+, 2 on mobile) using Tailwind `grid grid-cols-2 sm:grid-cols-3 gap-3`
- Each card uses a `div` (NOT Card component -- too heavy):
  - Rounded border: `rounded-xl border border-border/50 p-4 cursor-pointer transition-all duration-200`
  - Selected state: `border-primary bg-primary/5 shadow-md ring-1 ring-primary/20`
  - Hover (unselected): `hover:border-border hover:bg-muted/30`
  - Card contents (top to bottom):
    1. Tier number badge: small circle `size-6 rounded-full bg-muted text-xs font-semibold` with tier number
    2. Tier name: `text-sm font-semibold mt-2`
    3. Score range: `text-xs text-muted-foreground` (e.g., "0-16 pts")
    4. Hours added: `text-xs font-medium text-primary mt-1` showing `+{hoursAdded}h` (or nothing for 0)
  - On click: calls `onChange(tier.tier)`
- Label above grid: uses `useLanguage()` for localized "Complexity Tier" header
- Below grid: small text showing selected tier description (if any tier selected), using `text-sm text-muted-foreground`

**Styling notes:**
- Follow existing component patterns: use `cn()` from `@/lib/utils` for conditional classes
- Use `useLanguage()` from `@/lib/i18n` for the section label only (tier data comes from props pre-localized)
- Import Lucide `Check` icon for selected state indicator in the badge circle

**Mobile behavior:**
- 2 columns on mobile, 3 columns on sm+
- Cards stack well at any width

**Export:** Named export `TierSelector` and the `TierData` interface.
  </action>
  <verify>
```bash
cd frontend && npx tsc --noEmit src/components/estimateur/tier-selector.tsx 2>&1 | head -20
```
Verify no TypeScript errors. Also visually inspect: the component should compile and export TierSelector.
  </verify>
  <done>
TierSelector component renders 6 clickable tier cards in 2x3 grid, highlights selected tier, shows tier name/score/hours, and fires onChange callback. Responsive (2 cols mobile, 3 cols desktop).
  </done>
</task>

<task type="auto">
  <name>Task 2: Build FactorChecklist collapsible panel component</name>
  <files>frontend/src/components/estimateur/factor-checklist.tsx</files>
  <action>
Create `frontend/src/components/estimateur/factor-checklist.tsx` as a standalone controlled component.

**Component interface:**
```typescript
interface FactorValues {
  roof_pitch: string | null;             // flat|low|medium|steep|very_steep
  access_difficulty: string[];            // selected checklist items
  demolition: string | null;              // none|single_layer|multi_layer|structural
  penetrations_count: number;             // 0+
  security: string[];                     // selected checklist items
  material_removal: string | null;        // none|standard|heavy|hazardous
  roof_sections_count: number;            // 1+
  previous_layers_count: number;          // 0+
}

interface FactorOption {
  key: string;
  hours: number;
  label: string;  // Pre-localized
}

interface FactorConfig {
  roof_pitch: { options: FactorOption[] };
  access_difficulty: { options: FactorOption[] };
  demolition: { options: FactorOption[] };
  penetrations: { hours_per_item: number; label: string };
  security: { options: FactorOption[] };
  material_removal: { options: FactorOption[] };
  roof_sections: { hours_per_item_above: number; baseline: number; label: string };
  previous_layers: { hours_per_item_above: number; baseline: number; label: string };
}

interface FactorChecklistProps {
  value: FactorValues;
  onChange: (value: FactorValues) => void;
  config: FactorConfig;           // Factor config (localized by parent)
  totalHours: number;             // Pre-computed total for display
}
```

**Visual design:**
- Collapsible panel using the SAME pattern as existing `ComplexityPresets` (Button with ChevronDown, collapsed by default):
  ```tsx
  <Button type="button" variant="ghost" size="sm" onClick={toggle} className="w-full justify-between...">
    <span className="flex items-center gap-2">
      <SlidersHorizontal className="size-4 text-muted-foreground" />
      {t.fullQuote.factorAdjustments} ({totalHours > 0 ? `+${totalHours}h` : "0h"})
    </span>
    <ChevronDown className={cn("size-4 ...", isExpanded && "rotate-180")} />
  </Button>
  ```

- When expanded, render 8 factor groups vertically:

  **Dropdown factors** (roof_pitch, demolition, material_removal):
  - Use shadcn `Select` component: `<Select onValueChange={...}><SelectTrigger>...</SelectTrigger><SelectContent>{options.map(...)}</SelectContent></Select>`
  - Each option label includes hours: `"Steep (7/12-8/12) â€” +4h"`
  - Show current selection's hours next to label: `<span className="text-xs text-primary font-medium">+{hours}h</span>`

  **Checklist factors** (access_difficulty, security):
  - Use shadcn `Checkbox` component for each item
  - Each checkbox row: `<div className="flex items-center gap-2"><Checkbox checked={...} onCheckedChange={...} /><label>...</label><span className="text-xs text-primary">+{hours}h</span></div>`
  - Items wrapped in a `div className="space-y-2 pl-1"`

  **Number inputs** (penetrations_count, roof_sections_count, previous_layers_count):
  - Use shadcn `Input` type="number" with min/max
  - Show computed hours next to input: `+{computed}h`
  - For roof_sections: hours = max(0, (value - baseline)) * hours_per_item_above
  - For previous_layers: same formula
  - For penetrations: hours = value * hours_per_item

- Each factor group has:
  - Label (bold, text-sm): factor name
  - Input control
  - Hours badge (text-xs text-primary font-medium): `+Xh`

- At the bottom of expanded section, show running total:
  ```
  <div className="flex justify-between pt-3 border-t">
    <span className="text-sm font-medium">{t.fullQuote.totalAdjustments}</span>
    <span className="text-sm font-semibold text-primary">+{totalHours}h</span>
  </div>
  ```

**Key implementation details:**
- Import `Checkbox` from `@/components/ui/checkbox` (will need to add via shadcn if not present -- check first with `ls frontend/src/components/ui/checkbox.tsx`)
- Import `Select, SelectContent, SelectItem, SelectTrigger, SelectValue` from `@/components/ui/select`
- Import `Input` from `@/components/ui/input`
- Import `Button` from `@/components/ui/button`
- Use `useState` for `isExpanded` (default false)
- All onChange calls should spread previous value and update only the changed field
- Use `useLanguage()` for section header labels only (factor labels come from config pre-localized)

**Before creating the component, check if Checkbox component exists:**
```bash
ls frontend/src/components/ui/checkbox.tsx 2>/dev/null
```
If it does NOT exist, install it first: `cd frontend && npx shadcn@latest add checkbox`

**Export:** Named export `FactorChecklist` and both interfaces `FactorValues` and `FactorConfig`.
  </action>
  <verify>
```bash
cd frontend && npx tsc --noEmit src/components/estimateur/factor-checklist.tsx 2>&1 | head -20
```
Verify no TypeScript errors. The component should compile cleanly with all imports resolved.
  </verify>
  <done>
FactorChecklist renders a collapsible panel with 8 factor inputs (3 dropdowns, 2 checklists, 3 number inputs), each showing dynamic "+Xh" badges. Running total displayed at bottom. Collapsed by default. All factor data comes from props (config-driven).
  </done>
</task>

</tasks>

<verification>
1. `tier-selector.tsx` exports TierSelector component that compiles without TypeScript errors
2. `factor-checklist.tsx` exports FactorChecklist component that compiles without TypeScript errors
3. Both components are standalone (no dependency on each other or on Plan 01 backend code)
4. Both use existing shadcn/ui components (Select, Input, Button, Checkbox)
5. Both use useLanguage() for section headers and cn() for conditional styling
</verification>

<success_criteria>
- TierSelector displays 6 clickable cards in responsive grid with selection highlighting
- FactorChecklist shows 8 factor inputs in collapsible panel with dynamic hour badges
- Both components are controlled (value + onChange pattern)
- Both compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-complexity-system-rebuild/21-02-SUMMARY.md`
</output>
