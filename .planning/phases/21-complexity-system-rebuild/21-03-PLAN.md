---
phase: 21-complexity-system-rebuild
plan: 03
type: execute
wave: 2
depends_on: ["21-01", "21-02"]
files_modified:
  - frontend/src/types/hybrid-quote.ts
  - frontend/src/lib/schemas/hybrid-quote.ts
  - frontend/src/lib/api/hybrid-quote.ts
  - frontend/src/components/estimateur/full-quote-form.tsx
  - frontend/src/lib/i18n/fr.ts
  - frontend/src/lib/i18n/en.ts
  - backend/app/services/hybrid_quote.py
autonomous: true

must_haves:
  truths:
    - "Full quote form shows TierSelector cards instead of old complexity presets"
    - "Factor checklist appears below tier selector as collapsible panel"
    - "Form submits complexity_tier + factor values to backend instead of old 6 sliders"
    - "Backend orchestrator uses complexity_calculator for new tier-based requests"
    - "Old slider-based submissions still work (backward compatibility)"
    - "All new labels and tier descriptions available in French and English"
  artifacts:
    - path: "frontend/src/types/hybrid-quote.ts"
      provides: "Updated HybridQuoteRequest type with tier + factor fields"
      contains: "complexity_tier"
    - path: "frontend/src/lib/schemas/hybrid-quote.ts"
      provides: "Updated Zod schema for new complexity fields"
      contains: "complexity_tier"
    - path: "frontend/src/components/estimateur/full-quote-form.tsx"
      provides: "Full quote form with TierSelector and FactorChecklist"
      contains: "TierSelector"
    - path: "backend/app/services/hybrid_quote.py"
      provides: "Orchestrator using complexity_calculator for tier-based requests"
      contains: "calculate_complexity_hours"
  key_links:
    - from: "frontend/src/components/estimateur/full-quote-form.tsx"
      to: "frontend/src/components/estimateur/tier-selector.tsx"
      via: "import and render TierSelector"
      pattern: "import.*TierSelector"
    - from: "frontend/src/components/estimateur/full-quote-form.tsx"
      to: "frontend/src/components/estimateur/factor-checklist.tsx"
      via: "import and render FactorChecklist"
      pattern: "import.*FactorChecklist"
    - from: "frontend/src/components/estimateur/full-quote-form.tsx"
      to: "/estimate/hybrid"
      via: "submitHybridQuote API call with new fields"
      pattern: "submitHybridQuote"
    - from: "backend/app/services/hybrid_quote.py"
      to: "backend/app/services/complexity_calculator.py"
      via: "import and call calculate_complexity_hours"
      pattern: "from app.services.complexity_calculator import"
---

<objective>
Wire the new tier selector and factor checklist components into the full quote form, update all TypeScript types and Zod schemas to match the new backend fields, add i18n translations, and integrate the complexity calculator into the backend orchestrator.

Purpose: This plan connects all the pieces from Plans 01 and 02 into a working end-to-end flow: user selects tier + adjusts factors -> form sends new fields -> backend calculates hours -> quote generated with tier-aware complexity.

Output: Updated form, types, schemas, translations, and backend orchestrator integration
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-complexity-system-rebuild/21-01-SUMMARY.md
@.planning/phases/21-complexity-system-rebuild/21-02-SUMMARY.md
@frontend/src/components/estimateur/full-quote-form.tsx
@frontend/src/types/hybrid-quote.ts
@frontend/src/lib/schemas/hybrid-quote.ts
@frontend/src/lib/api/hybrid-quote.ts
@frontend/src/lib/i18n/fr.ts
@frontend/src/lib/i18n/en.ts
@backend/app/services/hybrid_quote.py
@backend/app/schemas/hybrid_quote.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TypeScript types, Zod schema, and i18n translations</name>
  <files>
    frontend/src/types/hybrid-quote.ts
    frontend/src/lib/schemas/hybrid-quote.ts
    frontend/src/lib/i18n/fr.ts
    frontend/src/lib/i18n/en.ts
  </files>
  <action>
**1. Update `frontend/src/types/hybrid-quote.ts`:**

Add new fields to `HybridQuoteRequest` interface (keep ALL existing fields for backward compat, mark old ones as optional):

```typescript
export interface HybridQuoteRequest {
  // Core job parameters
  sqft: number;
  category: string;

  // NEW: Tier-based complexity (Phase 21)
  complexity_tier?: number;        // 1-6
  complexity_score?: number;       // 0-100

  // NEW: Factor checklist (Phase 21)
  factor_roof_pitch?: string;               // flat|low|medium|steep|very_steep
  factor_access_difficulty?: string[];       // checklist items
  factor_demolition?: string;               // none|single_layer|multi_layer|structural
  factor_penetrations_count?: number;        // 0+
  factor_security?: string[];               // checklist items
  factor_material_removal?: string;          // none|standard|heavy|hazardous
  factor_roof_sections_count?: number;       // 1+
  factor_previous_layers_count?: number;     // 0+
  manual_extra_hours?: number;               // upward override

  // LEGACY: Old complexity factors (still accepted for backward compat)
  complexity_aggregate?: number;   // 0-56
  access_difficulty?: number;      // 0-10
  roof_pitch?: number;             // 0-8
  penetrations?: number;           // 0-10
  material_removal?: number;       // 0-8
  safety_concerns?: number;        // 0-10
  timeline_constraints?: number;   // 0-10

  // Optional features
  has_chimney: boolean;
  has_skylights: boolean;

  // Line item counts
  material_lines: number;
  labor_lines: number;

  // Subcontractor flag
  has_subs: boolean;

  // Known price
  quoted_total?: number | null;
}
```

**2. Update `frontend/src/lib/schemas/hybrid-quote.ts`:**

Replace the Zod schema to support the new tier-based system. The form will now submit tier + factor values instead of old sliders:

```typescript
export const hybridQuoteFormSchema = z.object({
  // Core job parameters
  sqft: z.number().positive().max(100000),
  category: z.enum(CATEGORIES, { message: "Invalid category" }),

  // NEW: Tier-based complexity
  complexity_tier: z.number().int().min(1).max(6),

  // NEW: Factor checklist values
  factor_roof_pitch: z.string().nullable().default(null),
  factor_access_difficulty: z.array(z.string()).default([]),
  factor_demolition: z.string().nullable().default(null),
  factor_penetrations_count: z.number().int().min(0).default(0),
  factor_security: z.array(z.string()).default([]),
  factor_material_removal: z.string().nullable().default(null),
  factor_roof_sections_count: z.number().int().min(1).default(2),
  factor_previous_layers_count: z.number().int().min(0).default(0),
  manual_extra_hours: z.number().min(0).default(0),

  // Line item counts
  material_lines: z.number().int().min(0).max(100),
  labor_lines: z.number().int().min(0).max(50),

  // Optional features
  has_chimney: z.boolean(),
  has_skylights: z.boolean(),
  has_subs: z.boolean(),

  // Known price
  quoted_total: z.number().nonnegative().nullable().optional(),
});
```

Remove the old `.refine()` validator for complexity_aggregate sum -- it's no longer needed since we're using tiers.

Export the inferred type: `export type HybridQuoteFormData = z.infer<typeof hybridQuoteFormSchema>;`

**3. Update `frontend/src/lib/i18n/fr.ts`:**

Add new keys inside the `fullQuote` section (after existing keys, before the closing brace):

```typescript
// Tier selector
tierSelector: "Niveau de complexite",
tierSelectorDescription: "Selectionnez le niveau qui correspond au chantier",
tierScoreRange: "pts",
tierHoursAdded: "h ajoutees",

// Tier names (also available from config, but needed for static labels)
tierSimple: "Simple / Standard",
tierModerate: "Modere",
tierComplex: "Complexe",
tierHighComplexity: "Haute complexite",
tierVeryHighComplexity: "Tres haute complexite",
tierExtreme: "Extreme",

// Factor checklist
factorAdjustments: "Ajustements detailles",
totalAdjustments: "Total des ajustements",
factorRoofPitch: "Pente du toit",
factorAccessDifficulty: "Difficulte d'acces",
factorDemolition: "Demolition",
factorPenetrations: "Penetrations",
factorSecurity: "Securite",
factorMaterialRemoval: "Retrait de materiaux",
factorRoofSections: "Sections de toit",
factorPreviousLayers: "Couches precedentes",
manualExtraHours: "Heures supplementaires manuelles",
manualExtraHoursDesc: "Ajout manuel (a la hausse uniquement)",

// Complexity hours display
baseHours: "Heures de base",
tierHours: "Heures du niveau",
factorHoursLabel: "Heures des facteurs",
totalLaborHours: "Total heures de travail",
```

**4. Update `frontend/src/lib/i18n/en.ts`:**

Add matching English keys in the same location:

```typescript
// Tier selector
tierSelector: "Complexity Level",
tierSelectorDescription: "Select the level that matches the job site",
tierScoreRange: "pts",
tierHoursAdded: "hours added",

// Tier names
tierSimple: "Simple / Standard",
tierModerate: "Moderate",
tierComplex: "Complex",
tierHighComplexity: "High Complexity",
tierVeryHighComplexity: "Very High Complexity",
tierExtreme: "Extreme",

// Factor checklist
factorAdjustments: "Detailed Adjustments",
totalAdjustments: "Total adjustments",
factorRoofPitch: "Roof Pitch",
factorAccessDifficulty: "Access Difficulty",
factorDemolition: "Demolition",
factorPenetrations: "Penetrations",
factorSecurity: "Security",
factorMaterialRemoval: "Material Removal",
factorRoofSections: "Roof Sections",
factorPreviousLayers: "Previous Layers",
manualExtraHours: "Manual Extra Hours",
manualExtraHoursDesc: "Manual addition (upward only)",

// Complexity hours display
baseHours: "Base hours",
tierHours: "Tier hours",
factorHoursLabel: "Factor hours",
totalLaborHours: "Total labor hours",
```

Ensure new keys are added after existing `fullQuote` keys and before the closing brace. Do NOT modify any existing translation keys.
  </action>
  <verify>
```bash
cd frontend && npx tsc --noEmit 2>&1 | head -30
```
Verify no TypeScript errors across the project. The types, schema, and translations should all be consistent.
  </verify>
  <done>
TypeScript types match new backend schema with both old (optional) and new (tier-based) fields. Zod schema validates tier-based form inputs. French and English translations added for all new UI labels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire TierSelector and FactorChecklist into full-quote-form and update backend orchestrator</name>
  <files>
    frontend/src/components/estimateur/full-quote-form.tsx
    frontend/src/lib/api/hybrid-quote.ts
    backend/app/services/hybrid_quote.py
  </files>
  <action>
**1. Rewrite the complexity section of `frontend/src/components/estimateur/full-quote-form.tsx`:**

Replace the `ComplexityPresets` Controller block with `TierSelector` + `FactorChecklist`:

- Remove import of `ComplexityPresets` from `./complexity-presets`
- Add imports:
  ```typescript
  import { TierSelector, type TierData } from "./tier-selector";
  import { FactorChecklist, type FactorValues, type FactorConfig } from "./factor-checklist";
  ```

- Add tier configuration data (hardcoded from config -- this avoids needing an API call to load config). Define inside the component or at module level:
  ```typescript
  function useTierData(): { tiers: TierData[]; factorConfig: FactorConfig } {
    const { t, locale } = useLanguage();
    // Tier data matching complexity_tiers_config.json
    const tiers: TierData[] = [
      { tier: 1, name: locale === 'fr' ? "Simple / Standard" : "Simple / Standard", description: locale === 'fr' ? "Maison plain-pied, toit plat a faible pente, acces facile" : "Single-story house, flat to low pitch, easy access", scoreRange: "0-16", hoursAdded: 0 },
      { tier: 2, name: locale === 'fr' ? "Modere" : "Moderate", description: locale === 'fr' ? "Maison 2 etages, pente 4/12 a 6/12, bon acces" : "Two-story house, 4/12 to 6/12 pitch, good access", scoreRange: "17-33", hoursAdded: 4 },
      { tier: 3, name: locale === 'fr' ? "Complexe" : "Complex", description: locale === 'fr' ? "2 etages, forte pente, acces limite, multi-couches" : "Two-story, steep pitch, limited access, multi-layer", scoreRange: "34-50", hoursAdded: 8 },
      { tier: 4, name: locale === 'fr' ? "Haute complexite" : "High Complexity", description: locale === 'fr' ? "3 etages ou pente 8/12+, grue recommandee" : "Three-story or 8/12+, crane recommended", scoreRange: "51-66", hoursAdded: 16 },
      { tier: 5, name: locale === 'fr' ? "Tres haute complexite" : "Very High Complexity", description: locale === 'fr' ? "3 etages, pente 10/12+, grue requise, centre-ville" : "Three-story, 10/12+, crane required, downtown", scoreRange: "67-83", hoursAdded: 24 },
      { tier: 6, name: locale === 'fr' ? "Extreme" : "Extreme", description: locale === 'fr' ? "Commercial, pente extreme, echafaudage, conditions hivernales" : "Commercial, extreme pitch, scaffolding, winter conditions", scoreRange: "84-100", hoursAdded: 40 },
    ];
    // Factor config matching complexity_tiers_config.json, localized
    const factorConfig: FactorConfig = {
      // Build from config JSON structure, using locale to pick label_fr or label_en
      // ... (construct from the tier config structure, selecting localized labels)
    };
    return { tiers, factorConfig };
  }
  ```

  NOTE: Build the factorConfig object inline with localized labels from the JSON structure. This mirrors the config file but picks fr/en labels based on current locale. In a future phase, this could be loaded from a backend API endpoint.

- Update form defaultValues:
  ```typescript
  defaultValues: {
    sqft: 1500,
    category: "Bardeaux",
    complexity_tier: 2,  // Default to Moderate
    factor_roof_pitch: null,
    factor_access_difficulty: [],
    factor_demolition: null,
    factor_penetrations_count: 0,
    factor_security: [],
    factor_material_removal: null,
    factor_roof_sections_count: 2,
    factor_previous_layers_count: 0,
    manual_extra_hours: 0,
    material_lines: 5,
    labor_lines: 2,
    has_chimney: false,
    has_skylights: false,
    has_subs: false,
  }
  ```

- Replace the Complexity Section card content. Instead of the `<Controller>` wrapping `<ComplexityPresets>`, render:
  ```tsx
  <CardContent className="space-y-4">
    <TierSelector
      value={form.watch("complexity_tier")}
      onChange={(tier) => form.setValue("complexity_tier", tier)}
      tiers={tiers}
    />
    <FactorChecklist
      value={{
        roof_pitch: form.watch("factor_roof_pitch"),
        access_difficulty: form.watch("factor_access_difficulty"),
        demolition: form.watch("factor_demolition"),
        penetrations_count: form.watch("factor_penetrations_count"),
        security: form.watch("factor_security"),
        material_removal: form.watch("factor_material_removal"),
        roof_sections_count: form.watch("factor_roof_sections_count"),
        previous_layers_count: form.watch("factor_previous_layers_count"),
      }}
      onChange={(factors) => {
        form.setValue("factor_roof_pitch", factors.roof_pitch);
        form.setValue("factor_access_difficulty", factors.access_difficulty);
        form.setValue("factor_demolition", factors.demolition);
        form.setValue("factor_penetrations_count", factors.penetrations_count);
        form.setValue("factor_security", factors.security);
        form.setValue("factor_material_removal", factors.material_removal);
        form.setValue("factor_roof_sections_count", factors.roof_sections_count);
        form.setValue("factor_previous_layers_count", factors.previous_layers_count);
      }}
      config={factorConfig}
      totalHours={calculatedFactorHours}  // Compute this from factor values
    />
    {/* Manual extra hours input */}
    <FormField
      control={form.control}
      name="manual_extra_hours"
      render={({ field }) => (
        <FormItem>
          <FormLabel className="text-sm font-medium">{t.fullQuote.manualExtraHours}</FormLabel>
          <FormControl>
            <Input type="number" min={0} step={0.5} className="h-11" {...field}
              onChange={(e) => field.onChange(e.target.valueAsNumber || 0)} />
          </FormControl>
          <FormDescription className="text-xs text-muted-foreground">
            {t.fullQuote.manualExtraHoursDesc}
          </FormDescription>
        </FormItem>
      )}
    />
  </CardContent>
  ```

- Compute `calculatedFactorHours` using a useMemo that sums hours from watched factor values (mirror the backend calculator logic in simple JS). This is for UI display only -- the backend does the authoritative calculation.

- Update `onSubmit` to build the new request format:
  ```typescript
  const request: HybridQuoteRequest = {
    sqft: data.sqft,
    category: data.category,
    complexity_tier: data.complexity_tier,
    factor_roof_pitch: data.factor_roof_pitch || undefined,
    factor_access_difficulty: data.factor_access_difficulty.length > 0 ? data.factor_access_difficulty : undefined,
    factor_demolition: data.factor_demolition || undefined,
    factor_penetrations_count: data.factor_penetrations_count || undefined,
    factor_security: data.factor_security.length > 0 ? data.factor_security : undefined,
    factor_material_removal: data.factor_material_removal || undefined,
    factor_roof_sections_count: data.factor_roof_sections_count > 2 ? data.factor_roof_sections_count : undefined,
    factor_previous_layers_count: data.factor_previous_layers_count > 0 ? data.factor_previous_layers_count : undefined,
    manual_extra_hours: data.manual_extra_hours > 0 ? data.manual_extra_hours : undefined,
    has_chimney: data.has_chimney,
    has_skylights: data.has_skylights,
    material_lines: data.material_lines,
    labor_lines: data.labor_lines,
    has_subs: data.has_subs,
    quoted_total: data.quoted_total,
  };
  ```

- Keep the old `complexity-presets.tsx` file in place (don't delete it) -- it's no longer imported but may be useful for Phase 22 reference.

**2. Update `frontend/src/lib/api/hybrid-quote.ts`:**

No changes needed to the API client itself -- it already sends whatever HybridQuoteRequest contains. The type update in step 1 handles the new fields.

**3. Update `backend/app/services/hybrid_quote.py` to use the complexity calculator:**

Add import at top:
```python
from app.services.complexity_calculator import calculate_complexity_hours
```

In `_run_ml_prediction()`, update the `complexity` parameter passed to `predict()` and `predict_materials()`:
- If `request.complexity_tier` is set, compute complexity_score from tier and use it
- If old `request.complexity_aggregate` is set, use it as before (backward compat)
- Default to 28 (moderate) if neither is set

```python
def _get_complexity_for_ml(request: HybridQuoteRequest) -> int:
    """Get complexity score for ML models (0-100 scale or legacy 0-56)."""
    if request.complexity_tier is not None:
        # New tier system: compute score from tier
        from app.services.complexity_calculator import get_tier_config
        config = get_tier_config()
        tier_cfg = config["tiers"][request.complexity_tier - 1]
        return tier_cfg["score_min"] + (tier_cfg["score_max"] - tier_cfg["score_min"]) // 2
    elif request.complexity_aggregate is not None:
        return request.complexity_aggregate
    else:
        return 28  # Default moderate
```

Use this helper in `_run_ml_prediction()` and `_run_cbr_query()` where `request.complexity_aggregate` is currently referenced.

In `_format_merger_prompt()`, update the complexity section of the prompt:
- If `request.complexity_tier` is set, show tier info + factor checklist instead of old 6 sliders:
  ```python
  if request.complexity_tier:
      complexity_section = f"""
  Complexity Tier: {request.complexity_tier}/6
  Complexity Score: {request.complexity_score or 'auto'}/100
  Factor Adjustments:
  - Roof Pitch: {request.factor_roof_pitch or 'N/A'}
  - Access Difficulty: {', '.join(request.factor_access_difficulty or []) or 'None'}
  - Demolition: {request.factor_demolition or 'N/A'}
  - Penetrations: {request.factor_penetrations_count or 0}
  - Security: {', '.join(request.factor_security or []) or 'None'}
  - Material Removal: {request.factor_material_removal or 'N/A'}
  - Roof Sections: {request.factor_roof_sections_count or 'N/A'}
  - Previous Layers: {request.factor_previous_layers_count or 0}
  - Manual Extra Hours: {request.manual_extra_hours or 0}
  """
  else:
      # Legacy 6-factor breakdown
      complexity_section = f"""
  Complexity Score: {request.complexity_aggregate or 0}/56
  6-Factor Breakdown:
  - Access Difficulty: {request.access_difficulty or 0}/10
  - Roof Pitch: {request.roof_pitch or 0}/8
  ...
  """
  ```

In `generate_hybrid_quote()`, if the request uses the new tier system, call `calculate_complexity_hours()` to get the labor hour breakdown and include it in the response reasoning:
```python
complexity_breakdown = None
if request.complexity_tier is not None:
    complexity_breakdown = calculate_complexity_hours(
        category=request.category,
        sqft=request.sqft,
        tier=request.complexity_tier,
        factors={
            "roof_pitch": request.factor_roof_pitch,
            "access_difficulty": request.factor_access_difficulty or [],
            "demolition": request.factor_demolition,
            "penetrations_count": request.factor_penetrations_count or 0,
            "security": request.factor_security or [],
            "material_removal": request.factor_material_removal,
            "roof_sections_count": request.factor_roof_sections_count or 2,
            "previous_layers_count": request.factor_previous_layers_count or 0,
        },
    )
    logger.info(f"Complexity breakdown: {complexity_breakdown}")
```

This breakdown is logged for now. It will be used more extensively when Phase 22 adds crew cost calculations.
  </action>
  <verify>
```bash
# Frontend: verify full project compiles
cd frontend && npx tsc --noEmit 2>&1 | head -30

# Backend: verify imports work
cd backend && python -c "
from app.services.hybrid_quote import generate_hybrid_quote
from app.schemas.hybrid_quote import HybridQuoteRequest
print('Backend imports OK')

# Test new request format parses
req = HybridQuoteRequest(
    sqft=1500, category='Bardeaux',
    complexity_tier=3,
    factor_roof_pitch='steep',
    factor_access_difficulty=['no_crane'],
    material_lines=5, labor_lines=2,
    has_chimney=False, has_skylights=False, has_subs=False
)
print(f'Request parsed: tier={req.complexity_tier}')
"
```
  </verify>
  <done>
Full quote form renders TierSelector + FactorChecklist instead of old sliders. Form submits complexity_tier + factor fields to backend. Backend orchestrator detects tier-based requests and uses complexity_calculator for labor hour calculations. Old slider requests still work via backward compatibility. All new labels translated in FR and EN.
  </done>
</task>

</tasks>

<verification>
1. Frontend compiles without TypeScript errors (`npx tsc --noEmit`)
2. Full quote form displays tier cards and factor checklist
3. Submitting form sends `complexity_tier` + factor fields (not old slider values)
4. Backend parses new request format without errors
5. Backend calls `calculate_complexity_hours()` for tier-based requests
6. Old-format requests (with complexity_aggregate + 6 sliders) still work
7. French and English translations render correctly
</verification>

<success_criteria>
- TierSelector and FactorChecklist visible in the full quote form replacing old presets
- End-to-end: user selects tier 3 + checks some factors -> submit -> backend receives and logs complexity breakdown
- Backward compatibility: old format submissions still accepted
- All UI text in French (default) and English (toggle)
</success_criteria>

<output>
After completion, create `.planning/phases/21-complexity-system-rebuild/21-03-SUMMARY.md`
</output>
