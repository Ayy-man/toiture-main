# 12-02: Revenue → Total Quote Value Renaming

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Rename all instances of "Revenue" to "Total Quote Value" across the codebase to accurately represent what the data measures.

**Architecture:** Systematic find-and-replace across backend schemas, routers, frontend types, components, and i18n. Add disclaimer explaining the metric.

**Tech Stack:** FastAPI (Pydantic), TypeScript, React, French i18n

---

## Context

Laurent clarified that all "Revenue" labels actually represent "Total Quote Value" (quoted amounts, NOT invoiced/collected revenue). This is misleading. There are 32+ occurrences to update.

## Renaming Map

| Current | New |
|---------|-----|
| `RevenueByYear` | `QuoteValueByYear` |
| `RevenueByCategory` | `QuoteValueByCategory` |
| `total_revenue` | `total_quote_value` |
| `revenue` (field) | `quote_value` |
| `revenue_by_year` | `quote_value_by_year` |
| `revenue_by_category` | `quote_value_by_category` |
| "Revenu total" (FR) | "Valeur totale des soumissions" |
| "Revenu par annee" (FR) | "Valeur des soumissions par annee" |
| "Revenu par categorie" (FR) | "Valeur des soumissions par categorie" |

---

## Plan

### Task 1: Update Backend Schemas

**Files:**
- Modify: `backend/app/schemas/dashboard.py`

**Step 1: Rename classes and fields**

Update `backend/app/schemas/dashboard.py`:

```python
from pydantic import BaseModel, Field
from typing import List, Optional


class DashboardMetrics(BaseModel):
    """Summary metrics for the dashboard"""
    total_quotes: int = Field(description="Total number of quotes")
    # RENAMED: total_revenue → total_quote_value
    total_quote_value: float = Field(description="Sum of all quoted amounts (not invoiced revenue)")
    avg_margin: float = Field(description="Average margin percentage")
    active_customers: int = Field(description="Number of unique customers")


class QuoteValueByYear(BaseModel):
    """Quote value aggregated by year (formerly RevenueByYear)"""
    year: int
    # RENAMED: revenue → quote_value
    quote_value: float = Field(description="Total quoted amount for the year")
    count: int = Field(description="Number of quotes")


class QuoteValueByCategory(BaseModel):
    """Quote value aggregated by category (formerly RevenueByCategory)"""
    category: str
    # RENAMED: revenue → quote_value
    quote_value: float = Field(description="Total quoted amount for the category")
    percentage: float = Field(description="Percentage of total quote value")


class MonthlyTrend(BaseModel):
    """Monthly trend data for charts"""
    month: str  # Format: "YYYY-MM"
    # RENAMED: revenue → quote_value
    quote_value: float = Field(description="Total quoted amount for the month")
    count: int = Field(description="Number of quotes")


class DashboardCharts(BaseModel):
    """Chart data for the dashboard"""
    # RENAMED: revenue_by_year → quote_value_by_year
    quote_value_by_year: List[QuoteValueByYear]
    # RENAMED: revenue_by_category → quote_value_by_category
    quote_value_by_category: List[QuoteValueByCategory]
    monthly_trend: List[MonthlyTrend]


class DashboardResponse(BaseModel):
    """Complete dashboard response"""
    metrics: DashboardMetrics
    charts: DashboardCharts
    # NEW: Add disclaimer
    disclaimer: str = Field(
        default="Note: All values represent quoted amounts, not invoiced or collected revenue.",
        description="Data clarification for users"
    )
```

---

### Task 2: Update Backend Router

**Files:**
- Modify: `backend/app/routers/dashboard.py`

**Step 1: Update variable names and dictionary keys**

Find and replace in `backend/app/routers/dashboard.py`:

```python
# Line ~54: total_revenue → total_quote_value
total_quote_value = sum(row.get("ai_estimate", 0) or 0 for row in result.data)

# Line ~123-131: Dictionary building
year_data[year] = {
    "year": year,
    "quote_value": 0,  # Changed from "revenue"
    "count": 0,
}
year_data[year]["quote_value"] += price  # Changed from "revenue"

# Line ~143-158: Category aggregation
category_data[cat] = {
    "category": cat,
    "quote_value": 0,  # Changed from "revenue"
}
category_data[cat]["quote_value"] += price  # Changed from "revenue"

# Line ~162-179: Response construction
quote_value_by_year = [
    QuoteValueByYear(
        year=data["year"],
        quote_value=data["quote_value"],
        count=data["count"],
    )
    for data in sorted(year_data.values(), key=lambda x: x["year"])
]

quote_value_by_category = [
    QuoteValueByCategory(
        category=data["category"],
        quote_value=data["quote_value"],
        percentage=(data["quote_value"] / total_quote_value * 100) if total_quote_value > 0 else 0,
    )
    for data in category_data.values()
]

# Return statement
return DashboardResponse(
    metrics=DashboardMetrics(
        total_quotes=total_quotes,
        total_quote_value=total_quote_value,  # Changed
        avg_margin=avg_margin,
        active_customers=active_customers,
    ),
    charts=DashboardCharts(
        quote_value_by_year=quote_value_by_year,  # Changed
        quote_value_by_category=quote_value_by_category,  # Changed
        monthly_trend=monthly_trend,
    ),
    disclaimer="Note: All values represent quoted amounts, not invoiced or collected revenue.",
)
```

---

### Task 3: Update Frontend Types

**Files:**
- Modify: `frontend/src/types/dashboard.ts`

**Step 1: Rename interfaces and fields**

```typescript
export interface DashboardMetrics {
  total_quotes: number;
  // RENAMED: total_revenue → total_quote_value
  total_quote_value: number;
  avg_margin: number;
  active_customers: number;
}

// RENAMED: RevenueByYear → QuoteValueByYear
export interface QuoteValueByYear {
  year: number;
  // RENAMED: revenue → quote_value
  quote_value: number;
  count: number;
}

// RENAMED: RevenueByCategory → QuoteValueByCategory
export interface QuoteValueByCategory {
  category: string;
  // RENAMED: revenue → quote_value
  quote_value: number;
  percentage: number;
}

export interface MonthlyTrend {
  month: string;
  // RENAMED: revenue → quote_value
  quote_value: number;
  count: number;
}

export interface DashboardCharts {
  // RENAMED: revenue_by_year → quote_value_by_year
  quote_value_by_year: QuoteValueByYear[];
  // RENAMED: revenue_by_category → quote_value_by_category
  quote_value_by_category: QuoteValueByCategory[];
  monthly_trend: MonthlyTrend[];
}

export interface DashboardResponse {
  metrics: DashboardMetrics;
  charts: DashboardCharts;
  // NEW: Disclaimer field
  disclaimer: string;
}
```

---

### Task 4: Update Frontend Components

**Files:**
- Modify: `frontend/src/components/apercu/revenue-chart.tsx` → Rename to `quote-value-chart.tsx`
- Modify: `frontend/src/components/apercu/category-chart.tsx`
- Modify: `frontend/src/components/apercu/trend-chart.tsx`
- Modify: `frontend/src/components/apercu/metrics-cards.tsx`
- Modify: `frontend/src/app/(admin)/apercu/page.tsx`

**Step 1: Rename revenue-chart.tsx to quote-value-chart.tsx**

```bash
cd frontend/src/components/apercu
mv revenue-chart.tsx quote-value-chart.tsx
```

**Step 2: Update quote-value-chart.tsx**

```tsx
"use client";

import { QuoteValueByYear } from "@/types/dashboard";  // Changed import
// ... other imports

interface QuoteValueChartProps {  // Renamed
  data: QuoteValueByYear[];  // Changed type
}

export function QuoteValueChart({ data }: QuoteValueChartProps) {  // Renamed
  // ...
  return (
    // Update chart dataKey from "revenue" to "quote_value"
    <Bar dataKey="quote_value" fill="#8B2323" />
  );
}
```

**Step 3: Update category-chart.tsx**

```tsx
import { QuoteValueByCategory } from "@/types/dashboard";  // Changed

interface CategoryChartProps {
  data: QuoteValueByCategory[];  // Changed
}

// Update chart dataKey from "revenue" to "quote_value"
<Bar dataKey="quote_value" fill="#8B2323" />
```

**Step 4: Update trend-chart.tsx**

```tsx
import { MonthlyTrend } from "@/types/dashboard";

// Update chart dataKey from "revenue" to "quote_value"
<Line dataKey="quote_value" stroke="#8B2323" />
```

**Step 5: Update metrics-cards.tsx**

```tsx
// Change reference from metrics.total_revenue to metrics.total_quote_value
<span>{formatCurrency(metrics.total_quote_value)}</span>
```

**Step 6: Update apercu/page.tsx**

```tsx
import { QuoteValueChart } from "@/components/apercu/quote-value-chart";  // Changed import

// Update card titles
<CardTitle>Valeur des soumissions par annee</CardTitle>  // Changed
<CardTitle>Valeur des soumissions par categorie</CardTitle>  // Changed

// Update component usage
<QuoteValueChart data={dashboard.charts.quote_value_by_year} />  // Changed
// ...data={dashboard.charts.quote_value_by_category}
```

---

### Task 5: Update French Translations

**Files:**
- Modify: `frontend/src/lib/i18n/fr.ts`

**Step 1: Update French labels**

```typescript
export const fr = {
  // ... existing translations
  apercu: {
    titre: "Tableau de bord",
    // RENAMED: revenuTotal → valeurTotaleSoumissions
    valeurTotaleSoumissions: "Valeur totale des soumissions",
    nombreSoumissions: "Nombre de soumissions",
    margeAvg: "Marge moyenne",
    clientsActifs: "Clients actifs",
    // RENAMED: revenuParAnnee → valeurParAnnee
    valeurParAnnee: "Valeur des soumissions par annee",
    // RENAMED: revenuParCategorie → valeurParCategorie
    valeurParCategorie: "Valeur des soumissions par categorie",
    tendanceMensuelle: "Tendance mensuelle",
    // NEW: Disclaimer
    avertissement: "Note: Ces valeurs representent les montants soumis, non les revenus factures ou collectes.",
  },
  // ... rest of translations
};
```

---

### Task 6: Add Disclaimer Component

**Files:**
- Create: `frontend/src/components/apercu/data-disclaimer.tsx`
- Modify: `frontend/src/app/(admin)/apercu/page.tsx`

**Step 1: Create disclaimer component**

```tsx
// frontend/src/components/apercu/data-disclaimer.tsx
"use client";

import { AlertCircle } from "lucide-react";
import { fr } from "@/lib/i18n/fr";

export function DataDisclaimer() {
  return (
    <div className="flex items-center gap-2 p-3 bg-amber-50 border border-amber-200 rounded-md text-amber-800 text-sm">
      <AlertCircle className="h-4 w-4 flex-shrink-0" />
      <span>{fr.apercu.avertissement}</span>
    </div>
  );
}
```

**Step 2: Add to apercu page**

```tsx
import { DataDisclaimer } from "@/components/apercu/data-disclaimer";

// At top of page content, after title
<DataDisclaimer />
```

---

### Task 7: Verify and Test

**Step 1: Build verification**

```bash
cd backend && python -m pytest tests/ -v
cd frontend && npm run build
```

**Step 2: API test**

```bash
# Verify renamed fields in API response
curl http://localhost:8000/dashboard | jq '.metrics.total_quote_value, .charts.quote_value_by_year'
```

**Step 3: Visual verification**

- Navigate to /apercu
- Verify "Valeur totale des soumissions" label (not "Revenu total")
- Verify disclaimer banner is visible
- Verify charts use correct data keys

**Step 4: Commit**

```bash
git add -A
git commit -m "fix(dashboard): rename Revenue to Total Quote Value

BREAKING CHANGE: API field names changed

- Rename RevenueByYear → QuoteValueByYear
- Rename RevenueByCategory → QuoteValueByCategory
- Rename total_revenue → total_quote_value
- Rename revenue field → quote_value
- Update all French labels
- Add disclaimer explaining metric represents quoted amounts, not revenue

Closes: Laurent feedback issue #3"
```

---

## Success Criteria

- [ ] No occurrences of "revenue" or "Revenue" in codebase (except git history)
- [ ] API returns `total_quote_value`, `quote_value_by_year`, `quote_value_by_category`
- [ ] French labels updated to "Valeur des soumissions"
- [ ] Disclaimer visible on dashboard explaining the metric
- [ ] Build passes for both frontend and backend
