# 12-03: Square Footage Compliance Dashboard

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create a compliance tracking dashboard to monitor square footage data entry rates by estimator, with alerts when compliance drops below 80%.

**Architecture:** Backend endpoint for compliance metrics, frontend dashboard component with estimator breakdown, and alert system for low compliance.

**Tech Stack:** Supabase (PostgreSQL), FastAPI, React, Recharts, shadcn/ui

---

## Context

Laurent noted that only 33% of historical quotes have square footage data. While square footage is already required in our app (schema validation enforces gt=0), we need:
1. Dashboard to track compliance rates by estimator
2. Alerts when compliance drops below 80%
3. Historical tracking to measure improvement

**Note:** The square footage field IS already required in backend schemas. This plan adds compliance MONITORING, not enforcement.

---

## Plan

### Task 1: Create Backend Compliance Endpoint

**Files:**
- Create: `backend/app/schemas/compliance.py`
- Modify: `backend/app/routers/dashboard.py`

**Step 1: Create compliance schemas**

Create `backend/app/schemas/compliance.py`:

```python
from pydantic import BaseModel, Field
from typing import List, Optional
from datetime import datetime


class EstimatorCompliance(BaseModel):
    """Compliance metrics for a single estimator"""
    estimator_id: Optional[str] = None
    estimator_name: str = Field(default="Unknown")
    total_quotes: int
    quotes_with_sqft: int
    compliance_rate: float = Field(description="Percentage with sqft (0-100)")
    is_compliant: bool = Field(description="True if rate >= 80%")


class ComplianceAlert(BaseModel):
    """Alert for low compliance"""
    estimator_name: str
    compliance_rate: float
    quotes_missing_sqft: int
    severity: str = Field(description="warning (60-80%) or critical (<60%)")


class ComplianceMetrics(BaseModel):
    """Overall compliance summary"""
    total_quotes: int
    quotes_with_sqft: int
    overall_compliance_rate: float
    threshold: float = Field(default=80.0)
    is_meeting_target: bool
    by_estimator: List[EstimatorCompliance]
    alerts: List[ComplianceAlert]
    period_start: Optional[str] = None
    period_end: Optional[str] = None


class ComplianceTrend(BaseModel):
    """Weekly compliance trend"""
    week: str  # Format: "YYYY-WW"
    compliance_rate: float
    total_quotes: int
    quotes_with_sqft: int
```

**Step 2: Add compliance endpoint to dashboard router**

Add to `backend/app/routers/dashboard.py`:

```python
from app.schemas.compliance import (
    ComplianceMetrics,
    EstimatorCompliance,
    ComplianceAlert,
    ComplianceTrend,
)

@router.get("/compliance", response_model=ComplianceMetrics)
async def get_compliance_metrics(
    start_date: Optional[str] = None,
    end_date: Optional[str] = None,
    threshold: float = Query(80.0, ge=0, le=100),
):
    """
    Get square footage compliance metrics.

    Returns compliance rates by estimator and alerts for those below threshold.
    """
    try:
        supabase = get_supabase_client()

        # Build query
        query = supabase.table("estimates").select(
            "id, sqft, created_at, estimator_id, estimator_name",
            count="exact"
        )

        if start_date:
            query = query.gte("created_at", start_date)
        if end_date:
            query = query.lte("created_at", end_date)

        result = query.execute()
        rows = result.data or []

        # Calculate overall compliance
        total_quotes = len(rows)
        quotes_with_sqft = sum(1 for r in rows if r.get("sqft") and r["sqft"] > 0)
        overall_rate = (quotes_with_sqft / total_quotes * 100) if total_quotes > 0 else 0

        # Group by estimator
        estimator_data = {}
        for row in rows:
            name = row.get("estimator_name") or row.get("estimator_id") or "Unknown"
            if name not in estimator_data:
                estimator_data[name] = {"total": 0, "with_sqft": 0}
            estimator_data[name]["total"] += 1
            if row.get("sqft") and row["sqft"] > 0:
                estimator_data[name]["with_sqft"] += 1

        # Build estimator compliance list
        by_estimator = []
        alerts = []

        for name, data in estimator_data.items():
            rate = (data["with_sqft"] / data["total"] * 100) if data["total"] > 0 else 0
            is_compliant = rate >= threshold

            by_estimator.append(EstimatorCompliance(
                estimator_name=name,
                total_quotes=data["total"],
                quotes_with_sqft=data["with_sqft"],
                compliance_rate=round(rate, 1),
                is_compliant=is_compliant,
            ))

            # Generate alerts for non-compliant estimators
            if not is_compliant:
                severity = "critical" if rate < 60 else "warning"
                alerts.append(ComplianceAlert(
                    estimator_name=name,
                    compliance_rate=round(rate, 1),
                    quotes_missing_sqft=data["total"] - data["with_sqft"],
                    severity=severity,
                ))

        # Sort by compliance rate (lowest first for visibility)
        by_estimator.sort(key=lambda x: x.compliance_rate)
        alerts.sort(key=lambda x: x.compliance_rate)

        return ComplianceMetrics(
            total_quotes=total_quotes,
            quotes_with_sqft=quotes_with_sqft,
            overall_compliance_rate=round(overall_rate, 1),
            threshold=threshold,
            is_meeting_target=overall_rate >= threshold,
            by_estimator=by_estimator,
            alerts=alerts,
            period_start=start_date,
            period_end=end_date,
        )

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/compliance/trend", response_model=List[ComplianceTrend])
async def get_compliance_trend(
    weeks: int = Query(12, ge=1, le=52),
):
    """
    Get weekly compliance trend for the past N weeks.
    """
    try:
        supabase = get_supabase_client()

        # Get data for past N weeks
        from datetime import datetime, timedelta
        end_date = datetime.now()
        start_date = end_date - timedelta(weeks=weeks)

        result = supabase.table("estimates").select(
            "sqft, created_at"
        ).gte("created_at", start_date.isoformat()).execute()

        rows = result.data or []

        # Group by week
        week_data = {}
        for row in rows:
            created = row.get("created_at", "")
            if created:
                dt = datetime.fromisoformat(created.replace("Z", "+00:00"))
                week_key = f"{dt.year}-W{dt.isocalendar()[1]:02d}"
                if week_key not in week_data:
                    week_data[week_key] = {"total": 0, "with_sqft": 0}
                week_data[week_key]["total"] += 1
                if row.get("sqft") and row["sqft"] > 0:
                    week_data[week_key]["with_sqft"] += 1

        # Build trend list
        trend = [
            ComplianceTrend(
                week=week,
                total_quotes=data["total"],
                quotes_with_sqft=data["with_sqft"],
                compliance_rate=round(
                    (data["with_sqft"] / data["total"] * 100) if data["total"] > 0 else 0,
                    1
                ),
            )
            for week, data in sorted(week_data.items())
        ]

        return trend

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

---

### Task 2: Create Frontend Types

**Files:**
- Create: `frontend/src/types/compliance.ts`

**Step 1: Define TypeScript types**

```typescript
// frontend/src/types/compliance.ts

export interface EstimatorCompliance {
  estimator_id?: string;
  estimator_name: string;
  total_quotes: number;
  quotes_with_sqft: number;
  compliance_rate: number;
  is_compliant: boolean;
}

export interface ComplianceAlert {
  estimator_name: string;
  compliance_rate: number;
  quotes_missing_sqft: number;
  severity: "warning" | "critical";
}

export interface ComplianceMetrics {
  total_quotes: number;
  quotes_with_sqft: number;
  overall_compliance_rate: number;
  threshold: number;
  is_meeting_target: boolean;
  by_estimator: EstimatorCompliance[];
  alerts: ComplianceAlert[];
  period_start?: string;
  period_end?: string;
}

export interface ComplianceTrend {
  week: string;
  compliance_rate: number;
  total_quotes: number;
  quotes_with_sqft: number;
}
```

---

### Task 3: Create API Hook

**Files:**
- Create: `frontend/src/lib/hooks/use-compliance.ts`

**Step 1: Create React Query hook**

```typescript
// frontend/src/lib/hooks/use-compliance.ts
"use client";

import { useQuery } from "@tanstack/react-query";
import { ComplianceMetrics, ComplianceTrend } from "@/types/compliance";

const API_URL = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8000";

export function useCompliance(startDate?: string, endDate?: string) {
  return useQuery<ComplianceMetrics>({
    queryKey: ["compliance", startDate, endDate],
    queryFn: async () => {
      const params = new URLSearchParams();
      if (startDate) params.set("start_date", startDate);
      if (endDate) params.set("end_date", endDate);

      const url = `${API_URL}/dashboard/compliance?${params}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("Failed to fetch compliance data");
      return res.json();
    },
  });
}

export function useComplianceTrend(weeks: number = 12) {
  return useQuery<ComplianceTrend[]>({
    queryKey: ["compliance-trend", weeks],
    queryFn: async () => {
      const url = `${API_URL}/dashboard/compliance/trend?weeks=${weeks}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("Failed to fetch compliance trend");
      return res.json();
    },
  });
}
```

---

### Task 4: Create Compliance Dashboard Components

**Files:**
- Create: `frontend/src/components/apercu/compliance-card.tsx`
- Create: `frontend/src/components/apercu/compliance-alerts.tsx`
- Create: `frontend/src/components/apercu/compliance-table.tsx`
- Create: `frontend/src/components/apercu/compliance-trend-chart.tsx`

**Step 1: Create compliance card**

```tsx
// frontend/src/components/apercu/compliance-card.tsx
"use client";

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Progress } from "@/components/ui/progress";
import { CheckCircle, AlertTriangle, XCircle } from "lucide-react";
import { ComplianceMetrics } from "@/types/compliance";

interface ComplianceCardProps {
  metrics: ComplianceMetrics;
}

export function ComplianceCard({ metrics }: ComplianceCardProps) {
  const rate = metrics.overall_compliance_rate;
  const Icon = rate >= 80 ? CheckCircle : rate >= 60 ? AlertTriangle : XCircle;
  const color = rate >= 80 ? "text-green-600" : rate >= 60 ? "text-amber-600" : "text-red-600";

  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between pb-2">
        <CardTitle className="text-sm font-medium">
          Conformite Superficie
        </CardTitle>
        <Icon className={`h-5 w-5 ${color}`} />
      </CardHeader>
      <CardContent>
        <div className="text-2xl font-bold">{rate.toFixed(1)}%</div>
        <Progress value={rate} className="mt-2" />
        <p className="text-xs text-muted-foreground mt-2">
          {metrics.quotes_with_sqft} / {metrics.total_quotes} soumissions avec superficie
        </p>
        <p className="text-xs text-muted-foreground">
          Objectif: {metrics.threshold}%
        </p>
      </CardContent>
    </Card>
  );
}
```

**Step 2: Create alerts component**

```tsx
// frontend/src/components/apercu/compliance-alerts.tsx
"use client";

import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { AlertTriangle, XCircle } from "lucide-react";
import { ComplianceAlert } from "@/types/compliance";

interface ComplianceAlertsProps {
  alerts: ComplianceAlert[];
}

export function ComplianceAlerts({ alerts }: ComplianceAlertsProps) {
  if (alerts.length === 0) return null;

  return (
    <div className="space-y-2">
      {alerts.map((alert, i) => (
        <Alert
          key={i}
          variant={alert.severity === "critical" ? "destructive" : "default"}
          className={alert.severity === "warning" ? "border-amber-500 bg-amber-50" : ""}
        >
          {alert.severity === "critical" ? (
            <XCircle className="h-4 w-4" />
          ) : (
            <AlertTriangle className="h-4 w-4 text-amber-600" />
          )}
          <AlertTitle>
            {alert.estimator_name}: {alert.compliance_rate.toFixed(1)}%
          </AlertTitle>
          <AlertDescription>
            {alert.quotes_missing_sqft} soumissions sans superficie
          </AlertDescription>
        </Alert>
      ))}
    </div>
  );
}
```

**Step 3: Create estimator table**

```tsx
// frontend/src/components/apercu/compliance-table.tsx
"use client";

import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { EstimatorCompliance } from "@/types/compliance";

interface ComplianceTableProps {
  estimators: EstimatorCompliance[];
}

export function ComplianceTable({ estimators }: ComplianceTableProps) {
  return (
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>Estimateur</TableHead>
          <TableHead className="text-right">Soumissions</TableHead>
          <TableHead className="text-right">Avec Superficie</TableHead>
          <TableHead className="text-right">Taux</TableHead>
          <TableHead>Status</TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {estimators.map((est, i) => (
          <TableRow key={i}>
            <TableCell className="font-medium">{est.estimator_name}</TableCell>
            <TableCell className="text-right">{est.total_quotes}</TableCell>
            <TableCell className="text-right">{est.quotes_with_sqft}</TableCell>
            <TableCell className="text-right">{est.compliance_rate.toFixed(1)}%</TableCell>
            <TableCell>
              <Badge variant={est.is_compliant ? "default" : "destructive"}>
                {est.is_compliant ? "Conforme" : "Non conforme"}
              </Badge>
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  );
}
```

**Step 4: Create trend chart**

```tsx
// frontend/src/components/apercu/compliance-trend-chart.tsx
"use client";

import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  ReferenceLine,
} from "recharts";
import { ComplianceTrend } from "@/types/compliance";

interface ComplianceTrendChartProps {
  data: ComplianceTrend[];
  threshold?: number;
}

export function ComplianceTrendChart({ data, threshold = 80 }: ComplianceTrendChartProps) {
  return (
    <ResponsiveContainer width="100%" height={300}>
      <LineChart data={data}>
        <CartesianGrid strokeDasharray="3 3" />
        <XAxis dataKey="week" tick={{ fontSize: 12 }} />
        <YAxis domain={[0, 100]} tick={{ fontSize: 12 }} />
        <Tooltip
          formatter={(value: number) => [`${value.toFixed(1)}%`, "Taux de conformite"]}
        />
        <ReferenceLine
          y={threshold}
          stroke="#22c55e"
          strokeDasharray="5 5"
          label={{ value: `Objectif ${threshold}%`, position: "right", fontSize: 12 }}
        />
        <Line
          type="monotone"
          dataKey="compliance_rate"
          stroke="#8B2323"
          strokeWidth={2}
          dot={{ fill: "#8B2323" }}
        />
      </LineChart>
    </ResponsiveContainer>
  );
}
```

---

### Task 5: Add Compliance Section to Dashboard

**Files:**
- Modify: `frontend/src/app/(admin)/apercu/page.tsx`

**Step 1: Add compliance section to apercu page**

Add below existing dashboard content:

```tsx
import { useCompliance, useComplianceTrend } from "@/lib/hooks/use-compliance";
import { ComplianceCard } from "@/components/apercu/compliance-card";
import { ComplianceAlerts } from "@/components/apercu/compliance-alerts";
import { ComplianceTable } from "@/components/apercu/compliance-table";
import { ComplianceTrendChart } from "@/components/apercu/compliance-trend-chart";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";

// Inside component:
const { data: compliance, isLoading: complianceLoading } = useCompliance();
const { data: complianceTrend } = useComplianceTrend(12);

// In JSX, add new section:
<section className="mt-8">
  <h2 className="text-xl font-semibold mb-4">Conformite des Donnees</h2>

  {compliance?.alerts && compliance.alerts.length > 0 && (
    <div className="mb-4">
      <ComplianceAlerts alerts={compliance.alerts} />
    </div>
  )}

  <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
    {compliance && <ComplianceCard metrics={compliance} />}
  </div>

  <div className="grid gap-4 mt-4 md:grid-cols-2">
    <Card>
      <CardHeader>
        <CardTitle>Tendance de Conformite (12 semaines)</CardTitle>
      </CardHeader>
      <CardContent>
        {complianceTrend && (
          <ComplianceTrendChart data={complianceTrend} threshold={80} />
        )}
      </CardContent>
    </Card>

    <Card>
      <CardHeader>
        <CardTitle>Conformite par Estimateur</CardTitle>
      </CardHeader>
      <CardContent>
        {compliance && <ComplianceTable estimators={compliance.by_estimator} />}
      </CardContent>
    </Card>
  </div>
</section>
```

---

### Task 6: Add French Translations

**Files:**
- Modify: `frontend/src/lib/i18n/fr.ts`

**Step 1: Add compliance translations**

```typescript
export const fr = {
  // ... existing
  compliance: {
    titre: "Conformite des Donnees",
    superficieConformite: "Conformite Superficie",
    objectif: "Objectif",
    conforme: "Conforme",
    nonConforme: "Non conforme",
    soumissionsSansSuperficie: "soumissions sans superficie",
    tendance: "Tendance de Conformite",
    parEstimateur: "Conformite par Estimateur",
    estimateur: "Estimateur",
    soumissions: "Soumissions",
    avecSuperficie: "Avec Superficie",
    taux: "Taux",
    status: "Status",
  },
  // ...
};
```

---

### Task 7: Verify and Test

**Step 1: Build verification**

```bash
cd backend && python -m pytest tests/ -v
cd frontend && npm run build
```

**Step 2: API test**

```bash
# Test compliance endpoint
curl http://localhost:8000/dashboard/compliance | jq '.overall_compliance_rate, .alerts'

# Test trend endpoint
curl http://localhost:8000/dashboard/compliance/trend?weeks=4 | jq '.'
```

**Step 3: Visual verification**

- Navigate to /apercu
- Verify "Conformite des Donnees" section appears
- Check compliance card shows percentage
- Verify alerts appear for non-compliant estimators
- Check trend chart shows 80% reference line

**Step 4: Commit**

```bash
git add -A
git commit -m "feat(compliance): add square footage compliance dashboard

- Add /dashboard/compliance endpoint with estimator breakdown
- Add /dashboard/compliance/trend for weekly trend data
- Create compliance card, alerts, table, and trend chart components
- Add alerts for estimators below 80% compliance threshold
- Integrate into Apercu dashboard page

Closes: Laurent feedback issue #1"
```

---

## Success Criteria

- [ ] GET /dashboard/compliance returns overall and per-estimator compliance rates
- [ ] GET /dashboard/compliance/trend returns weekly compliance data
- [ ] Compliance card shows current rate with progress bar
- [ ] Alerts appear for estimators below 80% threshold
- [ ] Estimator table shows all estimators ranked by compliance
- [ ] Trend chart shows 12-week history with 80% reference line
- [ ] Build passes for both frontend and backend
