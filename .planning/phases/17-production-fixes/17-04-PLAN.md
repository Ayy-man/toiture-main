---
phase: 17-production-fixes
plan: 04
type: feature
wave: 4
depends_on: ["17-01"]
autonomous: true

files_modified:
  - frontend/src/components/estimateur/materials-form.tsx

must_haves:
  truths:
    - "Matériaux tab shows actual prediction form"
    - "Form submits to /estimate/materials"
    - "Results display as material table"
  artifacts:
    - path: "frontend/src/components/estimateur/materials-form.tsx"
      provides: "Material prediction form and results display"
  key_links:
    - from: "Materials form"
      to: "/estimate/materials"
      via: "POST fetch"
---

<objective>
Replace the Matériaux tab placeholder with a real material prediction form.

Purpose: The backend /estimate/materials endpoint exists and works, but the frontend shows "Bientôt disponible - Phase 10".

Output: Working materials prediction form that displays predicted materials as a table.
</objective>

<context>
@.planning/phases/17-production-fixes/17-RESEARCH.md
@backend/app/routers/estimate.py
@backend/app/schemas/materials.py
@frontend/src/components/estimateur/materials-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify Backend Endpoint</name>
  <action>
Confirm the materials endpoint works:

```bash
curl -X POST https://toiture-main-production-d6a5.up.railway.app/estimate/materials \
  -H "Content-Type: application/json" \
  -d '{
    "sqft": 2500,
    "job_category": "Shingle",
    "complexity_score": 50,
    "has_chimney": true,
    "has_skylight": false
  }' | jq .
```

Expected response format:
```json
{
  "materials": [
    {
      "material_id": "string",
      "quantity": number,
      "unit_price": number,
      "total": number
    }
  ],
  "total_cost": number
}
```

Document the actual response schema for Task 2.
  </action>
  <done>
    - Endpoint confirmed working
    - Response schema documented
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace Placeholder with Form</name>
  <files>
    frontend/src/components/estimateur/materials-form.tsx
  </files>
  <action>
Replace the placeholder content with an actual form:

**Form Inputs:**
- sqft: number input (required, min 100, max 100000)
- job_category: dropdown (Shingle, Elastomere, Other, Service)
- complexity_score: slider (1-100)
- has_chimney: switch/toggle
- has_skylight: switch/toggle

**Submit Handler:**
```typescript
const onSubmit = async (data: MaterialsFormData) => {
  setLoading(true);
  try {
    const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/estimate/materials`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });
    const result = await response.json();
    setMaterials(result.materials);
    setTotalCost(result.total_cost);
  } catch (error) {
    setError('Erreur lors de la prédiction');
  } finally {
    setLoading(false);
  }
};
```

**Results Display:**
- Table with columns: Material ID | Quantité | Prix unitaire | Total
- Total row at bottom showing total_cost
- Loading state while fetching
- Error state if request fails

Use existing UI components (Card, Button, Input, Select, Switch, Slider, Table).
  </action>
  <verify>
```bash
cd frontend && pnpm run build
```
Should build without TypeScript errors.
  </verify>
  <done>
    - Placeholder replaced with form
    - Form inputs match backend schema
    - Results table displays materials
    - Build passes
  </done>
</task>

<task type="auto">
  <name>Task 3: Add French Labels</name>
  <files>
    frontend/src/lib/i18n/fr.ts
    frontend/src/lib/i18n/en.ts
  </files>
  <action>
Add translations for materials form:

**French (fr.ts):**
```typescript
materials: {
  title: "Prédiction des Matériaux",
  sqft: "Superficie (pi²)",
  category: "Catégorie de travaux",
  complexity: "Score de complexité",
  hasChimney: "Présence de cheminée",
  hasSkylight: "Présence de puits de lumière",
  submit: "Calculer les matériaux",
  results: "Matériaux prédits",
  materialId: "ID Matériau",
  quantity: "Quantité",
  unitPrice: "Prix unitaire",
  total: "Total",
  totalCost: "Coût total des matériaux",
  loading: "Calcul en cours...",
  error: "Erreur lors de la prédiction"
}
```

**English (en.ts):**
```typescript
materials: {
  title: "Material Prediction",
  sqft: "Square Footage",
  category: "Job Category",
  complexity: "Complexity Score",
  hasChimney: "Has Chimney",
  hasSkylight: "Has Skylight",
  submit: "Calculate Materials",
  results: "Predicted Materials",
  materialId: "Material ID",
  quantity: "Quantity",
  unitPrice: "Unit Price",
  total: "Total",
  totalCost: "Total Materials Cost",
  loading: "Calculating...",
  error: "Prediction error"
}
```
  </action>
  <done>
    - French translations added
    - English translations added
    - Form uses useLanguage hook
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Replaced Matériaux tab placeholder with working material prediction form.
  </what-built>
  <how-to-verify>
    1. Go to Estimateur → Matériaux tab
    2. Fill in the form:
       - Superficie: 2500
       - Catégorie: Bardeaux
       - Complexité: 50
       - Cheminée: Oui
       - Puits de lumière: Non
    3. Click "Calculer les matériaux"
    4. Verify you see a table of predicted materials with quantities and prices
    5. Verify the total cost is shown at the bottom
  </how-to-verify>
  <resume-signal>Type "approved" if materials prediction works, or describe what's broken</resume-signal>
</task>

</tasks>

<verification>
- [ ] Matériaux tab no longer shows placeholder
- [ ] Form has all 5 inputs
- [ ] Form submits to /estimate/materials
- [ ] Results display as table
- [ ] Total cost shown at bottom
- [ ] French labels used
- [ ] Build passes
</verification>

<success_criteria>
1. Matériaux tab shows functional form
2. Form submission returns material predictions
3. Results displayed clearly with totals
4. Fully translated to French
</success_criteria>

<output>
After completion, create `.planning/phases/17-production-fixes/17-04-SUMMARY.md`
</output>
