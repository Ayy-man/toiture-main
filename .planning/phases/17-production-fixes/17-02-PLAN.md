---
phase: 17-production-fixes
plan: 02
type: debug
wave: 2
depends_on: ["17-01"]
autonomous: true

files_modified:
  - backend/app/routers/dashboard.py
  - backend/Dockerfile

must_haves:
  truths:
    - "/dashboard/metrics returns 200 with JSON"
    - "/dashboard/charts returns 200 with JSON"
    - "Aperçu page shows real KPI data"
  key_links:
    - from: "Frontend Aperçu page"
      to: "/dashboard/metrics"
      via: "fetch"
    - from: "Frontend Aperçu page"
      to: "/dashboard/charts"
      via: "fetch"
---

<objective>
Fix Dashboard 500 errors on /dashboard/metrics and /dashboard/charts endpoints.

Purpose: These endpoints power the Aperçu (Overview) page. Currently returning 500 Internal Server Error.

Output: Both endpoints return 200 with valid JSON data.
</objective>

<context>
@.planning/phases/17-production-fixes/17-RESEARCH.md
@backend/app/routers/dashboard.py
@backend/Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Get Railway Error Logs</name>
  <action>
Check Railway deployment logs for the actual Python traceback:

```bash
cd backend
railway logs --tail 100 2>&1 | grep -A 20 "Error\|Traceback\|500"
```

Or via Railway dashboard:
1. Go to Railway project
2. Click on the service
3. View Logs tab
4. Look for Python traceback when /dashboard/* is called

Also test the endpoints directly:
```bash
curl -v https://toiture-main-production-d6a5.up.railway.app/dashboard/metrics
curl -v https://toiture-main-production-d6a5.up.railway.app/dashboard/charts
```
  </action>
  <done>
    - Error traceback captured
    - Root cause identified
  </done>
</task>

<task type="auto">
  <name>Task 2: Check Data Files in Docker Image</name>
  <files>
    backend/Dockerfile
  </files>
  <action>
Verify data files are included in Docker build:

```bash
# Check if data files exist locally
ls -la backend/app/data/
ls -la backend/app/models/

# Check Dockerfile COPY statements
grep -n "COPY" backend/Dockerfile
```

Common missing files:
- cbr_cases.json (CBR cases for dashboard)
- master_quotes_valid.csv (historical quotes)
- *.pkl model files

If files are missing from Docker image, update Dockerfile:
```dockerfile
# Add data files
COPY app/data/ app/data/
```
  </action>
  <done>
    - Data files verified in Docker image
    - Or Dockerfile updated to include them
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix Root Cause</name>
  <files>
    backend/app/routers/dashboard.py
  </files>
  <action>
Based on the error from Task 1, fix the root cause.

Common fixes:

**If file not found:**
```python
# Add fallback for missing data
import os
data_path = os.path.join(os.path.dirname(__file__), '..', 'data', 'file.json')
if not os.path.exists(data_path):
    return {"error": "Data not available", "data": []}
```

**If division by zero:**
```python
# Add zero check
avg = total / count if count > 0 else 0
```

**If field name mismatch:**
```python
# Check actual field names in data
# Update code to match
```

**If missing dependency:**
```bash
# Check if all deps are in requirements.txt
pip freeze | grep <package>
```
  </action>
  <done>
    - Root cause fixed in code
    - Changes committed
  </done>
</task>

<task type="auto">
  <name>Task 4: Redeploy to Railway</name>
  <action>
```bash
cd backend
railway up
```

Wait for deployment to complete (may take 3-5 minutes due to ML model loading).
  </action>
  <verify>
```bash
# Test both endpoints
curl -s https://toiture-main-production-d6a5.up.railway.app/dashboard/metrics | jq .
curl -s https://toiture-main-production-d6a5.up.railway.app/dashboard/charts | jq .
```
Expected: JSON with actual data, not 500 error
  </verify>
  <done>
    - Railway deployment successful
    - /dashboard/metrics returns 200
    - /dashboard/charts returns 200
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Fixed Dashboard API endpoints that were returning 500 errors.
  </what-built>
  <how-to-verify>
    1. Visit the Vercel frontend
    2. Log in with the password
    3. Go to the Aperçu tab
    4. Verify you see:
       - KPI cards with real numbers (not errors)
       - Charts with actual data
       - No loading spinners stuck
  </how-to-verify>
  <resume-signal>Type "approved" if Aperçu page shows data, or describe what's still broken</resume-signal>
</task>

</tasks>

<verification>
- [ ] Railway logs show no 500 errors
- [ ] /dashboard/metrics returns 200 with JSON
- [ ] /dashboard/charts returns 200 with JSON
- [ ] Aperçu page displays KPI cards
- [ ] Aperçu page displays charts
</verification>

<success_criteria>
1. Both dashboard endpoints return 200 OK
2. Response contains valid JSON with numeric data
3. Aperçu page renders without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-production-fixes/17-02-SUMMARY.md`
</output>
