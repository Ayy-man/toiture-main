---
phase: 17-production-fixes
plan: 03
type: debug
wave: 3
depends_on: ["17-01", "17-02"]
autonomous: true

files_modified:
  - backend/app/routers/quotes.py
  - backend/app/routers/customers.py

must_haves:
  truths:
    - "/quotes?page=1&limit=10 returns quote data"
    - "/customers returns customer data"
    - "Historique page shows paginated quotes"
    - "Clients page shows searchable customers"
---

<objective>
Fix Historique and Clients pages if still broken after Steps 1-2.

Purpose: These pages may be fixed by the mixed content and dashboard fixes. If not, debug and fix.

Output: Both pages display real data from the database.
</objective>

<context>
@.planning/phases/17-production-fixes/17-RESEARCH.md
@.planning/phases/17-production-fixes/17-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test Endpoints Directly</name>
  <action>
After 17-01 and 17-02 are complete, test the endpoints:

```bash
# Test quotes endpoint
curl -s "https://toiture-main-production-d6a5.up.railway.app/quotes?page=1&limit=10" | jq .

# Test customers endpoint
curl -s "https://toiture-main-production-d6a5.up.railway.app/customers" | jq .
```

Check response:
- If 200 with data → frontend parsing bug (Task 3)
- If 200 with empty array → data loading issue (Task 2)
- If 500 error → same class of bug as 17-02 (Task 2)
  </action>
  <done>
    - Endpoint status documented
    - Issue type identified
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix Backend if Endpoints Fail</name>
  <files>
    backend/app/routers/quotes.py
    backend/app/routers/customers.py
  </files>
  <action>
If endpoints return 500 or empty:

1. Check Railway logs for traceback:
```bash
railway logs --tail 100 | grep -A 10 "quotes\|customers"
```

2. Common issues:
   - Data file not in Docker image
   - Database connection issue
   - Field name mismatch with CSV/data source

3. Fix the issue in the router file

4. Redeploy:
```bash
railway up
```
  </action>
  <verify>
```bash
curl -s "https://toiture-main-production-d6a5.up.railway.app/quotes?page=1&limit=10" | jq 'length'
curl -s "https://toiture-main-production-d6a5.up.railway.app/customers" | jq 'length'
```
Expected: Non-zero numbers
  </verify>
  <done>
    - Backend endpoints return data
    - Or issue documented for frontend fix
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix Frontend if Endpoints Work</name>
  <files>
    frontend/src/app/(admin)/historique/page.tsx
    frontend/src/app/(admin)/clients/page.tsx
  </files>
  <action>
If endpoints return data but pages are empty:

1. Check browser console for JavaScript errors
2. Check network tab - are requests being made?
3. Check response parsing - field name mismatches?

Common frontend fixes:
- API URL construction (should use NEXT_PUBLIC_API_URL)
- Response field names (backend returns `items` vs frontend expects `data`)
- Pagination handling
  </action>
  <done>
    - Frontend correctly displays data from endpoints
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Fixed Historique and Clients pages to display real data.
  </what-built>
  <how-to-verify>
    1. Go to Historique tab
    2. Verify you see a table of quotes with pagination
    3. Try filtering/searching
    4. Go to Clients tab
    5. Verify you see a list of customers
    6. Try the search functionality
  </how-to-verify>
  <resume-signal>Type "approved" if both pages work, or describe what's broken</resume-signal>
</task>

</tasks>

<verification>
- [ ] /quotes endpoint returns 200 with quote data
- [ ] /customers endpoint returns 200 with customer data
- [ ] Historique page shows paginated quotes table
- [ ] Clients page shows searchable customer list
- [ ] No console errors on either page
</verification>

<success_criteria>
1. Both backend endpoints return valid data
2. Historique page displays quotes with pagination
3. Clients page displays customers with search
</success_criteria>

<output>
After completion, create `.planning/phases/17-production-fixes/17-03-SUMMARY.md`
</output>
