---
phase: 17-production-fixes
plan: 06
type: feature
wave: 4
depends_on: ["17-01"]
autonomous: true

files_modified:
  - frontend/src/components/estimateur/estimate-result.tsx
  - frontend/src/components/estimateur/full-quote-result.tsx
  - frontend/src/components/estimateur/feedback-panel.tsx
  - backend/app/routers/feedback.py
  - backend/app/schemas/feedback.py

must_haves:
  truths:
    - "üëç/üëé buttons appear on Prix tab results"
    - "üëç/üëé buttons appear on Soumission Compl√®te tab results"
    - "Feedback POST stores in Supabase cortex_feedback table"
  artifacts:
    - path: "frontend/src/components/estimateur/feedback-panel.tsx"
      provides: "Reusable feedback UI component"
  key_links:
    - from: "Feedback panel"
      to: "/feedback"
      via: "POST fetch"
    - from: "Backend /feedback"
      to: "Supabase cortex_feedback"
      via: "insert"
---

<objective>
Add feedback collection (üëç/üëé) to all estimate results.

Purpose: Collect user feedback on estimate accuracy to improve the model over time.

Output: Users can rate estimates and optionally provide actual price and reason.
</objective>

<context>
@.planning/phases/17-production-fixes/17-RESEARCH.md
@backend/app/routers/feedback.py
@frontend/src/components/estimateur/estimate-result.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Check Existing Feedback Endpoint</name>
  <action>
Check if /feedback endpoint already exists:

```bash
# Check backend routes
grep -r "feedback" backend/app/routers/

# Test endpoint
curl -X POST https://toiture-main-production-d6a5.up.railway.app/feedback \
  -H "Content-Type: application/json" \
  -d '{"test": true}' -v
```

If endpoint exists, document the expected schema.
If not, create it in Task 2.
  </action>
  <done>
    - Feedback endpoint status documented
  </done>
</task>

<task type="auto">
  <name>Task 2: Create/Update Feedback Endpoint</name>
  <files>
    backend/app/schemas/feedback.py
    backend/app/routers/feedback.py
  </files>
  <action>
Create or update the feedback endpoint:

**Schema (feedback.py):**
```python
from pydantic import BaseModel
from typing import Optional, List, Literal
from datetime import datetime
import uuid

class FeedbackRequest(BaseModel):
    estimate_id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    input_params: dict
    predicted_price: float
    predicted_materials: Optional[List[dict]] = None
    feedback: Literal["positive", "negative"]
    actual_price: Optional[float] = None
    reason: Optional[str] = None
    timestamp: datetime = Field(default_factory=datetime.utcnow)

class FeedbackResponse(BaseModel):
    success: bool
    message: str
```

**Router (feedback.py):**
```python
from fastapi import APIRouter, HTTPException
from app.schemas.feedback import FeedbackRequest, FeedbackResponse
from app.config import settings
from supabase import create_client

router = APIRouter(prefix="/feedback", tags=["feedback"])

@router.post("", response_model=FeedbackResponse)
async def submit_feedback(feedback: FeedbackRequest):
    try:
        supabase = create_client(settings.supabase_url, settings.supabase_service_key)

        # Insert into cortex_feedback table
        data = feedback.model_dump()
        data["timestamp"] = data["timestamp"].isoformat()

        result = supabase.table("cortex_feedback").insert(data).execute()

        return FeedbackResponse(success=True, message="Feedback recorded")
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

Register router in main.py if not already done.
  </action>
  <verify>
```bash
curl -X POST https://toiture-main-production-d6a5.up.railway.app/feedback \
  -H "Content-Type: application/json" \
  -d '{
    "input_params": {"sqft": 2500, "category": "Shingle"},
    "predicted_price": 15000,
    "feedback": "positive"
  }'
```
Expected: {"success": true, "message": "Feedback recorded"}
  </verify>
  <done>
    - Feedback endpoint created/updated
    - Stores data in Supabase
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Supabase Table (if needed)</name>
  <action>
Check if cortex_feedback table exists in Supabase.

If not, create it via Supabase dashboard or SQL:

```sql
CREATE TABLE cortex_feedback (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    estimate_id TEXT NOT NULL,
    input_params JSONB NOT NULL,
    predicted_price NUMERIC NOT NULL,
    predicted_materials JSONB,
    feedback TEXT NOT NULL CHECK (feedback IN ('positive', 'negative')),
    actual_price NUMERIC,
    reason TEXT,
    timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Index for querying by feedback type
CREATE INDEX idx_cortex_feedback_feedback ON cortex_feedback(feedback);
CREATE INDEX idx_cortex_feedback_timestamp ON cortex_feedback(timestamp);
```
  </action>
  <done>
    - cortex_feedback table exists in Supabase
  </done>
</task>

<task type="auto">
  <name>Task 4: Create FeedbackPanel Component</name>
  <files>
    frontend/src/components/estimateur/feedback-panel.tsx
  </files>
  <action>
Create a reusable feedback panel component:

```typescript
"use client";

import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { ThumbsUp, ThumbsDown, Send } from "lucide-react";
import { useLanguage } from "@/lib/i18n";

interface FeedbackPanelProps {
  estimateId: string;
  inputParams: Record<string, unknown>;
  predictedPrice: number;
  predictedMaterials?: Array<Record<string, unknown>> | null;
}

export function FeedbackPanel({
  estimateId,
  inputParams,
  predictedPrice,
  predictedMaterials,
}: FeedbackPanelProps) {
  const { t } = useLanguage();
  const [selectedFeedback, setSelectedFeedback] = useState<"positive" | "negative" | null>(null);
  const [actualPrice, setActualPrice] = useState("");
  const [reason, setReason] = useState("");
  const [submitted, setSubmitted] = useState(false);
  const [loading, setLoading] = useState(false);

  const handleSubmit = async () => {
    if (!selectedFeedback) return;

    setLoading(true);
    try {
      const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/feedback`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          estimate_id: estimateId,
          input_params: inputParams,
          predicted_price: predictedPrice,
          predicted_materials: predictedMaterials,
          feedback: selectedFeedback,
          actual_price: actualPrice ? parseFloat(actualPrice) : null,
          reason: reason || null,
          timestamp: new Date().toISOString(),
        }),
      });

      if (response.ok) {
        setSubmitted(true);
      }
    } catch (error) {
      console.error("Feedback error:", error);
    } finally {
      setLoading(false);
    }
  };

  if (submitted) {
    return (
      <div className="text-center py-4 text-green-600 font-medium">
        {t.feedback.thanks}
      </div>
    );
  }

  return (
    <div className="border-t pt-4 mt-4">
      <p className="text-sm text-muted-foreground mb-3">{t.feedback.question}</p>

      <div className="flex gap-3 mb-4">
        <Button
          variant={selectedFeedback === "positive" ? "default" : "outline"}
          size="lg"
          onClick={() => setSelectedFeedback("positive")}
        >
          <ThumbsUp className="mr-2 h-5 w-5" />
          {t.feedback.accurate}
        </Button>
        <Button
          variant={selectedFeedback === "negative" ? "destructive" : "outline"}
          size="lg"
          onClick={() => setSelectedFeedback("negative")}
        >
          <ThumbsDown className="mr-2 h-5 w-5" />
          {t.feedback.inaccurate}
        </Button>
      </div>

      {selectedFeedback && (
        <div className="space-y-3">
          <div>
            <label className="text-sm font-medium">
              {t.feedback.actualPrice}
              {selectedFeedback === "negative" && " *"}
            </label>
            <Input
              type="number"
              placeholder="$"
              value={actualPrice}
              onChange={(e) => setActualPrice(e.target.value)}
              required={selectedFeedback === "negative"}
            />
          </div>

          {selectedFeedback === "negative" && (
            <div>
              <label className="text-sm font-medium">{t.feedback.reason} *</label>
              <Textarea
                placeholder={t.feedback.reasonPlaceholder}
                value={reason}
                onChange={(e) => setReason(e.target.value)}
                required
              />
            </div>
          )}

          <Button
            onClick={handleSubmit}
            disabled={loading || (selectedFeedback === "negative" && (!actualPrice || !reason))}
          >
            <Send className="mr-2 h-4 w-4" />
            {loading ? t.feedback.submitting : t.feedback.submit}
          </Button>
        </div>
      )}
    </div>
  );
}
```
  </action>
  <done>
    - FeedbackPanel component created
  </done>
</task>

<task type="auto">
  <name>Task 5: Add Feedback to Estimate Results</name>
  <files>
    frontend/src/components/estimateur/estimate-result.tsx
    frontend/src/components/estimateur/full-quote-result.tsx
  </files>
  <action>
Add FeedbackPanel to both result components:

**estimate-result.tsx (Prix tab):**
```typescript
import { FeedbackPanel } from "./feedback-panel";
import { v4 as uuidv4 } from "uuid";

// Inside the component, after displaying results:
<FeedbackPanel
  estimateId={estimateId || uuidv4()}
  inputParams={formData}
  predictedPrice={result.estimate}
  predictedMaterials={null}
/>
```

**full-quote-result.tsx (Soumission Compl√®te tab):**
```typescript
import { FeedbackPanel } from "./feedback-panel";

// Inside the component, after displaying results:
<FeedbackPanel
  estimateId={estimateId || uuidv4()}
  inputParams={formData}
  predictedPrice={result.total_price}
  predictedMaterials={result.materials}
/>
```

Generate estimate_id when the estimate is created (before displaying results).
  </action>
  <done>
    - FeedbackPanel added to Prix tab results
    - FeedbackPanel added to Soumission Compl√®te tab results
  </done>
</task>

<task type="auto">
  <name>Task 6: Add Translations</name>
  <files>
    frontend/src/lib/i18n/fr.ts
    frontend/src/lib/i18n/en.ts
  </files>
  <action>
Add feedback translations:

**French:**
```typescript
feedback: {
  question: "Cette estimation √©tait-elle utile?",
  accurate: "Pr√©cise",
  inaccurate: "Impr√©cise",
  actualPrice: "Quel √©tait le vrai prix?",
  reason: "Pourquoi?",
  reasonPlaceholder: "Expliquez pourquoi l'estimation √©tait impr√©cise...",
  submit: "Soumettre",
  submitting: "Envoi...",
  thanks: "Merci pour votre retour!"
}
```

**English:**
```typescript
feedback: {
  question: "Was this estimate helpful?",
  accurate: "Accurate",
  inaccurate: "Inaccurate",
  actualPrice: "What was the actual price?",
  reason: "Why?",
  reasonPlaceholder: "Explain why the estimate was inaccurate...",
  submit: "Submit",
  submitting: "Submitting...",
  thanks: "Thank you for your feedback!"
}
```
  </action>
  <done>
    - Translations added for both languages
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Feedback collection system with üëç/üëé buttons on all estimate results.
  </what-built>
  <how-to-verify>
    1. Go to Estimateur ‚Üí Prix tab
    2. Submit an estimate
    3. Verify üëç/üëé buttons appear below the result
    4. Click üëç - verify optional price input appears
    5. Click üëé - verify required price and reason inputs appear
    6. Submit feedback
    7. Verify "Merci!" confirmation appears
    8. Check Supabase cortex_feedback table for the new row
    9. Repeat for Soumission Compl√®te tab
  </how-to-verify>
  <resume-signal>Type "approved" if feedback works on both tabs, or describe what's broken</resume-signal>
</task>

</tasks>

<verification>
- [ ] /feedback endpoint accepts POST requests
- [ ] Supabase cortex_feedback table exists
- [ ] üëç/üëé buttons appear on Prix tab results
- [ ] üëç/üëé buttons appear on Soumission Compl√®te tab results
- [ ] Positive feedback shows optional price input
- [ ] Negative feedback requires price and reason
- [ ] Feedback successfully stored in Supabase
- [ ] "Merci!" confirmation shown after submit
</verification>

<success_criteria>
1. Users can rate every estimate
2. Feedback stored in Supabase for later analysis
3. French UI throughout
</success_criteria>

<output>
After completion, create `.planning/phases/17-production-fixes/17-06-SUMMARY.md`
</output>
