---
phase: 17-production-fixes
plan: 05
type: improvement
wave: 4
depends_on: ["17-01"]
autonomous: true

files_modified:
  - backend/app/services/pinecone_cbr.py

must_haves:
  truths:
    - "Similar cases for 1500 sqft return jobs in 750-3000 sqft range"
    - "Pinecone query includes sqft metadata filter"
    - "Results are relevant to input parameters"
---

<objective>
Add square footage filtering to Pinecone similar case queries.

Purpose: A 1500 sqft bardeaux query currently returns five 138 sqft jobs, which is useless for comparison.

Output: Similar cases are filtered to 0.5x-2x the input sqft value.
</objective>

<context>
@.planning/phases/17-production-fixes/17-RESEARCH.md
@backend/app/services/pinecone_cbr.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Check Current Pinecone Query</name>
  <files>
    backend/app/services/pinecone_cbr.py
  </files>
  <action>
Read the current query implementation:

```bash
cat backend/app/services/pinecone_cbr.py
```

Identify:
1. How is the query vector constructed?
2. Is there any metadata filtering?
3. What metadata is stored with each vector?

Check Pinecone index metadata schema:
```python
# In the code, look for upsert calls to see what metadata is stored
# metadata={"sqft": ..., "category": ..., etc}
```
  </action>
  <done>
    - Current query logic documented
    - Metadata schema identified
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify sqft in Pinecone Metadata</name>
  <action>
Test if sqft is already stored in Pinecone metadata:

```bash
# Use Python to query Pinecone and check metadata
python -c "
from pinecone import Pinecone
import os

pc = Pinecone(api_key=os.environ['PINECONE_API_KEY'])
index = pc.Index(host=os.environ['PINECONE_INDEX_HOST'])

# Fetch a sample vector
results = index.query(
    vector=[0.0] * 384,  # dummy vector
    top_k=1,
    include_metadata=True
)
print(results.matches[0].metadata if results.matches else 'No results')
"
```

If sqft is NOT in metadata, proceed to Task 3a.
If sqft IS in metadata, proceed to Task 3b.
  </action>
  <done>
    - Confirmed whether sqft is in Pinecone metadata
  </done>
</task>

<task type="auto">
  <name>Task 3a: Add sqft to Pinecone Metadata (if missing)</name>
  <files>
    backend/app/services/pinecone_cbr.py
  </files>
  <action>
If sqft is not in metadata, need to re-upsert all 8,132 vectors with sqft metadata.

1. Find the original embedding generation script
2. Add sqft to metadata during upsert:

```python
# When upserting vectors
index.upsert(vectors=[
    {
        "id": case_id,
        "values": embedding,
        "metadata": {
            "sqft": case["sqft"],
            "category": case["category"],
            # ... other fields
        }
    }
])
```

3. Run the upsert script to update all vectors

This may take several minutes for 8,132 vectors.
  </action>
  <done>
    - sqft added to all Pinecone vector metadata
  </done>
</task>

<task type="auto">
  <name>Task 3b: Add sqft Filter to Query</name>
  <files>
    backend/app/services/pinecone_cbr.py
  </files>
  <action>
Add metadata filter to the Pinecone query:

```python
def query_similar_cases(self, sqft: float, category: str, ..., top_k: int = 5):
    # Calculate sqft range: 0.5x to 2x input
    sqft_min = sqft * 0.5
    sqft_max = sqft * 2.0

    # Build query with metadata filter
    results = self.index.query(
        vector=query_embedding,
        top_k=top_k,
        include_metadata=True,
        filter={
            "sqft": {
                "$gte": sqft_min,
                "$lte": sqft_max
            }
        }
    )

    return results.matches
```

Pinecone filter operators:
- `$eq`: equal
- `$ne`: not equal
- `$gt`: greater than
- `$gte`: greater than or equal
- `$lt`: less than
- `$lte`: less than or equal
- `$in`: in array
  </action>
  <verify>
```bash
cd backend && python -c "
from app.services.pinecone_cbr import PineconeCBR
cbr = PineconeCBR()
results = cbr.query_similar_cases(sqft=1500, category='Shingle', ...)
for r in results:
    print(f'sqft: {r.metadata.get(\"sqft\")}, category: {r.metadata.get(\"category\")}')
"
```
All sqft values should be between 750 and 3000.
  </verify>
  <done>
    - sqft filter added to query
    - Local test confirms filter works
  </done>
</task>

<task type="auto">
  <name>Task 4: Deploy and Verify</name>
  <action>
```bash
cd backend
railway up
```

Test the production endpoint:
```bash
curl -X POST https://toiture-main-production-d6a5.up.railway.app/estimate \
  -H "Content-Type: application/json" \
  -d '{
    "sqft": 1500,
    "category": "Shingle",
    "material_lines": 10,
    "labor_lines": 5,
    "has_subs": false,
    "complexity": 50
  }' | jq '.similar_cases[].sqft'
```

All returned sqft values should be between 750 and 3000.
  </action>
  <verify>
Verify no results are outside the 0.5x-2x range.
  </verify>
  <done>
    - Deployed to Railway
    - Production endpoint returns relevant similar cases
  </done>
</task>

</tasks>

<verification>
- [ ] sqft is available in Pinecone metadata
- [ ] Query includes sqft filter (0.5x to 2x range)
- [ ] 1500 sqft query returns cases in 750-3000 sqft range
- [ ] No 138 sqft jobs returned for 1500 sqft query
- [ ] Deployed to production
</verification>

<success_criteria>
1. Similar cases are filtered by sqft range
2. Results are relevant to input parameters
3. No wildly different sqft values in similar cases
</success_criteria>

<output>
After completion, create `.planning/phases/17-production-fixes/17-05-SUMMARY.md`
</output>
