---
phase: 20-materials-database-import
plan: 03
type: execute
wave: 2
depends_on: ["20-01", "20-02"]
files_modified:
  - frontend/src/components/ui/popover.tsx
  - frontend/src/components/ui/command.tsx
  - frontend/src/components/estimateur/material-selector.tsx
  - frontend/src/components/estimateur/materials-form.tsx
  - frontend/src/lib/api/materials.ts
  - frontend/src/lib/i18n/fr.ts
  - frontend/src/lib/i18n/en.ts
autonomous: true

must_haves:
  truths:
    - "User can search materials by name in a dropdown and see matching results"
    - "User can select multiple materials from the dropdown"
    - "Selected materials display with name, category, and price"
    - "User can remove selected materials"
    - "User can add a custom material not in the database"
    - "Material count auto-updates based on selections (replaces manual material_lines input)"
    - "Category filter narrows material search results"
    - "All UI labels available in both French and English"
  artifacts:
    - path: "frontend/src/components/estimateur/material-selector.tsx"
      provides: "Searchable multi-select material picker component"
      contains: "MaterialSelector"
    - path: "frontend/src/lib/api/materials.ts"
      provides: "API client for material search and categories"
      contains: "searchMaterials"
    - path: "frontend/src/components/ui/command.tsx"
      provides: "shadcn Command component (cmdk-based)"
      contains: "Command"
    - path: "frontend/src/components/ui/popover.tsx"
      provides: "shadcn Popover component"
      contains: "Popover"
  key_links:
    - from: "frontend/src/components/estimateur/material-selector.tsx"
      to: "frontend/src/lib/api/materials.ts"
      via: "searchMaterials() fetch call"
      pattern: "searchMaterials"
    - from: "frontend/src/lib/api/materials.ts"
      to: "GET /materials/search"
      via: "fetch to backend API"
      pattern: "materials/search"
    - from: "frontend/src/components/estimateur/materials-form.tsx"
      to: "frontend/src/components/estimateur/material-selector.tsx"
      via: "MaterialSelector component usage"
      pattern: "<MaterialSelector"
---

<objective>
Build the frontend material selector UI replacing the manual "material_lines" number input with a searchable multi-select dropdown backed by the materials search API.

Purpose: Users pick specific materials from Laurent's database instead of guessing a line count. This makes estimates more accurate and gives Laurent visibility into what materials estimators are selecting.
Output: MaterialSelector component integrated into materials-form.tsx with search, multi-select, category filter, custom material entry, and auto line-count.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-materials-database-import/20-RESEARCH.md
@.planning/phases/20-materials-database-import/20-02-SUMMARY.md
@frontend/src/components/estimateur/materials-form.tsx
@frontend/src/lib/i18n/fr.ts
@frontend/src/lib/i18n/en.ts
@frontend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn Command + Popover and create material API client</name>
  <files>
    frontend/src/components/ui/popover.tsx
    frontend/src/components/ui/command.tsx
    frontend/src/lib/api/materials.ts
  </files>
  <action>
    1. Install shadcn/ui components needed for Combobox:
       - Run `cd frontend && pnpm dlx shadcn@latest add popover command` from the frontend directory
       - This installs @radix-ui/react-popover and cmdk as dependencies and generates:
         - `src/components/ui/popover.tsx`
         - `src/components/ui/command.tsx`
       - If the shadcn CLI hangs or fails (known issue from Phase 11), manually:
         a. `pnpm add @radix-ui/react-popover cmdk` in frontend/
         b. Create popover.tsx and command.tsx manually following shadcn/ui v4 source code

    2. Create `frontend/src/lib/api/materials.ts`:

       ```typescript
       // Material types matching backend MaterialItem schema
       export interface MaterialItem {
         id: number;
         code: string | null;
         name: string;
         cost: number | null;
         sell_price: number | null;
         unit: string;
         category: string | null;
         supplier: string | null;
         note: string | null;
         area_sqft: number;
         length_ft: number;
         width_ft: number;
         thickness_ft: number;
         item_type: string;
         ml_material_id: number | null;
         review_status: string;
       }

       export interface MaterialSearchResponse {
         materials: MaterialItem[];
         count: number;
         total_available: number;
       }

       export interface MaterialCategoryResponse {
         categories: string[];
         count: number;
       }
       ```

       - `searchMaterials(q: string, category?: string, limit?: number)`: GET to `${NEXT_PUBLIC_API_URL}/materials/search?q=...&category=...&limit=...`
         - Returns MaterialSearchResponse
         - Throws on non-OK response

       - `fetchMaterialCategories()`: GET to `${NEXT_PUBLIC_API_URL}/materials/categories`
         - Returns MaterialCategoryResponse

       Follow the same patterns as existing API clients (e.g., `frontend/src/lib/api/customers.ts` or `hybrid-quote.ts`):
       - Use `process.env.NEXT_PUBLIC_API_URL` as base URL
       - Use fetch with appropriate headers
       - Handle errors with throw
  </action>
  <verify>
    - `ls frontend/src/components/ui/popover.tsx frontend/src/components/ui/command.tsx` both exist
    - `ls frontend/src/lib/api/materials.ts` exists
    - `cd frontend && pnpm tsc --noEmit 2>&1 | head -20` shows no new type errors from these files
  </verify>
  <done>
    - Popover and Command shadcn components installed
    - Materials API client created with searchMaterials() and fetchMaterialCategories()
    - TypeScript types match backend MaterialItem schema
    - No TypeScript compilation errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Build MaterialSelector component and integrate into materials form</name>
  <files>
    frontend/src/components/estimateur/material-selector.tsx
    frontend/src/components/estimateur/materials-form.tsx
    frontend/src/lib/i18n/fr.ts
    frontend/src/lib/i18n/en.ts
  </files>
  <action>
    1. Add i18n translations for the material selector. In BOTH fr.ts and en.ts, add a `materialSelector` section (or extend the existing `materiaux` section):

       **French (fr.ts):**
       ```
       materialSelector: {
         rechercher: "Rechercher un matériau...",
         aucunResultat: "Aucun matériau trouvé.",
         selectionner: "Sélectionner des matériaux...",
         materiauSelectionnes: "matériaux sélectionnés",
         touteCategories: "Toutes les catégories",
         ajouterPersonnalise: "Ajouter un matériau personnalisé",
         nomPersonnalise: "Nom du matériau",
         prixPersonnalise: "Prix unitaire",
         unitePersonnalisee: "Unité",
         ajouter: "Ajouter",
         annuler: "Annuler",
         supprimer: "Retirer",
         lignesAuto: "Lignes de matériaux (auto)",
       }
       ```

       **English (en.ts):**
       ```
       materialSelector: {
         rechercher: "Search for a material...",
         aucunResultat: "No materials found.",
         selectionner: "Select materials...",
         materiauSelectionnes: "materials selected",
         touteCategories: "All categories",
         ajouterPersonnalise: "Add custom material",
         nomPersonnalise: "Material name",
         prixPersonnalise: "Unit price",
         unitePersonnalisee: "Unit",
         ajouter: "Add",
         annuler: "Cancel",
         supprimer: "Remove",
         lignesAuto: "Material lines (auto)",
       }
       ```

    2. Create `frontend/src/components/estimateur/material-selector.tsx`:

       **Component: MaterialSelector**
       Props:
       - `selectedMaterials: SelectedMaterial[]` (controlled state)
       - `onSelectionChange: (materials: SelectedMaterial[]) => void`

       Where `SelectedMaterial` type = `{ id: number; name: string; category: string | null; sell_price: number | null; unit: string; isCustom?: boolean }`

       **Features:**
       a. **Search input with debounce (300ms)**: Uses useState for search term. When user types 2+ chars, calls `searchMaterials(q, selectedCategory)` from the API client. Uses `useDeferredValue` (React 19) for debouncing, matching the project's established pattern from Phase 11-04.

       b. **Category filter dropdown**: Small Select above the search. Fetches categories on mount via `fetchMaterialCategories()`. Options: "All categories" + each category. When changed, re-triggers search.

       c. **Popover + Command pattern (Combobox)**: Button trigger shows "N matériaux sélectionnés" or placeholder. Popover opens with CommandInput for search, CommandGroup for results (max 50 items), CommandEmpty for no results.

       d. **Multi-select**: Clicking a material toggles selection. Selected items show a checkmark. Selection stored in parent state via onSelectionChange callback.

       e. **Selected materials list**: Below the Popover, show a list/table of selected materials:
          - Each row: material name, category badge, price (formatted CAD), remove button (X icon)
          - At bottom: total count and total estimated cost

       f. **"Add custom material" button**: At the bottom of the CommandGroup, a special item opens a small inline form (Dialog or collapsible) with: name (text input), unit price (number), unit (text). On submit, adds a SelectedMaterial with `isCustom: true` and a negative temporary ID (e.g., -Date.now()).

       g. **Scroll handling**: CommandGroup has `className="max-h-64 overflow-auto"` to handle long lists.

       Use these imports:
       - `{ Check, ChevronsUpDown, X, Plus }` from lucide-react
       - `{ cn }` from "@/lib/utils"
       - Command, Popover components from ui/
       - `{ searchMaterials, fetchMaterialCategories, MaterialItem }` from "@/lib/api/materials"
       - `{ useLanguage }` from "@/lib/i18n"

    3. Update `frontend/src/components/estimateur/materials-form.tsx`:

       **Changes:**
       a. Import `MaterialSelector` and its `SelectedMaterial` type
       b. Add state: `const [selectedMaterials, setSelectedMaterials] = useState<SelectedMaterial[]>([])`
       c. **Replace** the `material_lines` number input with the `MaterialSelector` component:
          - Remove the Input for material_lines
          - Add `<MaterialSelector selectedMaterials={selectedMaterials} onSelectionChange={setSelectedMaterials} />`
          - Below the selector, show a read-only display: "Lignes de matériaux (auto): {selectedMaterials.length}"
          - Update the form's material_lines value automatically: `form.setValue('material_lines', selectedMaterials.length)` in a useEffect watching selectedMaterials
       d. Keep ALL other form fields (sqft, category, complexity, toggles, labor_lines) unchanged
       e. Keep the results table and submit logic unchanged
       f. The form still submits material_lines as a number to the existing /estimate/materials endpoint

       **Important:** The material_lines field in the Zod schema and form state stays as-is. The selector just auto-populates it. This maintains backward compatibility with the existing prediction endpoint.
  </action>
  <verify>
    - `cd frontend && pnpm tsc --noEmit` passes with no errors
    - `ls frontend/src/components/estimateur/material-selector.tsx` exists
    - `grep "MaterialSelector" frontend/src/components/estimateur/materials-form.tsx` finds the import and usage
    - `grep "materialSelector" frontend/src/lib/i18n/fr.ts` finds the translations
    - `grep "materialSelector" frontend/src/lib/i18n/en.ts` finds the translations
  </verify>
  <done>
    - MaterialSelector component renders searchable dropdown with multi-select
    - Category filter narrows search results
    - Selected materials shown as removable list with prices
    - "Add custom material" button allows adding unlisted items
    - material_lines auto-calculated from selection count
    - materials-form.tsx uses MaterialSelector instead of manual number input
    - All labels bilingual (FR/EN) via i18n
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && pnpm tsc --noEmit` passes
2. `grep -r "MaterialSelector" frontend/src/` shows component definition and usage
3. `grep "materialSelector" frontend/src/lib/i18n/fr.ts` shows French translations
4. `grep "materialSelector" frontend/src/lib/i18n/en.ts` shows English translations
5. `pnpm ls cmdk` confirms cmdk package installed
6. MaterialSelector component file exists with Popover + Command pattern
</verification>

<success_criteria>
- Material selector replaces manual material_lines input with searchable dropdown
- Users search by typing 2+ characters, results come from backend API
- Category filter dropdown narrows results
- Multi-select with visual checkmarks and removal
- Custom material entry for items not in database
- Auto-calculated material_lines synced with form state
- Bilingual labels (FR/EN)
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-materials-database-import/20-03-SUMMARY.md`
</output>
