---
phase: 20-materials-database-import
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/routers/materials.py
  - backend/app/schemas/materials.py
  - backend/app/main.py
autonomous: true

must_haves:
  truths:
    - "GET /materials/search returns materials matching a text query"
    - "GET /materials/categories returns distinct category list"
    - "Search results are limited and paginated"
    - "Only approved materials appear in search by default"
    - "Materials endpoint returns 503 when Supabase not configured"
  artifacts:
    - path: "backend/app/routers/materials.py"
      provides: "Materials search and categories endpoints"
      contains: "search_materials"
    - path: "backend/app/schemas/materials.py"
      provides: "Pydantic models for material DB records and search"
      contains: "MaterialItem"
  key_links:
    - from: "backend/app/routers/materials.py"
      to: "backend/app/services/supabase_client.py"
      via: "get_supabase() for database queries"
      pattern: "get_supabase"
    - from: "backend/app/main.py"
      to: "backend/app/routers/materials.py"
      via: "app.include_router(materials.router)"
      pattern: "include_router.*materials"
---

<objective>
Create backend API endpoints for searching materials in the database and listing categories.

Purpose: The frontend material selector needs a search API to query materials by name/category. Server-side search avoids loading all 1,152 items into the browser.
Output: Two new endpoints: GET /materials/search and GET /materials/categories, registered in main.py.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-materials-database-import/20-RESEARCH.md
@backend/app/services/supabase_client.py
@backend/app/schemas/materials.py
@backend/app/main.py
@backend/app/routers/feedback.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend material schemas for database records and search</name>
  <files>
    backend/app/schemas/materials.py
  </files>
  <action>
    Update `backend/app/schemas/materials.py` to ADD new models (keep all existing models intact -- MaterialEstimateRequest, MaterialPrediction, MaterialEstimateResponse, FullEstimateResponse are used by Phase 10 endpoints).

    Add these new models AFTER the existing ones:

    1. `MaterialItem(BaseModel)` -- represents a material from the database:
       - id: int
       - code: Optional[str] = None
       - name: str
       - cost: Optional[float] = None
       - sell_price: Optional[float] = None
       - unit: str
       - category: Optional[str] = None
       - supplier: Optional[str] = None
       - note: Optional[str] = None
       - area_sqft: float = 0
       - length_ft: float = 0
       - width_ft: float = 0
       - thickness_ft: float = 0
       - item_type: str = "material"
       - ml_material_id: Optional[int] = None
       - review_status: str = "approved"

    2. `MaterialSearchResponse(BaseModel)` -- search endpoint response:
       - materials: List[MaterialItem]
       - count: int
       - total_available: int (total matching materials, for pagination info)

    3. `MaterialCategoryResponse(BaseModel)` -- categories endpoint response:
       - categories: List[str]
       - count: int
  </action>
  <verify>
    - `python -c "from app.schemas.materials import MaterialItem, MaterialSearchResponse, MaterialCategoryResponse; print('OK')"` from backend/
    - Existing imports still work: `python -c "from app.schemas.materials import MaterialEstimateRequest, MaterialPrediction; print('OK')"`
  </verify>
  <done>
    - MaterialItem, MaterialSearchResponse, MaterialCategoryResponse models defined
    - All existing models (MaterialEstimateRequest, MaterialPrediction, etc.) remain unchanged
    - All models importable without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create materials router with search and categories endpoints</name>
  <files>
    backend/app/routers/materials.py
    backend/app/main.py
  </files>
  <action>
    1. Create `backend/app/routers/materials.py` with:

       Router prefix: `/materials`, tags: `["materials"]`

       **GET /materials/search**
       - Query params:
         - `q: str` (required, min_length=2) -- search text
         - `category: Optional[str] = None` -- filter by category
         - `include_flagged: bool = False` -- include flagged items in results
         - `limit: int = Query(default=50, le=200)` -- max results
         - `offset: int = Query(default=0, ge=0)` -- pagination offset
       - Logic:
         a. Get Supabase client via get_supabase(). If None, return 503 with {"error": "Database not configured"}
         b. Build query: `supabase.from_('materials').select('*', count='exact')`
         c. Filter: `.ilike('name', f'%{q}%')` for fuzzy name matching
         d. Filter: `.eq('item_type', 'material')` (always exclude labor items from search)
         e. If not include_flagged: `.eq('review_status', 'approved')`
         f. If category provided: `.eq('category', category)`
         g. Order by name, apply limit and offset: `.order('name').range(offset, offset + limit - 1)`
         h. Execute and return MaterialSearchResponse with materials, count=len(data), total_available=count from Supabase
       - Error handling: try/except around Supabase query, return 500 with error message

       **GET /materials/categories**
       - No params
       - Logic:
         a. Get Supabase client. If None, return 503.
         b. Query: `supabase.from_('materials').select('category').eq('item_type', 'material').eq('review_status', 'approved').not_.is_('category', 'null')`
         c. Extract unique categories from results, sort alphabetically
         d. Return MaterialCategoryResponse with categories list and count
       - This is a simple endpoint; categories are relatively few (~30 max) so no pagination needed

       Follow the same patterns as `backend/app/routers/feedback.py`:
       - Use `from fastapi import APIRouter, Query, HTTPException`
       - Use `from app.services.supabase_client import get_supabase`
       - Use `from app.schemas.materials import MaterialItem, MaterialSearchResponse, MaterialCategoryResponse`
       - Return 503 when Supabase not configured (same as feedback router pattern)

    2. Update `backend/app/main.py`:
       - Add import: `from app.routers import customers, dashboard, estimate, feedback, health, materials, quotes`
       - Add router: `app.include_router(materials.router)` after the dashboard router line
  </action>
  <verify>
    - `python -c "from app.routers.materials import router; print(router.prefix)"` outputs `/materials`
    - `python -c "from app.main import app; routes = [r.path for r in app.routes]; print('/materials/search' in str(routes))"` shows the route is registered
  </verify>
  <done>
    - GET /materials/search endpoint returns materials matching query text with category filter and pagination
    - GET /materials/categories endpoint returns sorted list of distinct material categories
    - Both endpoints return 503 when Supabase not configured (graceful degradation)
    - Materials router registered in main.py
  </done>
</task>

</tasks>

<verification>
1. `python -c "from app.routers.materials import router; print('Router OK')"` from backend/
2. `python -c "from app.schemas.materials import MaterialItem, MaterialSearchResponse; print('Schemas OK')"` from backend/
3. `python -c "from app.main import app; print([r.path for r in app.routes])"` includes materials routes
4. Existing material prediction endpoints still importable: `python -c "from app.schemas.materials import MaterialEstimateRequest; print('Legacy OK')"`
</verification>

<success_criteria>
- GET /materials/search accepts query text, category filter, pagination params
- GET /materials/categories returns distinct categories for dropdown filter
- Both endpoints handle missing Supabase gracefully (503)
- Existing material prediction schemas and endpoints unaffected
- Router registered in FastAPI app
</success_criteria>

<output>
After completion, create `.planning/phases/20-materials-database-import/20-02-SUMMARY.md`
</output>
