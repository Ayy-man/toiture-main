---
phase: 11-cortex-admin-dashboard
plan: 04
type: execute
wave: 2
depends_on: ["11-01", "11-02"]
files_modified:
  - frontend/src/app/(admin)/clients/page.tsx
  - frontend/src/components/clients/customer-search.tsx
  - frontend/src/components/clients/customer-card.tsx
  - frontend/src/components/clients/segment-badge.tsx
  - frontend/src/components/clients/quote-history.tsx
  - frontend/src/lib/hooks/use-customers.ts
  - frontend/src/lib/api/customers.ts
  - frontend/src/types/customer.ts
autonomous: true

must_haves:
  truths:
    - "User can search customers by name"
    - "Search returns results in <1 second"
    - "User sees customer lifetime value and segment badge"
    - "User can view customer's quote history"
  artifacts:
    - path: "frontend/src/components/clients/customer-search.tsx"
      provides: "Debounced search input with results dropdown"
      exports: ["CustomerSearch"]
    - path: "frontend/src/components/clients/customer-card.tsx"
      provides: "Customer detail card with metrics"
      exports: ["CustomerCard"]
    - path: "frontend/src/lib/hooks/use-customers.ts"
      provides: "React Query hook with deferred search"
      exports: ["useCustomerSearch"]
  key_links:
    - from: "frontend/src/components/clients/customer-search.tsx"
      to: "frontend/src/lib/hooks/use-customers.ts"
      via: "useCustomerSearch hook"
      pattern: "useCustomerSearch"
    - from: "frontend/src/lib/hooks/use-customers.ts"
      to: "backend /customers/search"
      via: "fetch call"
      pattern: "customers/search"
---

<objective>
Build the Clients tab with customer search, segment badges, and quote history display.

Purpose: Laurent needs to look up customers quickly to see their history and value. The search must be fast (<1 second) and show relevant customer metrics.

Output: Customer lookup interface with search, detail view, segment badges (VIP/Regular/New), and quote history.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-cortex-admin-dashboard/11-RESEARCH.md
@.planning/phases/11-cortex-admin-dashboard/11-01-SUMMARY.md (sidebar layout, fr translations)
@.planning/phases/11-cortex-admin-dashboard/11-02-SUMMARY.md (backend /customers endpoints)

Reference existing patterns:
@frontend/src/lib/hooks/use-analytics.ts (React Query pattern)
@frontend/src/lib/i18n/fr.ts (French translations)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create customer types and API client</name>
  <files>
    frontend/src/types/customer.ts
    frontend/src/lib/api/customers.ts
  </files>
  <action>
1. Create `frontend/src/types/customer.ts`:
   ```typescript
   export type CustomerSegment = "VIP" | "Regular" | "New";

   export interface CustomerResult {
     id: string;
     name: string;
     city: string | null;
     total_quotes: number;
     lifetime_value: number;
     segment: CustomerSegment;
   }

   export interface CustomerQuote {
     id: string;
     category: string | null;
     sqft: number | null;
     total_price: number | null;
     created_at: string;
   }

   export interface CustomerDetail {
     id: string;
     name: string;
     city: string | null;
     phone: string | null;
     email: string | null;
     total_quotes: number;
     lifetime_value: number;
     segment: CustomerSegment;
     quotes: CustomerQuote[];
   }
   ```

2. Create `frontend/src/lib/api/customers.ts`:
   ```typescript
   import type { CustomerResult, CustomerDetail } from "@/types/customer";

   const API_URL = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8000";

   export async function searchCustomers(
     query: string,
     limit: number = 10
   ): Promise<CustomerResult[]> {
     if (query.length < 2) return [];

     const params = new URLSearchParams({
       q: query,
       limit: String(limit),
     });

     const response = await fetch(`${API_URL}/customers/search?${params}`);
     if (!response.ok) {
       throw new Error("Failed to search customers");
     }
     return response.json();
   }

   export async function getCustomerDetail(
     customerId: string
   ): Promise<CustomerDetail> {
     const response = await fetch(`${API_URL}/customers/${customerId}`);
     if (!response.ok) {
       throw new Error("Failed to fetch customer details");
     }
     return response.json();
   }
   ```
  </action>
  <verify>
```bash
ls /Users/aymanbaig/Desktop/Toiture-P1/frontend/src/types/customer.ts
ls /Users/aymanbaig/Desktop/Toiture-P1/frontend/src/lib/api/customers.ts
```
  </verify>
  <done>
- CustomerResult, CustomerDetail, CustomerSegment types defined
- searchCustomers API function with minimum 2-char query
- getCustomerDetail API function for full customer info
  </done>
</task>

<task type="auto">
  <name>Task 2: Create customer hooks and segment badge</name>
  <files>
    frontend/src/lib/hooks/use-customers.ts
    frontend/src/components/clients/segment-badge.tsx
  </files>
  <action>
1. Create `frontend/src/lib/hooks/use-customers.ts`:
   - "use client" directive
   - Import useQuery from @tanstack/react-query
   - Import useState, useDeferredValue from react
   - Import searchCustomers, getCustomerDetail from @/lib/api/customers

   Export useCustomerSearch hook:
   - State: searchTerm (string, default "")
   - Use useDeferredValue for deferredSearch (prevents excessive re-renders)
   - React Query for search:
     - queryKey: ["customers", "search", deferredSearch]
     - queryFn: searchCustomers(deferredSearch)
     - enabled: deferredSearch.length >= 2 (don't fetch until 2+ chars)
     - staleTime: 5 minutes
   - Return: searchTerm, setSearchTerm, results, isSearching, isStale

   Export useCustomerDetail hook:
   - Parameter: customerId (string | null)
   - React Query:
     - queryKey: ["customers", "detail", customerId]
     - queryFn: getCustomerDetail(customerId!)
     - enabled: !!customerId (only fetch when ID provided)
     - staleTime: 5 minutes
   - Return: query result

2. Create `frontend/src/components/clients/segment-badge.tsx`:
   - Import Badge from @/components/ui/badge
   - Import CustomerSegment from @/types/customer

   Props: segment (CustomerSegment)

   Render Badge with variant based on segment:
   - VIP: variant="default", className with gold/yellow background (bg-amber-500)
   - Regular: variant="secondary"
   - New: variant="outline"

   Badge text is the segment name (VIP, Regular, New)
  </action>
  <verify>
```bash
cd /Users/aymanbaig/Desktop/Toiture-P1/frontend
npx tsc --noEmit src/lib/hooks/use-customers.ts 2>&1 | head -5
npx tsc --noEmit src/components/clients/segment-badge.tsx 2>&1 | head -5
```
  </verify>
  <done>
- useCustomerSearch hook with debounced search via useDeferredValue
- useCustomerDetail hook for fetching full customer info
- SegmentBadge component with visual styling for VIP/Regular/New
  </done>
</task>

<task type="auto">
  <name>Task 3: Create customer components and complete Clients page</name>
  <files>
    frontend/src/components/clients/customer-search.tsx
    frontend/src/components/clients/customer-card.tsx
    frontend/src/components/clients/quote-history.tsx
    frontend/src/app/(admin)/clients/page.tsx
  </files>
  <action>
1. Create `frontend/src/components/clients/customer-search.tsx`:
   - "use client" directive
   - Import Input from @/components/ui/input
   - Import Card from @/components/ui/card
   - Import fr from @/lib/i18n/fr
   - Import SegmentBadge from ./segment-badge
   - Import CustomerResult from @/types/customer

   Props: searchTerm, onSearchChange, results, isSearching, onSelectCustomer

   Render:
   - Input with placeholder fr.clients.rechercher
   - onChange calls onSearchChange
   - Below input: results dropdown (absolutely positioned)
   - Each result shows: name, city, lifetime value, segment badge
   - Click on result calls onSelectCustomer(customer.id)
   - Show loading indicator when isSearching
   - Show "Aucun resultat" when results empty and searchTerm >= 2 chars

2. Create `frontend/src/components/clients/customer-card.tsx`:
   - Import Card, CardHeader, CardContent from @/components/ui/card
   - Import fr from @/lib/i18n/fr
   - Import SegmentBadge from ./segment-badge
   - Import CustomerDetail from @/types/customer

   Props: customer (CustomerDetail)

   Render Card with:
   - Header: customer name + segment badge
   - Content grid with metrics:
     - City
     - Phone (if available)
     - Email (if available)
     - Total quotes (fr.clients.historique count)
     - Lifetime value (fr.clients.valeurVie) formatted as CAD currency
   - Use Intl.NumberFormat("fr-CA", { style: "currency", currency: "CAD" })

3. Create `frontend/src/components/clients/quote-history.tsx`:
   - Import Table components from @/components/ui/table
   - Import fr from @/lib/i18n/fr
   - Import CustomerQuote from @/types/customer

   Props: quotes (CustomerQuote[])

   Render table with columns:
   - Date (formatted fr-CA)
   - Category
   - Superficie (sqft with "pi2" suffix)
   - Prix (CAD currency format)

   Show "Aucune soumission" if quotes array empty

4. Update `frontend/src/app/(admin)/clients/page.tsx`:
   - "use client" directive
   - Import useCustomerSearch, useCustomerDetail from hooks
   - Import CustomerSearch, CustomerCard, QuoteHistory components
   - Import fr from @/lib/i18n/fr
   - Import useState for selectedCustomerId

   State: selectedCustomerId (string | null, default null)

   Use useCustomerSearch for search functionality
   Use useCustomerDetail(selectedCustomerId) for detail fetching

   Render:
   - h1 "Clients" title
   - CustomerSearch component
   - When selectedCustomerId and customer data loaded:
     - CustomerCard with customer detail
     - QuoteHistory with customer.quotes
   - When loading customer detail: show skeleton/loading state
  </action>
  <verify>
```bash
cd /Users/aymanbaig/Desktop/Toiture-P1/frontend
npm run build 2>&1 | tail -20
```
  </verify>
  <done>
- CustomerSearch shows search input with results dropdown
- Results display instantly as user types (deferred for perf)
- Clicking result loads full customer detail
- CustomerCard shows name, segment badge, metrics
- QuoteHistory shows customer's quote history in table
- All text uses French translations
  </done>
</task>

</tasks>

<verification>
1. Start backend and frontend
2. Navigate to http://localhost:3000/clients
3. Test search:
   - Type 1 character - no results (minimum 2)
   - Type 2+ characters - results appear
   - Results show within 1 second
4. Test customer selection:
   - Click on a search result
   - Customer card appears with details
   - Quote history shows below
   - Segment badge displays (VIP/Regular/New)
5. Test empty states:
   - Search for gibberish - "Aucun resultat"
   - Customer with no quotes - "Aucune soumission"
</verification>

<success_criteria>
- Search input accepts customer name
- Results appear after typing 2+ characters
- Search responds in <1 second
- Clicking result loads customer detail card
- Customer card shows: name, city, phone, email, total quotes, lifetime value
- Segment badge shows VIP (gold), Regular (gray), or New (outline)
- Quote history table shows customer's past quotes
- All labels in French
- `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/11-cortex-admin-dashboard/11-04-SUMMARY.md`
</output>
