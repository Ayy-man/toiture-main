---
phase: 11-cortex-admin-dashboard
plan: 05
type: execute
wave: 2
depends_on: ["11-01", "11-02"]
files_modified:
  - frontend/src/app/(admin)/apercu/page.tsx
  - frontend/src/components/apercu/metrics-cards.tsx
  - frontend/src/components/apercu/revenue-chart.tsx
  - frontend/src/components/apercu/category-chart.tsx
  - frontend/src/components/apercu/trend-chart.tsx
  - frontend/src/components/apercu/top-clients.tsx
  - frontend/src/lib/hooks/use-dashboard.ts
  - frontend/src/lib/api/dashboard.ts
  - frontend/src/types/dashboard.ts
autonomous: true

must_haves:
  truths:
    - "User sees KPI cards (revenue, quotes, margin, clients)"
    - "User sees revenue by year bar chart"
    - "User sees revenue by category pie chart"
    - "User sees monthly trend line chart"
    - "User sees top 10 clients list"
  artifacts:
    - path: "frontend/src/components/apercu/metrics-cards.tsx"
      provides: "4 KPI stat cards"
      exports: ["MetricsCards"]
    - path: "frontend/src/components/apercu/revenue-chart.tsx"
      provides: "Revenue by year bar chart"
      exports: ["RevenueChart"]
    - path: "frontend/src/lib/hooks/use-dashboard.ts"
      provides: "React Query hooks for dashboard data"
      exports: ["useDashboardMetrics", "useDashboardCharts"]
  key_links:
    - from: "frontend/src/app/(admin)/apercu/page.tsx"
      to: "frontend/src/lib/hooks/use-dashboard.ts"
      via: "useDashboardMetrics, useDashboardCharts hooks"
      pattern: "useDashboard"
    - from: "frontend/src/lib/hooks/use-dashboard.ts"
      to: "backend /dashboard/metrics"
      via: "fetch call"
      pattern: "dashboard/metrics"
---

<objective>
Build the Apercu tab with business metrics, revenue charts, and top clients display.

Purpose: The team needs to see business performance at a glance - total revenue, quote counts, margins, and trends. Charts visualize data patterns for decision making.

Output: Dashboard with KPI cards, 3 charts (revenue by year, by category, monthly trend), and top clients list.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-cortex-admin-dashboard/11-RESEARCH.md
@.planning/phases/11-cortex-admin-dashboard/11-01-SUMMARY.md (sidebar layout, fr translations)
@.planning/phases/11-cortex-admin-dashboard/11-02-SUMMARY.md (backend /dashboard endpoints)

Reference existing patterns:
@frontend/src/components/dashboard/accuracy-chart.tsx (Recharts pattern)
@frontend/src/components/ui/chart.tsx (ChartContainer wrapper)
@frontend/src/lib/i18n/fr.ts (French translations)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard types and API client</name>
  <files>
    frontend/src/types/dashboard.ts
    frontend/src/lib/api/dashboard.ts
    frontend/src/lib/hooks/use-dashboard.ts
  </files>
  <action>
1. Create `frontend/src/types/dashboard.ts`:
   ```typescript
   export interface DashboardMetrics {
     total_revenue: number;
     total_quotes: number;
     average_margin: number;
     active_clients: number;
     period_start: string | null;
     period_end: string | null;
   }

   export interface RevenueByYear {
     year: number;
     revenue: number;
     quote_count: number;
   }

   export interface RevenueByCategory {
     category: string;
     revenue: number;
     quote_count: number;
     percentage: number;
   }

   export interface MonthlyTrend {
     month: string;
     revenue: number;
     quote_count: number;
   }

   export interface TopClient {
     name: string;
     total_spent: number;
     quote_count: number;
   }

   export interface DashboardCharts {
     revenue_by_year: RevenueByYear[];
     revenue_by_category: RevenueByCategory[];
     monthly_trend: MonthlyTrend[];
     top_clients: TopClient[];
   }
   ```

2. Create `frontend/src/lib/api/dashboard.ts`:
   ```typescript
   import type { DashboardMetrics, DashboardCharts } from "@/types/dashboard";

   const API_URL = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8000";

   export async function fetchDashboardMetrics(
     startDate?: string,
     endDate?: string
   ): Promise<DashboardMetrics> {
     const params = new URLSearchParams();
     if (startDate) params.set("start_date", startDate);
     if (endDate) params.set("end_date", endDate);

     const url = params.toString()
       ? `${API_URL}/dashboard/metrics?${params}`
       : `${API_URL}/dashboard/metrics`;

     const response = await fetch(url);
     if (!response.ok) {
       throw new Error("Failed to fetch dashboard metrics");
     }
     return response.json();
   }

   export async function fetchDashboardCharts(
     startDate?: string,
     endDate?: string
   ): Promise<DashboardCharts> {
     const params = new URLSearchParams();
     if (startDate) params.set("start_date", startDate);
     if (endDate) params.set("end_date", endDate);

     const url = params.toString()
       ? `${API_URL}/dashboard/charts?${params}`
       : `${API_URL}/dashboard/charts`;

     const response = await fetch(url);
     if (!response.ok) {
       throw new Error("Failed to fetch dashboard charts");
     }
     return response.json();
   }
   ```

3. Create `frontend/src/lib/hooks/use-dashboard.ts`:
   - "use client" directive
   - Import useQuery from @tanstack/react-query
   - Import fetchDashboardMetrics, fetchDashboardCharts from @/lib/api/dashboard

   Export useDashboardMetrics hook:
   - Parameters: startDate?, endDate?
   - React Query:
     - queryKey: ["dashboard", "metrics", startDate, endDate]
     - queryFn: fetchDashboardMetrics(startDate, endDate)
     - staleTime: 5 minutes

   Export useDashboardCharts hook:
   - Parameters: startDate?, endDate?
   - React Query:
     - queryKey: ["dashboard", "charts", startDate, endDate]
     - queryFn: fetchDashboardCharts(startDate, endDate)
     - staleTime: 5 minutes
  </action>
  <verify>
```bash
ls /Users/aymanbaig/Desktop/Toiture-P1/frontend/src/types/dashboard.ts
ls /Users/aymanbaig/Desktop/Toiture-P1/frontend/src/lib/api/dashboard.ts
ls /Users/aymanbaig/Desktop/Toiture-P1/frontend/src/lib/hooks/use-dashboard.ts
```
  </verify>
  <done>
- Dashboard types defined (metrics, charts, component data)
- API client functions for metrics and charts endpoints
- React Query hooks with caching for both endpoints
  </done>
</task>

<task type="auto">
  <name>Task 2: Create KPI cards and chart components</name>
  <files>
    frontend/src/components/apercu/metrics-cards.tsx
    frontend/src/components/apercu/revenue-chart.tsx
    frontend/src/components/apercu/category-chart.tsx
    frontend/src/components/apercu/trend-chart.tsx
  </files>
  <action>
1. Create `frontend/src/components/apercu/metrics-cards.tsx`:
   - Import Card, CardHeader, CardTitle, CardContent from @/components/ui/card
   - Import fr from @/lib/i18n/fr
   - Import DashboardMetrics from @/types/dashboard
   - Import lucide icons: DollarSign, FileText, Percent, Users

   Props: metrics (DashboardMetrics), isLoading (boolean)

   Render 4 cards in a grid (grid-cols-1 md:grid-cols-2 lg:grid-cols-4):
   - Revenu total (DollarSign icon): format as CAD currency
   - Nombre de soumissions (FileText icon): total_quotes number
   - Marge moyenne (Percent icon): average_margin as percentage
   - Clients actifs (Users icon): active_clients number

   Show skeleton when isLoading
   Use Intl.NumberFormat for currency formatting

2. Create `frontend/src/components/apercu/revenue-chart.tsx`:
   - Import ChartContainer from @/components/ui/chart
   - Import BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer from recharts
   - Import RevenueByYear from @/types/dashboard

   Props: data (RevenueByYear[]), isLoading (boolean)

   Render:
   - ChartContainer wrapper
   - ResponsiveContainer with height 300
   - BarChart with data
   - XAxis with dataKey="year"
   - YAxis formatted as currency (compact notation for millions)
   - Bar with dataKey="revenue", fill brick red (#8B2323)
   - Tooltip with currency formatting

3. Create `frontend/src/components/apercu/category-chart.tsx`:
   - Import PieChart, Pie, Cell, Tooltip, ResponsiveContainer, Legend from recharts
   - Import RevenueByCategory from @/types/dashboard

   Props: data (RevenueByCategory[]), isLoading (boolean)

   Define COLORS array for pie slices (5-6 colors including brick red)

   Render:
   - ResponsiveContainer with height 300
   - PieChart
   - Pie with dataKey="revenue", nameKey="category"
   - Cell for each entry with color from COLORS array
   - Legend below chart
   - Tooltip with category name and revenue

4. Create `frontend/src/components/apercu/trend-chart.tsx`:
   - Import LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer from recharts
   - Import MonthlyTrend from @/types/dashboard

   Props: data (MonthlyTrend[]), isLoading (boolean)

   Render:
   - ResponsiveContainer with height 300
   - LineChart with data
   - XAxis with dataKey="month"
   - YAxis formatted as currency
   - Line with dataKey="revenue", stroke brick red (#8B2323), strokeWidth 2
   - Tooltip with month and revenue
  </action>
  <verify>
```bash
cd /Users/aymanbaig/Desktop/Toiture-P1/frontend
npx tsc --noEmit src/components/apercu/metrics-cards.tsx 2>&1 | head -5
npx tsc --noEmit src/components/apercu/revenue-chart.tsx 2>&1 | head -5
```
  </verify>
  <done>
- MetricsCards shows 4 KPI cards with icons and formatted values
- RevenueChart shows bar chart of revenue by year
- CategoryChart shows pie chart of revenue by category
- TrendChart shows line chart of monthly revenue trend
- All charts use brick red (#8B2323) as primary color
  </done>
</task>

<task type="auto">
  <name>Task 3: Create top clients and complete Apercu page</name>
  <files>
    frontend/src/components/apercu/top-clients.tsx
    frontend/src/app/(admin)/apercu/page.tsx
  </files>
  <action>
1. Create `frontend/src/components/apercu/top-clients.tsx`:
   - Import Card, CardHeader, CardTitle, CardContent from @/components/ui/card
   - Import fr from @/lib/i18n/fr
   - Import TopClient from @/types/dashboard

   Props: clients (TopClient[]), isLoading (boolean)

   Render Card with:
   - Header: "Top 10 Clients"
   - Content: ordered list of clients
   - Each client row shows:
     - Rank number (1-10)
     - Client name
     - Total spent (CAD currency format)
     - Quote count in parentheses

   Show skeleton when isLoading
   Show empty state if no clients

2. Update `frontend/src/app/(admin)/apercu/page.tsx`:
   - "use client" directive
   - Import useDashboardMetrics, useDashboardCharts from hooks
   - Import all chart components
   - Import MetricsCards, TopClients
   - Import fr from @/lib/i18n/fr

   Render layout:
   - h1 with fr.apercu.titre
   - MetricsCards at top (full width)
   - Grid layout for charts:
     - Row 1: RevenueChart (col-span-2) + CategoryChart (col-span-1)
     - Row 2: TrendChart (col-span-2) + TopClients (col-span-1)
   - Use responsive grid: grid-cols-1 lg:grid-cols-3
   - Pass data and isLoading to each component
   - Charts should have Card wrapper with title

   Chart titles (in Cards):
   - "Revenu par annee"
   - "Revenu par categorie"
   - "Tendance mensuelle"
   - "Top clients"
  </action>
  <verify>
```bash
cd /Users/aymanbaig/Desktop/Toiture-P1/frontend
npm run build 2>&1 | tail -20
```
  </verify>
  <done>
- Apercu page shows complete dashboard layout
- KPI cards display all 4 metrics with proper formatting
- Bar chart shows revenue by year
- Pie chart shows revenue distribution by category
- Line chart shows monthly revenue trend
- Top clients list shows top 10 with spending totals
- Responsive layout works on different screen sizes
  </done>
</task>

</tasks>

<verification>
1. Start backend and frontend
2. Navigate to http://localhost:3000/apercu
3. Verify components:
   - 4 KPI cards visible with values
   - Revenue by year bar chart renders
   - Category pie chart renders with legend
   - Monthly trend line chart renders
   - Top clients list shows entries
4. Test responsiveness:
   - Resize browser
   - Charts reflow appropriately
   - Cards stack on mobile
5. Test loading states:
   - Refresh page
   - Skeletons should appear briefly
</verification>

<success_criteria>
- Apercu tab shows dashboard with KPIs and charts
- KPI cards display: Revenu total, Nombre de soumissions, Marge moyenne, Clients actifs
- Bar chart shows revenue by year
- Pie chart shows revenue by category with legend
- Line chart shows monthly trend
- Top 10 clients list displays
- All values formatted in French Canadian locale (CAD currency)
- Charts use brick red (#8B2323) as accent color
- Loading states show skeletons
- Responsive layout works on mobile and desktop
- `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/11-cortex-admin-dashboard/11-05-SUMMARY.md`
</output>
