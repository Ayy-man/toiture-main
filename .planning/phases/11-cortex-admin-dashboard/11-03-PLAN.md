---
phase: 11-cortex-admin-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["11-01", "11-02"]
files_modified:
  - frontend/src/app/(admin)/historique/page.tsx
  - frontend/src/components/historique/quote-table.tsx
  - frontend/src/components/historique/quote-columns.tsx
  - frontend/src/components/historique/quote-filters.tsx
  - frontend/src/lib/hooks/use-quotes.ts
  - frontend/src/lib/api/quotes.ts
  - frontend/src/lib/utils/csv-export.ts
  - frontend/src/types/quote.ts
autonomous: true

must_haves:
  truths:
    - "User can browse 8,293 quotes with pagination"
    - "User can filter by category, city, sqft range, price range, date"
    - "User can export filtered results to CSV"
    - "Page navigation shows current page and total pages"
  artifacts:
    - path: "frontend/src/components/historique/quote-table.tsx"
      provides: "Paginated quote table with server-side pagination"
      exports: ["QuoteTable"]
    - path: "frontend/src/lib/hooks/use-quotes.ts"
      provides: "React Query hook for quotes with pagination state"
      exports: ["useQuotes"]
    - path: "frontend/src/lib/utils/csv-export.ts"
      provides: "CSV export with UTF-8 BOM for French characters"
      exports: ["exportToCSV"]
  key_links:
    - from: "frontend/src/components/historique/quote-table.tsx"
      to: "frontend/src/lib/hooks/use-quotes.ts"
      via: "useQuotes hook call"
      pattern: "useQuotes"
    - from: "frontend/src/lib/hooks/use-quotes.ts"
      to: "backend /quotes endpoint"
      via: "fetch with pagination params"
      pattern: "quotes\\?page"
---

<objective>
Build the Historique tab with a paginated quote browser supporting filters and CSV export.

Purpose: Laurent needs to browse historical quotes (8,293 records) with filters. Server-side pagination is required for performance. CSV export enables data analysis in Excel.

Output: Full-featured quote browser with filters, pagination, and export functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-cortex-admin-dashboard/11-RESEARCH.md
@.planning/phases/11-cortex-admin-dashboard/11-01-SUMMARY.md (sidebar layout)
@.planning/phases/11-cortex-admin-dashboard/11-02-SUMMARY.md (backend endpoints)

Reference existing patterns:
@frontend/src/components/review/data-table.tsx (TanStack Table pattern)
@frontend/src/lib/hooks/use-analytics.ts (React Query hook pattern)
@frontend/src/lib/i18n/fr.ts (French translations)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create quote types and API client</name>
  <files>
    frontend/src/types/quote.ts
    frontend/src/lib/api/quotes.ts
    frontend/src/lib/utils/csv-export.ts
  </files>
  <action>
1. Create `frontend/src/types/quote.ts`:
   ```typescript
   export interface Quote {
     id: string;
     client_name: string | null;
     category: string | null;
     city: string | null;
     sqft: number | null;
     total_price: number | null;
     margin_percent: number | null;
     created_at: string;
   }

   export interface QuoteFilters {
     category?: string;
     city?: string;
     min_sqft?: number;
     max_sqft?: number;
     min_price?: number;
     max_price?: number;
     start_date?: string;
     end_date?: string;
   }

   export interface PaginatedQuotes {
     items: Quote[];
     total: number;
     page: number;
     per_page: number;
     total_pages: number;
   }
   ```

2. Create `frontend/src/lib/api/quotes.ts`:
   ```typescript
   import type { QuoteFilters, PaginatedQuotes } from "@/types/quote";

   const API_URL = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8000";

   export async function fetchQuotes(
     page: number,
     perPage: number,
     filters: QuoteFilters
   ): Promise<PaginatedQuotes> {
     const params = new URLSearchParams({
       page: String(page),
       per_page: String(perPage),
     });

     // Add non-empty filters
     Object.entries(filters).forEach(([key, value]) => {
       if (value !== undefined && value !== "") {
         params.set(key, String(value));
       }
     });

     const response = await fetch(`${API_URL}/quotes?${params}`);
     if (!response.ok) {
       throw new Error("Failed to fetch quotes");
     }
     return response.json();
   }

   export async function fetchAllQuotesForExport(
     filters: QuoteFilters
   ): Promise<Quote[]> {
     // Fetch all matching quotes for export (no pagination, max 10000)
     const params = new URLSearchParams({
       page: "1",
       per_page: "10000",
     });
     Object.entries(filters).forEach(([key, value]) => {
       if (value !== undefined && value !== "") {
         params.set(key, String(value));
       }
     });

     const response = await fetch(`${API_URL}/quotes?${params}`);
     if (!response.ok) {
       throw new Error("Failed to fetch quotes for export");
     }
     const data: PaginatedQuotes = await response.json();
     return data.items;
   }
   ```

3. Create `frontend/src/lib/utils/csv-export.ts`:
   ```typescript
   export function exportToCSV(
     data: Record<string, unknown>[],
     filename: string
   ): void {
     if (data.length === 0) return;

     const headers = Object.keys(data[0]);
     const csvContent = [
       headers.join(","),
       ...data.map((row) =>
         headers
           .map((header) => {
             const value = row[header];
             const str = String(value ?? "").replace(/"/g, '""');
             return str.includes(",") || str.includes('"') || str.includes("\n")
               ? `"${str}"`
               : str;
           })
           .join(",")
       ),
     ].join("\n");

     // UTF-8 BOM for Excel French character support
     const BOM = "\uFEFF";
     const blob = new Blob([BOM + csvContent], {
       type: "text/csv;charset=utf-8;",
     });

     const link = document.createElement("a");
     link.href = URL.createObjectURL(blob);
     link.download = `${filename}.csv`;
     link.click();
     URL.revokeObjectURL(link.href);
   }
   ```
  </action>
  <verify>
```bash
ls /Users/aymanbaig/Desktop/Toiture-P1/frontend/src/types/quote.ts
ls /Users/aymanbaig/Desktop/Toiture-P1/frontend/src/lib/api/quotes.ts
ls /Users/aymanbaig/Desktop/Toiture-P1/frontend/src/lib/utils/csv-export.ts
```
  </verify>
  <done>
- Quote, QuoteFilters, PaginatedQuotes types defined
- fetchQuotes and fetchAllQuotesForExport API functions created
- CSV export utility with UTF-8 BOM for French character support
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useQuotes hook and filter components</name>
  <files>
    frontend/src/lib/hooks/use-quotes.ts
    frontend/src/components/historique/quote-filters.tsx
  </files>
  <action>
1. Create `frontend/src/lib/hooks/use-quotes.ts`:
   - "use client" directive
   - Import useQuery, keepPreviousData from @tanstack/react-query
   - Import useState
   - Import fetchQuotes from @/lib/api/quotes
   - Import QuoteFilters from @/types/quote

   Define PaginationState interface: { pageIndex: number; pageSize: number }

   Export useQuotes hook:
   - State: pagination (default pageIndex: 0, pageSize: 20)
   - State: filters (QuoteFilters, default empty object)
   - React Query with:
     - queryKey: ["quotes", pagination, filters]
     - queryFn: fetchQuotes(pagination.pageIndex + 1, pagination.pageSize, filters)
     - placeholderData: keepPreviousData (prevents flicker on page change)
     - staleTime: 5 minutes
   - Return: query result, pagination, setPagination, filters, setFilters, pageCount

2. Create `frontend/src/components/historique/quote-filters.tsx`:
   - "use client" directive
   - Import fr from @/lib/i18n/fr
   - Import Input, Select, Button from shadcn/ui
   - Import QuoteFilters from @/types/quote

   Props: filters, onFiltersChange, onExport, isExporting

   Render filter controls in a grid layout:
   - Category dropdown (using CATEGORIES from @/lib/schemas if available, or hardcode common categories)
   - City text input with .ilike search
   - Min/Max sqft inputs (number)
   - Min/Max price inputs (number)
   - Start/End date inputs (date type)
   - Clear filters button
   - Export CSV button (shows loading state when isExporting)

   All labels use fr.historique translations
  </action>
  <verify>
```bash
cd /Users/aymanbaig/Desktop/Toiture-P1/frontend
npx tsc --noEmit src/lib/hooks/use-quotes.ts 2>&1 | head -5
npx tsc --noEmit src/components/historique/quote-filters.tsx 2>&1 | head -5
```
  </verify>
  <done>
- useQuotes hook manages pagination and filter state
- React Query handles caching and refetching
- QuoteFilters component renders all filter inputs with French labels
- Filters include: category, city, sqft range, price range, date range
  </done>
</task>

<task type="auto">
  <name>Task 3: Create quote table and complete Historique page</name>
  <files>
    frontend/src/components/historique/quote-columns.tsx
    frontend/src/components/historique/quote-table.tsx
    frontend/src/app/(admin)/historique/page.tsx
  </files>
  <action>
1. Create `frontend/src/components/historique/quote-columns.tsx`:
   - Import ColumnDef from @tanstack/react-table
   - Import Quote from @/types/quote

   Export columns array with:
   - client_name: header "Client"
   - category: header "Categorie"
   - city: header "Ville"
   - sqft: header "Superficie", format with toLocaleString("fr-CA") + " pi2"
   - total_price: header "Prix", format with Intl.NumberFormat("fr-CA", currency: "CAD")
   - margin_percent: header "Marge", format as percentage with % suffix
   - created_at: header "Date", format with toLocaleDateString("fr-CA")

2. Create `frontend/src/components/historique/quote-table.tsx`:
   - "use client" directive
   - Import TanStack Table utilities
   - Import Table components from @/components/ui/table
   - Import Button from @/components/ui/button
   - Import fr from @/lib/i18n/fr
   - Import columns from ./quote-columns
   - Import Quote from @/types/quote

   Props: data (Quote[]), pagination, setPagination, pageCount, isFetching

   Use useReactTable with:
   - data, columns
   - pageCount
   - state: { pagination }
   - onPaginationChange: setPagination
   - getCoreRowModel: getCoreRowModel()
   - manualPagination: true

   Render:
   - Table with headers and body from TanStack Table
   - Loading overlay when isFetching (semi-transparent background)
   - Pagination controls: Precedent/Suivant buttons
   - Page indicator: "Page X sur Y" using fr.common translations
   - Empty state: "Aucun resultat" when no data

3. Update `frontend/src/app/(admin)/historique/page.tsx`:
   - "use client" directive
   - Import useQuotes from @/lib/hooks/use-quotes
   - Import QuoteFilters from @/components/historique/quote-filters
   - Import QuoteTable from @/components/historique/quote-table
   - Import exportToCSV from @/lib/utils/csv-export
   - Import fetchAllQuotesForExport from @/lib/api/quotes
   - Import fr from @/lib/i18n/fr
   - Import useState for export loading state

   Render:
   - h1 with fr.historique.titre
   - QuoteFilters component (pass filters, setFilters, export handler)
   - QuoteTable component (pass data, pagination, pageCount, isFetching)

   Export handler:
   - Set isExporting true
   - Call fetchAllQuotesForExport with current filters
   - Call exportToCSV with data and filename "historique-soumissions"
   - Set isExporting false
   - Handle errors gracefully
  </action>
  <verify>
```bash
cd /Users/aymanbaig/Desktop/Toiture-P1/frontend
npm run build 2>&1 | tail -20
```
  </verify>
  <done>
- QuoteTable renders with server-side pagination
- Column formatters display French locale formatting (CAD currency, dates)
- Pagination controls work (page changes, shows current/total)
- Export button downloads CSV with all filtered quotes
- French accents preserved in CSV (UTF-8 BOM)
- Loading state shown during data fetches
  </done>
</task>

</tasks>

<verification>
1. Start both backend and frontend:
```bash
cd backend && uvicorn app.main:app --reload &
cd frontend && npm run dev &
```

2. Visit http://localhost:3000/historique:
   - Table loads with quotes (or empty state if no data)
   - Pagination controls visible
   - Change page - data updates without full reload

3. Test filters:
   - Select a category - results filter
   - Enter city text - results filter
   - Set sqft range - results filter
   - Clear filters - all results return

4. Test export:
   - Apply some filters
   - Click "Exporter CSV"
   - File downloads
   - Open in Excel - French characters display correctly
</verification>

<success_criteria>
- Historique tab shows paginated quote table
- Pagination works (next/previous, page indicator accurate)
- All 6 filter types work (category, city, sqft min/max, price min/max, dates)
- Clear filters resets to show all
- Export downloads CSV with current filter applied
- French characters (accents) display correctly in CSV
- Loading indicator shows during data fetches
- Empty state shows when no results match filters
- `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/11-cortex-admin-dashboard/11-03-SUMMARY.md`
</output>
