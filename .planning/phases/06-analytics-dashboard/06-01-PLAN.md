---
phase: 06-analytics-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/src/lib/supabase/client.ts
  - frontend/src/lib/supabase/analytics.ts
  - frontend/src/lib/hooks/use-analytics.ts
  - frontend/src/types/analytics.ts
  - frontend/src/app/layout.tsx
  - frontend/src/providers/query-provider.tsx
autonomous: true

must_haves:
  truths:
    - "React Query provider wraps application for data caching"
    - "Supabase client can call RPC functions for analytics"
    - "Analytics hooks return typed accuracy data with loading states"
    - "Time period filter changes update query parameters"
  artifacts:
    - path: "frontend/src/providers/query-provider.tsx"
      provides: "QueryClientProvider wrapper"
      exports: ["QueryProvider"]
    - path: "frontend/src/lib/supabase/client.ts"
      provides: "Supabase browser client"
      exports: ["createClient"]
    - path: "frontend/src/lib/supabase/analytics.ts"
      provides: "RPC function calls for analytics"
      exports: ["getAccuracyStats", "getCategoryBreakdown", "getConfidenceAccuracy"]
    - path: "frontend/src/lib/hooks/use-analytics.ts"
      provides: "React Query hooks for dashboard data"
      exports: ["useAccuracyStats", "useCategoryBreakdown", "useConfidenceAccuracy"]
    - path: "frontend/src/types/analytics.ts"
      provides: "TypeScript interfaces for analytics data"
      exports: ["AccuracyStats", "CategoryBreakdown", "ConfidenceAccuracy", "TimePeriod"]
  key_links:
    - from: "frontend/src/lib/hooks/use-analytics.ts"
      to: "frontend/src/lib/supabase/analytics.ts"
      via: "import and call in useQuery"
      pattern: "import.*from.*analytics"
    - from: "frontend/src/app/layout.tsx"
      to: "frontend/src/providers/query-provider.tsx"
      via: "QueryProvider wrapping children"
      pattern: "QueryProvider"
---

<objective>
Install charting and data-fetching dependencies, create Supabase analytics functions, and set up React Query infrastructure for the dashboard.

Purpose: Establish the data layer that dashboard charts will consume. All analytics queries will use PostgreSQL RPC functions for efficient aggregation, with React Query handling caching and loading states.

Output: Working analytics hooks that fetch accuracy stats, category breakdown, and confidence correlation from Supabase with proper TypeScript typing and time period filtering.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-analytics-dashboard/06-RESEARCH.md

# Phase 4 established frontend patterns
@frontend/package.json
@frontend/src/app/layout.tsx
@frontend/src/lib/utils.ts

# Phase 5 provides Supabase schema (estimates table with ai_estimate, laurent_price, category, confidence, created_at)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create Supabase client</name>
  <files>
    frontend/package.json
    frontend/src/lib/supabase/client.ts
    frontend/src/types/analytics.ts
  </files>
  <action>
1. Install required packages:
   ```bash
   cd frontend && pnpm add recharts @tanstack/react-query @supabase/supabase-js date-fns
   ```

2. Add shadcn chart component:
   ```bash
   pnpm dlx shadcn@latest add chart toggle-group
   ```

3. Create frontend/src/lib/supabase/client.ts:
   - Export createClient function that creates Supabase browser client
   - Read NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY from env
   - Use createBrowserClient from @supabase/ssr (or createClient from @supabase/supabase-js for client-side)

4. Create frontend/src/types/analytics.ts with interfaces:
   - TimePeriod = "7d" | "30d" | "all"
   - AccuracyStats: { total_estimates, reviewed_count, within_10_percent, within_20_percent, accuracy_10, accuracy_20 }
   - CategoryBreakdown: { category, count, percentage }
   - ConfidenceAccuracy: { confidence, total_count, reviewed_count, accuracy_10, accuracy_20 }
  </action>
  <verify>
    Run `cd frontend && pnpm tsc --noEmit` - should pass with no errors.
    Check `pnpm list recharts @tanstack/react-query @supabase/supabase-js date-fns` shows all installed.
  </verify>
  <done>
    Dependencies installed, Supabase client created, analytics types defined. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create React Query provider and analytics hooks</name>
  <files>
    frontend/src/providers/query-provider.tsx
    frontend/src/lib/supabase/analytics.ts
    frontend/src/lib/hooks/use-analytics.ts
    frontend/src/app/layout.tsx
  </files>
  <action>
1. Create frontend/src/providers/query-provider.tsx:
   - "use client" directive (client component)
   - Create QueryClient with default options: staleTime 5 minutes, refetchOnWindowFocus true
   - Export QueryProvider component that wraps children with QueryClientProvider
   - Use useState to ensure QueryClient is created once per client session

2. Update frontend/src/app/layout.tsx:
   - Import QueryProvider
   - Wrap {children} with QueryProvider inside body

3. Create frontend/src/lib/supabase/analytics.ts with async functions:
   - getAccuracyStats(startDate?: Date, endDate?: Date): Promise<AccuracyStats>
     Calls supabase.rpc("get_accuracy_stats", { start_date, end_date })
   - getCategoryBreakdown(startDate?: Date, endDate?: Date): Promise<CategoryBreakdown[]>
     Calls supabase.rpc("get_category_breakdown", { start_date, end_date })
   - getConfidenceAccuracy(startDate?: Date, endDate?: Date): Promise<ConfidenceAccuracy[]>
     Calls supabase.rpc("get_confidence_accuracy", { start_date, end_date })
   - Handle null/undefined dates by passing null to RPC
   - Throw on error, return data on success

4. Create frontend/src/lib/hooks/use-analytics.ts:
   - "use client" directive
   - Helper function getDateRange(period: TimePeriod) using date-fns subDays/startOfDay
   - useAccuracyStats(period: TimePeriod) - returns useQuery with queryKey ["accuracy-stats", period]
   - useCategoryBreakdown(period: TimePeriod) - returns useQuery with queryKey ["category-breakdown", period]
   - useConfidenceAccuracy(period: TimePeriod) - returns useQuery with queryKey ["confidence-accuracy", period]
   - All hooks use staleTime: 5 minutes (1000 * 60 * 5)
  </action>
  <verify>
    Run `cd frontend && pnpm tsc --noEmit` - should pass.
    Run `cd frontend && pnpm build` - should build successfully (may warn about missing env vars, that's OK).
  </verify>
  <done>
    React Query provider wraps app, analytics service functions call Supabase RPC, typed hooks ready for dashboard components. Build passes.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `cd frontend && pnpm tsc --noEmit` passes
2. `cd frontend && pnpm build` succeeds
3. Files exist: providers/query-provider.tsx, lib/supabase/client.ts, lib/supabase/analytics.ts, lib/hooks/use-analytics.ts, types/analytics.ts
4. layout.tsx imports and uses QueryProvider
</verification>

<success_criteria>
- All dependencies installed (recharts, @tanstack/react-query, @supabase/supabase-js, date-fns)
- shadcn chart and toggle-group components added
- Supabase client configured for browser use
- Analytics types match expected RPC return shapes
- React Query hooks provide typed data fetching with loading/error states
- Provider wraps application in layout.tsx
</success_criteria>

<output>
After completion, create `.planning/phases/06-analytics-dashboard/06-01-SUMMARY.md`
</output>
