---
phase: 14-full-quote-frontend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/types/hybrid-quote.ts
  - frontend/src/lib/api/hybrid-quote.ts
  - frontend/src/components/estimateur/complexity-presets.tsx
  - frontend/src/lib/schemas/hybrid-quote.ts
autonomous: true

must_haves:
  truths:
    - "User can select complexity preset (Simple/Modere/Complexe)"
    - "User can override individual complexity factors via sliders"
    - "Complexity aggregate auto-computes from 6 factors"
    - "API client can POST to /estimate/hybrid with proper types"
  artifacts:
    - path: "frontend/src/types/hybrid-quote.ts"
      provides: "TypeScript types matching backend HybridQuoteResponse"
      exports: ["HybridQuoteRequest", "HybridQuoteResponse", "WorkItem", "PricingTier"]
    - path: "frontend/src/lib/api/hybrid-quote.ts"
      provides: "API client for hybrid quote endpoint"
      exports: ["submitHybridQuote"]
    - path: "frontend/src/components/estimateur/complexity-presets.tsx"
      provides: "Preset selector with 6-factor override"
      exports: ["ComplexityPresets"]
    - path: "frontend/src/lib/schemas/hybrid-quote.ts"
      provides: "Zod schema for form validation"
      exports: ["hybridQuoteFormSchema", "HybridQuoteFormData"]
  key_links:
    - from: "frontend/src/types/hybrid-quote.ts"
      to: "backend/app/schemas/hybrid_quote.py"
      via: "Type parity"
      pattern: "WorkItem.*source.*CBR|ML|MERGED"
    - from: "frontend/src/lib/api/hybrid-quote.ts"
      to: "/estimate/hybrid"
      via: "fetch POST"
      pattern: "fetch.*estimate/hybrid"
---

<objective>
Create TypeScript types, API client, and complexity presets component for hybrid quote integration.

Purpose: Foundation layer that enables form submission and complexity input for full quote generation.
Output: Types mirroring backend, API client, reusable complexity presets component with 6-factor sliders.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-full-quote-frontend/14-CONTEXT.md

# Backend schema to match
@backend/app/schemas/hybrid_quote.py

# Frontend patterns to follow
@frontend/src/lib/api.ts
@frontend/src/lib/schemas.ts
@frontend/src/components/estimate-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript types and Zod schema</name>
  <files>
    frontend/src/types/hybrid-quote.ts
    frontend/src/lib/schemas/hybrid-quote.ts
  </files>
  <action>
Create TypeScript types in `frontend/src/types/hybrid-quote.ts` that exactly mirror the backend Pydantic models from `backend/app/schemas/hybrid_quote.py`:

1. **HybridQuoteRequest** - All fields from backend:
   - sqft: number
   - category: string
   - complexity_aggregate: number (0-56)
   - access_difficulty: number (0-10)
   - roof_pitch: number (0-8)
   - penetrations: number (0-10)
   - material_removal: number (0-8)
   - safety_concerns: number (0-10)
   - timeline_constraints: number (0-10)
   - has_chimney: boolean
   - has_skylights: boolean
   - material_lines: number
   - labor_lines: number
   - has_subs: boolean
   - quoted_total?: number | null

2. **WorkItem** interface:
   - name: string
   - labor_hours: number
   - source: "CBR" | "ML" | "MERGED"

3. **MaterialLineItem** interface:
   - material_id: number
   - quantity: number
   - unit_price: number
   - total: number
   - source: "CBR" | "ML" | "MERGED"
   - confidence: number

4. **PricingTier** interface:
   - tier: "Basic" | "Standard" | "Premium"
   - total_price: number
   - materials_cost: number
   - labor_cost: number
   - description: string

5. **HybridQuoteResponse** interface:
   - work_items: WorkItem[]
   - materials: MaterialLineItem[]
   - total_labor_hours: number
   - total_materials_cost: number
   - total_price: number
   - overall_confidence: number
   - reasoning: string
   - pricing_tiers: PricingTier[]
   - request_id: string | null
   - needs_review: boolean
   - cbr_cases_used: number
   - ml_confidence: "HIGH" | "MEDIUM" | "LOW"
   - processing_time_ms: number

Create Zod schema in `frontend/src/lib/schemas/hybrid-quote.ts`:
- Import CATEGORIES from existing schemas.ts
- Create `hybridQuoteFormSchema` with all fields
- Add validation: sqft > 0, complexity factors within their ranges
- Export type `HybridQuoteFormData = z.infer<typeof hybridQuoteFormSchema>`

Note: Create the `frontend/src/lib/schemas/` directory if it doesn't exist.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd frontend && npx tsc --noEmit
```
  </verify>
  <done>
Types exist at frontend/src/types/hybrid-quote.ts with all interfaces exported.
Zod schema exists at frontend/src/lib/schemas/hybrid-quote.ts with form validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: API client for hybrid quote</name>
  <files>frontend/src/lib/api/hybrid-quote.ts</files>
  <action>
Create API client in `frontend/src/lib/api/hybrid-quote.ts` following the pattern from `frontend/src/lib/api.ts`:

```typescript
import type { HybridQuoteRequest, HybridQuoteResponse } from "@/types/hybrid-quote";

const API_URL = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8000";

interface ApiError {
  detail: string;
}

/**
 * Submit hybrid quote request to backend
 *
 * @param data - Validated form data matching HybridQuoteRequest
 * @returns HybridQuoteResponse with work items, materials, pricing tiers
 * @throws Error with detail message on failure
 */
export async function submitHybridQuote(
  data: HybridQuoteRequest
): Promise<HybridQuoteResponse> {
  const response = await fetch(`${API_URL}/estimate/hybrid`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(data),
  });

  if (!response.ok) {
    let errorMessage = "Failed to generate quote";
    try {
      const errorData: ApiError = await response.json();
      errorMessage = errorData.detail || errorMessage;
    } catch {
      errorMessage = response.statusText || errorMessage;
    }
    throw new Error(errorMessage);
  }

  return response.json();
}
```

Note: Create the `frontend/src/lib/api/` directory if it doesn't exist.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd frontend && npx tsc --noEmit
```
  </verify>
  <done>
API client exists at frontend/src/lib/api/hybrid-quote.ts with submitHybridQuote function.
  </done>
</task>

<task type="auto">
  <name>Task 3: Complexity presets component</name>
  <files>frontend/src/components/estimateur/complexity-presets.tsx</files>
  <action>
Create complexity presets component with 6-factor override sliders:

1. **Preset values** (from CONTEXT.md):
   | Factor | Simple | Modere | Complexe |
   |--------|--------|--------|----------|
   | access_difficulty (0-10) | 2 | 5 | 8 |
   | roof_pitch (0-8) | 2 | 4 | 6 |
   | penetrations (0-10) | 1 | 5 | 8 |
   | material_removal (0-8) | 2 | 4 | 6 |
   | safety_concerns (0-10) | 2 | 5 | 8 |
   | timeline_constraints (0-10) | 2 | 5 | 8 |

2. **Component structure:**
   - Radio group for preset selection (Simple/Modere/Complexe)
   - Collapsible section "Personnaliser les facteurs" (default collapsed)
   - 6 sliders with French labels when expanded
   - Auto-compute complexity_aggregate as sum of 6 factors
   - When preset changes, update all 6 factors
   - When any slider changes, clear preset selection (custom mode)

3. **Props interface:**
```typescript
interface ComplexityPresetsProps {
  value: {
    preset: "Simple" | "Modere" | "Complexe" | null;
    access_difficulty: number;
    roof_pitch: number;
    penetrations: number;
    material_removal: number;
    safety_concerns: number;
    timeline_constraints: number;
  };
  onChange: (value: ComplexityPresetsProps["value"]) => void;
}
```

4. **French labels:**
   - "Complexite du travail"
   - "Difficulte d'acces"
   - "Pente du toit"
   - "Penetrations"
   - "Retrait de materiaux"
   - "Preoccupations de securite"
   - "Contraintes de delai"

5. **UI components to use:**
   - ToggleGroup from @radix-ui/react-toggle-group for presets
   - Collapsible from shadcn/ui pattern (ChevronDown icon)
   - Slider from @/components/ui/slider for each factor
   - Show computed aggregate: "Total: {sum}/56"

Note: Use existing ui components. Style with Tailwind. Add appropriate aria labels for accessibility.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd frontend && npx tsc --noEmit
```
  </verify>
  <done>
Component exists at frontend/src/components/estimateur/complexity-presets.tsx.
Preset selection updates all 6 factors.
Custom slider adjustments clear preset selection.
Aggregate displays as sum of factors.
  </done>
</task>

</tasks>

<verification>
1. All TypeScript files compile without errors
2. Types match backend schema structure
3. API client follows existing patterns from api.ts
4. Complexity presets component is reusable
</verification>

<success_criteria>
- TypeScript types exist matching HybridQuoteRequest/Response from backend
- Zod schema validates form input with proper ranges
- API client can POST to /estimate/hybrid
- Complexity presets component renders with 3 presets and 6 sliders
- All files pass TypeScript compilation
</success_criteria>

<output>
After completion, create `.planning/phases/14-full-quote-frontend/14-01-SUMMARY.md`
</output>
