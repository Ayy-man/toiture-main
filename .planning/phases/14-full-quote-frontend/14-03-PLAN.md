---
phase: 14-full-quote-frontend
plan: 03
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - frontend/package.json
  - frontend/src/lib/pdf/quote-template.tsx
  - frontend/src/components/estimateur/quote-actions.tsx
autonomous: true

must_haves:
  truths:
    - "User can click Export PDF button to download client-facing PDF"
    - "PDF displays work items WITHOUT labor hours"
    - "PDF shows materials total, labor total, and grand total"
    - "PDF has professional formatting suitable for clients"
    - "Filename follows pattern: Soumission-{category}-{date}.pdf"
  artifacts:
    - path: "frontend/src/lib/pdf/quote-template.tsx"
      provides: "React-PDF template for client quotes"
      exports: ["QuotePDFDocument"]
    - path: "frontend/src/components/estimateur/quote-actions.tsx"
      provides: "Export/action buttons for quote"
      exports: ["QuoteActions"]
  key_links:
    - from: "frontend/src/components/estimateur/quote-actions.tsx"
      to: "frontend/src/lib/pdf/quote-template.tsx"
      via: "pdf() function call"
      pattern: "pdf.*QuotePDFDocument"
    - from: "frontend/src/lib/pdf/quote-template.tsx"
      to: "@react-pdf/renderer"
      via: "Document/Page/View imports"
      pattern: "from.*@react-pdf/renderer"
---

<objective>
Add PDF export capability for client-facing quotes without labor hours.

Purpose: Enable users to generate professional PDF quotes for clients that exclude internal details like labor hours.
Output: QuotePDFDocument template and QuoteActions component with working PDF download.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-full-quote-frontend/14-CONTEXT.md

# Plan 01 types needed
@frontend/src/types/hybrid-quote.ts

# Existing package.json
@frontend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @react-pdf/renderer and create PDF template</name>
  <files>
    frontend/package.json
    frontend/src/lib/pdf/quote-template.tsx
  </files>
  <action>
**Part A: Install dependency**

Install @react-pdf/renderer for client-side PDF generation:
```bash
cd frontend && pnpm add @react-pdf/renderer
```

**Part B: Create PDF template**

Create `frontend/src/lib/pdf/quote-template.tsx`:

```typescript
import {
  Document,
  Page,
  Text,
  View,
  StyleSheet,
} from "@react-pdf/renderer";
import type { HybridQuoteResponse, WorkItem, PricingTier } from "@/types/hybrid-quote";

const styles = StyleSheet.create({
  page: {
    padding: 40,
    fontFamily: "Helvetica",
    fontSize: 11,
  },
  header: {
    marginBottom: 30,
    textAlign: "center",
  },
  title: {
    fontSize: 24,
    fontWeight: "bold",
    marginBottom: 8,
  },
  subtitle: {
    fontSize: 12,
    color: "#666",
  },
  section: {
    marginBottom: 20,
  },
  sectionTitle: {
    fontSize: 13,
    fontWeight: "bold",
    borderBottomWidth: 1,
    borderBottomColor: "#333",
    paddingBottom: 4,
    marginBottom: 10,
    textTransform: "uppercase",
  },
  row: {
    flexDirection: "row",
    justifyContent: "space-between",
    paddingVertical: 4,
  },
  workItem: {
    flexDirection: "row",
    paddingVertical: 3,
  },
  bullet: {
    width: 15,
  },
  itemText: {
    flex: 1,
  },
  summaryRow: {
    flexDirection: "row",
    justifyContent: "space-between",
    paddingVertical: 6,
  },
  totalRow: {
    flexDirection: "row",
    justifyContent: "space-between",
    paddingVertical: 10,
    borderTopWidth: 2,
    borderTopColor: "#333",
    marginTop: 10,
  },
  totalLabel: {
    fontSize: 14,
    fontWeight: "bold",
  },
  totalValue: {
    fontSize: 14,
    fontWeight: "bold",
  },
  footer: {
    position: "absolute",
    bottom: 30,
    left: 40,
    right: 40,
    textAlign: "center",
    fontSize: 9,
    color: "#666",
  },
  infoRow: {
    flexDirection: "row",
    marginBottom: 4,
  },
  infoLabel: {
    width: 100,
    fontWeight: "bold",
  },
  infoValue: {
    flex: 1,
  },
});

interface QuotePDFDocumentProps {
  quote: HybridQuoteResponse;
  category: string;
  sqft: number;
  date: string;
}

// Format number as CAD currency (French Canadian format)
function formatCAD(amount: number): string {
  return new Intl.NumberFormat("fr-CA", {
    style: "currency",
    currency: "CAD",
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(amount);
}

export function QuotePDFDocument({
  quote,
  category,
  sqft,
  date,
}: QuotePDFDocumentProps) {
  // Get Standard tier for pricing
  const standardTier = quote.pricing_tiers.find(
    (tier) => tier.tier === "Standard"
  ) as PricingTier;

  return (
    <Document>
      <Page size="A4" style={styles.page}>
        {/* Header */}
        <View style={styles.header}>
          <Text style={styles.title}>SOUMISSION</Text>
          <Text style={styles.subtitle}>Toiture LV</Text>
        </View>

        {/* Job Info */}
        <View style={styles.section}>
          <View style={styles.infoRow}>
            <Text style={styles.infoLabel}>Date:</Text>
            <Text style={styles.infoValue}>{date}</Text>
          </View>
          <View style={styles.infoRow}>
            <Text style={styles.infoLabel}>Categorie:</Text>
            <Text style={styles.infoValue}>{category}</Text>
          </View>
          <View style={styles.infoRow}>
            <Text style={styles.infoLabel}>Superficie:</Text>
            <Text style={styles.infoValue}>
              {sqft.toLocaleString("fr-CA")} pi2
            </Text>
          </View>
        </View>

        {/* Work Items - NO HOURS (client facing) */}
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Travaux</Text>
          {quote.work_items.map((item: WorkItem, index: number) => (
            <View key={index} style={styles.workItem}>
              <Text style={styles.bullet}>â€¢</Text>
              <Text style={styles.itemText}>{item.name}</Text>
            </View>
          ))}
        </View>

        {/* Summary */}
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Sommaire</Text>
          <View style={styles.summaryRow}>
            <Text>Materiaux</Text>
            <Text>{formatCAD(standardTier.materials_cost)}</Text>
          </View>
          <View style={styles.summaryRow}>
            <Text>Main-d&apos;oeuvre</Text>
            <Text>{formatCAD(standardTier.labor_cost)}</Text>
          </View>
          <View style={styles.totalRow}>
            <Text style={styles.totalLabel}>TOTAL</Text>
            <Text style={styles.totalValue}>
              {formatCAD(standardTier.total_price)}
            </Text>
          </View>
        </View>

        {/* Footer */}
        <Text style={styles.footer}>
          Cette soumission est valide pour 30 jours a compter de la date
          d&apos;emission.
        </Text>
      </Page>
    </Document>
  );
}
```

Key differences from internal view:
- NO labor hours shown for work items (just names)
- NO confidence warning
- NO reasoning section
- Professional header with Toiture LV branding
- Validity footer note
  </action>
  <verify>
1. Package installed:
```bash
cd frontend && pnpm list @react-pdf/renderer
```
2. TypeScript compiles:
```bash
cd frontend && npx tsc --noEmit
```
  </verify>
  <done>
@react-pdf/renderer installed in package.json.
QuotePDFDocument component exists in frontend/src/lib/pdf/quote-template.tsx.
PDF layout excludes labor hours (client-facing).
  </done>
</task>

<task type="auto">
  <name>Task 2: Quote actions component with PDF export</name>
  <files>frontend/src/components/estimateur/quote-actions.tsx</files>
  <action>
Create quote actions component with PDF export button:

```typescript
"use client";

import { useState } from "react";
import { pdf } from "@react-pdf/renderer";
import { Button } from "@/components/ui/button";
import { FileDown, Loader2 } from "lucide-react";
import { QuotePDFDocument } from "@/lib/pdf/quote-template";
import type { HybridQuoteResponse } from "@/types/hybrid-quote";
import { fr } from "@/lib/i18n/fr";

interface QuoteActionsProps {
  quote: HybridQuoteResponse;
  category: string;
  sqft: number;
}

export function QuoteActions({ quote, category, sqft }: QuoteActionsProps) {
  const [isExporting, setIsExporting] = useState(false);

  async function handleExportPDF() {
    setIsExporting(true);
    try {
      // Format date for filename and document
      const now = new Date();
      const dateStr = now.toLocaleDateString("fr-CA"); // YYYY-MM-DD format
      const filenameDateStr = now.toISOString().split("T")[0]; // YYYY-MM-DD

      // Generate PDF blob
      const blob = await pdf(
        <QuotePDFDocument
          quote={quote}
          category={category}
          sqft={sqft}
          date={dateStr}
        />
      ).toBlob();

      // Create download link
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `Soumission-${category}-${filenameDateStr}.pdf`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    } catch (error) {
      console.error("PDF export failed:", error);
    } finally {
      setIsExporting(false);
    }
  }

  return (
    <div className="flex flex-wrap gap-3 pt-4 border-t">
      <Button
        variant="outline"
        onClick={handleExportPDF}
        disabled={isExporting}
      >
        {isExporting ? (
          <>
            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
            {fr.common.chargement}
          </>
        ) : (
          <>
            <FileDown className="mr-2 h-4 w-4" />
            {fr.fullQuote.exporterPDF}
          </>
        )}
      </Button>

      {/* Future buttons for Send and Save (Phase 14C) */}
      {/*
      <Button variant="outline" disabled>
        <Mail className="mr-2 h-4 w-4" />
        {fr.fullQuote.envoyer}
      </Button>
      <Button variant="outline" disabled>
        <Save className="mr-2 h-4 w-4" />
        {fr.fullQuote.sauvegarder}
      </Button>
      */}
    </div>
  );
}
```

Also add the missing i18n key to fr.ts (in fullQuote section):
```typescript
exporterPDF: "Exporter PDF",
```

**Integration with quote-result.tsx:**

Update quote-result.tsx to include QuoteActions at the bottom:
1. Import QuoteActions component
2. Add QuoteActions below the reasoning section
3. Pass quote, category, and sqft props

The QuoteActions should be placed at the bottom of the QuoteResult component, inside the Card but after the reasoning accordion.
  </action>
  <verify>
1. TypeScript compiles:
```bash
cd frontend && npx tsc --noEmit
```
2. Manual test:
- Start dev server: `cd frontend && npm run dev`
- Navigate to /estimateur/complet
- Generate a quote
- Click "Exporter PDF" button
- Verify PDF downloads with correct filename
- Open PDF and verify: work items show WITHOUT hours, totals display correctly
  </verify>
  <done>
QuoteActions component exists with working PDF export.
PDF downloads with filename pattern: Soumission-{category}-{date}.pdf.
PDF content is client-facing (no hours, no confidence, no reasoning).
Export button shows loading state during generation.
  </done>
</task>

</tasks>

<verification>
1. Generate a quote via the form
2. Click "Exporter PDF" button
3. PDF downloads immediately
4. Open PDF and verify:
   - Header shows "SOUMISSION" and "Toiture LV"
   - Category and superficie display correctly
   - Work items list WITHOUT hours (just bullet + name)
   - Summary shows Materials, Labor, Total
   - Footer shows validity notice
5. Filename is: Soumission-{category}-YYYY-MM-DD.pdf
</verification>

<success_criteria>
- @react-pdf/renderer installed and working
- PDF template renders professional client-facing layout
- No labor hours visible in PDF (only work item names)
- Export button triggers download
- Filename follows correct pattern
- French text throughout PDF
</success_criteria>

<output>
After completion, create `.planning/phases/14-full-quote-frontend/14-03-SUMMARY.md`
</output>
