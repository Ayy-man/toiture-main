---
phase: 24-export-send-red-flags
plan: 03
type: execute
wave: 2
depends_on: ["24-01", "24-02"]
files_modified:
  - frontend/src/components/submissions/send-dialog.tsx
  - frontend/src/components/submissions/red-flag-banner.tsx
  - frontend/src/lib/api/submissions.ts
  - frontend/src/lib/i18n/fr.ts
  - frontend/src/lib/i18n/en.ts
autonomous: true

must_haves:
  truths:
    - "User sees a 'Send' button on approved submissions that opens the send dialog"
    - "Send dialog offers 3 options: Send now, Schedule send, Save as draft"
    - "Send now option requires email input and sends immediately"
    - "Schedule option shows date+time picker for future delivery"
    - "Draft option saves without sending"
    - "Red flag warnings appear as dismissible alert banners before the send dialog confirm button"
    - "Red flags show bilingual messages based on current locale"
    - "Critical red flags show destructive styling, warnings show amber/yellow styling"
    - "User can dismiss individual red flags (dismiss action logged via API)"
    - "All send dialog and red flag UI labels are bilingual (FR/EN)"
    - "API client has functions for getRedFlags, sendSubmission, dismissFlags"
  artifacts:
    - path: "frontend/src/components/submissions/send-dialog.tsx"
      provides: "Send dialog with radio group (now/schedule/draft), email input, date-time picker, red flag integration"
      min_lines: 100
    - path: "frontend/src/components/submissions/red-flag-banner.tsx"
      provides: "Dismissible alert banners for red flag warnings"
      exports: ["RedFlagBanner"]
    - path: "frontend/src/lib/api/submissions.ts"
      provides: "Extended API client with getRedFlags, sendSubmission, dismissFlags functions"
      contains: "getRedFlags"
    - path: "frontend/src/lib/i18n/fr.ts"
      provides: "French i18n keys for send dialog and red flags"
      contains: "redFlags"
    - path: "frontend/src/lib/i18n/en.ts"
      provides: "English i18n keys for send dialog and red flags"
      contains: "redFlags"
  key_links:
    - from: "frontend/src/components/submissions/send-dialog.tsx"
      to: "frontend/src/lib/api/submissions.ts"
      via: "getRedFlags(), sendSubmission(), dismissFlags() API calls"
      pattern: "getRedFlags|sendSubmission|dismissFlags"
    - from: "frontend/src/components/submissions/send-dialog.tsx"
      to: "frontend/src/components/submissions/red-flag-banner.tsx"
      via: "RedFlagBanner component rendering inside dialog"
      pattern: "RedFlagBanner"
    - from: "frontend/src/components/submissions/red-flag-banner.tsx"
      to: "frontend/src/lib/i18n"
      via: "useLanguage() hook for bilingual flag messages"
      pattern: "useLanguage"
---

<objective>
Build the frontend send dialog and red flag warning UI. This includes: a send dialog component with 3 send options (now/schedule/draft), red flag dismissible banner component, API client extensions for red flags and sending, and all i18n keys for both features.

Purpose: This is the user-facing interface for sending quotes to clients. Red flag warnings prevent accidental sending of risky submissions. The dialog provides flexibility (immediate, scheduled, or draft).

Output: 2 new frontend components, extended API client, complete i18n coverage for send and red flag features.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-export-send-red-flags/24-RESEARCH.md
@.planning/phases/24-export-send-red-flags/24-01-SUMMARY.md
@.planning/phases/24-export-send-red-flags/24-02-SUMMARY.md
@frontend/src/lib/i18n/fr.ts
@frontend/src/lib/i18n/en.ts
@frontend/src/lib/api/submissions.ts
@frontend/src/components/ui/dialog.tsx
@frontend/src/components/ui/radio-group.tsx
@frontend/src/components/ui/input.tsx
@frontend/src/components/ui/button.tsx
@frontend/src/components/ui/textarea.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Red flag banner component, send dialog, and API client extensions</name>
  <files>
    frontend/src/components/submissions/red-flag-banner.tsx
    frontend/src/components/submissions/send-dialog.tsx
    frontend/src/lib/api/submissions.ts
  </files>
  <action>
**1. Create `frontend/src/components/submissions/` directory if it doesn't exist.**

**2. Extend `frontend/src/lib/api/submissions.ts`:**

Read the existing file first (created by Phase 23-02). Add these 3 new functions at the end of the file, following the existing fetch pattern (same API_URL construction, same error handling):

```typescript
// Red flag types
export interface RedFlag {
  category: string;
  severity: "warning" | "critical";
  message_fr: string;
  message_en: string;
  dismissible: boolean;
}

// Send request types
export interface SendSubmissionRequest {
  send_option: "now" | "schedule" | "draft";
  recipient_email?: string;
  email_subject?: string;
  email_body?: string;
  scheduled_send_at?: string; // ISO datetime string
}

export async function getRedFlags(submissionId: string): Promise<RedFlag[]> {
  const res = await fetch(`${API_URL}/submissions/${submissionId}/red-flags`);
  if (!res.ok) throw new Error(`Failed to get red flags: ${res.status}`);
  return res.json();
}

export async function sendSubmission(
  submissionId: string,
  request: SendSubmissionRequest
): Promise<{ status: string; send_status: string }> {
  const res = await fetch(`${API_URL}/submissions/${submissionId}/send`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(request),
  });
  if (!res.ok) {
    const err = await res.json().catch(() => ({ detail: "Send failed" }));
    throw new Error(err.detail || `Send failed: ${res.status}`);
  }
  return res.json();
}

export async function dismissFlags(
  submissionId: string,
  categories: string[],
  dismissedBy: string = "estimator"
): Promise<{ status: string }> {
  const res = await fetch(`${API_URL}/submissions/${submissionId}/dismiss-flags`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      dismissed_categories: categories,
      dismissed_by: dismissedBy,
    }),
  });
  if (!res.ok) throw new Error(`Failed to dismiss flags: ${res.status}`);
  return res.json();
}
```

Note: `API_URL` should already be defined at the top of the file from Phase 23. Use the same constant.

**3. Create `frontend/src/components/submissions/red-flag-banner.tsx`:**

```tsx
"use client";

import { useState } from "react";
import { AlertTriangle, X } from "lucide-react";
import { useLanguage } from "@/lib/i18n";
import { Button } from "@/components/ui/button";
import type { RedFlag } from "@/lib/api/submissions";

interface RedFlagBannerProps {
  flags: RedFlag[];
  onDismiss?: (category: string) => void;
}

export function RedFlagBanner({ flags, onDismiss }: RedFlagBannerProps) {
  const { locale } = useLanguage();
  // Check if useLanguage returns `locale` or `language` — adjust field name accordingly
  const [dismissed, setDismissed] = useState<Set<string>>(new Set());

  const visibleFlags = flags.filter((f) => !dismissed.has(f.category));

  if (visibleFlags.length === 0) return null;

  function handleDismiss(category: string) {
    setDismissed((prev) => new Set(prev).add(category));
    onDismiss?.(category);
  }

  return (
    <div className="space-y-2 mb-4">
      {visibleFlags.map((flag) => {
        const isCritical = flag.severity === "critical";
        const message = locale === "fr" ? flag.message_fr : flag.message_en;

        return (
          <div
            key={flag.category}
            className={`flex items-start gap-3 rounded-lg border p-3 text-sm ${
              isCritical
                ? "border-destructive/50 bg-destructive/10 text-destructive"
                : "border-yellow-500/50 bg-yellow-500/10 text-yellow-700 dark:text-yellow-400"
            }`}
          >
            <AlertTriangle className="h-4 w-4 mt-0.5 flex-shrink-0" />
            <div className="flex-1">
              <p className="font-medium">{message}</p>
            </div>
            {flag.dismissible && (
              <Button
                variant="ghost"
                size="sm"
                className="h-6 w-6 p-0 flex-shrink-0"
                onClick={() => handleDismiss(flag.category)}
              >
                <X className="h-3 w-3" />
              </Button>
            )}
          </div>
        );
      })}
    </div>
  );
}
```

Note: This uses Tailwind classes directly rather than shadcn Alert component (which doesn't exist in the ui/ directory). Destructive variant for critical flags, yellow/amber for warnings.

**4. Create `frontend/src/components/submissions/send-dialog.tsx`:**

```tsx
"use client";

import { useState, useEffect } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from "@/components/ui/dialog";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";
import { Loader2, Send, Clock, Save } from "lucide-react";
import { useLanguage } from "@/lib/i18n";
import { RedFlagBanner } from "./red-flag-banner";
import {
  getRedFlags,
  sendSubmission,
  dismissFlags as dismissFlagsAPI,
  type RedFlag,
  type SendSubmissionRequest,
} from "@/lib/api/submissions";

interface SendDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  submissionId: string;
  onSendComplete?: (status: string) => void;
}

export function SendDialog({
  open,
  onOpenChange,
  submissionId,
  onSendComplete,
}: SendDialogProps) {
  const { t, locale } = useLanguage();
  // Adjust field names from useLanguage hook as needed

  const [sendOption, setSendOption] = useState<"now" | "schedule" | "draft">("now");
  const [recipientEmail, setRecipientEmail] = useState("");
  const [emailSubject, setEmailSubject] = useState("");
  const [emailBody, setEmailBody] = useState("");
  const [scheduledDate, setScheduledDate] = useState("");
  const [scheduledTime, setScheduledTime] = useState("09:00");
  const [redFlags, setRedFlags] = useState<RedFlag[]>([]);
  const [dismissedCategories, setDismissedCategories] = useState<string[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isSending, setIsSending] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Fetch red flags when dialog opens
  useEffect(() => {
    if (open && submissionId) {
      setIsLoading(true);
      setError(null);
      getRedFlags(submissionId)
        .then(setRedFlags)
        .catch((err) => {
          console.error("Failed to fetch red flags:", err);
          setRedFlags([]);
        })
        .finally(() => setIsLoading(false));
    }
  }, [open, submissionId]);

  function handleDismissFlag(category: string) {
    setDismissedCategories((prev) => [...prev, category]);
  }

  async function handleSend() {
    setIsSending(true);
    setError(null);

    try {
      // Log dismissed flags if any
      if (dismissedCategories.length > 0) {
        await dismissFlagsAPI(submissionId, dismissedCategories);
      }

      // Build scheduled datetime if scheduling
      let scheduledSendAt: string | undefined;
      if (sendOption === "schedule" && scheduledDate && scheduledTime) {
        // Combine date + time, assume America/Montreal timezone
        const dateTimeStr = `${scheduledDate}T${scheduledTime}:00`;
        scheduledSendAt = new Date(dateTimeStr).toISOString();
      }

      const request: SendSubmissionRequest = {
        send_option: sendOption,
        recipient_email: sendOption !== "draft" ? recipientEmail : undefined,
        email_subject: emailSubject || undefined,
        email_body: emailBody || undefined,
        scheduled_send_at: scheduledSendAt,
      };

      const result = await sendSubmission(submissionId, request);
      onSendComplete?.(result.send_status);
      onOpenChange(false);

      // Reset form
      setSendOption("now");
      setRecipientEmail("");
      setEmailSubject("");
      setEmailBody("");
      setScheduledDate("");
      setScheduledTime("09:00");
      setDismissedCategories([]);
    } catch (err) {
      setError(err instanceof Error ? err.message : "Send failed");
    } finally {
      setIsSending(false);
    }
  }

  const showEmailFields = sendOption === "now" || sendOption === "schedule";

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle>{t.sendDialog?.titre || "Envoyer la soumission"}</DialogTitle>
          <DialogDescription>
            {t.sendDialog?.description || "Choisissez comment envoyer cette soumission"}
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          {/* Red flag warnings */}
          {isLoading ? (
            <div className="flex items-center gap-2 text-sm text-muted-foreground">
              <Loader2 className="h-4 w-4 animate-spin" />
              {t.common?.chargement || "Chargement..."}
            </div>
          ) : (
            <RedFlagBanner flags={redFlags} onDismiss={handleDismissFlag} />
          )}

          {/* Send option selection */}
          <RadioGroup
            value={sendOption}
            onValueChange={(v) => setSendOption(v as "now" | "schedule" | "draft")}
            className="space-y-3"
          >
            <div className="flex items-center space-x-3">
              <RadioGroupItem value="now" id="send-now" />
              <Label htmlFor="send-now" className="flex items-center gap-2 cursor-pointer">
                <Send className="h-4 w-4" />
                {t.sendDialog?.envoyerMaintenant || "Envoyer maintenant"}
              </Label>
            </div>
            <div className="flex items-center space-x-3">
              <RadioGroupItem value="schedule" id="send-schedule" />
              <Label htmlFor="send-schedule" className="flex items-center gap-2 cursor-pointer">
                <Clock className="h-4 w-4" />
                {t.sendDialog?.planifier || "Planifier l'envoi"}
              </Label>
            </div>
            <div className="flex items-center space-x-3">
              <RadioGroupItem value="draft" id="send-draft" />
              <Label htmlFor="send-draft" className="flex items-center gap-2 cursor-pointer">
                <Save className="h-4 w-4" />
                {t.sendDialog?.sauvegarderBrouillon || "Sauvegarder comme brouillon"}
              </Label>
            </div>
          </RadioGroup>

          {/* Schedule date+time picker */}
          {sendOption === "schedule" && (
            <div className="space-y-2">
              <Label>{t.sendDialog?.dateHeure || "Date et heure d'envoi"}</Label>
              <div className="flex gap-2">
                <Input
                  type="date"
                  value={scheduledDate}
                  onChange={(e) => setScheduledDate(e.target.value)}
                  min={new Date().toISOString().split("T")[0]}
                  className="flex-1"
                />
                <Input
                  type="time"
                  value={scheduledTime}
                  onChange={(e) => setScheduledTime(e.target.value)}
                  className="w-32"
                />
              </div>
            </div>
          )}

          {/* Email fields (shown for send now and schedule) */}
          {showEmailFields && (
            <div className="space-y-3">
              <div className="space-y-2">
                <Label>{t.sendDialog?.destinataire || "Destinataire"}</Label>
                <Input
                  type="email"
                  placeholder="client@example.com"
                  value={recipientEmail}
                  onChange={(e) => setRecipientEmail(e.target.value)}
                />
              </div>
              <div className="space-y-2">
                <Label>{t.sendDialog?.sujet || "Sujet (optionnel)"}</Label>
                <Input
                  placeholder={locale === "fr" ? "Votre soumission - Toiture LV" : "Your quote - Toiture LV"}
                  value={emailSubject}
                  onChange={(e) => setEmailSubject(e.target.value)}
                />
              </div>
              <div className="space-y-2">
                <Label>{t.sendDialog?.message || "Message (optionnel)"}</Label>
                <Textarea
                  placeholder={locale === "fr" ? "Message personnalise..." : "Custom message..."}
                  value={emailBody}
                  onChange={(e) => setEmailBody(e.target.value)}
                  rows={3}
                />
              </div>
            </div>
          )}

          {/* Error display */}
          {error && (
            <p className="text-sm text-destructive">{error}</p>
          )}
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            {t.sendDialog?.annuler || "Annuler"}
          </Button>
          <Button
            onClick={handleSend}
            disabled={isSending || (showEmailFields && !recipientEmail)}
          >
            {isSending ? (
              <>
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                {t.common?.chargement || "Chargement..."}
              </>
            ) : (
              t.sendDialog?.confirmer || "Confirmer l'envoi"
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

**Important:** The `useLanguage()` hook — read the actual hook implementation to verify the exact field names it returns (it may return `{ t, language }` instead of `{ t, locale }`). Use whatever field name gives "fr" or "en".

Also: For i18n key access, use optional chaining (`t.sendDialog?.titre`) with fallback strings to avoid runtime crashes if keys aren't loaded yet.

The dialog uses native HTML `<input type="date">` and `<input type="time">` instead of a library date picker — this is simpler, requires no new dependency, and works well for the MVP use case (react-day-picker not installed and not worth adding for one input).
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` — no TypeScript errors. Verify `red-flag-banner.tsx` and `send-dialog.tsx` exist in `frontend/src/components/submissions/`. Verify API client has `getRedFlags`, `sendSubmission`, `dismissFlags` exports.
  </verify>
  <done>
Send dialog component with 3 send options, email fields, date-time picker for scheduling. Red flag banner with dismissible warnings (critical=destructive, warning=amber). API client extended with 3 new functions. All components use bilingual labels with fallback strings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add all i18n keys for send dialog and red flags</name>
  <files>
    frontend/src/lib/i18n/fr.ts
    frontend/src/lib/i18n/en.ts
  </files>
  <action>
**1. Add to `frontend/src/lib/i18n/fr.ts`:**

Read the file first to see its full structure and where to add new sections. Add these sections at the root level of the exported object (alongside existing keys like `nav`, `estimateur`, `fullQuote`, etc.):

```typescript
sendDialog: {
  titre: "Envoyer la soumission",
  description: "Choisissez comment envoyer cette soumission",
  envoyerMaintenant: "Envoyer maintenant",
  planifier: "Planifier l'envoi",
  sauvegarderBrouillon: "Sauvegarder comme brouillon",
  dateHeure: "Date et heure d'envoi",
  destinataire: "Destinataire",
  sujet: "Sujet (optionnel)",
  message: "Message (optionnel)",
  confirmer: "Confirmer l'envoi",
  annuler: "Annuler",
  envoyeAvecSucces: "Soumission envoyee avec succes",
  planifieAvecSucces: "Envoi planifie avec succes",
  brouillonSauvegarde: "Brouillon sauvegarde",
  erreurEnvoi: "Erreur lors de l'envoi",
},
redFlags: {
  titre: "Avertissements detectes",
  budgetMismatch: "Ecart budgetaire",
  geographic: "Distance geographique",
  materialRisk: "Risque d'approvisionnement",
  crewAvailability: "Disponibilite de l'equipe",
  lowMargin: "Marge faible",
  ignorer: "Ignorer",
  toutIgnorer: "Tout ignorer",
},
```

**2. Add to `frontend/src/lib/i18n/en.ts`:**

Read the file first to match its structure exactly. Add corresponding English sections:

```typescript
sendDialog: {
  titre: "Send Submission",
  description: "Choose how to send this submission",
  envoyerMaintenant: "Send Now",
  planifier: "Schedule Send",
  sauvegarderBrouillon: "Save as Draft",
  dateHeure: "Send Date and Time",
  destinataire: "Recipient",
  sujet: "Subject (optional)",
  message: "Message (optional)",
  confirmer: "Confirm Send",
  annuler: "Cancel",
  envoyeAvecSucces: "Submission sent successfully",
  planifieAvecSucces: "Send scheduled successfully",
  brouillonSauvegarde: "Draft saved",
  erreurEnvoi: "Error sending submission",
},
redFlags: {
  titre: "Warnings Detected",
  budgetMismatch: "Budget Mismatch",
  geographic: "Geographic Distance",
  materialRisk: "Supply Chain Risk",
  crewAvailability: "Crew Availability",
  lowMargin: "Low Margin",
  ignorer: "Dismiss",
  toutIgnorer: "Dismiss All",
},
```

**Important:** The key names in both files MUST be identical (same property names). Only the values differ (French vs English). Follow the existing pattern where French keys use French property names (e.g., `titre` not `title`).

Also: Verify the existing `fullQuote` section already has `exporterPDF` key. The `exporterDOCX` key should have been added by Plan 24-01.
  </action>
  <verify>
Grep for `sendDialog` and `redFlags` in both `fr.ts` and `en.ts`. Run `cd frontend && npx tsc --noEmit` — no TypeScript errors (i18n types must be consistent between FR and EN).
  </verify>
  <done>
Both FR and EN translation files have complete i18n coverage for send dialog (11 keys) and red flags (8 keys). Key names are identical across both files. Values are properly translated.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` — TypeScript compiles cleanly
2. Verify `frontend/src/components/submissions/send-dialog.tsx` exists with SendDialog export
3. Verify `frontend/src/components/submissions/red-flag-banner.tsx` exists with RedFlagBanner export
4. Verify `frontend/src/lib/api/submissions.ts` has `getRedFlags`, `sendSubmission`, `dismissFlags`
5. Grep for `sendDialog` in both fr.ts and en.ts
6. Grep for `redFlags` in both fr.ts and en.ts
</verification>

<success_criteria>
- Send dialog opens with 3 radio options (send now, schedule, draft)
- Email fields appear for send now and schedule options
- Date+time picker appears for schedule option
- Red flag banner displays dismissible warnings with proper severity styling
- All UI text is bilingual via i18n keys
- API client covers all 3 new submission endpoints
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/24-export-send-red-flags/24-03-SUMMARY.md`
</output>
