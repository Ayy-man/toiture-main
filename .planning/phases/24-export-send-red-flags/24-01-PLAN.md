---
phase: 24-export-send-red-flags
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/docx/quote-template.ts
  - frontend/src/components/estimateur/quote-actions.tsx
  - frontend/src/lib/i18n/fr.ts
  - frontend/src/lib/i18n/en.ts
autonomous: true

must_haves:
  truths:
    - "User can click 'Export DOCX' button to download a Word document of the quote"
    - "DOCX document contains: header (SOUMISSION/QUOTE title, Toiture LV), job info (date, category, sqft), work items, materials/labor/total summary, footer with 30-day validity"
    - "DOCX structure matches existing PDF template content (same fields, no labor hours shown)"
    - "DOCX respects current locale (FR or EN) for all text labels"
    - "Both PDF and DOCX export buttons appear in QuoteActions"
    - "Export format i18n keys available in both FR and EN"
  artifacts:
    - path: "frontend/src/lib/docx/quote-template.ts"
      provides: "DOCX generation function using docx npm package"
      exports: ["generateQuoteDOCX"]
    - path: "frontend/src/components/estimateur/quote-actions.tsx"
      provides: "Updated QuoteActions with both PDF and DOCX export buttons"
      contains: "generateQuoteDOCX"
    - path: "frontend/src/lib/i18n/fr.ts"
      provides: "French i18n keys for export formats"
      contains: "exporterDOCX"
    - path: "frontend/src/lib/i18n/en.ts"
      provides: "English i18n keys for export formats"
      contains: "exportDOCX"
  key_links:
    - from: "frontend/src/components/estimateur/quote-actions.tsx"
      to: "frontend/src/lib/docx/quote-template.ts"
      via: "import generateQuoteDOCX"
      pattern: "generateQuoteDOCX"
    - from: "frontend/src/lib/docx/quote-template.ts"
      to: "docx npm package"
      via: "import { Document, Packer, Paragraph, Table } from 'docx'"
      pattern: "from 'docx'"
---

<objective>
Add DOCX (Word) export alongside the existing PDF export. Create a `generateQuoteDOCX` function using the `docx` npm package that mirrors the existing `QuotePDFDocument` structure, and wire it into the `QuoteActions` component with a new "Export DOCX" button.

Purpose: Clients often prefer Word documents for editing. DOCX export provides an alternative format matching the same content as the PDF.

Output: New `quote-template.ts` for DOCX generation, updated `QuoteActions` with DOCX button, i18n keys for export labels.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-export-send-red-flags/24-RESEARCH.md
@frontend/src/lib/pdf/quote-template.tsx
@frontend/src/components/estimateur/quote-actions.tsx
@frontend/src/types/hybrid-quote.ts
@frontend/src/lib/i18n/fr.ts
@frontend/src/lib/i18n/en.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install docx package and create DOCX quote template</name>
  <files>
    frontend/src/lib/docx/quote-template.ts
  </files>
  <action>
**1. Install the `docx` npm package:**
```bash
cd frontend && pnpm add docx
```

**2. Create `frontend/src/lib/docx/quote-template.ts`:**

This function mirrors the existing `QuotePDFDocument` in `frontend/src/lib/pdf/quote-template.tsx` but generates a `.docx` blob using the `docx` npm package.

Import from docx: `Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType, HeadingLevel, BorderStyle`.

Import the translation objects directly: `import { fr } from "@/lib/i18n/fr"` and `import { en } from "@/lib/i18n/en"`.

Import types: `HybridQuoteResponse, WorkItem, PricingTier` from `@/types/hybrid-quote`.

**Function signature:**
```typescript
export async function generateQuoteDOCX(
  quote: HybridQuoteResponse,
  category: string,
  sqft: number,
  date: string,
  locale: "fr" | "en" = "fr"
): Promise<Blob>
```

**Helper function** `formatCAD(amount: number): string` — same as in PDF template, using `Intl.NumberFormat("fr-CA", ...)`.

**Document structure (matching PDF exactly):**

1. **Header section:**
   - Title paragraph: `locale === "fr" ? "SOUMISSION" : "QUOTE"` — HeadingLevel.HEADING_1, center aligned, bold
   - Subtitle paragraph: "Toiture LV" — center aligned, gray color (#666666)
   - Empty paragraph spacer

2. **Job Info section:**
   - Three rows as simple paragraphs with bold label + regular value using TextRun:
     - "Date: {date}"
     - "Categorie: / Category: {category}" (label based on locale, use `locale === "fr" ? "Categorie" : "Category"`)
     - "Superficie: / Area: {sqft.toLocaleString('fr-CA')} pi2 / sq ft" (label + unit based on locale)

3. **Work Items section:**
   - Section header: bold paragraph with "TRAVAUX" / "WORK ITEMS" (locale-dependent), with bottom border (using thematicBreak or underline paragraph)
   - Get Standard tier: `quote.pricing_tiers.find(t => t.tier === "Standard") as PricingTier`
   - For each `quote.work_items`: bullet paragraph with `bullet: { level: 0 }` and text = `item.name`
   - NO labor hours shown (client-facing, matching PDF decision)

4. **Summary section:**
   - Section header: bold paragraph "SOMMAIRE" / "SUMMARY"
   - Create a 2-column Table with `WidthType.PERCENTAGE` (width 100%):
     - Row 1: "Materiaux" / "Materials" | formatCAD(standardTier.materials_cost)
     - Row 2: "Main-d'oeuvre" / "Labor" | formatCAD(standardTier.labor_cost)
   - Total row: bold, with top border — "TOTAL" | formatCAD(standardTier.total_price)
   - Table cells: no borders except total row has top border. Use `BorderStyle.SINGLE` for total row top only.

5. **Footer:**
   - Empty paragraph spacer
   - Footer paragraph at bottom: small font (size 18 = 9pt in docx half-points), gray (#666666), center aligned
   - FR: "Cette soumission est valide pour 30 jours a compter de la date d'emission."
   - EN: "This quote is valid for 30 days from the date of issue."

**Generate and return blob:**
```typescript
return await Packer.toBlob(doc);
```

**Important details:**
- Font sizes in `docx` package use half-points (e.g., size 22 = 11pt, size 48 = 24pt)
- The Standard tier is used for display (matching PDF decision from Phase 14-03)
- No logo yet (research noted LV logo file needed from Laurent — use text header only, same as current PDF)
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` — no TypeScript errors. Verify the file exists and exports `generateQuoteDOCX`. Check `pnpm list docx` shows the package installed.
  </verify>
  <done>
`generateQuoteDOCX` function exists, accepts quote data + locale, returns a Blob. TypeScript compiles without errors. docx package is in dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire DOCX export button into QuoteActions and add i18n keys</name>
  <files>
    frontend/src/components/estimateur/quote-actions.tsx
    frontend/src/lib/i18n/fr.ts
    frontend/src/lib/i18n/en.ts
  </files>
  <action>
**1. Add i18n keys to `frontend/src/lib/i18n/fr.ts`:**

Add to the `fullQuote` section (alongside existing `exporterPDF`):
```typescript
exporterDOCX: "Exporter DOCX",
```

**2. Add i18n keys to `frontend/src/lib/i18n/en.ts`:**

Add to the `fullQuote` section:
```typescript
exportDOCX: "Export DOCX",
```

Note: Check the exact key name used for PDF in en.ts (likely `exportPDF`) and follow the same naming pattern.

**3. Update `frontend/src/components/estimateur/quote-actions.tsx`:**

Add import for DOCX generator:
```typescript
import { generateQuoteDOCX } from "@/lib/docx/quote-template";
```

Add `FileText` icon from lucide-react (alongside existing `FileDown`):
```typescript
import { FileDown, FileText, Loader2 } from "lucide-react";
```

Add `locale` prop or get it from `useLanguage()` hook. The hook already exists — extract `locale` from it:
```typescript
const { t, locale } = useLanguage();
```

Check if `useLanguage()` actually returns `locale`. Read the hook to verify — it may return `language` instead. Use whatever field holds "fr" or "en".

Add DOCX export state:
```typescript
const [isExportingDOCX, setIsExportingDOCX] = useState(false);
```

Add `handleExportDOCX` function (mirror `handleExportPDF` pattern):
```typescript
async function handleExportDOCX() {
  setIsExportingDOCX(true);
  try {
    const now = new Date();
    const dateStr = now.toLocaleDateString("fr-CA");
    const filenameDateStr = now.toISOString().split("T")[0];

    const blob = await generateQuoteDOCX(
      quote, category, sqft, dateStr, locale as "fr" | "en"
    );

    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `Soumission-${category}-${filenameDateStr}.docx`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  } catch (error) {
    console.error("DOCX export failed:", error);
  } finally {
    setIsExportingDOCX(false);
  }
}
```

Add DOCX button in the return JSX, right after the PDF button:
```tsx
<Button
  variant="outline"
  onClick={handleExportDOCX}
  disabled={isExportingDOCX}
>
  {isExportingDOCX ? (
    <>
      <Loader2 className="mr-2 h-4 w-4 animate-spin" />
      {t.common.chargement}
    </>
  ) : (
    <>
      <FileText className="mr-2 h-4 w-4" />
      {t.fullQuote.exporterDOCX}
    </>
  )}
</Button>
```

Remove or keep the commented-out "Future buttons for Send and Save" comment — those will be implemented in Plan 24-03 with the send dialog.
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` — no TypeScript errors. Verify quote-actions.tsx imports generateQuoteDOCX. Grep for `exporterDOCX` in fr.ts and `exportDOCX` in en.ts.
  </verify>
  <done>
QuoteActions component has two export buttons (PDF + DOCX). Both use the same download pattern. DOCX generation passes locale for bilingual support. i18n keys exist in both language files.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && pnpm list docx` — docx package installed
2. `cd frontend && npx tsc --noEmit` — TypeScript compiles cleanly
3. Verify file exists: `frontend/src/lib/docx/quote-template.ts` with `generateQuoteDOCX` export
4. Verify `quote-actions.tsx` imports and uses `generateQuoteDOCX`
5. Verify i18n keys: `exporterDOCX` in fr.ts and corresponding key in en.ts
</verification>

<success_criteria>
- DOCX export function generates a Word document blob matching PDF content structure
- QuoteActions shows both PDF and DOCX export buttons
- DOCX template is bilingual (locale parameter controls all labels)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/24-export-send-red-flags/24-01-SUMMARY.md`
</output>
