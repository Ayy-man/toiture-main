---
phase: 13-hybrid-quote-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/schemas/hybrid_quote.py
autonomous: true

must_haves:
  truths:
    - "HybridQuoteRequest accepts all job parameters including 6 complexity factors"
    - "HybridQuoteOutput defines structured LLM response with work_items, materials, confidence"
    - "Three-tier pricing models (Basic/Standard/Premium) are defined"
  artifacts:
    - path: "backend/app/schemas/hybrid_quote.py"
      provides: "Pydantic models for hybrid quote request, response, and LLM tool calling"
      min_lines: 100
      exports: ["HybridQuoteRequest", "HybridQuoteResponse", "HybridQuoteOutput", "WorkItem", "MaterialLineItem", "PricingTier"]
  key_links:
    - from: "backend/app/schemas/hybrid_quote.py"
      to: "pydantic BaseModel"
      via: "inheritance"
      pattern: "class.*BaseModel"
---

<objective>
Create Pydantic schemas for hybrid quote generation including request validation, LLM structured output definitions, and three-tier pricing models.

Purpose: These schemas are the type foundation for the entire hybrid quote system. The LLM tool calling feature requires Pydantic models that can be converted to JSON schema for Claude's structured outputs API.

Output: backend/app/schemas/hybrid_quote.py with all type definitions
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-hybrid-quote-generation/13-CONTEXT.md
@.planning/phases/13-hybrid-quote-generation/13-RESEARCH.md

# Existing schemas to follow patterns from
@backend/app/schemas/estimate.py
@backend/app/schemas/materials.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hybrid quote Pydantic schemas</name>
  <files>backend/app/schemas/hybrid_quote.py</files>
  <action>
Create comprehensive Pydantic models for hybrid quote generation:

**HybridQuoteRequest** - Input validation:
- sqft: float (>0, <=100000)
- category: str (validate against ALLOWED_CATEGORIES from estimate.py)
- complexity_aggregate: int (0-56, sum of 6 factors)
- access_difficulty: int (0-10)
- roof_pitch: int (0-8)
- penetrations: int (0-10)
- material_removal: int (0-8)
- safety_concerns: int (0-10)
- timeline_constraints: int (0-10)
- has_chimney: bool (default False)
- has_skylights: bool (default False)
- material_lines: int (default 5, 0-100)
- labor_lines: int (default 2, 0-50)
- has_subs: bool (default False)
- quoted_total: Optional[float] (if known)

Add field_validator to ensure complexity_aggregate equals sum of 6 factors (with 5% tolerance for rounding).

**WorkItem** - For LLM structured output:
- name: str (work item description)
- labor_hours: float (>=0)
- source: Literal["CBR", "ML", "MERGED"]

**MaterialLineItem** - For LLM structured output:
- material_id: int (validated against known range)
- quantity: float (>0)
- unit_price: float (>=0)
- total: float (quantity * unit_price)
- source: Literal["CBR", "ML", "MERGED"]
- confidence: float (0.0-1.0)

**PricingTier** - Three-tier output:
- tier: Literal["Basic", "Standard", "Premium"]
- total_price: float
- materials_cost: float
- labor_cost: float
- description: str (brief explanation of tier differences)

**HybridQuoteOutput** - LLM tool calling schema:
- work_items: List[WorkItem]
- materials: List[MaterialLineItem]
- total_labor_hours: float
- total_materials_cost: float
- total_price: float
- overall_confidence: float (0.0-1.0)
- reasoning: str (explanation of merger decisions)
- pricing_tiers: List[PricingTier] (exactly 3)

Add @model_validator to ensure pricing_tiers has exactly 3 items (Basic, Standard, Premium).

**HybridQuoteResponse** - API response:
- All fields from HybridQuoteOutput
- request_id: Optional[str] (for tracking)
- needs_review: bool (True if confidence < 0.5)
- cbr_cases_used: int (number of similar cases found)
- ml_confidence: Literal["HIGH", "MEDIUM", "LOW"]
- processing_time_ms: int

Follow existing schema patterns:
- Use Field() with descriptions for API documentation
- Include model_config with json_schema_extra examples
- Use Literal types for constrained strings
</action>
  <verify>
Run: `cd /Users/aymanbaig/Desktop/Toiture-P1/backend && python -c "from app.schemas.hybrid_quote import HybridQuoteRequest, HybridQuoteResponse, HybridQuoteOutput; print('Schemas imported successfully')"`

Verify model_json_schema() works for LLM tool calling:
`cd /Users/aymanbaig/Desktop/Toiture-P1/backend && python -c "from app.schemas.hybrid_quote import HybridQuoteOutput; import json; print(json.dumps(HybridQuoteOutput.model_json_schema(), indent=2)[:500])"`
</verify>
  <done>
- HybridQuoteRequest validates all 6 complexity factors plus job parameters
- HybridQuoteOutput produces valid JSON schema for Claude tool calling
- PricingTier enforces exactly 3 tiers (Basic/Standard/Premium)
- All models import without errors and serialize to JSON
</done>
</task>

<task type="auto">
  <name>Task 2: Export schemas from package init</name>
  <files>backend/app/schemas/__init__.py</files>
  <action>
Add hybrid_quote exports to the schemas package __init__.py:

```python
from app.schemas.hybrid_quote import (
    HybridQuoteRequest,
    HybridQuoteResponse,
    HybridQuoteOutput,
    WorkItem,
    MaterialLineItem,
    PricingTier,
)
```

This allows cleaner imports: `from app.schemas import HybridQuoteRequest`
</action>
  <verify>
Run: `cd /Users/aymanbaig/Desktop/Toiture-P1/backend && python -c "from app.schemas import HybridQuoteRequest, HybridQuoteResponse; print('Package exports work')"`
</verify>
  <done>
All hybrid quote schemas are exported from app.schemas package
</done>
</task>

</tasks>

<verification>
1. All Pydantic models import without errors
2. HybridQuoteRequest validates complexity factor sum
3. HybridQuoteOutput.model_json_schema() produces valid JSON for LLM tool calling
4. PricingTier enforces exactly 3 tiers
5. Package exports work for cleaner imports
</verification>

<success_criteria>
- backend/app/schemas/hybrid_quote.py exists with 100+ lines
- All 6 models defined: HybridQuoteRequest, HybridQuoteResponse, HybridQuoteOutput, WorkItem, MaterialLineItem, PricingTier
- Schemas export from app.schemas package
- JSON schema generation works for LLM structured outputs
</success_criteria>

<output>
After completion, create `.planning/phases/13-hybrid-quote-generation/13-01-SUMMARY.md`
</output>
