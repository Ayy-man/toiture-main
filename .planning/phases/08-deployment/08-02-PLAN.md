---
phase: 08-deployment
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - backend/app/config.py
autonomous: false

user_setup:
  - service: railway
    why: "Backend hosting platform"
    env_vars:
      - name: CORS_ORIGINS
        value: "Will be set after Vercel domain known"
      - name: MODEL_DIR
        value: "app/models"
      - name: PINECONE_API_KEY
        source: "From backend/.env (already have)"
      - name: PINECONE_INDEX_HOST
        source: "From backend/.env (already have)"
      - name: OPENROUTER_API_KEY
        source: "From backend/.env (already have)"
      - name: OPENROUTER_MODEL
        value: "openai/gpt-4o-mini"
      - name: SUPABASE_URL
        source: "From backend/.env (already have)"
      - name: SUPABASE_SERVICE_KEY
        source: "From backend/.env (already have)"
    dashboard_config:
      - task: "Create new project from GitHub repo"
        location: "Railway Dashboard -> New Project -> Deploy from GitHub"
      - task: "Set root directory to 'backend'"
        location: "Project Settings -> Root Directory"
  - service: vercel
    why: "Frontend hosting platform"
    env_vars:
      - name: NEXT_PUBLIC_API_URL
        source: "Railway backend URL after deployment"
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "From frontend/.env.local (already have)"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "From frontend/.env.local (already have)"
      - name: IRON_SESSION_SECRET
        source: "From frontend/.env.local (already have)"
      - name: APP_PASSWORD
        source: "From frontend/.env.local (already have)"
    dashboard_config:
      - task: "Import project from GitHub"
        location: "Vercel Dashboard -> Add New -> Project"
      - task: "Set root directory to 'frontend'"
        location: "Project configuration during import"

must_haves:
  truths:
    - "Backend health check returns 200 OK on Railway"
    - "Frontend loads and displays login page on Vercel"
    - "Frontend can reach backend API (CORS works)"
    - "Estimate form submits and gets response from backend"
    - "Team can log in with shared password"
  artifacts:
    - path: "Railway deployment"
      provides: "Live backend API"
      url: "https://*.up.railway.app/health"
    - path: "Vercel deployment"
      provides: "Live frontend application"
      url: "https://*.vercel.app"
  key_links:
    - from: "Vercel frontend"
      to: "Railway backend"
      via: "NEXT_PUBLIC_API_URL"
      pattern: "fetch.*NEXT_PUBLIC_API_URL"
    - from: "Railway backend"
      to: "Vercel frontend"
      via: "CORS_ORIGINS"
      pattern: "allow_origins"
---

<objective>
Deploy backend to Railway and frontend to Vercel, configure environment variables, and verify end-to-end functionality.

Purpose: Make the application accessible to the team in production.

Output: Live application with working estimate flow and authentication.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-deployment/08-RESEARCH.md
@.planning/phases/08-deployment/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy Backend to Railway via CLI</name>
  <files>None (deployment only)</files>
  <action>
Deploy the backend to Railway using the Railway CLI.

1. Check if Railway CLI is installed:
   ```bash
   railway --version || npm install -g @railway/cli
   ```

2. Login to Railway (will open browser):
   ```bash
   railway login
   ```

3. Navigate to backend and initialize Railway project:
   ```bash
   cd backend
   railway init  # Creates new project or links existing
   ```

4. Set environment variables (copy from backend/.env):
   ```bash
   railway variables set CORS_ORIGINS='["http://localhost:3000"]'
   railway variables set MODEL_DIR=app/models
   railway variables set PINECONE_API_KEY=<from .env>
   railway variables set PINECONE_INDEX_HOST=<from .env>
   railway variables set OPENROUTER_API_KEY=<from .env>
   railway variables set OPENROUTER_MODEL=openai/gpt-4o-mini
   railway variables set SUPABASE_URL=<from .env>
   railway variables set SUPABASE_SERVICE_KEY=<from .env>
   ```

5. Deploy:
   ```bash
   railway up
   ```

6. Get the deployed URL:
   ```bash
   railway domain
   ```
   Expected format: https://toiturelv-cortex-production.up.railway.app

7. Verify health check:
   ```bash
   curl https://<railway-domain>/health
   ```
   Expected: {"status": "healthy"}

Note: First deployment may take 5-10 minutes due to ML model dependencies.
  </action>
  <verify>
  ```bash
  # Test health endpoint
  curl -s https://<railway-domain>/health | grep -q "healthy" && echo "Backend healthy"

  # Test CORS preflight
  curl -s -I -X OPTIONS https://<railway-domain>/estimate \
    -H "Origin: http://localhost:3000" \
    -H "Access-Control-Request-Method: POST" | grep -i "access-control"
  ```
  </verify>
  <done>
    - Railway deployment successful
    - Health check returns 200 with {"status": "healthy"}
    - Backend URL available
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy Frontend to Vercel via CLI</name>
  <files>
    backend/app/config.py (update CORS after Vercel URL known)
  </files>
  <action>
Deploy the frontend to Vercel using the Vercel CLI.

1. Check if Vercel CLI is installed:
   ```bash
   vercel --version || npm install -g vercel
   ```

2. Navigate to frontend and deploy:
   ```bash
   cd frontend
   vercel --prod
   ```
   - When prompted, select the team/account
   - Confirm root directory is current directory
   - Framework detection should show Next.js

3. Set environment variables via Vercel dashboard or CLI:
   ```bash
   vercel env add NEXT_PUBLIC_API_URL production
   # Enter: https://<railway-domain>

   vercel env add NEXT_PUBLIC_SUPABASE_URL production
   # Enter: https://mqlorlnnwzvfazxdqvja.supabase.co

   vercel env add NEXT_PUBLIC_SUPABASE_ANON_KEY production
   # Enter: <from .env.local>

   vercel env add IRON_SESSION_SECRET production
   # Enter: <from .env.local>

   vercel env add APP_PASSWORD production
   # Enter: toiturelv2026
   ```

4. Redeploy with env vars:
   ```bash
   vercel --prod
   ```

5. Get deployed URL:
   ```bash
   vercel ls
   ```
   Expected format: https://toiturelv-cortex.vercel.app

6. Update Railway CORS to include Vercel domain:
   ```bash
   cd ../backend
   railway variables set CORS_ORIGINS='["https://toiturelv-cortex.vercel.app","http://localhost:3000"]'
   railway up  # Redeploy with new CORS
   ```
  </action>
  <verify>
  ```bash
  # Check frontend loads
  curl -s https://<vercel-domain> | head -20

  # Check login page accessible
  curl -s -L https://<vercel-domain>/login | grep -i "password" && echo "Login page works"
  ```
  </verify>
  <done>
    - Vercel deployment successful
    - Frontend loads and shows login page
    - Environment variables configured
    - Railway CORS updated to allow Vercel domain
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Full production deployment:
    - Backend API on Railway with ML models, Pinecone CBR, and LLM reasoning
    - Frontend on Vercel with authentication and estimate form
    - CORS configured for cross-origin requests
    - All environment variables set
  </what-built>
  <how-to-verify>
    1. Visit the Vercel URL in your browser
    2. Enter the password (toiturelv2026) on the login page
    3. You should see the estimate form
    4. Fill in the form:
       - Square footage: 2500
       - Category: Shingle
       - Material lines: 15
       - Labor lines: 10
       - Has subcontractors: Yes
       - Complexity: 3
    5. Click Submit
    6. Verify you see:
       - Price estimate with range
       - Confidence level (LOW/MEDIUM/HIGH)
       - Similar cases section
       - LLM reasoning explanation

    Expected: Full estimate response with all sections populated.

    If any issues:
    - Check browser console for errors (F12)
    - Check Railway logs: `railway logs`
    - Check Vercel deployment logs in dashboard
  </how-to-verify>
  <resume-signal>Type "approved" if estimate works end-to-end, or describe what failed</resume-signal>
</task>

</tasks>

<verification>
- [ ] Railway backend health check returns 200 OK
- [ ] Vercel frontend loads without errors
- [ ] Login with shared password works
- [ ] Estimate form submits to backend successfully
- [ ] Similar cases display correctly
- [ ] LLM reasoning shows explanation
- [ ] No CORS errors in browser console
</verification>

<success_criteria>
1. Backend accessible at Railway URL, /health returns healthy
2. Frontend accessible at Vercel URL, shows login page
3. Full estimate flow works: login -> form -> submit -> results
4. Team can access the application with shared password
</success_criteria>

<output>
After completion, create `.planning/phases/08-deployment/08-02-SUMMARY.md`
</output>
