---
phase: 05-feedback-system
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - frontend/package.json
  - frontend/src/components/ui/table.tsx
  - frontend/src/lib/feedback-api.ts
  - frontend/src/types/feedback.ts
  - frontend/src/components/review/columns.tsx
  - frontend/src/components/review/data-table.tsx
  - frontend/src/components/review/feedback-dialog.tsx
  - frontend/src/app/review/page.tsx
autonomous: true

must_haves:
  truths:
    - "Laurent can see list of pending estimates"
    - "Laurent can view estimate details (inputs, AI output, reasoning)"
    - "Laurent can enter his price and submit feedback"
    - "Submitted estimates disappear from pending queue"
  artifacts:
    - path: "frontend/src/app/review/page.tsx"
      provides: "Review queue page"
      min_lines: 30
    - path: "frontend/src/components/review/data-table.tsx"
      provides: "TanStack Table wrapper"
      min_lines: 40
    - path: "frontend/src/components/review/feedback-dialog.tsx"
      provides: "Feedback submission modal"
      min_lines: 50
    - path: "frontend/src/lib/feedback-api.ts"
      provides: "API client for feedback endpoints"
      exports: ["fetchPendingEstimates", "fetchEstimateDetail", "submitFeedback"]
  key_links:
    - from: "frontend/src/app/review/page.tsx"
      to: "/api feedback endpoints"
      via: "feedback-api.ts functions"
      pattern: "fetchPendingEstimates|submitFeedback"
    - from: "frontend/src/components/review/data-table.tsx"
      to: "@tanstack/react-table"
      via: "useReactTable hook"
      pattern: "useReactTable|getCoreRowModel"
    - from: "frontend/src/components/review/feedback-dialog.tsx"
      to: "backend POST /feedback/submit"
      via: "submitFeedback API call"
      pattern: "submitFeedback"
---

<objective>
Create the review queue UI where Laurent can see pending estimates and enter his prices.

Purpose: Enable Laurent to provide feedback on AI estimates, building the dataset for accuracy measurement.
Output: /review page with data table, estimate details, and feedback submission dialog.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-feedback-system/05-RESEARCH.md
@.planning/phases/05-feedback-system/05-01-SUMMARY.md

# Existing frontend patterns
@frontend/src/lib/api.ts
@frontend/src/components/estimate-form.tsx
@frontend/src/components/ui/card.tsx
@frontend/src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dependencies and API Client</name>
  <files>
    frontend/package.json
    frontend/src/components/ui/table.tsx
    frontend/src/lib/feedback-api.ts
    frontend/src/types/feedback.ts
  </files>
  <action>
    1. Install dependencies:
       ```bash
       cd /Users/aymanbaig/Desktop/Toiture-P1/frontend
       pnpm add @tanstack/react-table
       pnpm dlx shadcn@latest add table dialog
       ```

    2. Create frontend/src/types/feedback.ts:
       ```typescript
       // Matches backend EstimateListItem
       export interface PendingEstimate {
         id: string;
         created_at: string;
         sqft: number;
         category: string;
         ai_estimate: number;
         confidence: "HIGH" | "MEDIUM" | "LOW";
         reviewed: boolean;
       }

       // Matches backend EstimateDetail
       export interface EstimateDetail extends PendingEstimate {
         material_lines: number;
         labor_lines: number;
         has_subs: boolean;
         complexity: number;
         range_low: number;
         range_high: number;
         model: string;
         reasoning: string | null;
       }

       // Request for submitting feedback
       export interface SubmitFeedbackRequest {
         estimate_id: string;
         laurent_price: number;
       }
       ```

    3. Create frontend/src/lib/feedback-api.ts:
       - Use same API_URL pattern as api.ts
       - fetchPendingEstimates(): Promise<PendingEstimate[]>
         - GET /feedback/pending
         - Return array or throw error with detail
       - fetchEstimateDetail(id: string): Promise<EstimateDetail>
         - GET /feedback/estimate/{id}
         - Return estimate or throw error
       - submitFeedback(request: SubmitFeedbackRequest): Promise<void>
         - POST /feedback/submit with JSON body
         - Throw error on failure
  </action>
  <verify>
    - `cd frontend && pnpm build` succeeds
    - @tanstack/react-table in package.json dependencies
    - table.tsx and dialog.tsx exist in components/ui
    - `import { fetchPendingEstimates } from "@/lib/feedback-api"` works
  </verify>
  <done>
    - @tanstack/react-table installed
    - shadcn table and dialog components added
    - feedback-api.ts exports fetchPendingEstimates, fetchEstimateDetail, submitFeedback
    - types/feedback.ts exports PendingEstimate, EstimateDetail, SubmitFeedbackRequest
  </done>
</task>

<task type="auto">
  <name>Task 2: Review Queue Components</name>
  <files>
    frontend/src/components/review/columns.tsx
    frontend/src/components/review/data-table.tsx
    frontend/src/components/review/feedback-dialog.tsx
  </files>
  <action>
    1. Create frontend/src/components/review/columns.tsx:
       - "use client" directive
       - Import ColumnDef from @tanstack/react-table
       - Import PendingEstimate from types/feedback
       - Import Button from ui/button

       - Define columns: ColumnDef<PendingEstimate>[]:
         - created_at: Format as date (toLocaleDateString)
         - category: Plain text
         - sqft: Format with toLocaleString()
         - ai_estimate: Format as CAD currency (Intl.NumberFormat)
         - confidence: Badge with color (reuse pattern from estimate-result.tsx)
         - actions: "Review" button that calls onReview callback

       - Export columns function that takes onReview callback

    2. Create frontend/src/components/review/data-table.tsx:
       - "use client" directive
       - Import useReactTable, getCoreRowModel, flexRender from @tanstack/react-table
       - Import Table, TableBody, TableCell, TableHead, TableHeader, TableRow from ui/table
       - Generic DataTable<TData, TValue> component
       - Props: columns, data
       - Use useReactTable with getCoreRowModel()
       - Render table with header and body rows
       - Handle empty state: "No pending estimates" message

    3. Create frontend/src/components/review/feedback-dialog.tsx:
       - "use client" directive
       - Props: estimate (EstimateDetail | null), open, onOpenChange, onSubmit
       - Use Dialog, DialogContent, DialogHeader, DialogTitle from ui/dialog
       - Display estimate details:
         - Category, sqft, complexity
         - AI estimate with range
         - Confidence badge
         - Reasoning (if present, in scrollable area)
       - Input for laurent_price (number, required, min 0)
       - Submit button that calls onSubmit with price
       - Use controlled form with useState for price input
       - Show loading state during submission
  </action>
  <verify>
    - `cd frontend && pnpm build` succeeds
    - No TypeScript errors in components/review/
  </verify>
  <done>
    - columns.tsx defines table columns with date, category, sqft, estimate, confidence, actions
    - data-table.tsx is generic TanStack Table wrapper with empty state
    - feedback-dialog.tsx shows estimate details and price input
  </done>
</task>

<task type="auto">
  <name>Task 3: Review Page</name>
  <files>
    frontend/src/app/review/page.tsx
  </files>
  <action>
    Create frontend/src/app/review/page.tsx:

    - "use client" directive
    - Import useState, useEffect from react
    - Import DataTable from components/review/data-table
    - Import columns from components/review/columns
    - Import FeedbackDialog from components/review/feedback-dialog
    - Import fetchPendingEstimates, fetchEstimateDetail, submitFeedback from lib/feedback-api
    - Import types from types/feedback

    State:
    - estimates: PendingEstimate[] (initially [])
    - loading: boolean
    - error: string | null
    - selectedEstimate: EstimateDetail | null
    - dialogOpen: boolean
    - submitting: boolean

    Effects:
    - useEffect to fetch pending estimates on mount
    - Refetch after successful submission

    Handlers:
    - handleReview(estimate: PendingEstimate): Fetch full detail, open dialog
    - handleSubmit(price: number): Submit feedback, close dialog, refetch list
    - handleDialogClose(): Clear selection, close dialog

    UI:
    - Container matching home page style (max-w-4xl, centered)
    - Header: "Review Queue" with estimate count
    - Link back to home page
    - Loading state: "Loading estimates..."
    - Error state: Display error message with retry button
    - DataTable with pending estimates
    - FeedbackDialog for selected estimate

    Page should be accessible at /review (protected by existing middleware).
  </action>
  <verify>
    - `cd frontend && pnpm build` succeeds
    - Start dev server: `cd frontend && pnpm dev`
    - Navigate to http://localhost:3000/review
    - Page loads without errors (shows empty table if no estimates)
  </verify>
  <done>
    - /review page renders with review queue table
    - Clicking Review opens dialog with estimate details
    - Entering price and submitting calls backend
    - Successful submission removes estimate from list
    - Error states handled gracefully
  </done>
</task>

</tasks>

<verification>
End-to-end test (requires backend running with Supabase configured):

1. **Create test estimate:**
   - Go to http://localhost:3000 (home page)
   - Submit estimate form
   - Verify estimate saved in Supabase

2. **View in review queue:**
   - Go to http://localhost:3000/review
   - Verify new estimate appears in table
   - Check date, category, sqft, AI estimate display correctly

3. **Submit feedback:**
   - Click "Review" on estimate row
   - Verify dialog shows full estimate details (inputs, range, reasoning)
   - Enter price (e.g., 15000)
   - Click Submit
   - Verify estimate disappears from table
   - Verify Supabase: estimate.reviewed = true, feedback row created
</verification>

<success_criteria>
- /review page accessible and renders table
- Pending estimates displayed with correct formatting
- Review dialog shows full estimate details including reasoning
- Price input validates and submits to backend
- Successful feedback removes estimate from queue
- Empty state shows "No pending estimates" message
- Error states handled with user-friendly messages
</success_criteria>

<output>
After completion, create `.planning/phases/05-feedback-system/05-02-SUMMARY.md`
</output>
