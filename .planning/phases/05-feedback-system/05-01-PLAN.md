---
phase: 05-feedback-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/services/supabase_client.py
  - backend/app/schemas/feedback.py
  - backend/app/routers/feedback.py
  - backend/app/routers/estimate.py
  - backend/app/main.py
  - backend/requirements.txt
autonomous: false
user_setup:
  - service: supabase
    why: "Database for estimates and feedback storage"
    env_vars:
      - name: SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> service_role key (secret)"
    dashboard_config:
      - task: "Create estimates and feedback tables"
        location: "Supabase Dashboard -> SQL Editor"

must_haves:
  truths:
    - "New estimates are saved to Supabase database"
    - "Pending estimates can be retrieved via API"
    - "Laurent can submit feedback with his price"
    - "Submitting feedback marks estimate as reviewed"
  artifacts:
    - path: "backend/app/services/supabase_client.py"
      provides: "Supabase client singleton"
      exports: ["init_supabase", "get_supabase", "close_supabase"]
    - path: "backend/app/schemas/feedback.py"
      provides: "Pydantic models for feedback"
      exports: ["EstimateListItem", "EstimateDetail", "SubmitFeedbackRequest"]
    - path: "backend/app/routers/feedback.py"
      provides: "Feedback API endpoints"
      exports: ["router"]
  key_links:
    - from: "backend/app/routers/estimate.py"
      to: "supabase_client.get_supabase()"
      via: "save estimate after prediction"
      pattern: "supabase.*table.*estimates.*insert"
    - from: "backend/app/routers/feedback.py"
      to: "supabase_client.get_supabase()"
      via: "query and update estimates"
      pattern: "supabase.*table.*estimates"
    - from: "backend/app/main.py"
      to: "supabase_client"
      via: "lifespan init/close"
      pattern: "init_supabase|close_supabase"
---

<objective>
Integrate Supabase into the FastAPI backend to save estimates and enable feedback collection.

Purpose: Store all AI estimates for Laurent's review and collect his actual prices to measure accuracy.
Output: Backend endpoints for saving estimates, fetching pending reviews, and submitting feedback.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-feedback-system/05-RESEARCH.md

# Existing backend files to extend
@backend/app/main.py
@backend/app/routers/estimate.py
@backend/app/schemas/estimate.py
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 0: Create Supabase Tables</name>
  <action>
    User must run the following SQL in Supabase SQL Editor to create required tables.
    This cannot be automated as it requires Supabase dashboard access.
  </action>
  <sql>
```sql
-- Estimates table: stores all AI predictions
CREATE TABLE estimates (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at timestamptz DEFAULT now() NOT NULL,

  -- Input fields (from EstimateRequest)
  sqft numeric(10,2) NOT NULL,
  category text NOT NULL,
  material_lines integer NOT NULL,
  labor_lines integer NOT NULL,
  has_subs boolean NOT NULL DEFAULT false,
  complexity integer NOT NULL,

  -- AI output fields (from EstimateResponse)
  ai_estimate numeric(10,2) NOT NULL,
  range_low numeric(10,2) NOT NULL,
  range_high numeric(10,2) NOT NULL,
  confidence text NOT NULL CHECK (confidence IN ('HIGH', 'MEDIUM', 'LOW')),
  model text NOT NULL,
  reasoning text,

  -- Review status
  reviewed boolean NOT NULL DEFAULT false
);

-- Feedback table: stores Laurent's review
CREATE TABLE feedback (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at timestamptz DEFAULT now() NOT NULL,
  estimate_id uuid NOT NULL REFERENCES estimates(id) ON DELETE CASCADE,

  -- Laurent's input
  laurent_price numeric(10,2) NOT NULL,
  ai_estimate numeric(10,2) NOT NULL
);

-- Indexes for query performance
CREATE INDEX idx_estimates_reviewed ON estimates(reviewed);
CREATE INDEX idx_estimates_created_at ON estimates(created_at DESC);
CREATE INDEX idx_feedback_estimate_id ON feedback(estimate_id);
```
  </sql>
  <how-to-verify>
    1. Go to Supabase Dashboard -> Table Editor
    2. Verify "estimates" table exists with all columns
    3. Verify "feedback" table exists with all columns
    4. Check indexes exist in Database -> Indexes
  </how-to-verify>
  <resume-signal>Type "tables created" when complete</resume-signal>
</task>

<task type="auto">
  <name>Task 1: Supabase Client and Feedback Schemas</name>
  <files>
    backend/app/services/supabase_client.py
    backend/app/schemas/feedback.py
    backend/requirements.txt
  </files>
  <action>
    1. Add `supabase>=2.27.0` to backend/requirements.txt

    2. Create backend/app/services/supabase_client.py:
       - Import os, create_client from supabase
       - Module-level _client: Client | None = None
       - init_supabase(): Read SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY from env, create client if both present
       - get_supabase() -> Client | None: Return _client (may be None if not configured)
       - close_supabase(): Set _client = None

    3. Create backend/app/schemas/feedback.py:
       - EstimateListItem: id, created_at, sqft, category, ai_estimate, confidence, reviewed
       - EstimateDetail: extends EstimateListItem with material_lines, labor_lines, has_subs, complexity, range_low, range_high, model, reasoning
       - SubmitFeedbackRequest: estimate_id (str), laurent_price (float, gt=0)
       - FeedbackResponse: status (Literal["success"]), estimate_id (str)

    Pattern: Follow existing predictor.py and llm_reasoning.py singleton patterns.
    Use Pydantic v2 syntax (already in codebase).
  </action>
  <verify>
    - `pip install supabase` succeeds
    - Import test: `python -c "from backend.app.services.supabase_client import init_supabase, get_supabase, close_supabase; print('OK')"`
    - Import test: `python -c "from backend.app.schemas.feedback import EstimateListItem, EstimateDetail, SubmitFeedbackRequest; print('OK')"`
  </verify>
  <done>
    - supabase in requirements.txt
    - supabase_client.py exports init_supabase, get_supabase, close_supabase
    - feedback.py exports EstimateListItem, EstimateDetail, SubmitFeedbackRequest, FeedbackResponse
  </done>
</task>

<task type="auto">
  <name>Task 2: Feedback Router and Estimate Integration</name>
  <files>
    backend/app/routers/feedback.py
    backend/app/routers/estimate.py
    backend/app/main.py
  </files>
  <action>
    1. Create backend/app/routers/feedback.py:
       - Import APIRouter, HTTPException from fastapi
       - Import List from typing
       - Import schemas from backend.app.schemas.feedback
       - Import get_supabase from backend.app.services.supabase_client

       - router = APIRouter(prefix="/feedback", tags=["feedback"])

       - GET /feedback/pending -> List[EstimateListItem]
         - Get supabase client, raise 503 if None
         - Query estimates table WHERE reviewed = False, ORDER BY created_at DESC
         - Return result.data

       - GET /feedback/estimate/{estimate_id} -> EstimateDetail
         - Get estimate by ID, raise 404 if not found
         - Return full estimate details

       - POST /feedback/submit -> FeedbackResponse
         - Get estimate by ID, raise 404 if not found
         - Insert feedback record with estimate_id, laurent_price, ai_estimate
         - Update estimate SET reviewed = True
         - Return {"status": "success", "estimate_id": estimate_id}

    2. Update backend/app/routers/estimate.py:
       - Import get_supabase from backend.app.services.supabase_client
       - After successful EstimateResponse creation, save to Supabase:
         - Get supabase client
         - If client exists, insert estimate record with all fields
         - Use try/except to not block estimate if save fails (log warning)
         - Include estimate_id in response? No - keep response unchanged for frontend compatibility

    3. Update backend/app/main.py:
       - Import init_supabase, close_supabase from backend.app.services.supabase_client
       - Import feedback router from backend.app.routers.feedback
       - Add init_supabase() call in lifespan startup (after init_llm_client)
       - Add close_supabase() call in lifespan shutdown (before close_llm_client)
       - Add app.include_router(feedback.router)
  </action>
  <verify>
    - Start server: `cd /Users/aymanbaig/Desktop/Toiture-P1 && python -m uvicorn backend.app.main:app --reload`
    - Check docs: http://localhost:8000/docs shows /feedback endpoints
    - GET /feedback/pending returns [] (empty list initially)
  </verify>
  <done>
    - feedback.py router with 3 endpoints (GET /pending, GET /estimate/{id}, POST /submit)
    - estimate.py saves estimates to Supabase after prediction
    - main.py initializes Supabase in lifespan and includes feedback router
    - All endpoints visible in OpenAPI docs
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Estimate saving works:**
   - POST /estimate with valid data
   - Check Supabase Table Editor: new row in estimates table

2. **Pending endpoint works:**
   - GET /feedback/pending returns list with new estimate (reviewed=false)

3. **Feedback submission works:**
   - POST /feedback/submit with estimate_id and laurent_price
   - Check: estimate now has reviewed=true in Supabase
   - Check: feedback table has new row with prices

4. **Graceful degradation:**
   - Unset SUPABASE_URL env var
   - POST /estimate still works (estimate returned, save fails silently)
   - GET /feedback/pending returns 503 Service Unavailable
</verification>

<success_criteria>
- Supabase tables exist with correct schema
- New estimates saved to database automatically
- GET /feedback/pending returns unreviewed estimates
- GET /feedback/estimate/{id} returns full estimate details
- POST /feedback/submit creates feedback and marks reviewed
- Estimate endpoint works even if Supabase unavailable (graceful degradation)
</success_criteria>

<output>
After completion, create `.planning/phases/05-feedback-system/05-01-SUMMARY.md`
</output>
