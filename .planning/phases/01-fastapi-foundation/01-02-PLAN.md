---
phase: 01-fastapi-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - backend/app/schemas/estimate.py
  - backend/app/routers/health.py
  - backend/app/routers/estimate.py
  - backend/app/main.py
  - backend/tests/__init__.py
  - backend/tests/conftest.py
  - backend/tests/test_health.py
  - backend/tests/test_estimate.py
autonomous: true

must_haves:
  truths:
    - "GET /health returns 200 OK with status ok"
    - "POST /estimate with valid inputs returns estimate, range, and confidence"
    - "POST /estimate with invalid inputs returns 422 with error details"
    - "CORS preflight from localhost:3000 succeeds"
  artifacts:
    - path: "backend/app/routers/health.py"
      provides: "Health check endpoint"
      exports: ["router"]
    - path: "backend/app/routers/estimate.py"
      provides: "Estimate endpoint"
      exports: ["router"]
    - path: "backend/app/schemas/estimate.py"
      provides: "Request/response models"
      exports: ["EstimateRequest", "EstimateResponse"]
    - path: "backend/tests/test_estimate.py"
      provides: "Endpoint tests"
      min_lines: 30
  key_links:
    - from: "backend/app/routers/estimate.py"
      to: "backend/app/services/predictor.py"
      via: "import predict"
      pattern: "from app\\.services\\.predictor import predict"
    - from: "backend/app/main.py"
      to: "backend/app/routers/health.py"
      via: "include_router"
      pattern: "include_router\\(health\\.router\\)"
    - from: "backend/app/main.py"
      to: "backend/app/routers/estimate.py"
      via: "include_router"
      pattern: "include_router\\(estimate\\.router\\)"
---

<objective>
Create the API endpoints (health check and estimate) with Pydantic validation and tests.

Purpose: Complete the FastAPI backend so it can serve ML predictions via HTTP with proper validation and error handling.

Output: Working /health and /estimate endpoints with comprehensive tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-fastapi-foundation/01-RESEARCH.md
@.planning/phases/01-fastapi-foundation/01-01-SUMMARY.md

# Reference for prediction interface
@cortex-data/cortex_config_v3.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Pydantic schemas for estimate endpoint</name>
  <files>
    backend/app/schemas/__init__.py
    backend/app/schemas/estimate.py
  </files>
  <action>
Create estimate.py with Pydantic v2 models:

EstimateRequest:
- sqft: float, required, Field(gt=0, le=100000, description="Square footage of roof")
- category: str, required, Field(description="Job category")
- material_lines: int, default=5, Field(ge=0, le=100)
- labor_lines: int, default=2, Field(ge=0, le=50)
- has_subs: Literal[0, 1], default=0
- complexity: int, default=10, Field(ge=1, le=100)

Add @field_validator for category that validates against allowed values:
["Bardeaux", "Elastomere", "Other", "Gutters", "Heat Cables", "Insulation", "Service Call", "Skylights", "Unknown", "Ventilation"]

IMPORTANT: Accept both "Elastomere" (without accent) and "Elastomere" (with accent) and normalize to the accented version for the model.

EstimateResponse:
- estimate: float
- range_low: float
- range_high: float
- confidence: Literal["HIGH", "MEDIUM", "LOW"]
- model: str

Update schemas/__init__.py to export both models.
  </action>
  <verify>
    python -c "from backend.app.schemas.estimate import EstimateRequest, EstimateResponse; print('OK')"
  </verify>
  <done>EstimateRequest and EstimateResponse models with validation exported from schemas</done>
</task>

<task type="auto">
  <name>Task 2: Create health and estimate routers</name>
  <files>
    backend/app/routers/__init__.py
    backend/app/routers/health.py
    backend/app/routers/estimate.py
  </files>
  <action>
Create health.py:
- APIRouter with tags=["health"]
- GET /health endpoint returning {"status": "ok", "version": "1.0.0"}
- Use regular def (not async def) - simple JSON response

Create estimate.py:
- APIRouter with tags=["estimate"]
- POST /estimate endpoint with response_model=EstimateResponse
- Import predict from app.services.predictor
- Use regular def (not async def) - sklearn is CPU-bound
- Call predict() with request fields
- Return EstimateResponse from prediction result
- Wrap in try/except, raise HTTPException(500) on errors

Update routers/__init__.py to export health and estimate modules.

IMPORTANT: Use regular def, not async def, for the estimate endpoint. The sklearn predict() is CPU-bound and would block the event loop if async.
  </action>
  <verify>
    python -c "from backend.app.routers.health import router; print('health OK')"
    python -c "from backend.app.routers.estimate import router; print('estimate OK')"
  </verify>
  <done>Health and estimate routers created with proper endpoint signatures</done>
</task>

<task type="auto">
  <name>Task 3: Wire routers into main.py and add tests</name>
  <files>
    backend/app/main.py
    backend/tests/__init__.py
    backend/tests/conftest.py
    backend/tests/test_health.py
    backend/tests/test_estimate.py
  </files>
  <action>
Update main.py to include routers:
- Import health and estimate from app.routers
- app.include_router(health.router)
- app.include_router(estimate.router)

Create tests directory structure:
- tests/__init__.py (empty)
- tests/conftest.py with TestClient fixture

conftest.py content:
```python
import pytest
from fastapi.testclient import TestClient
from app.main import app

@pytest.fixture
def client():
    return TestClient(app)
```

Create test_health.py:
- test_health_returns_ok: GET /health returns 200 with status "ok"

Create test_estimate.py with tests:
- test_estimate_valid_bardeaux: POST /estimate with Bardeaux returns 200, has estimate/range/confidence
- test_estimate_valid_elastomere: POST /estimate with Elastomere (accented) returns 200
- test_estimate_elastomere_without_accent: POST /estimate with "Elastomere" normalized correctly
- test_estimate_invalid_category: POST /estimate with "BadCategory" returns 422
- test_estimate_negative_sqft: POST /estimate with sqft=-100 returns 422
- test_estimate_missing_required: POST /estimate without sqft returns 422

IMPORTANT: Before running tests, copy model files from cortex-data/ to backend/app/models/:
- cortex_model_global.pkl
- cortex_model_Bardeaux.pkl
- category_encoder_v3.pkl
- cortex_config_v3.json
  </action>
  <verify>
    # First copy model files
    cp cortex-data/cortex_model_global.pkl backend/app/models/
    cp cortex-data/cortex_model_Bardeaux.pkl backend/app/models/
    cp cortex-data/category_encoder_v3.pkl backend/app/models/
    cp cortex-data/cortex_config_v3.json backend/app/models/

    # Then run tests
    cd backend && python -m pytest tests/ -v
  </verify>
  <done>All routers included in app, tests pass for health and estimate endpoints</done>
</task>

</tasks>

<verification>
After all tasks complete, verify the success criteria from ROADMAP.md:

1. GET /health returns 200 OK:
   curl http://localhost:8000/health

2. POST /estimate with valid inputs returns estimate, range, and confidence:
   curl -X POST http://localhost:8000/estimate \
     -H "Content-Type: application/json" \
     -d '{"sqft": 1500, "category": "Bardeaux"}'

3. Invalid inputs return appropriate error messages:
   curl -X POST http://localhost:8000/estimate \
     -H "Content-Type: application/json" \
     -d '{"sqft": -100, "category": "Bardeaux"}'

4. CORS allows requests from localhost:3000:
   curl -X OPTIONS http://localhost:8000/estimate \
     -H "Origin: http://localhost:3000" \
     -H "Access-Control-Request-Method: POST"

Run server with: cd backend && uvicorn app.main:app --reload
</verification>

<success_criteria>
- GET /health returns {"status": "ok", "version": "1.0.0"}
- POST /estimate with valid inputs returns estimate, range_low, range_high, confidence, model
- POST /estimate with invalid category returns 422 with validation error
- POST /estimate with negative sqft returns 422 with validation error
- CORS preflight from localhost:3000 returns appropriate headers
- All tests pass (pytest returns 0)
</success_criteria>

<output>
After completion, create `.planning/phases/01-fastapi-foundation/01-02-SUMMARY.md`
</output>
