---
phase: 23-submission-workflow-editing
plan: 03
type: execute
wave: 3
depends_on: ["23-01", "23-02"]
files_modified:
  - frontend/src/components/estimateur/sortable-line-item.tsx
  - frontend/src/components/estimateur/notes-panel.tsx
  - frontend/src/components/estimateur/upsell-dialog.tsx
  - frontend/src/components/estimateur/submission-editor.tsx
  - frontend/src/components/estimateur/full-quote-form.tsx
  - frontend/src/components/estimateur/submission-list.tsx
  - frontend/src/components/estimateur/nav-tabs.tsx
  - frontend/src/app/(admin)/estimateur/soumissions/page.tsx
autonomous: false

must_haves:
  truths:
    - "After quote generation, user can click 'Create Submission' to create editable draft"
    - "Each line item can be edited (name, quantity, unit_price) with live total recalculation"
    - "Line items can be reordered via drag-drop using @dnd-kit"
    - "New line items can be added manually (material or labor type) or from Phase 20 MaterialSelector"
    - "Line items can be removed from draft submissions"
    - "Finalize button transitions draft to pending_approval and shows upsell suggestions dialog"
    - "Approve/Reject buttons visible only to admin role (Laurent)"
    - "Return to Draft button visible on rejected submissions AND pending submissions for non-admin users"
    - "Notes panel shows timestamped attributed notes and allows adding new ones"
    - "Upsell dialog shows category-specific suggestions after finalize"
    - "Each upsell creates a separate child submission linked to parent"
    - "Soumission tab in Estimateur navigates to /estimateur/soumissions route"
    - "Clicking a submission in the list opens the submission editor"
  artifacts:
    - path: "frontend/src/components/estimateur/sortable-line-item.tsx"
      provides: "Drag-droppable line item row with inline editing"
      exports: ["SortableLineItem"]
    - path: "frontend/src/components/estimateur/notes-panel.tsx"
      provides: "Timestamped notes display and input panel"
      exports: ["NotesPanel"]
    - path: "frontend/src/components/estimateur/upsell-dialog.tsx"
      provides: "Dialog showing category-specific upsell suggestions after finalize"
      exports: ["UpsellDialog"]
    - path: "frontend/src/components/estimateur/submission-editor.tsx"
      provides: "Main submission editor with drag-drop line items, totals, action buttons"
      exports: ["SubmissionEditor"]
      min_lines: 200
    - path: "frontend/src/components/estimateur/submission-list.tsx"
      provides: "Submission list view with status badges, filters, and click-to-open"
      exports: ["SubmissionList"]
    - path: "frontend/src/components/estimateur/full-quote-form.tsx"
      provides: "Updated full quote form with Create Submission button and SubmissionEditor rendering"
      contains: "SubmissionEditor"
    - path: "frontend/src/components/estimateur/nav-tabs.tsx"
      provides: "Updated nav tabs with 4th Soumissions tab as Link to /estimateur/soumissions"
      contains: "soumissions"
    - path: "frontend/src/app/(admin)/estimateur/soumissions/page.tsx"
      provides: "Soumissions page rendering SubmissionList wrapped with EstimateurTabs"
      contains: "SubmissionList"
  key_links:
    - from: "frontend/src/components/estimateur/submission-editor.tsx"
      to: "frontend/src/lib/api/submissions.ts"
      via: "API calls for CRUD and workflow operations"
      pattern: "from.*api/submissions.*import"
    - from: "frontend/src/components/estimateur/submission-editor.tsx"
      to: "frontend/src/components/estimateur/material-selector.tsx"
      via: "MaterialSelector imported in Dialog for 'Add from Materials Database' flow"
      pattern: "import.*MaterialSelector.*from.*material-selector"
    - from: "frontend/src/components/estimateur/full-quote-form.tsx"
      to: "frontend/src/components/estimateur/submission-editor.tsx"
      via: "Renders SubmissionEditor after quote result and Create Submission click"
      pattern: "<SubmissionEditor"
    - from: "frontend/src/components/estimateur/submission-editor.tsx"
      to: "@dnd-kit/sortable"
      via: "DndContext and SortableContext for drag-drop reordering"
      pattern: "from.*@dnd-kit"
    - from: "frontend/src/components/estimateur/submission-list.tsx"
      to: "frontend/src/lib/api/submissions.ts"
      via: "listSubmissions() to populate list, getSubmission() for detail"
      pattern: "listSubmissions"
    - from: "frontend/src/app/(admin)/estimateur/soumissions/page.tsx"
      to: "frontend/src/components/estimateur/submission-list.tsx"
      via: "Soumissions page renders SubmissionList"
      pattern: "SubmissionList"
---

<objective>
Build all remaining UI components and wire the complete submission workflow into the existing application: 3 sub-components (sortable line item, notes panel, upsell dialog), the main submission editor, Create Submission flow from full-quote-form, submission list page, and Soumissions tab in Estimateur navigation.

Purpose: This is the user-facing layer that makes submissions accessible and editable. Plan 23-02 created the infrastructure (types, API, auth, i18n); this plan builds every component that uses it and wires them into the existing UI.

Output: 5 new components, 2 updated files, 1 new page file. Complete end-to-end submission editing flow accessible from both the quote result and the Soumissions tab.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-submission-workflow-editing/23-RESEARCH.md
@.planning/phases/23-submission-workflow-editing/23-01-SUMMARY.md
@.planning/phases/23-submission-workflow-editing/23-02-SUMMARY.md
@frontend/src/components/estimateur/full-quote-form.tsx
@frontend/src/components/estimateur/quote-result.tsx
@frontend/src/components/estimateur/material-selector.tsx
@frontend/src/components/estimateur/nav-tabs.tsx
@frontend/src/app/(admin)/estimateur/complet/page.tsx
@frontend/src/types/submission.ts
@frontend/src/lib/api/submissions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build sortable-line-item, notes-panel, upsell-dialog, and submission-editor components</name>
  <files>
    frontend/src/components/estimateur/sortable-line-item.tsx
    frontend/src/components/estimateur/notes-panel.tsx
    frontend/src/components/estimateur/upsell-dialog.tsx
    frontend/src/components/estimateur/submission-editor.tsx
  </files>
  <action>
**1. Create `sortable-line-item.tsx`:**

"use client". Drag-droppable line item row. Props: `id` (string), `index` (number), `item` (LineItem), `onUpdate` (callback: index, field, value), `onRemove` (callback: index), `disabled` (boolean).

Use `useSortable({ id })` from `@dnd-kit/sortable`. Apply `CSS.Transform.toString(transform)` and `transition` to the outer div via `ref={setNodeRef}`.

Row layout (flex, gap-2, p-2, rounded-lg, border):
1. **Drag handle**: GripVertical icon with `{...attributes} {...listeners}`, hidden when disabled, `cursor-grab` class
2. **Type badge**: Small Badge "Mat." or "M.O." based on item.type, using `t.submission.material` / `t.submission.labor` abbreviations
3. **Name input**: `<Input>` bound to item.name, onChange calls `onUpdate(index, "name", e.target.value)`, disabled when parent disabled, className="h-9 flex-1"
4. **Quantity input**: `<Input type="number">` min=0.01 step=0.01, value=item.quantity, onChange calls `onUpdate(index, "quantity", parseFloat(e.target.value) || 0)`, className="h-9 w-20"
5. **Unit price input**: `<Input type="number">` min=0 step=0.01, value=item.unit_price, className="h-9 w-24"
6. **Total display**: Read-only span showing `quantity * unit_price` formatted as CAD with fr-CA locale (Intl.NumberFormat)
7. **Remove button**: `<Button variant="ghost" size="sm">` with Trash2 icon, hidden when disabled, calls `onRemove(index)`

CRITICAL: The parent component MUST use `key={item.id}` (not index) when mapping SortableLineItem.

**2. Create `notes-panel.tsx`:**

"use client". Notes display and input. Props: `notes` (Note[]), `onAddNote` (async callback with text), `disabled` (boolean, optional), `isLoading` (boolean, optional).

Layout wrapped in a Card:
- CardHeader: "Notes" title with count badge (`notes.length`)
- CardContent:
  - If no notes: muted "No notes yet" text (i18n)
  - Notes list (reverse chronological -- sort by created_at DESC):
    - Each note: text in a rounded-lg bg-muted/30 p-3, with "Par {created_by}" and formatted date below in text-xs text-muted-foreground
    - Date formatting: `new Intl.DateTimeFormat("fr-CA", { dateStyle: "medium", timeStyle: "short" }).format(new Date(note.created_at))`
  - Input area (bottom): shadcn `<Textarea rows={2}>` with placeholder from i18n, + "Add" Button
  - On submit: call `onAddNote(text)`, clear textarea
  - Disable input + button when `disabled` is true or `isLoading` is true

**3. Create `upsell-dialog.tsx`:**

"use client". Dialog shown after finalize. Props: `open` (boolean), `onOpenChange` (callback), `suggestions` (UpsellSuggestion[]), `onCreateUpsell` (async callback with type string), `locale` (string).

Use shadcn Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription.

Content:
- Title: `t.submission.upsellSuggestions`
- Description: `t.submission.upsellDescription`
- List of suggestion cards: each is a rounded border div with:
  - Name: `locale === 'fr' ? suggestion.name_fr : suggestion.name_en`
  - Description: same locale logic for description
  - "Create Submission" button (primary, small) on the right
  - Button calls `onCreateUpsell(suggestion.type)` and shows a loading state
- Footer: "Skip" button (outline variant) calls `onOpenChange(false)`

**4. Create `submission-editor.tsx`:**

"use client". This is the core component (~250+ lines). Props: `initialData` (Submission), `onUpdate` (callback: Submission), `userRole` ('admin' | 'estimator', default 'estimator'), `userName` (string, default 'estimateur').

**Imports -- explicit list:**
```typescript
import { MaterialSelector, type SelectedMaterial } from "@/components/estimateur/material-selector";
import { SortableLineItem } from "@/components/estimateur/sortable-line-item";
import { NotesPanel } from "@/components/estimateur/notes-panel";
import { UpsellDialog } from "@/components/estimateur/upsell-dialog";
import { SubmissionStatusBadge } from "@/components/estimateur/submission-status-badge";
import {
  updateSubmission, finalizeSubmission, approveSubmission, rejectSubmission,
  returnToDraft, addNote, createUpsell, getUpsellSuggestions
} from "@/lib/api/submissions";
import type { Submission, LineItem, UpsellSuggestion } from "@/types/submission";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { DndContext, closestCenter, DragEndEvent } from '@dnd-kit/core';
import { SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable';
```

State:
- `submission` (Submission, initialized from initialData)
- `lineItems` (LineItem[], initialized from submission.line_items -- local editing state)
- `isLoading` (boolean)
- `error` (string | null)
- `showUpsellDialog` (boolean)
- `upsellSuggestions` (UpsellSuggestion[])
- `showMaterialSelector` (boolean)
- `clientName` (string, from submission.client_name)

Derived:
- `isDraft = submission.status === 'draft'`
- `isPending = submission.status === 'pending_approval'`
- `isRejected = submission.status === 'rejected'`
- `isAdmin = userRole === 'admin'`

**Line item editing handlers:**
- `handleUpdateItem(index, field, value)`: Update lineItems[index][field] = value. If field is quantity or unit_price, also recompute total = quantity * unit_price. Set new lineItems state.
- `handleRemoveItem(index)`: Remove from lineItems, reorder remaining items.
- `handleAddItem(type: 'material' | 'labor')`: Append new LineItem with crypto.randomUUID() id, type, empty name, quantity=1, unit_price=0, total=0, order=lineItems.length.
- `handleAddFromMaterials(materials: SelectedMaterial[])`: Converts each SelectedMaterial (from Phase 20 MaterialSelector component) to a LineItem:
  ```typescript
  const handleAddFromMaterials = (materials: SelectedMaterial[]) => {
    const newItems: LineItem[] = materials.map((m, i) => ({
      id: crypto.randomUUID(),
      type: 'material' as const,
      material_id: m.id > 0 ? m.id : undefined,
      name: m.name,
      quantity: 1,
      unit_price: m.sell_price || 0,
      total: m.sell_price || 0,
      order: lineItems.length + i,
    }));
    setLineItems(prev => [...prev, ...newItems]);
    setShowMaterialSelector(false);
  };
  ```

**Drag-drop setup:**
```typescript
import { DndContext, closestCenter, DragEndEvent } from '@dnd-kit/core';
import { SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable';

const handleDragEnd = (event: DragEndEvent) => {
  const { active, over } = event;
  if (active.id !== over?.id) {
    const oldIndex = lineItems.findIndex(li => li.id === active.id);
    const newIndex = lineItems.findIndex(li => li.id === over?.id);
    const newItems = [...lineItems];
    const [moved] = newItems.splice(oldIndex, 1);
    newItems.splice(newIndex, 0, moved);
    setLineItems(newItems.map((item, i) => ({ ...item, order: i })));
  }
};
```

**Computed totals** (useMemo):
- totalMaterials = lineItems.filter(type==="material").reduce(sum total, 0)
- totalLabor = lineItems.filter(type==="labor").reduce(sum total, 0)
- grandTotal = totalMaterials + totalLabor

Format with `Intl.NumberFormat("fr-CA", { style: "currency", currency: "CAD" })` (same as quote-result.tsx).

**Action handlers:**
- `handleSave`: Call updateSubmission API with current lineItems and clientName. On success, update submission state and call onUpdate.
- `handleFinalize`: Show confirm dialog (shadcn AlertDialog). On confirm, call finalizeSubmission API. On success, fetch upsell suggestions via getUpsellSuggestions API, set showUpsellDialog=true, update submission state.
- `handleApprove`: Call approveSubmission API with admin role header. Update state.
- `handleReject`: Show dialog with optional reason textarea. Call rejectSubmission API.
- `handleReturnToDraft`: Call returnToDraft API (POST /submissions/{id}/return-to-draft). On success, update submission state (status back to draft, editing re-enabled). Show success toast using `t.submission.submissionReturnedToDraft`.
- `handleAddNote(text)`: Call addNote API. On success, update submission state (new note appears).
- `handleCreateUpsell(type)`: Call createUpsell API. Show success toast. Child appears in submission.children.

**Layout structure (top to bottom):**

```
<div className="space-y-6">

  {/* Header with status + metadata */}
  <div className="flex items-center justify-between">
    <div className="flex items-center gap-3">
      <SubmissionStatusBadge status={submission.status} />
      <span className="text-sm text-muted-foreground">{submission.category} | {submission.sqft} pi2</span>
    </div>
    <span className="text-xs text-muted-foreground">{formatDate(submission.created_at)}</span>
  </div>

  {/* Client name input (editable in draft) */}
  <div>
    <Label>{t.submission.clientName}</Label>
    <Input value={clientName} onChange={...} disabled={!isDraft} placeholder={t.submission.clientNamePlaceholder} />
  </div>

  {/* Line Items Card */}
  <Card>
    <CardHeader>
      <CardTitle>{t.submission.editLineItems}</CardTitle>
    </CardHeader>
    <CardContent>
      {/* Column headers */}
      <div className="hidden sm:grid grid-cols-[40px_60px_1fr_80px_100px_100px_40px] gap-2 text-xs font-medium text-muted-foreground mb-2">
        <span></span><span>{t.submission.lineItemType}</span><span>{t.submission.lineItemName}</span>
        <span>{t.submission.lineItemQuantity}</span><span>{t.submission.lineItemUnitPrice}</span>
        <span>{t.submission.lineItemTotal}</span><span></span>
      </div>

      {lineItems.length === 0 ? (
        <p className="text-sm text-muted-foreground py-4 text-center">{t.submission.noLineItems}</p>
      ) : (
        <DndContext collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
          <SortableContext items={lineItems.map(li => li.id)} strategy={verticalListSortingStrategy}>
            {lineItems.map((item, index) => (
              <SortableLineItem
                key={item.id}  // CRITICAL: key={item.id} NOT key={index}
                id={item.id}
                index={index}
                item={item}
                onUpdate={handleUpdateItem}
                onRemove={handleRemoveItem}
                disabled={!isDraft}
              />
            ))}
          </SortableContext>
        </DndContext>
      )}

      {/* Add buttons (draft only) */}
      {isDraft && (
        <div className="flex gap-2 mt-4">
          <Button variant="outline" size="sm" onClick={() => handleAddItem('material')}>
            + {t.submission.addMaterial}
          </Button>
          <Button variant="outline" size="sm" onClick={() => handleAddItem('labor')}>
            + {t.submission.addLabor}
          </Button>
          <Button variant="outline" size="sm" onClick={() => setShowMaterialSelector(true)}>
            {t.submission.addFromMaterials}
          </Button>
        </div>
      )}

      {/* Totals */}
      <div className="mt-4 pt-4 border-t space-y-1">
        <div className="flex justify-between text-sm">
          <span>{t.submission.totalMaterials}</span>
          <span className="font-medium tabular-nums">{formatCurrency(totalMaterials)}</span>
        </div>
        <div className="flex justify-between text-sm">
          <span>{t.submission.totalLabor}</span>
          <span className="font-medium tabular-nums">{formatCurrency(totalLabor)}</span>
        </div>
        <hr className="my-2" />
        <div className="flex justify-between text-lg font-bold">
          <span>{t.submission.grandTotal}</span>
          <span className="tabular-nums">{formatCurrency(grandTotal)}</span>
        </div>
      </div>
    </CardContent>
  </Card>

  {/* MaterialSelector Dialog (reuse Phase 20 component) */}
  <Dialog open={showMaterialSelector} onOpenChange={setShowMaterialSelector}>
    <DialogContent className="max-w-lg">
      <DialogHeader><DialogTitle>{t.submission.addFromMaterials}</DialogTitle></DialogHeader>
      <MaterialSelector
        selectedMaterials={[]}
        onSelectionChange={(materials: SelectedMaterial[]) => {
          handleAddFromMaterials(materials);
        }}
      />
    </DialogContent>
  </Dialog>

  {/* Notes Panel */}
  <NotesPanel
    notes={submission.notes}
    onAddNote={handleAddNote}
    disabled={isLoading}
  />

  {/* Error display */}
  {error && (
    <div className="flex items-center gap-2 rounded-lg border border-destructive/50 bg-destructive/10 p-4 text-destructive">
      <AlertCircle className="size-5 shrink-0" />
      <p className="text-sm">{error}</p>
    </div>
  )}

  {/* Action buttons */}
  <div className="flex gap-3 pt-4 border-t">
    {isDraft && (
      <>
        <Button onClick={handleSave} disabled={isLoading}>
          {isLoading ? <Loader2 className="mr-2 size-4 animate-spin" /> : null}
          {t.submission.save}
        </Button>
        <Button variant="secondary" onClick={handleFinalize} disabled={isLoading || lineItems.length === 0}>
          {t.submission.finalize}
        </Button>
      </>
    )}
    {isPending && isAdmin && (
      <>
        <Button onClick={handleApprove} disabled={isLoading} className="bg-green-600 hover:bg-green-700">
          {t.submission.approve}
        </Button>
        <Button variant="destructive" onClick={handleReject} disabled={isLoading}>
          {t.submission.reject}
        </Button>
      </>
    )}
    {isPending && !isAdmin && (
      <p className="text-sm text-muted-foreground italic">{t.submission.awaitingApproval}</p>
    )}
    {(isRejected || (isPending && !isAdmin)) && (
      <Button variant="outline" onClick={handleReturnToDraft} disabled={isLoading}>
        {t.submission.returnToDraft}
      </Button>
    )}
  </div>

  {/* Child submissions (upsells) */}
  {submission.children && submission.children.length > 0 && (
    <Card>
      <CardHeader><CardTitle>{t.submission.childSubmissions}</CardTitle></CardHeader>
      <CardContent>
        {submission.children.map(child => (
          <div key={child.id} className="flex items-center justify-between p-2 rounded border mb-2">
            <div>
              <SubmissionStatusBadge status={child.status} />
              <span className="ml-2 text-sm">{child.upsell_type}</span>
            </div>
            <span className="text-sm font-medium">{formatCurrency(child.total_price)}</span>
          </div>
        ))}
      </CardContent>
    </Card>
  )}

  {/* Upsell Dialog */}
  <UpsellDialog
    open={showUpsellDialog}
    onOpenChange={setShowUpsellDialog}
    suggestions={upsellSuggestions}
    onCreateUpsell={handleCreateUpsell}
    locale={locale}
  />
</div>
```

IMPORTANT on Return to Draft button: The button shows for BOTH `isRejected` AND `isPending && !isAdmin`. This allows estimators to recall their submission before the admin reviews it (pending_approval -> draft) as well as fix rejected submissions (rejected -> draft). The backend state machine already supports both transitions. The condition is:
```tsx
{(isRejected || (isPending && !isAdmin)) && (
  <Button variant="outline" onClick={handleReturnToDraft} disabled={isLoading}>
    {t.submission.returnToDraft}
  </Button>
)}
```

Note: The submission-editor.tsx uses SubmissionStatusBadge from Plan 23-02 (already created).
  </action>
  <verify>
```bash
cd /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend && npx tsc --noEmit --skipLibCheck 2>&1 | head -30
```
Verify all component files exist:
```bash
ls -la /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/submission-editor.tsx
ls -la /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/sortable-line-item.tsx
ls -la /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/notes-panel.tsx
ls -la /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/upsell-dialog.tsx
```
Verify MaterialSelector import in submission-editor.tsx:
```bash
grep "MaterialSelector\|material-selector\|handleAddFromMaterials\|SelectedMaterial" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/submission-editor.tsx
```
Verify returnToDraft wiring with expanded scope (both rejected and pending for non-admin):
```bash
grep "returnToDraft\|handleReturnToDraft\|return-to-draft\|isRejected\|isPending" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/submission-editor.tsx
```
  </verify>
  <done>
4 new components created: SortableLineItem (drag-droppable row with useSortable and inline editing), NotesPanel (timestamped notes with add input), UpsellDialog (category-specific suggestions after finalize), SubmissionEditor (main editor with DndContext, line items, totals, action buttons, MaterialSelector integration via Dialog, Return to Draft button for BOTH rejected submissions AND pending submissions when user is non-admin). All use types, API client, and i18n from Plan 23-02.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire into full-quote-form, build submission list, add Soumissions route</name>
  <files>
    frontend/src/components/estimateur/full-quote-form.tsx
    frontend/src/components/estimateur/submission-list.tsx
    frontend/src/components/estimateur/nav-tabs.tsx
    frontend/src/app/(admin)/estimateur/soumissions/page.tsx
  </files>
  <action>
**1. Update `full-quote-form.tsx`:**

After the existing QuoteResult display in the right column (around line 1059), add:

1. New state: `const [submission, setSubmission] = useState<Submission | null>(null);`
2. Import: `import { SubmissionEditor } from "./submission-editor";` and `import { createSubmission } from "@/lib/api/submissions";` and `import type { Submission, LineItem as SubmissionLineItem } from "@/types/submission";`

3. Add a "Create Submission" button below the QuoteResult component:
```tsx
{result && !submission && (
  <Button
    className="w-full mt-4"
    onClick={async () => {
      // Convert HybridQuoteResponse to submission line items
      const standardTier = result.pricing_tiers.find(t => t.tier === "Standard");
      const hourlyRate = result.total_labor_hours > 0
        ? (standardTier?.labor_cost || 0) / result.total_labor_hours
        : 0;

      const lineItems: SubmissionLineItem[] = [
        ...result.work_items.map((wi, i) => ({
          id: crypto.randomUUID(),
          type: 'labor' as const,
          name: wi.name,
          quantity: wi.labor_hours,
          unit_price: Math.round(hourlyRate * 100) / 100,
          total: Math.round(wi.labor_hours * hourlyRate * 100) / 100,
          order: i,
        })),
        ...result.materials.map((mat, i) => ({
          id: crypto.randomUUID(),
          type: 'material' as const,
          material_id: mat.material_id,
          name: `Material #${mat.material_id}`,
          quantity: mat.quantity,
          unit_price: mat.unit_price,
          total: mat.total,
          order: result.work_items.length + i,
        })),
      ];

      try {
        const sub = await createSubmission({
          category,
          sqft,
          created_by: form.getValues("created_by"),
          line_items: lineItems,
          pricing_tiers: result.pricing_tiers,
          selected_tier: "Standard",
        });
        setSubmission(sub);
      } catch (err) {
        setError(err instanceof Error ? err.message : "Failed to create submission");
      }
    }}
  >
    {t.submission.createSubmission}
  </Button>
)}
```

4. When submission exists, render SubmissionEditor below or replacing the QuoteResult:
```tsx
{submission && (
  <SubmissionEditor
    initialData={submission}
    onUpdate={(updated) => setSubmission(updated)}
    userRole="estimator"
    userName={form.getValues("created_by") || "estimateur"}
  />
)}
```

Keep existing QuoteResult and form functionality intact. The SubmissionEditor is additive.

**2. Create `submission-list.tsx`:**

"use client". List view showing all submissions:
- On mount: call `listSubmissions()` to load submissions
- Display as a list of Cards (card layout for mobile compatibility):
  - Each card shows: SubmissionStatusBadge, client_name (or "Sans nom"), category, total_price (formatted), created date, upsell_type badge if present
  - If has_children: show small indicator (e.g., "3 upsells" badge)
  - Click card: select it (set selectedId state)
- When selectedId is set: show SubmissionEditor component for that submission
  - Load full submission via `getSubmission(selectedId)`
  - Pass userRole and userName props
  - onUpdate callback: refresh the submission in the list
- Status filter tabs at top: All | Draft | Pending | Approved | Rejected (use shadcn Tabs)
- Back button when viewing single submission to return to list
- Refresh button to reload list
- Use useLanguage() for all labels
- Handle loading and empty states
- Props: `userRole?: 'admin' | 'estimator'`, `userName?: string`

When SubmissionEditor calls `onUpdate` and the updated submission has status="pending_approval" (meaning it was just finalized), track `showUpsellDialog` state and render UpsellDialog. This provides the natural flow: create quote -> create submission -> edit line items -> finalize -> upsell dialog appears.

Note on return-to-draft: The SubmissionEditor already has the "Return to Draft" button for both rejected AND pending (non-admin) submissions. When the user clicks it, the editor calls returnToDraft API and updates its state. The list will reflect the new status on the next refresh or via the onUpdate callback.

**3. Update `nav-tabs.tsx`:**

The Estimateur uses URL-based routing with Next.js Link components and separate page files per tab. The current tabs array is:
```typescript
const tabs = [
  { href: "/estimateur", label: t.estimateur.prix },
  { href: "/estimateur/materiaux", label: t.estimateur.materiaux },
  { href: "/estimateur/complet", label: t.estimateur.soumissionComplete },
];
```

Add a 4th Link-based tab entry to the tabs array:
```typescript
{ href: "/estimateur/soumissions", label: t.submission?.submissions || "Soumissions" }
```

This follows the exact same pattern as the existing tabs -- it's a Link that navigates to `/estimateur/soumissions`, which will be handled by a new page file. The `isActive` logic already handles sub-routes via `pathname.startsWith(tab.href)`, so `/estimateur/soumissions` will be correctly highlighted.

DO NOT add any tab state, useState, or conditional rendering to nav-tabs.tsx. The routing is entirely URL-based with Next.js file-system routing.

**4. Create `frontend/src/app/(admin)/estimateur/soumissions/page.tsx`:**

Create a new page file following the EXACT pattern from `estimateur/complet/page.tsx`:

```tsx
"use client";

import { useLanguage } from "@/lib/i18n";
import { EstimateurTabs } from "@/components/estimateur/nav-tabs";
import { SubmissionList } from "@/components/estimateur/submission-list";

export default function SoumissionsPage() {
  const { t } = useLanguage();

  return (
    <div className="max-w-2xl">
      <h1 className="text-3xl font-bold tracking-tight mb-6">
        {t.nav.estimateur}
      </h1>
      <EstimateurTabs />
      <div className="mt-6">
        <SubmissionList />
      </div>
    </div>
  );
}
```

This creates the `/estimateur/soumissions` route that the nav tab links to. The page wraps `<SubmissionList />` with the same layout and `<EstimateurTabs />` header used by all other estimateur pages (prix, materiaux, complet).

DO NOT modify `estimateur/page.tsx` -- it remains the "Prix" tab page. Each tab has its own page file under the `estimateur/` directory.
  </action>
  <verify>
```bash
cd /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend && npx tsc --noEmit --skipLibCheck 2>&1 | head -30
```
Verify full-quote-form imports:
```bash
grep "SubmissionEditor\|createSubmission" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/full-quote-form.tsx
```
Verify submission-list exists:
```bash
ls -la /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/submission-list.tsx
grep "SubmissionList" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/submission-list.tsx
```
Verify nav-tabs has soumissions Link:
```bash
grep "soumissions\|Soumissions" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/nav-tabs.tsx
```
Verify soumissions page file exists with correct pattern:
```bash
ls -la /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/app/\(admin\)/estimateur/soumissions/page.tsx
grep "SubmissionList\|EstimateurTabs" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/app/\(admin\)/estimateur/soumissions/page.tsx
```
  </verify>
  <done>
Full-quote-form updated with "Create Submission" button that converts HybridQuoteResponse to submission and renders SubmissionEditor. SubmissionList component displays filterable submission cards with click-to-edit and upsell dialog after finalize. Nav tabs updated with 4th "Soumissions" Link tab pointing to /estimateur/soumissions. New page file at estimateur/soumissions/page.tsx renders SubmissionList wrapped with EstimateurTabs (same pattern as complet/page.tsx). No modification to estimateur/page.tsx -- routing is URL-based.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete submission editing workflow integrated into the Estimateur page:
- After AI generates a quote, "Create Submission" button appears in the Complet tab
- Submission editor shows with editable line items (drag-drop reorder via @dnd-kit)
- Add items manually or from Phase 20 materials database (MaterialSelector in Dialog)
- Edit quantity/price with live total recalculation
- Status badges: draft (gray), pending (amber), approved (green), rejected (red)
- Notes panel with timestamped entries and add input
- Finalize button locks editing, triggers upsell suggestion dialog
- Approve/Reject buttons for admin role only
- Return to Draft button on BOTH rejected submissions AND pending submissions for non-admin users (allows estimator to recall before admin reviews)
- Upsell suggestions: Bardeaux (cables, gutters, ventilation), Elastomere (drain, insulation, maintenance), Metal (gutters, snow guards, warranty), Universal (inspection, maintenance)
- Each upsell creates separate child submission
- New "Soumissions" tab in Estimateur navigation links to /estimateur/soumissions route
- Soumissions page shows submission list with filters
- Clicking a submission opens the editor
- All UI bilingual FR/EN
- Auth extended with username/role (ADMIN_USERS env var)
  </what-built>
  <how-to-verify>
1. Set env var: `ADMIN_USERS=laurent,Laurent` in frontend .env.local
2. Start backend: `cd backend && python -m uvicorn app.main:app --reload`
3. Start frontend: `cd frontend && pnpm dev`
4. Go to http://localhost:3000/estimateur/complet
5. Fill the form and click "Generate" to get a quote
6. After quote appears, click "Create Submission" button
7. Verify submission editor shows with line items from the quote
8. Edit a line item quantity -- verify total recalculates
9. Drag a line item up or down -- verify reorder works
10. Click "Add Material" -- verify empty row appears
11. Click "Add from Materials Database" -- verify MaterialSelector dialog opens, select a material, verify it converts to a line item
12. Add a note -- verify it appears with timestamp
13. Click "Finalize" -- verify status changes to "Pending Approval" and upsell dialog appears
14. Verify editing is locked after finalize
15. As a NON-admin user: verify "Return to Draft" button appears on PENDING submissions (allows recall)
16. Click "Return to Draft" on a pending submission -- verify status returns to draft and editing is re-enabled
17. Re-finalize the submission, then test as admin: verify Approve/Reject buttons appear
18. Test reject flow: reject the submission, verify "Return to Draft" button appears on the rejected submission
19. Click "Return to Draft" on the rejected submission -- verify status returns to draft
20. Click the "Soumissions" tab in Estimateur -- verify it navigates to /estimateur/soumissions
21. Verify submission list appears with status filter tabs
22. Click a submission card -- verify editor opens with that submission
23. Toggle language FR/EN -- verify all new text switches
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. All 5 new component files exist and export correctly (sortable-line-item, notes-panel, upsell-dialog, submission-editor, submission-list)
2. `npx tsc --noEmit --skipLibCheck` passes without errors
3. Full-quote-form has "Create Submission" button and SubmissionEditor rendering
4. Drag-drop uses item.id as key (not index)
5. Totals recalculate on line item changes
6. MaterialSelector imported from "@/components/estimateur/material-selector" with SelectedMaterial type
7. handleAddFromMaterials converts SelectedMaterial[] to LineItem[]
8. Return to Draft button shows on rejected submissions AND pending submissions for non-admin users
9. Nav tabs have 4 tabs: Prix, Materiaux, Complet, Soumissions (all Link-based, URL routing)
10. /estimateur/soumissions route exists as page file rendering SubmissionList with EstimateurTabs
11. Upsell dialog triggered after finalization in both full-quote-form and submission-list contexts
12. No file overlap with Plan 23-02 (zero shared files)
</verification>

<success_criteria>
1. "Create Submission" button appears after quote generation and creates draft via API
2. Line items editable (name, qty, price) with live total recalculation
3. Drag-drop reordering works via @dnd-kit (grab handle, visual feedback, correct state after drop)
4. MaterialSelector from Phase 20 works for adding items from DB
5. Status workflow: draft (edit) -> finalize -> pending (locked) -> approve/reject (admin only) -> return to draft (if rejected OR if pending for non-admin)
6. Notes: add timestamped notes, view history, user attribution
7. Upsell dialog shows after finalize with category-specific suggestions, creates child submissions
8. Approve/Reject buttons only visible for admin role
9. Return to Draft button visible on rejected submissions AND pending submissions for non-admin users
10. Soumissions tab navigates to /estimateur/soumissions route (URL-based routing, not tab state)
11. No TypeScript compilation errors
12. All new UI text in both FR and EN
</success_criteria>

<output>
After completion, create `.planning/phases/23-submission-workflow-editing/23-03-SUMMARY.md`
</output>
