---
phase: 23-submission-workflow-editing
plan: 03
type: execute
wave: 3
depends_on: ["23-01", "23-02"]
files_modified:
  - frontend/src/lib/auth.ts
  - frontend/src/app/actions/auth.ts
  - frontend/src/components/estimateur/quote-result.tsx
  - frontend/src/components/estimateur/upsell-dialog.tsx
  - frontend/src/components/estimateur/submission-list.tsx
  - frontend/src/app/(admin)/estimateur/page.tsx
  - frontend/src/components/estimateur/nav-tabs.tsx
autonomous: true

must_haves:
  truths:
    - "After AI generates a quote, user can click 'Create Submission' to create a draft submission"
    - "Soumission tab in Estimateur shows list of submissions with status badges"
    - "Clicking a submission in the list opens the submission editor"
    - "After finalizing a submission, upsell suggestions dialog appears"
    - "User can select upsells to create as separate child submissions"
    - "Session carries username and role for RBAC headers in API calls"
    - "Admin users see approve/reject buttons, estimators see read-only pending status"
  artifacts:
    - path: "frontend/src/lib/auth.ts"
      provides: "Extended SessionData with username and role fields"
      contains: "role"
    - path: "frontend/src/app/actions/auth.ts"
      provides: "Auth action setting username and role from ADMIN_USERS env var"
      contains: "ADMIN_USERS"
    - path: "frontend/src/components/estimateur/upsell-dialog.tsx"
      provides: "Dialog showing category-specific upsell suggestions with create buttons"
    - path: "frontend/src/components/estimateur/submission-list.tsx"
      provides: "Submission list view with status badges, filters, and click-to-open"
    - path: "frontend/src/components/estimateur/quote-result.tsx"
      provides: "Updated quote result with 'Create Submission' button"
      contains: "createSubmission"
  key_links:
    - from: "frontend/src/components/estimateur/quote-result.tsx"
      to: "frontend/src/lib/api/submissions.ts"
      via: "createSubmission() call when user clicks 'Create Submission'"
      pattern: "createSubmission"
    - from: "frontend/src/components/estimateur/submission-list.tsx"
      to: "frontend/src/lib/api/submissions.ts"
      via: "listSubmissions() to populate list"
      pattern: "listSubmissions"
    - from: "frontend/src/components/estimateur/upsell-dialog.tsx"
      to: "frontend/src/lib/api/submissions.ts"
      via: "getUpsellSuggestions() + createUpsell() calls"
      pattern: "(getUpsellSuggestions|createUpsell)"
    - from: "frontend/src/app/(admin)/estimateur/page.tsx"
      to: "frontend/src/components/estimateur/submission-list.tsx"
      via: "Soumission tab renders SubmissionList"
      pattern: "SubmissionList"
---

<objective>
Wire the submission system into the existing application: extend auth with username/role, add "Create Submission" flow from quote results, build submission list view, add upsell dialog after finalization, and connect to the Estimateur Soumission tab.

Purpose: This is the integration layer that makes submissions accessible from the existing UI. Without this, the editor and API exist but are unreachable by users.

Output: Auth extended with RBAC, quote result has submission creation, Soumission tab shows submission list with editor, upsell dialog after finalization.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-submission-workflow-editing/23-RESEARCH.md
@.planning/phases/23-submission-workflow-editing/23-01-SUMMARY.md
@.planning/phases/23-submission-workflow-editing/23-02-SUMMARY.md
@frontend/src/lib/auth.ts
@frontend/src/app/actions/auth.ts
@frontend/src/components/estimateur/quote-result.tsx
@frontend/src/components/estimateur/nav-tabs.tsx
@frontend/src/app/(admin)/estimateur/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend auth with username/role and add Create Submission to quote result</name>
  <files>
    frontend/src/lib/auth.ts
    frontend/src/app/actions/auth.ts
    frontend/src/components/estimateur/quote-result.tsx
  </files>
  <action>
**Extend `frontend/src/lib/auth.ts`:**

Update the SessionData interface:
```typescript
export interface SessionData {
  isAuthenticated: boolean;
  username?: string;       // NEW: user identifier for notes/audit
  role?: 'admin' | 'estimator';  // NEW: role for RBAC
}
```

No other changes needed in this file.

**Update `frontend/src/app/actions/auth.ts`:**

Read the existing authenticate action. It currently accepts a password and sets isAuthenticated=true on match. Extend it to:

1. Accept `{ password: string, username?: string }` instead of just password (or formData with both fields)
2. After password validation passes, determine role:
   ```typescript
   const adminUsers = (process.env.ADMIN_USERS || "laurent,admin").toLowerCase().split(",").map(s => s.trim());
   const name = username || "estimateur";
   const role = adminUsers.includes(name.toLowerCase()) ? "admin" : "estimator";
   ```
3. Set on session:
   ```typescript
   session.isAuthenticated = true;
   session.username = name;
   session.role = role;
   ```
4. Keep backward compatibility: if no username provided, default to "estimateur" with "estimator" role.

**Update `frontend/src/components/estimateur/quote-result.tsx`:**

Add a "Create Submission" button to the QuoteResult component. This transforms the AI-generated quote into an editable submission.

After the existing QuoteActions component (PDF export etc.), add a new section:

1. Import `createSubmission` from `@/lib/api/submissions`
2. Import `Submission` type from `@/types/submission`
3. Add state: `const [submissionCreated, setSubmissionCreated] = useState<string | null>(null)`
4. Add state: `const [isCreating, setIsCreating] = useState(false)`
5. Add handler `handleCreateSubmission`:
   - Build SubmissionCreatePayload from quote data:
     - category from props
     - sqft from props
     - line_items: Convert quote.materials to LineItem[] (type="material", map material_id, name from material, quantity, unit_price, total, auto-generate UUID ids, sequential order). Also convert quote.work_items to LineItem[] (type="labor", name from work_item.name, quantity=work_item.labor_hours, unit_price=labor_cost/total_hours, total=computed).
     - pricing_tiers: from quote.pricing_tiers
     - selected_tier: "Standard"
     - estimate_id: use the generated estimateId from the component
     - created_by: will come from session (for now accept from props or default)
   - Call `createSubmission(payload)`
   - On success: setSubmissionCreated(response.id) — show success message with link/button to view
   - On error: show error toast
6. Render:
   - If submissionCreated is null: Show "Create Submission" button (primary, with FileText icon)
   - If submissionCreated: Show success checkmark with "Submission created" text and button "View Submission" that navigates to the submission editor (or triggers a callback)

Add `onSubmissionCreated?: (submissionId: string) => void` to QuoteResultProps for parent component to handle navigation.

Use useLanguage() for button labels.
  </action>
  <verify>
Run `cd /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend && npx tsc --noEmit --skipLibCheck 2>&1 | head -30` — no TypeScript errors. Verify SessionData has username and role fields. Verify quote-result.tsx imports createSubmission.
  </verify>
  <done>
SessionData extended with username (string) and role ('admin' | 'estimator'). Auth action reads ADMIN_USERS env var and sets role accordingly. Default: "estimateur" with "estimator" role. QuoteResult component has "Create Submission" button that transforms quote data into a draft submission via API, with success state showing submission ID.
  </done>
</task>

<task type="auto">
  <name>Task 2: Submission list, upsell dialog, and Soumission tab wiring</name>
  <files>
    frontend/src/components/estimateur/upsell-dialog.tsx
    frontend/src/components/estimateur/submission-list.tsx
    frontend/src/app/(admin)/estimateur/page.tsx
    frontend/src/components/estimateur/nav-tabs.tsx
  </files>
  <action>
**UpsellDialog** (`upsell-dialog.tsx`):

Dialog that shows after a submission is finalized, suggesting related services:
- Props: `submissionId: string`, `open: boolean`, `onOpenChange: (open: boolean) => void`, `onUpsellCreated?: (upsell: Submission) => void`, `userName?: string`
- "use client" directive
- On open: call `getUpsellSuggestions(submissionId)` to get category-specific suggestions
- Display suggestions as a checklist (checkboxes with name and description)
- Use useLanguage() — display name_fr or name_en based on current locale
- "Create Selected" button: for each checked suggestion, call `createUpsell(submissionId, suggestion.type, user)` sequentially
- Show progress: "Creating 1/3..." with loading state
- On complete: close dialog, call onUpsellCreated for each created upsell
- "Skip" button to dismiss without creating upsells
- Use shadcn Dialog, DialogContent, DialogHeader, DialogTitle, Checkbox, Button

**SubmissionList** (`submission-list.tsx`):

List view showing all submissions:
- "use client" directive
- On mount: call `listSubmissions()` to load submissions
- Display as a list of Cards (not table — card layout works better for mobile):
  - Each card shows: StatusBadge, client_name (or "Sans nom"), category, total_price (formatted), created date, upsell_type badge if present
  - If has_children: show small indicator (e.g., "3 upsells" badge)
  - Click card: select it (set selectedId state)
- When selectedId is set: show SubmissionEditor component for that submission
  - Load full submission via `getSubmission(selectedId)`
  - Pass userRole and userName from session context
  - onUpdate callback: refresh the submission in the list
- Status filter tabs at top: All | Draft | Pending | Approved | Rejected (use shadcn Tabs)
- Back button when viewing single submission to return to list
- Refresh button to reload list
- Use useLanguage() for all labels
- Handle loading and empty states

**Update nav-tabs.tsx:**

The Estimateur page has tabs: Prix, Materiaux, Soumission Complete. Check the current tab names — the "Soumission Complete" tab (or "Complet" tab) needs to either be repurposed or a new "Soumissions" tab added.

Looking at Phase 11-06: tabs are "Prix", "Materiaux", "Complet". The "Complet" tab shows the full quote form. We need to keep that AND add a "Soumissions" tab.

Update nav-tabs to add a 4th tab: "Soumissions" (FR) / "Submissions" (EN). This tab will render the SubmissionList component.

Check the nav-tabs component structure. It likely uses a tab value to switch views. Add:
- New tab value: "soumissions"
- New i18n key if needed (may already be added in Plan 02)

**Update estimateur page.tsx:**

The estimateur page renders the appropriate component based on selected tab. Add:
- Import SubmissionList and SubmissionEditor
- When tab === "soumissions": render `<SubmissionList />`
- Pass session data (username, role) to SubmissionList — use the `getSession()` function or a client-side session fetch

For session data on client side: Create a small API route `/api/session` that returns session data (username, role), OR use a React context. Simplest: create a `useSession` hook that calls `/api/session` on mount and returns `{ username, role }`.

Actually, even simpler: read session in the server component (estimateur page.tsx is likely a server component or has a server wrapper) and pass username/role as props to the client components.

Check the current page structure. If it's a server component, call `getSession()` at the top and pass session data down. If it's a client component, use a `useEffect` to fetch session from an API route.

The goal: SubmissionList and SubmissionEditor receive `userRole` and `userName` props so they can pass them to API calls and show/hide admin actions.

**Integration with Finalize flow:**

In SubmissionEditor (from Plan 02), when finalize succeeds, show the UpsellDialog:
- The SubmissionEditor needs to know when finalize completes so it can trigger the dialog
- Since we can't modify SubmissionEditor (it's from Plan 02), we handle this in SubmissionList:
  - Track `showUpsellDialog` state
  - When SubmissionEditor calls `onUpdate` and the updated submission has status="pending_approval" (meaning it was just finalized), set showUpsellDialog=true
  - Render UpsellDialog when showUpsellDialog is true

This provides the natural flow: create quote -> create submission -> edit line items -> finalize -> upsell dialog appears -> approve.
  </action>
  <verify>
Run `cd /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend && npx tsc --noEmit --skipLibCheck 2>&1 | head -30` — no TypeScript errors. Verify upsell-dialog.tsx exists. Verify submission-list.tsx exists. Verify nav-tabs.tsx has "soumissions" tab. Verify estimateur page.tsx imports SubmissionList.
  </verify>
  <done>
UpsellDialog shows category-specific suggestions with checkboxes and creates child submissions. SubmissionList displays all submissions as filterable cards with click-to-edit. Nav tabs updated with 4th "Soumissions" tab. Estimateur page renders SubmissionList in the new tab. Session data (username, role) flows from server to client components. Finalize flow triggers UpsellDialog automatically.
  </done>
</task>

</tasks>

<verification>
1. SessionData in auth.ts includes `username?: string` and `role?: 'admin' | 'estimator'`
2. Auth action reads ADMIN_USERS env var and sets role
3. QuoteResult has "Create Submission" button that calls createSubmission API
4. UpsellDialog shows suggestions and creates child submissions
5. SubmissionList shows all submissions with status filter and click-to-edit
6. Nav tabs have 4 tabs: Prix, Materiaux, Complet, Soumissions
7. Estimateur page renders SubmissionList in Soumissions tab
8. TypeScript compiles without errors
</verification>

<success_criteria>
- Full end-to-end flow works: generate quote -> create submission -> edit -> finalize -> upsells -> approve
- Auth carries username and role for all API calls
- Soumissions tab visible in Estimateur navigation
- Submission list filterable by status
- Upsell dialog triggered after finalization
- Admin-only approve/reject buttons
- All text bilingual FR/EN
</success_criteria>

<output>
After completion, create `.planning/phases/23-submission-workflow-editing/23-03-SUMMARY.md`
</output>
