---
phase: 23-submission-workflow-editing
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - frontend/src/types/submission.ts
  - frontend/src/lib/api/submissions.ts
  - frontend/src/lib/schemas/submission.ts
  - frontend/src/lib/auth.ts
  - frontend/src/app/login/actions.ts
  - frontend/src/lib/i18n/fr.ts
  - frontend/src/lib/i18n/en.ts
  - frontend/src/components/estimateur/submission-status-badge.tsx
autonomous: true

must_haves:
  truths:
    - "TypeScript types for Submission, LineItem, Note, AuditEntry, UpsellSuggestion mirror backend Pydantic schemas"
    - "API client has 11 functions for all submission endpoints including returnToDraft"
    - "Zod schema validates line items with positive quantity and non-negative price"
    - "SessionData includes username and role fields for RBAC"
    - "Auth action assigns admin role from ADMIN_USERS env var"
    - "Status badges show draft/pending/approved/rejected with correct color coding"
    - "All submission i18n keys available in FR and EN including returnToDraft"
  artifacts:
    - path: "frontend/src/types/submission.ts"
      provides: "TypeScript types mirroring backend Pydantic submission schemas"
      exports: ["Submission", "LineItem", "Note", "AuditEntry", "SubmissionListItem", "UpsellSuggestion", "SubmissionStatus", "SubmissionCreatePayload"]
    - path: "frontend/src/lib/api/submissions.ts"
      provides: "API client for all submission CRUD, workflow, notes, and upsell endpoints"
      exports: ["createSubmission", "getSubmission", "listSubmissions", "updateSubmission", "finalizeSubmission", "approveSubmission", "rejectSubmission", "returnToDraft", "addNote", "createUpsell", "getUpsellSuggestions"]
    - path: "frontend/src/lib/schemas/submission.ts"
      provides: "Zod validation schema for submission line items"
      exports: ["lineItemSchema", "submissionFormSchema"]
    - path: "frontend/src/lib/auth.ts"
      provides: "Extended SessionData with username and role fields"
      contains: "role"
    - path: "frontend/src/app/login/actions.ts"
      provides: "Auth action setting username and role from ADMIN_USERS env var"
      contains: "ADMIN_USERS"
    - path: "frontend/src/components/estimateur/submission-status-badge.tsx"
      provides: "Color-coded status badge component"
      exports: ["SubmissionStatusBadge"]
  key_links:
    - from: "frontend/src/lib/api/submissions.ts"
      to: "backend /submissions/* endpoints"
      via: "fetch calls with auth headers"
      pattern: "fetch.*submissions"
    - from: "frontend/src/types/submission.ts"
      to: "backend/app/schemas/submission.py"
      via: "mirrors Pydantic models"
      pattern: "SubmissionStatus"
    - from: "frontend/src/components/estimateur/submission-status-badge.tsx"
      to: "frontend/src/types/submission.ts"
      via: "imports SubmissionStatus type"
      pattern: "import.*SubmissionStatus"
---

<objective>
Build the frontend infrastructure layer for the submission workflow: install @dnd-kit, create TypeScript types, API client, Zod schemas, extend auth with username/role for RBAC, add all FR/EN i18n keys, and create the status badge component.

Purpose: This provides the foundational types, API layer, auth extension, translations, and one standalone UI component that all subsequent frontend components (Plan 23-03) will consume. No UI integration yet -- that comes in Plan 23-03.

Output: @dnd-kit installed, 3 new library files (types, API client, Zod), 2 updated auth files, 2 updated i18n files, 1 new component. All infrastructure ready for component building.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-submission-workflow-editing/23-RESEARCH.md
@.planning/phases/23-submission-workflow-editing/23-01-SUMMARY.md
@frontend/src/types/hybrid-quote.ts
@frontend/src/lib/api/hybrid-quote.ts
@frontend/src/lib/schemas/hybrid-quote.ts
@frontend/src/lib/auth.ts
@frontend/src/app/login/actions.ts
@frontend/src/lib/i18n/fr.ts
@frontend/src/lib/i18n/en.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dnd-kit, create TypeScript types, API client, Zod schema, extend auth</name>
  <files>
    frontend/src/types/submission.ts
    frontend/src/lib/api/submissions.ts
    frontend/src/lib/schemas/submission.ts
    frontend/src/lib/auth.ts
    frontend/src/app/login/actions.ts
  </files>
  <action>
**0. Install @dnd-kit packages:**
```bash
cd frontend && pnpm add @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
```

**1. Create `frontend/src/types/submission.ts`:**

TypeScript types mirroring backend Pydantic schemas from Plan 23-01:

- `SubmissionStatus` type: `'draft' | 'pending_approval' | 'approved' | 'rejected'`
- `LineItem` interface: id (string UUID), type (Literal 'material' | 'labor'), material_id (optional number), name (string), quantity (number), unit_price (number), total (number), order (number)
- `Note` interface: id (string), text (string), created_by (string), created_at (string ISO)
- `AuditEntry` interface: action (string), user (string), timestamp (string), changes (optional Record), reason (optional string)
- `Submission` interface: Full submission with all table columns including line_items (LineItem[]), notes (Note[]), audit_log (AuditEntry[]), pricing_tiers, children (optional SubmissionListItem[])
- `SubmissionListItem` interface: Compact (id, status, category, client_name, total_price, created_at, upsell_type, has_children)
- `SubmissionCreatePayload` interface: Fields needed to create a submission (category, sqft, client_name, created_by, line_items, pricing_tiers, selected_tier, estimate_id)
- `UpsellSuggestion` interface: type, name_fr, name_en, description_fr, description_en

**2. Create `frontend/src/lib/api/submissions.ts`:**

API client following exact pattern from `frontend/src/lib/api/hybrid-quote.ts`:
- `const API_URL = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8000";`
- Each function: async, uses fetch, throws Error with detail on failure, returns typed Promise

11 functions with auth headers (X-User-Name, X-User-Role):
- `createSubmission(data, userName?)` -- POST /submissions (201)
- `getSubmission(id)` -- GET /submissions/{id}
- `listSubmissions(params?: {status?, limit?, offset?})` -- GET /submissions with query params
- `updateSubmission(id, data: {line_items?, selected_tier?, client_name?}, userName?)` -- PATCH /submissions/{id}
- `finalizeSubmission(id, userName?)` -- POST /submissions/{id}/finalize
- `approveSubmission(id, userName?, userRole?)` -- POST /submissions/{id}/approve with X-User-Role: admin
- `rejectSubmission(id, reason?, userName?, userRole?)` -- POST /submissions/{id}/reject
- `returnToDraft(id, userName?)` -- POST /submissions/{id}/return-to-draft. Calls the backend return-to-draft endpoint. Sends X-User-Name header. Returns updated Submission.
- `addNote(id, text, userName)` -- POST /submissions/{id}/notes with body {text, created_by}
- `createUpsell(parentId, upsellType, userName?)` -- POST /submissions/{id}/upsells
- `getUpsellSuggestions(id)` -- GET /submissions/{id}/upsell-suggestions

All functions set headers: `"Content-Type": "application/json"`, `"X-User-Name": userName || "estimateur"`, `"X-User-Role": userRole || "estimator"`.

**3. Create `frontend/src/lib/schemas/submission.ts`:**

Zod schema for line item form validation:
```typescript
import { z } from "zod";

export const lineItemSchema = z.object({
  id: z.string(),
  type: z.enum(["material", "labor"]),
  material_id: z.number().nullable().optional(),
  name: z.string().min(1, "Name required"),
  quantity: z.number().positive("Must be positive"),
  unit_price: z.number().nonnegative("Must be non-negative"),
  total: z.number().nonnegative(),
  order: z.number().int().nonnegative(),
});

export const submissionFormSchema = z.object({
  lineItems: z.array(lineItemSchema).min(1, "At least one line item required"),
  client_name: z.string().optional(),
  selected_tier: z.enum(["Basic", "Standard", "Premium"]).default("Standard"),
});

export type LineItemFormData = z.infer<typeof lineItemSchema>;
export type SubmissionFormData = z.infer<typeof submissionFormSchema>;
```

**4. Extend `frontend/src/lib/auth.ts`:**

Update SessionData interface (currently: `{ isAuthenticated: boolean }`):
```typescript
export interface SessionData {
  isAuthenticated: boolean;
  username?: string;           // NEW: user identifier for audit trail
  role?: 'admin' | 'estimator';  // NEW: role for RBAC
}
```

**5. Update `frontend/src/app/login/actions.ts`:**

The actual auth action file is at `frontend/src/app/login/actions.ts` (NOT `frontend/src/app/actions/auth.ts`). Read the file first. The `authenticate` server action currently validates password and sets `session.isAuthenticated = true`. Extend it to:
- Accept optional `username` parameter (add to the function signature or form data)
- After password validation, set `session.username = username || "estimateur"`
- Check `process.env.ADMIN_USERS` env var (comma-separated names, e.g., "laurent,Laurent")
- If username matches any entry (case-insensitive trim), set `session.role = "admin"`, else `session.role = "estimator"`
- Preserve all existing auth logic -- only ADD the new fields
  </action>
  <verify>
Check dnd-kit installed:
```bash
cd /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend && node -e "require('@dnd-kit/core'); require('@dnd-kit/sortable'); require('@dnd-kit/utilities'); console.log('dnd-kit OK')"
```
Check TypeScript:
```bash
cd /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend && npx tsc --noEmit --skipLibCheck 2>&1 | head -30
```
Check API client exports returnToDraft:
```bash
grep "returnToDraft" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/lib/api/submissions.ts
```
Check auth extension:
```bash
grep "username\|role" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/lib/auth.ts
grep "ADMIN_USERS" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/app/login/actions.ts
```
  </verify>
  <done>
@dnd-kit packages installed. TypeScript types mirror all backend schemas (8 types/interfaces). API client has 11 functions for all endpoints (including returnToDraft for POST /submissions/{id}/return-to-draft) with auth headers. Zod schema validates line items with quantity/price constraints. SessionData extended with username + role. Auth action assigns admin role from ADMIN_USERS env var.
  </done>
</task>

<task type="auto">
  <name>Task 2: i18n submission keys and status badge component</name>
  <files>
    frontend/src/lib/i18n/fr.ts
    frontend/src/lib/i18n/en.ts
    frontend/src/components/estimateur/submission-status-badge.tsx
  </files>
  <action>
**1. Add i18n keys to `frontend/src/lib/i18n/fr.ts` and `en.ts`:**

Add `submission` section to both files (insert into the translation object before the closing brace, after the last existing section):

FR keys:
```
submission: {
  statusDraft: "Brouillon",
  statusPending: "En attente d'approbation",
  statusApproved: "Approuvee",
  statusRejected: "Rejetee",
  createSubmission: "Creer la soumission",
  editLineItems: "Modifier les items",
  addLineItem: "Ajouter un item",
  addMaterial: "Ajouter un materiau",
  addLabor: "Ajouter main-d'oeuvre",
  addFromMaterials: "Ajouter depuis la base de materiaux",
  removeItem: "Retirer",
  finalize: "Finaliser",
  approve: "Approuver",
  reject: "Rejeter",
  returnToDraft: "Retourner au brouillon",
  save: "Sauvegarder",
  lineItemName: "Description",
  lineItemQuantity: "Quantite",
  lineItemUnitPrice: "Prix unitaire",
  lineItemTotal: "Total",
  lineItemType: "Type",
  material: "Materiau",
  labor: "Main-d'oeuvre",
  dragToReorder: "Glisser pour reordonner",
  totalMaterials: "Total materiaux",
  totalLabor: "Total main-d'oeuvre",
  grandTotal: "TOTAL",
  notes: "Notes",
  addNote: "Ajouter une note",
  notePlaceholder: "Ecrire une note...",
  noteBy: "Par",
  noNotes: "Aucune note",
  approvalRequired: "Approbation requise",
  onlyAdminCanApprove: "Seul l'administrateur peut approuver",
  awaitingApproval: "En attente de l'approbation de l'administrateur",
  rejectReason: "Raison du rejet",
  rejectReasonPlaceholder: "Raison du rejet (optionnel)...",
  confirmFinalize: "Finaliser cette soumission? Elle sera envoyee pour approbation.",
  confirmApprove: "Approuver cette soumission?",
  upsellSuggestions: "Services supplementaires suggeres",
  upsellDescription: "Selon le type de projet, ces services pourraient interesser votre client",
  createUpsell: "Creer une soumission",
  skipUpsells: "Passer",
  upsellCreated: "Soumission supplementaire creee",
  submissionCreated: "Soumission creee avec succes",
  submissionUpdated: "Soumission mise a jour",
  submissionFinalized: "Soumission finalisee",
  submissionApproved: "Soumission approuvee",
  submissionRejected: "Soumission rejetee",
  submissionReturnedToDraft: "Soumission retournee au brouillon",
  noteAdded: "Note ajoutee",
  editingLocked: "Modification verrouillee (soumission finalisee)",
  clientName: "Nom du client",
  clientNamePlaceholder: "Nom du client (optionnel)",
  auditLog: "Journal d'audit",
  noLineItems: "Aucun item. Ajoutez des materiaux ou de la main-d'oeuvre.",
  childSubmissions: "Soumissions complementaires",
  submissions: "Soumissions",
  allStatuses: "Tous",
  noSubmissions: "Aucune soumission",
  viewSubmission: "Voir la soumission",
  backToList: "Retour a la liste",
  refresh: "Actualiser",
  upsells: "supplementaires",
},
```

EN keys (same structure, English translations for all of the above -- including `returnToDraft: "Return to Draft"`, `submissionReturnedToDraft: "Submission returned to draft"`, `submissions: "Submissions"`, `allStatuses: "All"`, `noSubmissions: "No submissions"`, `viewSubmission: "View Submission"`, `backToList: "Back to List"`, `refresh: "Refresh"`, `upsells: "upsells"`).

**2. Create `submission-status-badge.tsx`:**

"use client". Small component. Props: `status: SubmissionStatus`.

Renders shadcn `<Badge>` with color-coded styling per status:
- draft: `bg-gray-100 text-gray-700 border-gray-300`
- pending_approval: `bg-amber-100 text-amber-700 border-amber-300`
- approved: `bg-green-100 text-green-700 border-green-300`
- rejected: `bg-red-100 text-red-700 border-red-300`

Use `useLanguage()` to get localized label from `t.submission.statusDraft` / `statusPending` / `statusApproved` / `statusRejected`.
  </action>
  <verify>
Check i18n:
```bash
grep "submission:" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/lib/i18n/fr.ts
grep "submission:" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/lib/i18n/en.ts
grep "returnToDraft" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/lib/i18n/fr.ts
grep "submissions:" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/lib/i18n/fr.ts
```
Check badge component:
```bash
ls -la /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/submission-status-badge.tsx
grep "SubmissionStatusBadge" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/submission-status-badge.tsx
```
  </verify>
  <done>
37+ i18n keys in both FR and EN including returnToDraft, submissionReturnedToDraft, submissions tab label, list/filter labels. SubmissionStatusBadge component renders color-coded badges for all 4 statuses using localized labels.
  </done>
</task>

</tasks>

<verification>
1. @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities in package.json
2. `npx tsc --noEmit --skipLibCheck` passes without errors
3. TypeScript types file has 8 exports (Submission, LineItem, Note, AuditEntry, SubmissionListItem, UpsellSuggestion, SubmissionStatus, SubmissionCreatePayload)
4. API client has 11 functions matching backend endpoints (including returnToDraft)
5. Zod schema validates line items with positive quantity and non-negative price
6. SessionData includes username and role fields
7. Auth action reads ADMIN_USERS env var and sets role
8. fr.ts and en.ts both have complete submission i18n section (including returnToDraft, submissions tab label)
9. SubmissionStatusBadge renders colored badges for all 4 statuses
</verification>

<success_criteria>
1. @dnd-kit packages installed and importable
2. TypeScript types mirror all backend Pydantic schemas
3. API client covers all 11 submission endpoints with auth headers
4. Zod schema enforces line item constraints
5. Auth extended with username/role from ADMIN_USERS env var
6. All submission UI text available in FR and EN (37+ keys)
7. Status badge shows correct color per status
8. No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/23-submission-workflow-editing/23-02-SUMMARY.md`
</output>
