---
phase: 23-submission-workflow-editing
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - frontend/src/types/submission.ts
  - frontend/src/lib/api/submissions.ts
  - frontend/src/lib/schemas/submission.ts
  - frontend/src/components/estimateur/submission-editor.tsx
  - frontend/src/components/estimateur/sortable-line-item.tsx
  - frontend/src/components/estimateur/notes-panel.tsx
  - frontend/src/components/estimateur/upsell-dialog.tsx
  - frontend/src/components/estimateur/submission-status-badge.tsx
  - frontend/src/components/estimateur/full-quote-form.tsx
  - frontend/src/lib/auth.ts
  - frontend/src/app/actions/auth.ts
  - frontend/src/lib/i18n/fr.ts
  - frontend/src/lib/i18n/en.ts
autonomous: false

must_haves:
  truths:
    - "After quote generation, user can click 'Create Submission' to create editable draft"
    - "Each line item can be edited (name, quantity, unit_price) with live total recalculation"
    - "Line items can be reordered via drag-drop using @dnd-kit"
    - "New line items can be added manually (material or labor type) or from Phase 20 MaterialSelector"
    - "Line items can be removed from draft submissions"
    - "Status badges show draft/pending/approved/rejected with correct color coding"
    - "Finalize button transitions draft to pending_approval and shows upsell suggestions dialog"
    - "Approve/Reject buttons visible only to admin role (Laurent)"
    - "Return to Draft button visible on rejected submissions to allow re-editing"
    - "Notes panel shows timestamped attributed notes and allows adding new ones"
    - "Upsell dialog shows category-specific suggestions (Bardeaux: cables, gutters, ventilation; etc.)"
    - "Each upsell creates a separate child submission linked to parent"
    - "All UI text available in FR and EN"
  artifacts:
    - path: "frontend/src/types/submission.ts"
      provides: "TypeScript types mirroring backend Pydantic submission schemas"
      exports: ["Submission", "LineItem", "Note", "AuditEntry", "SubmissionListItem", "UpsellSuggestion", "SubmissionStatus"]
    - path: "frontend/src/lib/api/submissions.ts"
      provides: "API client for all submission CRUD, workflow, notes, and upsell endpoints"
      exports: ["createSubmission", "getSubmission", "listSubmissions", "updateSubmission", "finalizeSubmission", "approveSubmission", "rejectSubmission", "returnToDraft", "addNote", "createUpsell", "getUpsellSuggestions"]
    - path: "frontend/src/lib/schemas/submission.ts"
      provides: "Zod validation schema for submission line items"
      exports: ["lineItemSchema", "submissionFormSchema"]
    - path: "frontend/src/components/estimateur/submission-editor.tsx"
      provides: "Main submission editor with drag-drop line items, totals, action buttons"
      exports: ["SubmissionEditor"]
      min_lines: 200
    - path: "frontend/src/components/estimateur/sortable-line-item.tsx"
      provides: "Drag-droppable line item row with inline editing"
      exports: ["SortableLineItem"]
    - path: "frontend/src/components/estimateur/notes-panel.tsx"
      provides: "Timestamped notes display and input panel"
      exports: ["NotesPanel"]
    - path: "frontend/src/components/estimateur/upsell-dialog.tsx"
      provides: "Dialog showing category-specific upsell suggestions after finalize"
      exports: ["UpsellDialog"]
    - path: "frontend/src/components/estimateur/submission-status-badge.tsx"
      provides: "Color-coded status badge component"
      exports: ["SubmissionStatusBadge"]
  key_links:
    - from: "frontend/src/components/estimateur/submission-editor.tsx"
      to: "frontend/src/lib/api/submissions.ts"
      via: "API calls for CRUD and workflow operations"
      pattern: "from.*api/submissions.*import"
    - from: "frontend/src/components/estimateur/submission-editor.tsx"
      to: "frontend/src/components/estimateur/material-selector.tsx"
      via: "MaterialSelector imported in Dialog for 'Add from Materials Database' flow"
      pattern: "import.*MaterialSelector.*from.*material-selector"
    - from: "frontend/src/components/estimateur/full-quote-form.tsx"
      to: "frontend/src/components/estimateur/submission-editor.tsx"
      via: "Renders SubmissionEditor after quote result and Create Submission click"
      pattern: "<SubmissionEditor"
    - from: "frontend/src/components/estimateur/submission-editor.tsx"
      to: "@dnd-kit/sortable"
      via: "DndContext and SortableContext for drag-drop reordering"
      pattern: "from.*@dnd-kit"
    - from: "frontend/src/lib/api/submissions.ts"
      to: "backend /submissions/* endpoints"
      via: "fetch calls with auth headers"
      pattern: "fetch.*submissions"
---

<objective>
Build the complete frontend submission editing experience: install @dnd-kit, create TypeScript types and API client, extend auth with username/role, build 5 new UI components (editor, sortable line item, notes panel, upsell dialog, status badge), wire into the existing full quote form with "Create Submission" flow, and add all FR/EN translations.

Purpose: After AI generates a quote, estimators can edit line items (drag-drop reorder, add from materials DB, change quantities/prices), add notes, finalize for approval, and see upsell suggestions. Laurent (admin) can approve or reject. Rejected submissions can be returned to draft for re-editing. This is the primary user-facing workflow for Phase 23.

Output: 5 new components, types, API client, Zod schema, updated auth, updated full-quote-form, i18n keys. Complete submission editing experience.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-submission-workflow-editing/23-RESEARCH.md
@.planning/phases/23-submission-workflow-editing/23-01-SUMMARY.md
@frontend/src/components/estimateur/full-quote-form.tsx
@frontend/src/components/estimateur/quote-result.tsx
@frontend/src/components/estimateur/material-selector.tsx
@frontend/src/types/hybrid-quote.ts
@frontend/src/lib/api/hybrid-quote.ts
@frontend/src/lib/schemas/hybrid-quote.ts
@frontend/src/lib/auth.ts
@frontend/src/lib/i18n/fr.ts
@frontend/src/lib/i18n/en.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dnd-kit, types, API client, Zod schema, auth extension, i18n keys</name>
  <files>
    frontend/src/types/submission.ts
    frontend/src/lib/api/submissions.ts
    frontend/src/lib/schemas/submission.ts
    frontend/src/lib/auth.ts
    frontend/src/app/actions/auth.ts
    frontend/src/lib/i18n/fr.ts
    frontend/src/lib/i18n/en.ts
  </files>
  <action>
**0. Install @dnd-kit packages:**
```bash
cd frontend && pnpm add @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
```

**1. Create `frontend/src/types/submission.ts`:**

TypeScript types mirroring backend Pydantic schemas from Plan 23-01:

- `SubmissionStatus` type: `'draft' | 'pending_approval' | 'approved' | 'rejected'`
- `LineItem` interface: id (string UUID), type (Literal 'material' | 'labor'), material_id (optional number), name (string), quantity (number), unit_price (number), total (number), order (number)
- `Note` interface: id (string), text (string), created_by (string), created_at (string ISO)
- `AuditEntry` interface: action (string), user (string), timestamp (string), changes (optional Record), reason (optional string)
- `Submission` interface: Full submission with all table columns including line_items (LineItem[]), notes (Note[]), audit_log (AuditEntry[]), pricing_tiers, children (optional SubmissionListItem[])
- `SubmissionListItem` interface: Compact (id, status, category, client_name, total_price, created_at, upsell_type, has_children)
- `SubmissionCreatePayload` interface: Fields needed to create a submission (category, sqft, client_name, created_by, line_items, pricing_tiers, selected_tier, estimate_id)
- `UpsellSuggestion` interface: type, name_fr, name_en, description_fr, description_en

**2. Create `frontend/src/lib/api/submissions.ts`:**

API client following exact pattern from `frontend/src/lib/api/hybrid-quote.ts`:
- `const API_URL = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8000";`
- Each function: async, uses fetch, throws Error with detail on failure, returns typed Promise

11 functions with auth headers (X-User-Name, X-User-Role):
- `createSubmission(data, userName?)` -- POST /submissions (201)
- `getSubmission(id)` -- GET /submissions/{id}
- `listSubmissions(params?: {status?, limit?, offset?})` -- GET /submissions with query params
- `updateSubmission(id, data: {line_items?, selected_tier?, client_name?}, userName?)` -- PATCH /submissions/{id}
- `finalizeSubmission(id, userName?)` -- POST /submissions/{id}/finalize
- `approveSubmission(id, userName?, userRole?)` -- POST /submissions/{id}/approve with X-User-Role: admin
- `rejectSubmission(id, reason?, userName?, userRole?)` -- POST /submissions/{id}/reject
- `returnToDraft(id, userName?)` -- POST /submissions/{id}/return-to-draft. Calls the backend return-to-draft endpoint. Sends X-User-Name header. Returns updated Submission.
- `addNote(id, text, userName)` -- POST /submissions/{id}/notes with body {text, created_by}
- `createUpsell(parentId, upsellType, userName?)` -- POST /submissions/{id}/upsells
- `getUpsellSuggestions(id)` -- GET /submissions/{id}/upsell-suggestions

All functions set headers: `"Content-Type": "application/json"`, `"X-User-Name": userName || "estimateur"`, `"X-User-Role": userRole || "estimator"`.

**3. Create `frontend/src/lib/schemas/submission.ts`:**

Zod schema for line item form validation:
```typescript
import { z } from "zod";

export const lineItemSchema = z.object({
  id: z.string(),
  type: z.enum(["material", "labor"]),
  material_id: z.number().nullable().optional(),
  name: z.string().min(1, "Name required"),
  quantity: z.number().positive("Must be positive"),
  unit_price: z.number().nonnegative("Must be non-negative"),
  total: z.number().nonnegative(),
  order: z.number().int().nonnegative(),
});

export const submissionFormSchema = z.object({
  lineItems: z.array(lineItemSchema).min(1, "At least one line item required"),
  client_name: z.string().optional(),
  selected_tier: z.enum(["Basic", "Standard", "Premium"]).default("Standard"),
});

export type LineItemFormData = z.infer<typeof lineItemSchema>;
export type SubmissionFormData = z.infer<typeof submissionFormSchema>;
```

**4. Extend `frontend/src/lib/auth.ts`:**

Update SessionData interface (currently: `{ isAuthenticated: boolean }`):
```typescript
export interface SessionData {
  isAuthenticated: boolean;
  username?: string;           // NEW: user identifier for audit trail
  role?: 'admin' | 'estimator';  // NEW: role for RBAC
}
```

**5. Update `frontend/src/app/actions/auth.ts`:**

Read the file first. The `authenticate` server action currently validates password and sets `session.isAuthenticated = true`. Extend it to:
- Accept optional `username` parameter (add to the function signature or form data)
- After password validation, set `session.username = username || "estimateur"`
- Check `process.env.ADMIN_USERS` env var (comma-separated names, e.g., "laurent,Laurent")
- If username matches any entry (case-insensitive trim), set `session.role = "admin"`, else `session.role = "estimator"`
- Preserve all existing auth logic -- only ADD the new fields

**6. Add i18n keys to `frontend/src/lib/i18n/fr.ts` and `en.ts`:**

Add `submission` section to both files (insert into the translation object before the closing brace, after the last existing section):

FR keys:
```
submission: {
  statusDraft: "Brouillon",
  statusPending: "En attente d'approbation",
  statusApproved: "Approuvee",
  statusRejected: "Rejetee",
  createSubmission: "Creer la soumission",
  editLineItems: "Modifier les items",
  addLineItem: "Ajouter un item",
  addMaterial: "Ajouter un materiau",
  addLabor: "Ajouter main-d'oeuvre",
  addFromMaterials: "Ajouter depuis la base de materiaux",
  removeItem: "Retirer",
  finalize: "Finaliser",
  approve: "Approuver",
  reject: "Rejeter",
  returnToDraft: "Retourner au brouillon",
  save: "Sauvegarder",
  lineItemName: "Description",
  lineItemQuantity: "Quantite",
  lineItemUnitPrice: "Prix unitaire",
  lineItemTotal: "Total",
  lineItemType: "Type",
  material: "Materiau",
  labor: "Main-d'oeuvre",
  dragToReorder: "Glisser pour reordonner",
  totalMaterials: "Total materiaux",
  totalLabor: "Total main-d'oeuvre",
  grandTotal: "TOTAL",
  notes: "Notes",
  addNote: "Ajouter une note",
  notePlaceholder: "Ecrire une note...",
  noteBy: "Par",
  noNotes: "Aucune note",
  approvalRequired: "Approbation requise",
  onlyAdminCanApprove: "Seul l'administrateur peut approuver",
  awaitingApproval: "En attente de l'approbation de l'administrateur",
  rejectReason: "Raison du rejet",
  rejectReasonPlaceholder: "Raison du rejet (optionnel)...",
  confirmFinalize: "Finaliser cette soumission? Elle sera envoyee pour approbation.",
  confirmApprove: "Approuver cette soumission?",
  upsellSuggestions: "Services supplementaires suggeres",
  upsellDescription: "Selon le type de projet, ces services pourraient interesser votre client",
  createUpsell: "Creer une soumission",
  skipUpsells: "Passer",
  upsellCreated: "Soumission supplementaire creee",
  submissionCreated: "Soumission creee avec succes",
  submissionUpdated: "Soumission mise a jour",
  submissionFinalized: "Soumission finalisee",
  submissionApproved: "Soumission approuvee",
  submissionRejected: "Soumission rejetee",
  submissionReturnedToDraft: "Soumission retournee au brouillon",
  noteAdded: "Note ajoutee",
  editingLocked: "Modification verrouillee (soumission finalisee)",
  clientName: "Nom du client",
  clientNamePlaceholder: "Nom du client (optionnel)",
  auditLog: "Journal d'audit",
  noLineItems: "Aucun item. Ajoutez des materiaux ou de la main-d'oeuvre.",
  childSubmissions: "Soumissions complementaires",
},
```

EN keys (same structure, English translations for all of the above -- including `returnToDraft: "Return to Draft"` and `submissionReturnedToDraft: "Submission returned to draft"`).
  </action>
  <verify>
Check dnd-kit installed:
```bash
cd /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend && node -e "require('@dnd-kit/core'); require('@dnd-kit/sortable'); require('@dnd-kit/utilities'); console.log('dnd-kit OK')"
```
Check TypeScript:
```bash
cd /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend && npx tsc --noEmit --skipLibCheck 2>&1 | head -30
```
Check i18n:
```bash
grep "submission:" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/lib/i18n/fr.ts
grep "submission:" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/lib/i18n/en.ts
grep "returnToDraft" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/lib/i18n/fr.ts
```
Check API client exports returnToDraft:
```bash
grep "returnToDraft" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/lib/api/submissions.ts
```
  </verify>
  <done>
@dnd-kit packages installed. TypeScript types mirror all backend schemas. API client has 11 functions for all endpoints (including returnToDraft for POST /submissions/{id}/return-to-draft) with auth headers. Zod schema validates line items. SessionData extended with username + role. Auth action assigns admin role from ADMIN_USERS env var. 37+ i18n keys in both FR and EN including returnToDraft and submissionReturnedToDraft.
  </done>
</task>

<task type="auto">
  <name>Task 2: 5 new components, full-quote-form integration, upsell dialog</name>
  <files>
    frontend/src/components/estimateur/submission-status-badge.tsx
    frontend/src/components/estimateur/sortable-line-item.tsx
    frontend/src/components/estimateur/notes-panel.tsx
    frontend/src/components/estimateur/upsell-dialog.tsx
    frontend/src/components/estimateur/submission-editor.tsx
    frontend/src/components/estimateur/full-quote-form.tsx
  </files>
  <action>
**1. Create `submission-status-badge.tsx`:**

"use client". Small component. Props: `status: SubmissionStatus`.

Renders shadcn `<Badge>` with color-coded styling per status:
- draft: `bg-gray-100 text-gray-700 border-gray-300`
- pending_approval: `bg-amber-100 text-amber-700 border-amber-300`
- approved: `bg-green-100 text-green-700 border-green-300`
- rejected: `bg-red-100 text-red-700 border-red-300`

Use `useLanguage()` to get localized label from `t.submission.statusDraft` / `statusPending` / `statusApproved` / `statusRejected`.

**2. Create `sortable-line-item.tsx`:**

"use client". Drag-droppable line item row. Props: `id` (string), `index` (number), `item` (LineItem), `onUpdate` (callback: index, field, value), `onRemove` (callback: index), `disabled` (boolean).

Use `useSortable({ id })` from `@dnd-kit/sortable`. Apply `CSS.Transform.toString(transform)` and `transition` to the outer div via `ref={setNodeRef}`.

Row layout (flex, gap-2, p-2, rounded-lg, border):
1. **Drag handle**: GripVertical icon with `{...attributes} {...listeners}`, hidden when disabled, `cursor-grab` class
2. **Type badge**: Small Badge "Mat." or "M.O." based on item.type, using `t.submission.material` / `t.submission.labor` abbreviations
3. **Name input**: `<Input>` bound to item.name, onChange calls `onUpdate(index, "name", e.target.value)`, disabled when parent disabled, className="h-9 flex-1"
4. **Quantity input**: `<Input type="number">` min=0.01 step=0.01, value=item.quantity, onChange calls `onUpdate(index, "quantity", parseFloat(e.target.value) || 0)`, className="h-9 w-20"
5. **Unit price input**: `<Input type="number">` min=0 step=0.01, value=item.unit_price, className="h-9 w-24"
6. **Total display**: Read-only span showing `quantity * unit_price` formatted as CAD with fr-CA locale (Intl.NumberFormat)
7. **Remove button**: `<Button variant="ghost" size="sm">` with Trash2 icon, hidden when disabled, calls `onRemove(index)`

CRITICAL: The parent component MUST use `key={field.id}` (not index) when mapping SortableLineItem.

**3. Create `notes-panel.tsx`:**

"use client". Notes display and input. Props: `notes` (Note[]), `onAddNote` (async callback with text), `disabled` (boolean, optional), `isLoading` (boolean, optional).

Layout wrapped in a Card:
- CardHeader: "Notes" title with count badge (`notes.length`)
- CardContent:
  - If no notes: muted "No notes yet" text (i18n)
  - Notes list (reverse chronological -- sort by created_at DESC):
    - Each note: text in a rounded-lg bg-muted/30 p-3, with "Par {created_by}" and formatted date below in text-xs text-muted-foreground
    - Date formatting: `new Intl.DateTimeFormat("fr-CA", { dateStyle: "medium", timeStyle: "short" }).format(new Date(note.created_at))`
  - Input area (bottom): shadcn `<Textarea rows={2}>` with placeholder from i18n, + "Add" Button
  - On submit: call `onAddNote(text)`, clear textarea
  - Disable input + button when `disabled` is true or `isLoading` is true

**4. Create `upsell-dialog.tsx`:**

"use client". Dialog shown after finalize. Props: `open` (boolean), `onOpenChange` (callback), `suggestions` (UpsellSuggestion[]), `onCreateUpsell` (async callback with type string), `locale` (string).

Use shadcn Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription.

Content:
- Title: `t.submission.upsellSuggestions`
- Description: `t.submission.upsellDescription`
- List of suggestion cards: each is a rounded border div with:
  - Name: `locale === 'fr' ? suggestion.name_fr : suggestion.name_en`
  - Description: same locale logic for description
  - "Create Submission" button (primary, small) on the right
  - Button calls `onCreateUpsell(suggestion.type)` and shows a loading state
- Footer: "Skip" button (outline variant) calls `onOpenChange(false)`

**5. Create `submission-editor.tsx`:**

"use client". This is the core component (~250+ lines). Props: `initialData` (Submission), `onUpdate` (callback: Submission), `userRole` ('admin' | 'estimator', default 'estimator'), `userName` (string, default 'estimateur').

**Imports -- explicit list:**
```typescript
import { MaterialSelector, type SelectedMaterial } from "@/components/estimateur/material-selector";
import { SortableLineItem } from "@/components/estimateur/sortable-line-item";
import { NotesPanel } from "@/components/estimateur/notes-panel";
import { UpsellDialog } from "@/components/estimateur/upsell-dialog";
import { SubmissionStatusBadge } from "@/components/estimateur/submission-status-badge";
import {
  updateSubmission, finalizeSubmission, approveSubmission, rejectSubmission,
  returnToDraft, addNote, createUpsell, getUpsellSuggestions
} from "@/lib/api/submissions";
import type { Submission, LineItem, UpsellSuggestion } from "@/types/submission";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { DndContext, closestCenter, DragEndEvent } from '@dnd-kit/core';
import { SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable';
```

State:
- `submission` (Submission, initialized from initialData)
- `lineItems` (LineItem[], initialized from submission.line_items -- local editing state)
- `isLoading` (boolean)
- `error` (string | null)
- `showUpsellDialog` (boolean)
- `upsellSuggestions` (UpsellSuggestion[])
- `showMaterialSelector` (boolean)
- `clientName` (string, from submission.client_name)

Derived:
- `isDraft = submission.status === 'draft'`
- `isPending = submission.status === 'pending_approval'`
- `isRejected = submission.status === 'rejected'`
- `isAdmin = userRole === 'admin'`

**Line item editing handlers:**
- `handleUpdateItem(index, field, value)`: Update lineItems[index][field] = value. If field is quantity or unit_price, also recompute total = quantity * unit_price. Set new lineItems state.
- `handleRemoveItem(index)`: Remove from lineItems, reorder remaining items.
- `handleAddItem(type: 'material' | 'labor')`: Append new LineItem with crypto.randomUUID() id, type, empty name, quantity=1, unit_price=0, total=0, order=lineItems.length.
- `handleAddFromMaterials(materials: SelectedMaterial[])`: This is the explicit MaterialSelector integration handler. Converts each SelectedMaterial (from Phase 20 MaterialSelector component) to a LineItem:
  ```typescript
  const handleAddFromMaterials = (materials: SelectedMaterial[]) => {
    const newItems: LineItem[] = materials.map((m, i) => ({
      id: crypto.randomUUID(),
      type: 'material' as const,
      material_id: m.id > 0 ? m.id : undefined,  // negative IDs are custom materials
      name: m.name,
      quantity: 1,
      unit_price: m.sell_price || 0,
      total: m.sell_price || 0,  // quantity=1 * unit_price
      order: lineItems.length + i,
    }));
    setLineItems(prev => [...prev, ...newItems]);
    setShowMaterialSelector(false);
  };
  ```

**Drag-drop setup:**
```typescript
import { DndContext, closestCenter, DragEndEvent } from '@dnd-kit/core';
import { SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable';

const handleDragEnd = (event: DragEndEvent) => {
  const { active, over } = event;
  if (active.id !== over?.id) {
    const oldIndex = lineItems.findIndex(li => li.id === active.id);
    const newIndex = lineItems.findIndex(li => li.id === over?.id);
    const newItems = [...lineItems];
    const [moved] = newItems.splice(oldIndex, 1);
    newItems.splice(newIndex, 0, moved);
    // Recompute order field
    setLineItems(newItems.map((item, i) => ({ ...item, order: i })));
  }
};
```

**Computed totals** (useMemo):
- totalMaterials = lineItems.filter(type==="material").reduce(sum total, 0)
- totalLabor = lineItems.filter(type==="labor").reduce(sum total, 0)
- grandTotal = totalMaterials + totalLabor

Format with `Intl.NumberFormat("fr-CA", { style: "currency", currency: "CAD" })` (same as quote-result.tsx).

**Action handlers:**
- `handleSave`: Call updateSubmission API with current lineItems and clientName. On success, update submission state and call onUpdate.
- `handleFinalize`: Show confirm dialog (shadcn AlertDialog). On confirm, call finalizeSubmission API. On success, fetch upsell suggestions via getUpsellSuggestions API, set showUpsellDialog=true, update submission state.
- `handleApprove`: Call approveSubmission API with admin role header. Update state.
- `handleReject`: Show dialog with optional reason textarea. Call rejectSubmission API.
- `handleReturnToDraft`: Call returnToDraft API (POST /submissions/{id}/return-to-draft). On success, update submission state (status back to draft, editing re-enabled). Show success toast using `t.submission.submissionReturnedToDraft`.
- `handleAddNote(text)`: Call addNote API. On success, update submission state (new note appears).
- `handleCreateUpsell(type)`: Call createUpsell API. Show success toast or inline message. Child appears in submission.children.

**Layout structure (top to bottom):**

```
<div className="space-y-6">

  {/* Header with status + metadata */}
  <div className="flex items-center justify-between">
    <div className="flex items-center gap-3">
      <SubmissionStatusBadge status={submission.status} />
      <span className="text-sm text-muted-foreground">{submission.category} | {submission.sqft} pi2</span>
    </div>
    <span className="text-xs text-muted-foreground">{formatDate(submission.created_at)}</span>
  </div>

  {/* Client name input (editable in draft) */}
  <div>
    <Label>{t.submission.clientName}</Label>
    <Input value={clientName} onChange={...} disabled={!isDraft} placeholder={t.submission.clientNamePlaceholder} />
  </div>

  {/* Line Items Card */}
  <Card>
    <CardHeader>
      <CardTitle>{t.submission.editLineItems}</CardTitle>
    </CardHeader>
    <CardContent>
      {/* Column headers */}
      <div className="hidden sm:grid grid-cols-[40px_60px_1fr_80px_100px_100px_40px] gap-2 text-xs font-medium text-muted-foreground mb-2">
        <span></span><span>{t.submission.lineItemType}</span><span>{t.submission.lineItemName}</span>
        <span>{t.submission.lineItemQuantity}</span><span>{t.submission.lineItemUnitPrice}</span>
        <span>{t.submission.lineItemTotal}</span><span></span>
      </div>

      {lineItems.length === 0 ? (
        <p className="text-sm text-muted-foreground py-4 text-center">{t.submission.noLineItems}</p>
      ) : (
        <DndContext collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
          <SortableContext items={lineItems.map(li => li.id)} strategy={verticalListSortingStrategy}>
            {lineItems.map((item, index) => (
              <SortableLineItem
                key={item.id}  // CRITICAL: key={item.id} NOT key={index}
                id={item.id}
                index={index}
                item={item}
                onUpdate={handleUpdateItem}
                onRemove={handleRemoveItem}
                disabled={!isDraft}
              />
            ))}
          </SortableContext>
        </DndContext>
      )}

      {/* Add buttons (draft only) */}
      {isDraft && (
        <div className="flex gap-2 mt-4">
          <Button variant="outline" size="sm" onClick={() => handleAddItem('material')}>
            + {t.submission.addMaterial}
          </Button>
          <Button variant="outline" size="sm" onClick={() => handleAddItem('labor')}>
            + {t.submission.addLabor}
          </Button>
          <Button variant="outline" size="sm" onClick={() => setShowMaterialSelector(true)}>
            {t.submission.addFromMaterials}
          </Button>
        </div>
      )}

      {/* Totals */}
      <div className="mt-4 pt-4 border-t space-y-1">
        <div className="flex justify-between text-sm">
          <span>{t.submission.totalMaterials}</span>
          <span className="font-medium tabular-nums">{formatCurrency(totalMaterials)}</span>
        </div>
        <div className="flex justify-between text-sm">
          <span>{t.submission.totalLabor}</span>
          <span className="font-medium tabular-nums">{formatCurrency(totalLabor)}</span>
        </div>
        <hr className="my-2" />
        <div className="flex justify-between text-lg font-bold">
          <span>{t.submission.grandTotal}</span>
          <span className="tabular-nums">{formatCurrency(grandTotal)}</span>
        </div>
      </div>
    </CardContent>
  </Card>

  {/* MaterialSelector Dialog (reuse Phase 20 component) */}
  {/* EXPLICIT WIRING: MaterialSelector from @/components/estimateur/material-selector */}
  {/* When user selects materials and clicks confirm, onSelectionChange fires with SelectedMaterial[] */}
  {/* handleAddFromMaterials converts each SelectedMaterial to LineItem format */}
  <Dialog open={showMaterialSelector} onOpenChange={setShowMaterialSelector}>
    <DialogContent className="max-w-lg">
      <DialogHeader><DialogTitle>{t.submission.addFromMaterials}</DialogTitle></DialogHeader>
      <MaterialSelector
        selectedMaterials={[]}
        onSelectionChange={(materials: SelectedMaterial[]) => {
          handleAddFromMaterials(materials);
        }}
      />
    </DialogContent>
  </Dialog>

  {/* Notes Panel */}
  <NotesPanel
    notes={submission.notes}
    onAddNote={handleAddNote}
    disabled={isLoading}
  />

  {/* Error display */}
  {error && (
    <div className="flex items-center gap-2 rounded-lg border border-destructive/50 bg-destructive/10 p-4 text-destructive">
      <AlertCircle className="size-5 shrink-0" />
      <p className="text-sm">{error}</p>
    </div>
  )}

  {/* Action buttons */}
  <div className="flex gap-3 pt-4 border-t">
    {isDraft && (
      <>
        <Button onClick={handleSave} disabled={isLoading}>
          {isLoading ? <Loader2 className="mr-2 size-4 animate-spin" /> : null}
          {t.submission.save}
        </Button>
        <Button variant="secondary" onClick={handleFinalize} disabled={isLoading || lineItems.length === 0}>
          {t.submission.finalize}
        </Button>
      </>
    )}
    {isPending && isAdmin && (
      <>
        <Button onClick={handleApprove} disabled={isLoading} className="bg-green-600 hover:bg-green-700">
          {t.submission.approve}
        </Button>
        <Button variant="destructive" onClick={handleReject} disabled={isLoading}>
          {t.submission.reject}
        </Button>
      </>
    )}
    {isPending && !isAdmin && (
      <p className="text-sm text-muted-foreground italic">{t.submission.awaitingApproval}</p>
    )}
    {isRejected && (
      <Button variant="outline" onClick={handleReturnToDraft} disabled={isLoading}>
        {t.submission.returnToDraft}
      </Button>
    )}
  </div>

  {/* Child submissions (upsells) */}
  {submission.children && submission.children.length > 0 && (
    <Card>
      <CardHeader><CardTitle>{t.submission.childSubmissions}</CardTitle></CardHeader>
      <CardContent>
        {submission.children.map(child => (
          <div key={child.id} className="flex items-center justify-between p-2 rounded border mb-2">
            <div>
              <SubmissionStatusBadge status={child.status} />
              <span className="ml-2 text-sm">{child.upsell_type}</span>
            </div>
            <span className="text-sm font-medium">{formatCurrency(child.total_price)}</span>
          </div>
        ))}
      </CardContent>
    </Card>
  )}

  {/* Upsell Dialog */}
  <UpsellDialog
    open={showUpsellDialog}
    onOpenChange={setShowUpsellDialog}
    suggestions={upsellSuggestions}
    onCreateUpsell={handleCreateUpsell}
    locale={locale}
  />
</div>
```

**6. Update `full-quote-form.tsx`:**

After the existing QuoteResult display in the right column (around line 1059), add:

1. New state: `const [submission, setSubmission] = useState<Submission | null>(null);`
2. Import: `import { SubmissionEditor } from "./submission-editor";` and `import { createSubmission } from "@/lib/api/submissions";` and `import type { Submission, LineItem as SubmissionLineItem } from "@/types/submission";`

3. Add a "Create Submission" button below the QuoteResult component:
```tsx
{result && !submission && (
  <Button
    className="w-full mt-4"
    onClick={async () => {
      // Convert HybridQuoteResponse to submission line items
      const standardTier = result.pricing_tiers.find(t => t.tier === "Standard");
      const hourlyRate = result.total_labor_hours > 0
        ? (standardTier?.labor_cost || 0) / result.total_labor_hours
        : 0;

      const lineItems: SubmissionLineItem[] = [
        ...result.work_items.map((wi, i) => ({
          id: crypto.randomUUID(),
          type: 'labor' as const,
          name: wi.name,
          quantity: wi.labor_hours,
          unit_price: Math.round(hourlyRate * 100) / 100,
          total: Math.round(wi.labor_hours * hourlyRate * 100) / 100,
          order: i,
        })),
        ...result.materials.map((mat, i) => ({
          id: crypto.randomUUID(),
          type: 'material' as const,
          material_id: mat.material_id,
          name: `Material #${mat.material_id}`,
          quantity: mat.quantity,
          unit_price: mat.unit_price,
          total: mat.total,
          order: result.work_items.length + i,
        })),
      ];

      try {
        const sub = await createSubmission({
          category,
          sqft,
          created_by: form.getValues("created_by"),
          line_items: lineItems,
          pricing_tiers: result.pricing_tiers,
          selected_tier: "Standard",
        });
        setSubmission(sub);
      } catch (err) {
        setError(err instanceof Error ? err.message : "Failed to create submission");
      }
    }}
  >
    {t.submission.createSubmission}
  </Button>
)}
```

4. When submission exists, render SubmissionEditor below or replacing the QuoteResult:
```tsx
{submission && (
  <SubmissionEditor
    initialData={submission}
    onUpdate={(updated) => setSubmission(updated)}
    userRole="estimator"
    userName={form.getValues("created_by") || "estimateur"}
  />
)}
```

Keep existing QuoteResult and form functionality intact. The SubmissionEditor is additive.

Note: The `max-w-2xl` constraint on the left column and the `lg:w-[420px]` on the right column in the current layout may need to be widened when SubmissionEditor is showing (the editor needs more width for the line items table). Consider switching to full-width when submission is active: wrap the SubmissionEditor in a full-width div that spans both columns, or simply show it below the form/result split.
  </action>
  <verify>
```bash
cd /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend && npx tsc --noEmit --skipLibCheck 2>&1 | head -30
```
Verify all component files exist:
```bash
ls -la /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/submission-*.tsx
ls -la /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/sortable-line-item.tsx
ls -la /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/notes-panel.tsx
ls -la /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/upsell-dialog.tsx
```
Verify imports in full-quote-form.tsx:
```bash
grep "SubmissionEditor\|createSubmission" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/full-quote-form.tsx
```
Verify MaterialSelector import in submission-editor.tsx:
```bash
grep "MaterialSelector\|material-selector\|handleAddFromMaterials\|SelectedMaterial" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/submission-editor.tsx
```
Verify returnToDraft wiring:
```bash
grep "returnToDraft\|handleReturnToDraft\|return-to-draft" /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend/src/components/estimateur/submission-editor.tsx
```
  </verify>
  <done>
5 new components created: SubmissionStatusBadge (colored per status), SortableLineItem (drag-droppable row with useSortable and inline editing), NotesPanel (timestamped notes with add input), UpsellDialog (category-specific suggestions after finalize), SubmissionEditor (main editor with DndContext, line items, totals, action buttons, explicit MaterialSelector integration via Dialog wrapping MaterialSelector component with handleAddFromMaterials converting SelectedMaterial[] to LineItem[], and Return to Draft button for rejected submissions). Full-quote-form updated with "Create Submission" button that converts HybridQuoteResponse to submission and renders SubmissionEditor. All text uses i18n.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete submission editing workflow integrated into the Estimateur > Soumission Complete page:
- After AI generates a quote, "Create Submission" button appears
- Submission editor shows with editable line items (drag-drop reorder via @dnd-kit)
- Add items manually or from Phase 20 materials database (MaterialSelector in Dialog)
- Edit quantity/price with live total recalculation
- Status badges: draft (gray), pending (amber), approved (green), rejected (red)
- Notes panel with timestamped entries and add input
- Finalize button locks editing, triggers upsell suggestion dialog
- Approve/Reject buttons for admin role only
- Return to Draft button on rejected submissions (calls POST /submissions/{id}/return-to-draft)
- Upsell suggestions: Bardeaux (cables, gutters, ventilation), Elastomere (drain, insulation, maintenance), Metal (gutters, snow guards, warranty), Universal (inspection, maintenance)
- Each upsell creates separate child submission
- All UI bilingual FR/EN
- Auth extended with username/role (ADMIN_USERS env var)
  </what-built>
  <how-to-verify>
1. Set env var: `ADMIN_USERS=laurent,Laurent` in frontend .env.local
2. Start backend: `cd backend && python -m uvicorn app.main:app --reload`
3. Start frontend: `cd frontend && pnpm dev`
4. Go to http://localhost:3000/estimateur/complet
5. Fill the form and click "Generate" to get a quote
6. After quote appears, click "Create Submission" button
7. Verify submission editor shows with line items from the quote
8. Edit a line item quantity -- verify total recalculates
9. Drag a line item up or down -- verify reorder works
10. Click "Add Material" -- verify empty row appears
11. Click "Add from Materials Database" -- verify MaterialSelector dialog opens, select a material, verify it converts to a line item
12. Add a note -- verify it appears with timestamp
13. Click "Finalize" -- verify status changes to "Pending Approval" and upsell dialog appears
14. Verify editing is locked after finalize
15. If username matches ADMIN_USERS, verify Approve/Reject buttons appear
16. Test reject flow: reject the submission, verify "Return to Draft" button appears on the rejected submission
17. Click "Return to Draft" -- verify status returns to draft and editing is re-enabled
18. Toggle language FR/EN -- verify all new text switches
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities in package.json
2. `npx tsc --noEmit --skipLibCheck` passes without errors
3. All 5 new component files exist and export correctly
4. API client has 11 functions matching backend endpoints (including returnToDraft)
5. SessionData includes username and role fields
6. fr.ts and en.ts both have complete submission i18n section (including returnToDraft, submissionReturnedToDraft)
7. Full-quote-form has "Create Submission" button and SubmissionEditor rendering
8. Drag-drop uses field.id as key (not index)
9. Totals recalculate on line item changes
10. MaterialSelector imported from "@/components/estimateur/material-selector" with SelectedMaterial type
11. handleAddFromMaterials converts SelectedMaterial[] to LineItem[] (material_id, name, sell_price mapping)
12. Return to Draft button shows on rejected submissions and calls returnToDraft API
</verification>

<success_criteria>
1. "Create Submission" button appears after quote generation and creates draft via API
2. Line items editable (name, qty, price) with live total recalculation
3. Drag-drop reordering works via @dnd-kit (grab handle, visual feedback, correct state after drop)
4. MaterialSelector from Phase 20 works for adding items from DB (Dialog wraps MaterialSelector, onSelectionChange converts to LineItem[])
5. Status workflow: draft (edit) -> finalize -> pending (locked) -> approve/reject (admin only) -> return to draft (if rejected)
6. Notes: add timestamped notes, view history, user attribution
7. Upsell dialog shows after finalize with category-specific suggestions, creates child submissions
8. Approve/Reject buttons only visible for admin role
9. Return to Draft button visible on rejected submissions, returns to editable draft state
10. All new UI text in both FR and EN
11. No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/23-submission-workflow-editing/23-02-SUMMARY.md`
</output>
