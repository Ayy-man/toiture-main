---
phase: 23-submission-workflow-editing
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - frontend/src/types/submission.ts
  - frontend/src/lib/api/submissions.ts
  - frontend/src/components/estimateur/submission-editor.tsx
  - frontend/src/components/estimateur/sortable-line-item.tsx
  - frontend/src/components/estimateur/notes-panel.tsx
  - frontend/src/components/estimateur/status-badge.tsx
  - frontend/src/lib/i18n/fr.ts
  - frontend/src/lib/i18n/en.ts
autonomous: true

must_haves:
  truths:
    - "User can edit line item quantity and price in a draft submission"
    - "User can add new material or labor line items"
    - "User can remove line items from a draft submission"
    - "User can reorder line items via drag-and-drop"
    - "Line item totals and grand total recalculate when quantity or price changes"
    - "User can add timestamped notes to any submission"
    - "Submission status is visually displayed as a colored badge"
    - "All submission UI labels are bilingual (FR/EN)"
    - "TypeScript types mirror backend Pydantic schemas"
    - "API client covers all 10 submission endpoints"
  artifacts:
    - path: "frontend/src/types/submission.ts"
      provides: "TypeScript types mirroring backend Pydantic schemas"
      exports: ["Submission", "LineItem", "Note", "AuditEntry", "SubmissionStatus", "SubmissionListItem", "SubmissionCreatePayload"]
    - path: "frontend/src/lib/api/submissions.ts"
      provides: "API client functions for all submission endpoints"
      exports: ["createSubmission", "getSubmission", "listSubmissions", "updateSubmission", "finalizeSubmission", "approveSubmission", "rejectSubmission", "addNote", "createUpsell", "getUpsellSuggestions"]
    - path: "frontend/src/components/estimateur/submission-editor.tsx"
      provides: "Main editable submission component with line items, notes, and action buttons"
      min_lines: 150
    - path: "frontend/src/components/estimateur/sortable-line-item.tsx"
      provides: "Individual draggable line item row with editable fields"
    - path: "frontend/src/components/estimateur/notes-panel.tsx"
      provides: "Notes display and add-note input panel"
    - path: "frontend/src/components/estimateur/status-badge.tsx"
      provides: "Color-coded submission status badge"
  key_links:
    - from: "frontend/src/lib/api/submissions.ts"
      to: "/submissions"
      via: "fetch calls to backend API"
      pattern: "fetch.*submissions"
    - from: "frontend/src/components/estimateur/submission-editor.tsx"
      to: "frontend/src/lib/api/submissions.ts"
      via: "API client import for save/transition/notes"
      pattern: "from.*api/submissions.*import"
    - from: "frontend/src/components/estimateur/submission-editor.tsx"
      to: "frontend/src/components/estimateur/sortable-line-item.tsx"
      via: "Component composition in DndContext"
      pattern: "SortableLineItem"
---

<objective>
Build the complete frontend for submission editing: TypeScript types, API client, editable line items table with drag-and-drop reordering, notes panel, status badge, and bilingual i18n keys.

Purpose: Users can view, edit, and manage AI-generated quotes after they are created. This is the core editing experience that transforms static quotes into interactive submissions.

Output: 4 new React components (submission editor, sortable line item, notes panel, status badge), TypeScript types, API client, and i18n keys in both languages.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-submission-workflow-editing/23-RESEARCH.md
@.planning/phases/23-submission-workflow-editing/23-01-SUMMARY.md
@frontend/src/types/hybrid-quote.ts
@frontend/src/lib/api.ts
@frontend/src/components/estimateur/quote-result.tsx
@frontend/src/components/estimateur/material-selector.tsx
@frontend/src/lib/i18n/fr.ts
@frontend/src/lib/i18n/en.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript types, API client, i18n keys, and @dnd-kit install</name>
  <files>
    frontend/src/types/submission.ts
    frontend/src/lib/api/submissions.ts
    frontend/src/lib/i18n/fr.ts
    frontend/src/lib/i18n/en.ts
  </files>
  <action>
**First: Install @dnd-kit packages:**
```bash
cd frontend && pnpm add @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
```

**TypeScript types** (`frontend/src/types/submission.ts`):

Mirror the backend Pydantic schemas from 23-01-SUMMARY.md:

```typescript
export type SubmissionStatus = 'draft' | 'pending_approval' | 'approved' | 'rejected';

export interface LineItem {
  id: string;
  type: 'material' | 'labor';
  material_id?: number;
  name: string;
  quantity: number;
  unit_price: number;
  total: number;
  order: number;
}

export interface Note {
  id: string;
  text: string;
  created_by: string;
  created_at: string;
}

export interface AuditEntry {
  action: string;
  user: string;
  timestamp: string;
  changes?: Record<string, { old: unknown; new: unknown }>;
  reason?: string;
}

export interface PricingTier {
  tier: string;
  total_price: number;
  materials_cost: number;
  labor_cost: number;
  description: string;
}

export interface Submission {
  id: string;
  created_at: string;
  updated_at: string;
  estimate_id?: string;
  status: SubmissionStatus;
  finalized_at?: string;
  approved_at?: string;
  approved_by?: string;
  created_by?: string;
  client_name?: string;
  category: string;
  sqft?: number;
  line_items: LineItem[];
  notes: Note[];
  audit_log: AuditEntry[];
  parent_submission_id?: string;
  upsell_type?: string;
  pricing_tiers: PricingTier[];
  selected_tier: string;
  total_materials_cost: number;
  total_labor_cost: number;
  total_price: number;
  children?: SubmissionListItem[];
}

export interface SubmissionListItem {
  id: string;
  status: SubmissionStatus;
  category: string;
  client_name?: string;
  total_price: number;
  created_at: string;
  updated_at: string;
  upsell_type?: string;
  has_children: boolean;
}

export interface SubmissionCreatePayload {
  category: string;
  sqft?: number;
  client_name?: string;
  created_by?: string;
  line_items: LineItem[];
  pricing_tiers: PricingTier[];
  selected_tier?: string;
  estimate_id?: string;
}

export interface UpsellSuggestion {
  type: string;
  name_fr: string;
  name_en: string;
  description_fr: string;
  description_en: string;
}
```

**API Client** (`frontend/src/lib/api/submissions.ts`):

Create the `api/` directory if it doesn't exist (it may already). Follow the pattern in `frontend/src/lib/api.ts` — use the same `API_BASE_URL` environment variable.

Create a helper at the top:
```typescript
const getBaseUrl = () => process.env.NEXT_PUBLIC_API_URL || "http://localhost:8000";
```

Each function accepts an optional `user?: { name: string; role: string }` as last parameter for auth headers. Default to `{ name: "estimateur", role: "estimator" }`.

Functions (all async):
1. `createSubmission(data: SubmissionCreatePayload, user?)` — POST /submissions
2. `getSubmission(id: string)` — GET /submissions/{id}
3. `listSubmissions(params?: { status?: string; limit?: number; offset?: number })` — GET /submissions?status=X&limit=N&offset=N
4. `updateSubmission(id: string, data: { line_items?: LineItem[]; selected_tier?: string; client_name?: string }, user?)` — PATCH /submissions/{id}
5. `finalizeSubmission(id: string, user?)` — POST /submissions/{id}/finalize
6. `approveSubmission(id: string, user?)` — POST /submissions/{id}/approve
7. `rejectSubmission(id: string, reason?: string, user?)` — POST /submissions/{id}/reject
8. `addNote(id: string, text: string, createdBy: string)` — POST /submissions/{id}/notes with body `{text, created_by}`
9. `createUpsell(parentId: string, upsellType: string, user?)` — POST /submissions/{parentId}/upsells with body `{upsell_type, created_by}`
10. `getUpsellSuggestions(id: string)` — GET /submissions/{id}/upsell-suggestions

Each function sets headers:
```typescript
headers: {
  "Content-Type": "application/json",
  "X-User-Name": user?.name || "estimateur",
  "X-User-Role": user?.role || "estimator",
}
```

Handle errors: throw Error with response statusText if not ok.

**i18n keys** — Add `submissions` block to both `fr.ts` and `en.ts`:

French:
```
submissions: {
  title: "Soumissions",
  create: "Creer une soumission",
  edit: "Modifier",
  save: "Enregistrer",
  finalize: "Finaliser",
  approve: "Approuver",
  reject: "Rejeter",
  returnToDraft: "Retourner au brouillon",
  addNote: "Ajouter une note",
  addItem: "Ajouter un element",
  addMaterial: "Ajouter un materiau",
  addLabor: "Ajouter de la main-d'oeuvre",
  removeItem: "Retirer",
  lineItems: "Elements de la soumission",
  materials: "Materiaux",
  labor: "Main-d'oeuvre",
  quantity: "Quantite",
  unitPrice: "Prix unitaire",
  total: "Total",
  name: "Description",
  type: "Type",
  actions: "Actions",
  notes: "Notes",
  notePlaceholder: "Ajouter une note...",
  status: {
    draft: "Brouillon",
    pending_approval: "En attente",
    approved: "Approuvee",
    rejected: "Rejetee",
  },
  noItems: "Aucun element",
  totalMaterials: "Total materiaux",
  totalLabor: "Total main-d'oeuvre",
  grandTotal: "Grand total",
  auditLog: "Journal d'audit",
  confirmFinalize: "Etes-vous sur de vouloir finaliser cette soumission? Elle sera envoyee pour approbation.",
  confirmApprove: "Approuver cette soumission?",
  confirmReject: "Rejeter cette soumission?",
  rejectReason: "Raison du rejet (optionnel)",
  upsells: {
    title: "Services supplementaires suggeres",
    create: "Creer une soumission complementaire",
    selectServices: "Selectionnez les services a proposer",
    heating_cables: "Cables chauffants",
    gutters: "Gouttieres",
    ventilation: "Ventilation",
    drain_system: "Systeme de drain",
    insulation: "Isolation",
    maintenance_contract: "Contrat d'entretien",
    inspection_plan: "Plan d'inspection",
    snow_guards: "Garde-neiges",
    warranty_extension: "Extension de garantie",
  },
  clientName: "Nom du client",
  category: "Categorie",
  dragToReorder: "Glisser pour reordonner",
  draftOnly: "Modification en mode brouillon uniquement",
  emptyLineItems: "Ajoutez au moins un element avant de finaliser",
}
```

English (same structure with English labels). Include all keys listed above translated.
  </action>
  <verify>
Run `cd /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend && npx tsc --noEmit --skipLibCheck 2>&1 | head -30` — no TypeScript errors. Verify `@dnd-kit/core` appears in package.json. Verify `submissions` key exists in both fr.ts and en.ts.
  </verify>
  <done>
@dnd-kit packages installed. TypeScript types mirror all backend schemas. API client has 10 functions for all submission endpoints with auth header support. Both fr.ts and en.ts have complete `submissions` i18n block with status labels, upsell types, confirmation messages, and all UI labels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Submission editor UI with drag-drop line items, notes, and status badge</name>
  <files>
    frontend/src/components/estimateur/submission-editor.tsx
    frontend/src/components/estimateur/sortable-line-item.tsx
    frontend/src/components/estimateur/notes-panel.tsx
    frontend/src/components/estimateur/status-badge.tsx
  </files>
  <action>
**StatusBadge** (`status-badge.tsx`):

Simple component rendering a shadcn Badge with color per status:
- Props: `status: SubmissionStatus`
- draft -> variant="outline" (gray)
- pending_approval -> variant="secondary" with amber text/bg (className="bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200")
- approved -> variant="secondary" with green (className="bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200")
- rejected -> variant="destructive"
- Use `useLanguage()` for localized status label: `t.submissions.status[status]`
- "use client" directive at top

**NotesPanel** (`notes-panel.tsx`):

Notes display + input component:
- Props: `notes: Note[]`, `onAddNote: (text: string) => void`, `disabled?: boolean`, `isLoading?: boolean`
- "use client" directive
- Display notes in reverse chronological order (newest first)
- Each note shows: text, created_by (bold), formatted relative time (use simple helper: if <1h show "il y a X min", if <24h show "il y a X h", else show date)
- Input: shadcn Textarea (2 rows) + Button "Add" aligned right
- Clear textarea after successful add (controlled with useState)
- Disable textarea and button when `disabled` is true
- Use `useLanguage()` for labels
- Wrap in Card with CardHeader title "Notes" and CardContent

**SortableLineItem** (`sortable-line-item.tsx`):

Individual draggable table row for line items:
- Props: `id: string`, `index: number`, `item: LineItem`, `onUpdate: (index: number, field: keyof LineItem, value: string | number) => void`, `onRemove: (index: number) => void`, `disabled?: boolean`
- "use client" directive
- Use `useSortable({ id })` hook from @dnd-kit/sortable
- Apply `CSS.Transform.toString(transform)` and `transition` to row style
- Render as `<tr>` (or flex div row) with columns:
  1. **Drag handle**: GripVertical icon with `{...attributes} {...listeners}` — only shown when not disabled
  2. **Type**: Badge showing "Mat." or "M.O." (material/labor abbreviations)
  3. **Name**: Input (disabled when parent disabled), value=item.name
  4. **Quantity**: Input type="number", min=0.01, step=0.01, value=item.quantity, onChange calls onUpdate(index, "quantity", parseFloat)
  5. **Unit Price**: Input type="number", min=0, step=0.01, value=item.unit_price (formatted with $), onChange calls onUpdate(index, "unit_price", parseFloat)
  6. **Total**: Read-only display = quantity * unit_price, formatted as currency (fr-CA CAD)
  7. **Remove**: Trash2 icon button, only when not disabled, calls onRemove(index)
- Use cn() for conditional styling
- Key prop on parent MUST be item.id (NOT index) — critical for drag-drop correctness

**SubmissionEditor** (`submission-editor.tsx`):

Main component — the core of Phase 23 UI:
- Props: `submission: Submission`, `onUpdate: (updated: Submission) => void`, `userRole?: 'admin' | 'estimator'`, `userName?: string`
- "use client" directive

State management:
- `lineItems` state (copy of submission.line_items for editing)
- `isLoading` state for API calls
- `error` state for error display
- Derive `isDraft = submission.status === 'draft'`
- Derive `isPending = submission.status === 'pending_approval'`
- Derive `isAdmin = userRole === 'admin'`

Structure (top to bottom):

1. **Header**: Flex row with StatusBadge, client name (editable Input if draft), category badge, sqft display, created date

2. **Line Items Section**: Card with:
   - CardHeader: title from i18n, count badge showing item count
   - CardContent:
     - DndContext (from @dnd-kit/core) with closestCenter collision detection
     - SortableContext (from @dnd-kit/sortable) with verticalListSortingStrategy, items = lineItems.map(i => i.id)
     - Table header row: Drag | Type | Name | Qty | Unit Price | Total | Actions
     - Map lineItems to SortableLineItem components (key={item.id})
     - handleDragEnd: find oldIndex/newIndex from active.id/over.id, create new array with moved item, update order fields, setState
     - "Add Item" dropdown button: two options — "Add Material" and "Add Labor"
       - Adding material: append new LineItem with type="material", empty name, quantity=1, unit_price=0, unique UUID id, order = lineItems.length
       - Adding labor: same but type="labor"
     - Only show add/remove/drag when isDraft
   - **Totals row** below table: Total Materials | Total Labor | Grand Total (computed from lineItems)

3. **Notes Section**: NotesPanel component with submission.notes, onAddNote handler that calls `addNote()` API

4. **Action Buttons** (bottom, Separator above):
   - If isDraft:
     - "Save" button (primary) — calls updateSubmission API with current lineItems, then onUpdate
     - "Finalize" button (default variant) — shows confirmation Dialog, then calls finalizeSubmission API
   - If isPending AND isAdmin:
     - "Approve" button (green variant) — shows confirmation, calls approveSubmission API
     - "Reject" button (destructive) — shows Dialog with optional reason textarea, calls rejectSubmission API
   - If isPending AND NOT isAdmin:
     - "Return to Draft" button — calls transitionStatus(draft) or a dedicated endpoint (the PATCH with status revert — use the finalize in reverse... Actually, the backend handles pending_approval -> draft transition. Need to call the generic transition endpoint or a specific one. Use updateSubmission or a custom call. For simplicity, call `rejectSubmission` from the estimator perspective... No — estimators can't reject. Looking at VALID_TRANSITIONS: pending_approval -> [approved, rejected, draft]. The router doesn't have a "return to draft" endpoint. Use the PATCH /submissions/{id} with status transition via the general transition mechanism.)

   Actually, looking at Plan 01's router, there's no generic transition endpoint. The transitions are: finalize (draft->pending_approval), approve (pending->approved), reject (pending->rejected). For pending_approval->draft, we'd need to add this. The simplest approach: in the frontend, if estimator wants to pull back from pending, they call the reject endpoint... but estimators can't reject (403).

   **Resolution**: Add to the API client a `returnToDraft` function that calls `PATCH /submissions/{id}` with `{"status": "draft"}` — but the backend update endpoint doesn't support status changes (only line_items, tier, client_name).

   **Better resolution**: The backend service `update_submission` only allows draft edits. We need the backend to support a "withdraw" operation. Since Plan 01 is already defined and includes the service layer, we should add this capability.

   **Pragmatic approach for this plan**: Add a `withdrawSubmission` API call that sends `POST /submissions/{submission_id}/transition` to a hypothetical transition endpoint. OR, simply have the "Return to Draft" only available when the admin rejects — the rejected->draft transition IS available.

   For the submission-editor, implement these action buttons:
   - draft: Save + Finalize
   - pending_approval + admin: Approve + Reject
   - pending_approval + estimator: read-only message "Awaiting admin approval"
   - rejected: "Return to Draft" button (calls a custom API: POST request that triggers status change. Since the backend has reject which goes pending->rejected, and we need rejected->draft... The backend SubmissionUpdate or a PATCH could handle this.)

   For now, keep it simple: the "Return to Draft" after rejection will be a special API call. Add a `returnToDraft(id: string, user?)` function to the API client that makes a generic status transition request. On the backend side, this maps to pending_approval->draft or rejected->draft — both are valid transitions in VALID_TRANSITIONS. We'll need a generic `/submissions/{id}/transition` endpoint. Check if Plan 01 has this... Looking at Plan 01, it doesn't have a generic transition endpoint. The specific endpoints are: finalize, approve, reject.

   **Final decision**: Add one more function to the API client: `returnToDraft(id)`. This will call `PATCH /submissions/{id}` and pass the status change. We'll need to update the backend to support this — BUT we shouldn't modify Plan 01 from Plan 02. Instead, add a note that this endpoint needs to exist, and in the API client, make the call to a `/submissions/{id}/return-to-draft` endpoint that we'll add as a gap closure if needed.

   **Simplest approach**: In the frontend API client, call `PATCH /submissions/{id}` with body `{ "status": "draft" }` — but the SubmissionUpdate schema doesn't include status.

   **ACTUAL simplest approach**: Since Plan 01 controls the backend, and we see VALID_TRANSITIONS includes rejected->draft, we just need the frontend to hit the right endpoint. Add to the API client:
   ```typescript
   export async function returnToDraft(id: string, user?) {
     // Generic transition - backend needs to support this
     const res = await fetch(`${getBaseUrl()}/submissions/${id}/return-to-draft`, {
       method: "POST", headers: getHeaders(user)
     });
   }
   ```
   And Plan 01's executor will need to add this endpoint to the router (it's a small addition). Mark this as a known gap — the executor of Plan 01 should add `/submissions/{id}/return-to-draft` alongside finalize/approve/reject.

   For the submission-editor, implement the button and call regardless. If the backend endpoint doesn't exist yet, it'll fail gracefully with an error state.

Use currency formatting pattern from quote-result.tsx (Intl.NumberFormat fr-CA CAD).

Handle loading states: disable buttons + show spinner during API calls. Show error banner if API fails.
  </action>
  <verify>
Run `cd /Users/aymanbaig/Desktop/Manual\ Library/Toiture-P1/frontend && npx tsc --noEmit --skipLibCheck 2>&1 | head -30` — no TypeScript errors. Verify all 4 component files exist. Verify @dnd-kit packages in package.json dependencies.
  </verify>
  <done>
4 React components created: SubmissionEditor (main editor with DndContext, line items, notes, action buttons), SortableLineItem (draggable row with useSortable), NotesPanel (notes display + input), StatusBadge (colored per status). All components use useLanguage() for bilingual labels. Draft-only editing enforced. Admin-only approve button. Line totals recalculate reactively.
  </done>
</task>

</tasks>

<verification>
1. `frontend/src/types/submission.ts` exports all types including Submission, LineItem, Note, SubmissionStatus
2. `frontend/src/lib/api/submissions.ts` exports 11 API client functions
3. `frontend/src/components/estimateur/submission-editor.tsx` uses DndContext and SortableContext
4. `frontend/src/components/estimateur/sortable-line-item.tsx` uses useSortable hook
5. `frontend/src/components/estimateur/notes-panel.tsx` renders notes and input
6. `frontend/src/components/estimateur/status-badge.tsx` renders Badge with status color
7. @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities in package.json
8. fr.ts and en.ts both contain full `submissions` i18n block with nested status and upsells
9. `npx tsc --noEmit --skipLibCheck` passes without errors
</verification>

<success_criteria>
- Complete submission editor component with drag-drop reorder, add/remove line items
- Notes panel with timestamped display and input
- Status badge with 4 color-coded states
- Action buttons: Save/Finalize (draft), Approve/Reject (admin+pending), Return to Draft (rejected)
- All text bilingual FR/EN via useLanguage()
- TypeScript types match backend Pydantic schemas
- API client covers all submission endpoints with auth headers
- @dnd-kit installed and integrated
</success_criteria>

<output>
After completion, create `.planning/phases/23-submission-workflow-editing/23-02-SUMMARY.md`
</output>
