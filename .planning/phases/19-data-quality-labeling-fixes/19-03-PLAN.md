---
phase: 19-data-quality-labeling-fixes
plan: 03
type: execute
wave: 2
depends_on: ["19-01", "19-02"]
files_modified:
  - frontend/src/lib/schemas.ts
  - frontend/src/lib/schemas/hybrid-quote.ts
  - frontend/src/components/estimate-form.tsx
  - frontend/src/components/estimateur/full-quote-form.tsx
  - frontend/src/lib/i18n/en.ts
  - frontend/src/lib/i18n/fr.ts
  - frontend/src/app/(admin)/apercu/page.tsx
  - frontend/src/lib/hooks/use-dashboard.ts
  - frontend/src/lib/api/dashboard.ts
  - backend/app/schemas/estimate.py
  - backend/app/schemas/hybrid_quote.py
autonomous: true

must_haves:
  truths:
    - "Sqft field shows validation error when empty on non-Service Call categories"
    - "Sqft field becomes optional (no error when empty) when Service Call category is selected"
    - "Estimator dropdown appears on both Prix and Full Quote forms with options: Steven, Laurent, Other"
    - "Compliance section on Apercu page shows sqft completion rate with color coding"
    - "Alert banner appears on Apercu page when sqft compliance rate drops below 80%"
  artifacts:
    - path: "frontend/src/lib/schemas.ts"
      provides: "Conditional sqft validation based on category"
      contains: "superRefine"
    - path: "frontend/src/lib/schemas/hybrid-quote.ts"
      provides: "Conditional sqft validation for hybrid quote form"
      contains: "superRefine"
    - path: "frontend/src/components/estimate-form.tsx"
      provides: "Estimator dropdown on Prix form"
      contains: "created_by"
    - path: "frontend/src/components/estimateur/full-quote-form.tsx"
      provides: "Estimator dropdown on Full Quote form"
      contains: "created_by"
    - path: "frontend/src/app/(admin)/apercu/page.tsx"
      provides: "Compliance section below charts"
      contains: "compliance"
  key_links:
    - from: "frontend/src/app/(admin)/apercu/page.tsx"
      to: "frontend/src/lib/hooks/use-dashboard.ts"
      via: "useComplianceReport hook"
      pattern: "useComplianceReport"
    - from: "frontend/src/lib/hooks/use-dashboard.ts"
      to: "frontend/src/lib/api/dashboard.ts"
      via: "fetchComplianceReport function"
      pattern: "fetchComplianceReport"
    - from: "frontend/src/components/estimate-form.tsx"
      to: "frontend/src/lib/schemas.ts"
      via: "estimateFormSchema with conditional sqft"
      pattern: "estimateFormSchema"
---

<objective>
Make square footage required on estimate forms (with Service Call exception), add estimator dropdown for tracking who creates estimates, and build a compliance monitoring section on the Apercu dashboard page.

Purpose: Laurent needs sqft data for reliable estimates. Without mandatory collection, models degrade. The compliance dashboard lets management monitor data quality by estimator.

Output: Conditional sqft validation on both forms, estimator dropdown on both forms, compliance section on Apercu page with hook/API wiring to the backend endpoint created in Plan 19-02.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-data-quality-labeling-fixes/19-01-SUMMARY.md
@.planning/phases/19-data-quality-labeling-fixes/19-02-SUMMARY.md
@frontend/src/lib/schemas.ts
@frontend/src/lib/schemas/hybrid-quote.ts
@frontend/src/components/estimate-form.tsx
@frontend/src/components/estimateur/full-quote-form.tsx
@frontend/src/app/(admin)/apercu/page.tsx
@frontend/src/lib/hooks/use-dashboard.ts
@frontend/src/lib/api/dashboard.ts
@frontend/src/lib/i18n/en.ts
@frontend/src/lib/i18n/fr.ts
@backend/app/schemas/estimate.py
@backend/app/schemas/hybrid_quote.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Conditional sqft validation + estimator field on frontend schemas and forms</name>
  <files>
    frontend/src/lib/schemas.ts
    frontend/src/lib/schemas/hybrid-quote.ts
    frontend/src/components/estimate-form.tsx
    frontend/src/components/estimateur/full-quote-form.tsx
    frontend/src/lib/i18n/en.ts
    frontend/src/lib/i18n/fr.ts
    backend/app/schemas/estimate.py
    backend/app/schemas/hybrid_quote.py
  </files>
  <action>
**Frontend Schema Changes:**

1. **`frontend/src/lib/schemas.ts`** — Refactor `estimateFormSchema` to make sqft conditionally required:
   - Change `sqft` from `z.number().positive()...` to `z.number().min(0).max(100000).optional()`
   - Add `created_by` field: `z.string().optional()` (estimator name)
   - Add a `.superRefine()` that checks: if `category !== "Service Call"`, then `sqft` must be present and > 0
   - Update `EstimateFormData` type export

2. **`frontend/src/lib/schemas/hybrid-quote.ts`** — Same conditional sqft logic:
   - Change `sqft` from `z.number().positive()...` to `z.number().min(0).max(100000).optional()`
   - Add `created_by` field: `z.string().optional()`
   - In the existing `.refine()` block (complexity sum check), convert to `.superRefine()` that ALSO checks sqft requirement when category is not "Service Call"
   - Ensure the complexity_aggregate validation is preserved

**Frontend Form Changes:**

3. **`frontend/src/components/estimate-form.tsx`** — Add estimator dropdown:
   - Add a new `<FormField>` for `created_by` BEFORE the sqft field (at top of form)
   - Use a `<Select>` component with options: "Steven", "Laurent", "Autre" (Other)
   - Use i18n key for label: `t.estimateur.estimateurNom` (add this key)
   - Include `created_by` in the API submission payload
   - Update default form values to include `created_by: undefined`

4. **`frontend/src/components/estimateur/full-quote-form.tsx`** — Same estimator dropdown:
   - Add the same `created_by` `<FormField>` in the Project Details card, before sqft
   - Include `created_by` in the `HybridQuoteRequest` payload built in `onSubmit`
   - Update default form values to include `created_by: undefined`

**i18n Keys to Add** (in both `en.ts` and `fr.ts`, in the `estimateur` section):
   - `estimateurNom` — EN: `"Estimator"` / FR: `"Estimateur"`
   - `selectEstimateur` — EN: `"Select estimator"` / FR: `"Sélectionnez un estimateur"`
   - `autre` — EN: `"Other"` / FR: `"Autre"`
   - `sqftRequis` — EN: `"Square footage is required for this category"` / FR: `"La superficie est requise pour cette catégorie"`

**Backend Schema Changes:**

5. **`backend/app/schemas/estimate.py`** — Make sqft conditionally required:
   - Change `sqft: float = Field(gt=0, le=100000, ...)` to `sqft: Optional[float] = Field(default=None, le=100000, ...)`
   - Add `created_by: Optional[str] = Field(default=None, max_length=100, description="Estimator name")`
   - Add a `@model_validator(mode="after")` that validates: if category != "Service Call" and sqft is None or <= 0, raise ValueError
   - Import `Optional` and `model_validator` if not already imported

6. **`backend/app/schemas/hybrid_quote.py`** — Same conditional sqft:
   - Change `sqft: float = Field(gt=0, le=100000, ...)` to `sqft: Optional[float] = Field(default=None, le=100000, ...)`
   - Add `created_by: Optional[str] = Field(default=None, max_length=100, description="Estimator name")`
   - Add a `@model_validator(mode="after")` (before the existing `validate_complexity_sum`) that validates sqft when category != "Service Call"

NOTE: The `created_by` field is optional on both frontend and backend — it will not break existing API calls that don't send it. The estimator dropdown defaults to empty/unselected.
  </action>
  <verify>
1. `cd frontend && npx tsc --noEmit 2>&1 | head -20` — no type errors
2. `cd backend && python -c "from app.schemas.estimate import EstimateRequest; r = EstimateRequest(category='Service Call', material_lines=0, labor_lines=1); print('Service Call OK:', r.sqft)"` — should succeed with sqft=None
3. `cd backend && python -c "
from app.schemas.estimate import EstimateRequest
try:
    EstimateRequest(category='Bardeaux', material_lines=5, labor_lines=2)
    print('FAIL: should have raised error')
except Exception as e:
    print('OK: raised error for missing sqft:', str(e)[:60])
"` — should raise validation error for missing sqft on Bardeaux
4. `grep "created_by" frontend/src/components/estimate-form.tsx` — should return match
5. `grep "created_by" frontend/src/components/estimateur/full-quote-form.tsx` — should return match
  </verify>
  <done>
Sqft is conditionally required (mandatory for all categories except Service Call) on both frontend and backend. Estimator dropdown with Steven/Laurent/Other options appears on both Prix and Full Quote forms. The created_by field is sent with API requests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Compliance section on Apercu page with hook and API wiring</name>
  <files>
    frontend/src/app/(admin)/apercu/page.tsx
    frontend/src/lib/hooks/use-dashboard.ts
    frontend/src/lib/api/dashboard.ts
    frontend/src/lib/i18n/en.ts
    frontend/src/lib/i18n/fr.ts
  </files>
  <action>
**API Client (`frontend/src/lib/api/dashboard.ts`):**

Add a new function `fetchComplianceReport(days?: number)` that calls `GET /dashboard/compliance?days={days}` (default 30). Define the TypeScript interface inline or in `frontend/src/types/dashboard.ts`:

```typescript
export interface EstimatorCompliance {
  name: string;
  total_estimates: number;
  sqft_completed: number;
  completion_rate: number;
}

export interface ComplianceReport {
  overall_completion_rate: number;
  estimators: EstimatorCompliance[];
  alert: boolean;
  total_estimates: number;
  total_with_sqft: number;
}
```

Place the types in `frontend/src/types/dashboard.ts` (append to existing file).

The fetch function follows the same pattern as `fetchDashboardMetrics` and `fetchDashboardCharts`.

**Hook (`frontend/src/lib/hooks/use-dashboard.ts`):**

Add `useComplianceReport(days?: number)` hook following the same pattern as existing hooks:

```typescript
export function useComplianceReport(days: number = 30) {
  return useQuery({
    queryKey: ["dashboard", "compliance", days],
    queryFn: () => fetchComplianceReport(days),
    staleTime: 1000 * 60 * 5,
  });
}
```

Import `fetchComplianceReport` from `@/lib/api/dashboard`.

**Apercu Page (`frontend/src/app/(admin)/apercu/page.tsx`):**

Add a compliance section BELOW the charts grid. Structure:

1. Import `useComplianceReport` from hooks
2. Call `const { data: compliance, isLoading: complianceLoading } = useComplianceReport();`
3. Add a new `<Card>` section after the charts grid with:
   - CardTitle: `{t.apercu.sqftCompliance}`
   - Alert banner (amber/warning style) if `compliance?.alert` is true: `{t.apercu.complianceAlert}`
   - Overall rate display: large percentage text with color coding (green >= 80%, red < 80%)
   - Simple table with columns: Estimator | Total | Completed | Rate
   - Rows from `compliance?.estimators` array
   - Loading skeleton when `complianceLoading`

**i18n Keys to Add** (in `apercu` section of both files):

EN:
```
sqftCompliance: "Sqft Data Compliance",
completionRate: "Completion Rate",
estimateurCol: "Estimator",
totalEstimatesCol: "Total Estimates",
sqftCompletedCol: "Sqft Completed",
rateCol: "Rate",
complianceAlert: "Warning: Sqft completion rate is below 80%. Ensure all estimates include square footage data.",
noComplianceData: "No estimate data available for this period.",
```

FR:
```
sqftCompliance: "Conformité des données de superficie",
completionRate: "Taux de complétion",
estimateurCol: "Estimateur",
totalEstimatesCol: "Total estimations",
sqftCompletedCol: "Superficie complétée",
rateCol: "Taux",
complianceAlert: "Attention : Le taux de complétion de superficie est inférieur à 80%. Assurez-vous que toutes les estimations incluent la superficie.",
noComplianceData: "Aucune donnée d'estimation disponible pour cette période.",
```

NOTE: Plan 19-01 already modified `apercu/page.tsx` (disclaimer + i18n chart titles) and `en.ts`/`fr.ts`. This task builds on top of those changes. Read the current state of the files before editing.
  </action>
  <verify>
1. `cd frontend && npx tsc --noEmit 2>&1 | head -20` — no type errors
2. `grep "useComplianceReport" frontend/src/app/\(admin\)/apercu/page.tsx` — should return match
3. `grep "fetchComplianceReport" frontend/src/lib/api/dashboard.ts` — should return match
4. `grep "sqftCompliance" frontend/src/lib/i18n/en.ts` — should return match
5. `grep "sqftCompliance" frontend/src/lib/i18n/fr.ts` — should return match
6. Check build compiles: `cd frontend && npx next build --no-lint 2>&1 | tail -5`
  </verify>
  <done>
Apercu page now shows a compliance monitoring section below the charts with overall sqft completion rate, per-estimator breakdown table, and alert banner when rate drops below 80%. Data is fetched from GET /dashboard/compliance endpoint via React Query hook.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /estimateur (Prix tab) — estimator dropdown visible, sqft required for non-Service Call
2. Select "Service Call" category — sqft field becomes optional (no validation error if empty)
3. Navigate to /estimateur (Soumission Complete tab) — same estimator dropdown and conditional sqft
4. Navigate to /apercu — compliance section visible below charts
5. If backend running: compliance data loads with rates and estimator breakdown
6. Toggle language — all new labels switch between EN/FR
7. Both frontend and backend compile/start without errors
</verification>

<success_criteria>
- Sqft field conditionally required based on category (both forms, both frontend and backend)
- Estimator dropdown on both forms sends created_by to API
- Compliance section on Apercu shows overall rate, per-estimator table, and alert
- All new UI text bilingual (EN/FR)
- No type errors in frontend, no import errors in backend
</success_criteria>

<output>
After completion, create `.planning/phases/19-data-quality-labeling-fixes/19-03-SUMMARY.md`
</output>
