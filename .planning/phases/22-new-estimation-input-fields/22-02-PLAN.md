---
phase: 22-new-estimation-input-fields
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - frontend/src/components/estimateur/full-quote-form.tsx
autonomous: true
must_haves:
  truths:
    - "Estimator sees 3 number inputs (compagnons/apprentis/manoeuvres) with live total crew display"
    - "Estimator can select half-day/full-day/multi-day duration via radio buttons"
    - "Multi-day selection reveals a day count picker (2-30)"
    - "Estimator can select geographic zone from 5 options"
    - "Estimator can select premium client level from 4 options"
    - "Estimator sees equipment checklist with 5 items and $25/day placeholder prices"
    - "Estimator can select supply chain risk via radio, warning shows for extended/import"
    - "All new fields submit to backend as part of HybridQuoteRequest"
    - "All labels display in correct language when switching FR/EN"
  artifacts:
    - path: "frontend/src/components/estimateur/full-quote-form.tsx"
      provides: "3 new Card sections with 6 field groups wired to form + API submission"
      contains: "employee_compagnons"
  key_links:
    - from: "frontend/src/components/estimateur/full-quote-form.tsx"
      to: "frontend/src/lib/schemas/hybrid-quote.ts"
      via: "react-hook-form + zodResolver uses new Zod fields"
      pattern: "employee_compagnons.*duration_type.*geographic_zone"
    - from: "frontend/src/components/estimateur/full-quote-form.tsx"
      to: "frontend/src/lib/i18n/fr.ts"
      via: "t.fullQuote.* translation keys for all new labels"
      pattern: "t\\.fullQuote\\.compagnons|t\\.fullQuote\\.halfDay|t\\.fullQuote\\.zoneCore"
    - from: "frontend/src/components/estimateur/full-quote-form.tsx"
      to: "/estimate/hybrid"
      via: "onSubmit builds HybridQuoteRequest with new fields"
      pattern: "employee_compagnons.*data\\.duration_type.*data\\.geographic_zone"
---

<objective>
Build 3 new Card sections in the full-quote form UI with all 6 remaining field groups.

Purpose: Give estimators the missing input fields (crew, duration, zone, premium level, equipment, supply chain risk) needed to generate accurate quotes. Access difficulty is already implemented in Phase 21's factor checklist.

Output: Updated full-quote-form.tsx with 3 new Card sections between existing Complexity and Features sections, all fields wired to react-hook-form and included in API submission.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-new-estimation-input-fields/22-RESEARCH.md
@.planning/phases/22-new-estimation-input-fields/22-01-SUMMARY.md
@frontend/src/components/estimateur/full-quote-form.tsx
@frontend/src/components/estimateur/factor-checklist.tsx
@frontend/src/lib/schemas/hybrid-quote.ts
@frontend/src/types/hybrid-quote.ts
@frontend/src/lib/i18n/fr.ts
@frontend/src/lib/i18n/en.ts
@backend/app/models/equipment_config.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 3 new Card sections to full-quote-form.tsx</name>
  <files>frontend/src/components/estimateur/full-quote-form.tsx</files>
  <action>
Modify `frontend/src/components/estimateur/full-quote-form.tsx` to add 3 new Card sections between the existing Complexity section (ends ~line 555) and the existing Features section (starts ~line 557).

**Step 1: Add new imports at the top of the file.**

Add to the existing imports:
```typescript
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Checkbox } from "@/components/ui/checkbox";
import { Users, MapPin, Package } from "lucide-react";
```

(`Users` for crew section icon, `MapPin` for location section icon, `Package` for equipment section icon. `AlertCircle` is already imported.)

**Step 2: Add equipment config data inside the FullQuoteForm component.**

After the `useTierData()` call (~line 185), add a static equipment options array that loads from the JSON config values (hardcoded for now to avoid async loading complexity):

```typescript
// Equipment items from equipment_config.json (hardcoded to avoid async load)
const { locale } = useLanguage();
```

Wait — `locale` is not currently destructured in FullQuoteForm. The component currently uses `const { t } = useLanguage();`. Change this to:
```typescript
const { t, locale } = useLanguage();
```

Then add equipment data:
```typescript
const equipmentOptions = [
  { id: "crane", label: locale === 'fr' ? "Grue" : "Crane", dailyCost: 25 },
  { id: "scaffolding", label: locale === 'fr' ? "Echafaudage" : "Scaffolding", dailyCost: 25 },
  { id: "dumpster", label: locale === 'fr' ? "Conteneur a dechets" : "Dumpster", dailyCost: 25 },
  { id: "generator", label: locale === 'fr' ? "Generatrice" : "Generator", dailyCost: 25 },
  { id: "compressor", label: locale === 'fr' ? "Compresseur" : "Compressor", dailyCost: 25 },
];
```

**Step 3: Add new default values to the useForm call.**

Add these defaults to the existing `defaultValues` object (after `manual_extra_hours: 0`):
```typescript
employee_compagnons: 0,
employee_apprentis: 0,
employee_manoeuvres: 0,
duration_type: 'full_day' as const,
duration_days: undefined,
geographic_zone: undefined,
premium_client_level: 'standard' as const,
equipment_items: [] as string[],
supply_chain_risk: 'standard' as const,
```

**Step 4: Add watched values for crew total and conditional rendering.**

After the existing `const category = form.watch("category");` line (~line 214), add:
```typescript
const compagnons = form.watch("employee_compagnons") || 0;
const apprentis = form.watch("employee_apprentis") || 0;
const manoeuvres = form.watch("employee_manoeuvres") || 0;
const totalCrew = compagnons + apprentis + manoeuvres;
const durationType = form.watch("duration_type");
const supplyRisk = form.watch("supply_chain_risk");
```

**Step 5: Add new fields to the onSubmit request builder.**

In the `onSubmit` function, add these fields to the `request` object (after `quoted_total: data.quoted_total`):
```typescript
// Phase 22 new fields
employee_compagnons: data.employee_compagnons > 0 ? data.employee_compagnons : undefined,
employee_apprentis: data.employee_apprentis > 0 ? data.employee_apprentis : undefined,
employee_manoeuvres: data.employee_manoeuvres > 0 ? data.employee_manoeuvres : undefined,
duration_type: data.duration_type,
duration_days: data.duration_type === 'multi_day' ? data.duration_days : undefined,
geographic_zone: data.geographic_zone || undefined,
premium_client_level: data.premium_client_level !== 'standard' ? data.premium_client_level : undefined,
equipment_items: data.equipment_items.length > 0 ? data.equipment_items : undefined,
supply_chain_risk: data.supply_chain_risk !== 'standard' ? data.supply_chain_risk : undefined,
```

**Step 6: Add Card Section 1 — Crew & Duration.**

Insert this Card AFTER the Complexity section Card (after line ~555, the closing `</Card>` of the complexity section) and BEFORE the Features section Card:

```tsx
{/* Crew & Duration Section */}
<Card className="card-hover">
  <CardHeader className="pb-4">
    <div className="flex items-center gap-2">
      <div className="flex size-8 items-center justify-center rounded-lg bg-primary/10 text-primary">
        <Users className="size-4" />
      </div>
      <div>
        <CardTitle className="text-lg">{t.fullQuote.crewDuration}</CardTitle>
        <CardDescription className="text-sm">{t.fullQuote.crewDurationDescription}</CardDescription>
      </div>
    </div>
  </CardHeader>
  <CardContent className="space-y-6">
    {/* Employee Count - 3 columns */}
    <div>
      <label className="text-sm font-medium mb-3 block">{t.fullQuote.totalCrew}</label>
      <div className="grid grid-cols-3 gap-3">
        <FormField
          control={form.control}
          name="employee_compagnons"
          render={({ field }) => (
            <FormItem>
              <FormLabel className="text-xs font-medium">{t.fullQuote.compagnons}</FormLabel>
              <FormControl>
                <Input
                  type="number"
                  min={0}
                  max={20}
                  className="h-11"
                  {...field}
                  onChange={(e) => field.onChange(parseInt(e.target.value) || 0)}
                />
              </FormControl>
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="employee_apprentis"
          render={({ field }) => (
            <FormItem>
              <FormLabel className="text-xs font-medium">{t.fullQuote.apprentis}</FormLabel>
              <FormControl>
                <Input
                  type="number"
                  min={0}
                  max={20}
                  className="h-11"
                  {...field}
                  onChange={(e) => field.onChange(parseInt(e.target.value) || 0)}
                />
              </FormControl>
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="employee_manoeuvres"
          render={({ field }) => (
            <FormItem>
              <FormLabel className="text-xs font-medium">{t.fullQuote.manoeuvres}</FormLabel>
              <FormControl>
                <Input
                  type="number"
                  min={0}
                  max={20}
                  className="h-11"
                  {...field}
                  onChange={(e) => field.onChange(parseInt(e.target.value) || 0)}
                />
              </FormControl>
            </FormItem>
          )}
        />
      </div>
      {/* Total Crew Display */}
      <div className="flex justify-between items-center pt-3 mt-3 border-t border-border/50">
        <span className="text-sm font-medium">{t.fullQuote.totalCrew}</span>
        <span className="text-sm font-semibold text-primary">
          {totalCrew} {t.fullQuote.workers}
        </span>
      </div>
    </div>

    {/* Duration Radio */}
    <FormField
      control={form.control}
      name="duration_type"
      render={({ field }) => (
        <FormItem>
          <FormLabel className="text-sm font-medium">{t.fullQuote.projectDuration}</FormLabel>
          <FormControl>
            <RadioGroup
              onValueChange={field.onChange}
              value={field.value}
              className="space-y-2"
            >
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="half_day" id="half_day" />
                <label htmlFor="half_day" className="text-sm cursor-pointer">
                  {t.fullQuote.halfDay}
                </label>
              </div>
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="full_day" id="full_day" />
                <label htmlFor="full_day" className="text-sm cursor-pointer">
                  {t.fullQuote.fullDay}
                </label>
              </div>
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="multi_day" id="multi_day" />
                <label htmlFor="multi_day" className="text-sm cursor-pointer">
                  {t.fullQuote.multiDay}
                </label>
              </div>
            </RadioGroup>
          </FormControl>
        </FormItem>
      )}
    />

    {/* Conditional Day Picker (only when multi_day selected) */}
    {durationType === 'multi_day' && (
      <FormField
        control={form.control}
        name="duration_days"
        render={({ field }) => (
          <FormItem>
            <FormLabel className="text-sm font-medium">{t.fullQuote.numberOfDays}</FormLabel>
            <FormControl>
              <Input
                type="number"
                min={2}
                max={30}
                placeholder="3"
                className="h-11 max-w-32"
                {...field}
                value={field.value ?? ''}
                onChange={(e) => field.onChange(e.target.valueAsNumber || undefined)}
              />
            </FormControl>
          </FormItem>
        )}
      />
    )}
  </CardContent>
</Card>
```

**Step 7: Add Card Section 2 — Location & Client.**

Insert immediately after the Crew & Duration Card:

```tsx
{/* Location & Client Section */}
<Card className="card-hover">
  <CardHeader className="pb-4">
    <div className="flex items-center gap-2">
      <div className="flex size-8 items-center justify-center rounded-lg bg-primary/10 text-primary">
        <MapPin className="size-4" />
      </div>
      <div>
        <CardTitle className="text-lg">{t.fullQuote.locationClient}</CardTitle>
        <CardDescription className="text-sm">{t.fullQuote.locationClientDescription}</CardDescription>
      </div>
    </div>
  </CardHeader>
  <CardContent className="space-y-6">
    {/* Geographic Zone Dropdown */}
    <FormField
      control={form.control}
      name="geographic_zone"
      render={({ field }) => (
        <FormItem>
          <FormLabel className="text-sm font-medium">{t.fullQuote.geographicZone}</FormLabel>
          <Select
            onValueChange={field.onChange}
            value={field.value}
          >
            <FormControl>
              <SelectTrigger className="h-11">
                <SelectValue placeholder={t.fullQuote.selectZone} />
              </SelectTrigger>
            </FormControl>
            <SelectContent>
              <SelectItem value="core">{t.fullQuote.zoneCore}</SelectItem>
              <SelectItem value="secondary">{t.fullQuote.zoneSecondary}</SelectItem>
              <SelectItem value="north_premium">{t.fullQuote.zoneNorthPremium}</SelectItem>
              <SelectItem value="extended">{t.fullQuote.zoneExtended}</SelectItem>
              <SelectItem value="red_flag">{t.fullQuote.zoneRedFlag}</SelectItem>
            </SelectContent>
          </Select>
          <FormMessage />
        </FormItem>
      )}
    />

    {/* Premium Client Level Dropdown */}
    <FormField
      control={form.control}
      name="premium_client_level"
      render={({ field }) => (
        <FormItem>
          <FormLabel className="text-sm font-medium">{t.fullQuote.premiumClientLevel}</FormLabel>
          <Select
            onValueChange={field.onChange}
            value={field.value}
          >
            <FormControl>
              <SelectTrigger className="h-11">
                <SelectValue />
              </SelectTrigger>
            </FormControl>
            <SelectContent>
              <SelectItem value="standard">
                {t.fullQuote.premiumStandard} — {t.fullQuote.premiumStandardDesc}
              </SelectItem>
              <SelectItem value="premium_1">
                {t.fullQuote.premium1} — {t.fullQuote.premium1Desc} ({t.fullQuote.surchargeTBD})
              </SelectItem>
              <SelectItem value="premium_2">
                {t.fullQuote.premium2} — {t.fullQuote.premium2Desc} ({t.fullQuote.surchargeTBD})
              </SelectItem>
              <SelectItem value="premium_3">
                {t.fullQuote.premium3} — {t.fullQuote.premium3Desc} ({t.fullQuote.surchargeTBD})
              </SelectItem>
            </SelectContent>
          </Select>
          <FormDescription className="text-xs text-muted-foreground">
            {t.fullQuote.placeholderPricing}
          </FormDescription>
          <FormMessage />
        </FormItem>
      )}
    />
  </CardContent>
</Card>
```

**Step 8: Add Card Section 3 — Equipment & Supply Chain.**

Insert immediately after the Location & Client Card:

```tsx
{/* Equipment & Supply Chain Section */}
<Card className="card-hover">
  <CardHeader className="pb-4">
    <div className="flex items-center gap-2">
      <div className="flex size-8 items-center justify-center rounded-lg bg-primary/10 text-primary">
        <Package className="size-4" />
      </div>
      <div>
        <CardTitle className="text-lg">{t.fullQuote.equipmentSupplyChain}</CardTitle>
        <CardDescription className="text-sm">{t.fullQuote.equipmentSupplyChainDescription}</CardDescription>
      </div>
    </div>
  </CardHeader>
  <CardContent className="space-y-6">
    {/* Equipment Checklist */}
    <div>
      <label className="text-sm font-medium mb-3 block">{t.fullQuote.toolsEquipment}</label>
      <div className="space-y-2">
        {equipmentOptions.map((item) => {
          const currentItems = form.watch("equipment_items") || [];
          const isChecked = currentItems.includes(item.id);
          return (
            <div
              key={item.id}
              className="flex items-center justify-between rounded-lg border border-border/50 bg-muted/30 px-4 py-3 transition-colors hover:bg-muted/50"
            >
              <div className="flex items-center gap-3">
                <Checkbox
                  id={`equipment-${item.id}`}
                  checked={isChecked}
                  onCheckedChange={(checked) => {
                    const current = form.getValues("equipment_items") || [];
                    if (checked) {
                      form.setValue("equipment_items", [...current, item.id]);
                    } else {
                      form.setValue("equipment_items", current.filter((x: string) => x !== item.id));
                    }
                  }}
                />
                <label
                  htmlFor={`equipment-${item.id}`}
                  className="text-sm cursor-pointer"
                >
                  {item.label}
                </label>
              </div>
              <span className="text-xs font-medium text-primary">
                ${item.dailyCost}{t.fullQuote.dailyCost}
              </span>
            </div>
          );
        })}
      </div>
      <p className="text-xs text-muted-foreground mt-2">
        {t.fullQuote.placeholderPricing}
      </p>
    </div>

    {/* Supply Chain Risk Radio */}
    <FormField
      control={form.control}
      name="supply_chain_risk"
      render={({ field }) => (
        <FormItem>
          <FormLabel className="text-sm font-medium">{t.fullQuote.supplyChainRisk}</FormLabel>
          <FormControl>
            <RadioGroup
              onValueChange={field.onChange}
              value={field.value}
              className="space-y-2"
            >
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="standard" id="supply_standard" />
                <label htmlFor="supply_standard" className="text-sm cursor-pointer">
                  {t.fullQuote.supplyStandard} ({t.fullQuote.supplyStandardDesc})
                </label>
              </div>
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="extended" id="supply_extended" />
                <label htmlFor="supply_extended" className="text-sm cursor-pointer">
                  {t.fullQuote.supplyExtended} ({t.fullQuote.supplyExtendedDesc})
                </label>
              </div>
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="import" id="supply_import" />
                <label htmlFor="supply_import" className="text-sm cursor-pointer">
                  {t.fullQuote.supplyImport} ({t.fullQuote.supplyImportDesc})
                </label>
              </div>
            </RadioGroup>
          </FormControl>
        </FormItem>
      )}
    />

    {/* Supply Chain Warning */}
    {(supplyRisk === 'extended' || supplyRisk === 'import') && (
      <div className="flex items-center gap-2 rounded-lg border border-yellow-500/50 bg-yellow-500/10 p-3">
        <AlertCircle className="size-5 shrink-0 text-yellow-600" />
        <p className="text-sm text-yellow-700 dark:text-yellow-400">
          {t.fullQuote.supplyWarning}
        </p>
      </div>
    )}
  </CardContent>
</Card>
```

**IMPORTANT: Section order in the form should be:**
1. Project Details Card (existing)
2. Complexity Card (existing)
3. **NEW: Crew & Duration Card**
4. **NEW: Location & Client Card**
5. **NEW: Equipment & Supply Chain Card**
6. Features Card (existing — chimney, skylights, subs)
7. Error display (existing)
8. Submit button (existing)

**Do NOT modify any existing Card sections.** Only insert 3 new Cards between Complexity and Features.
  </action>
  <verify>
1. `cd frontend && npx tsc --noEmit` — zero TypeScript errors
2. `cd frontend && npm run build` — build succeeds (or `npx next build`)
3. Visual check: Navigate to the estimator Full Quote form and confirm:
   - 3 new Card sections visible between Complexity and Features
   - Employee count shows 3 number inputs in a row with total crew display
   - Duration shows 3 radio buttons, selecting "Multi-day" reveals day picker
   - Geographic zone shows dropdown with 5 options
   - Premium client level shows dropdown with 4 options, "Rate to be confirmed" for premium tiers
   - Equipment shows 5 checkbox items with $25/day each
   - Supply chain risk shows 3 radio buttons, selecting "Extended" or "Import" shows yellow warning
   - Switching language toggle updates all new labels
  </verify>
  <done>
Full-quote form displays 3 new Card sections (Crew & Duration, Location & Client, Equipment & Supply Chain) with all 6 field groups. All fields are wired to react-hook-form, included in API submission payload, and display bilingual labels via i18n.
  </done>
</task>

</tasks>

<verification>
1. **TypeScript compiles:** `cd frontend && npx tsc --noEmit` passes
2. **Build succeeds:** `cd frontend && npm run build` (or `npx next build`)
3. **Form renders:** Open browser, navigate to estimator Full Quote tab, see 6 Card sections total
4. **Employee count:** Enter values in 3 inputs, total crew updates live
5. **Duration:** Click each radio button, multi-day reveals day picker
6. **Geographic zone:** Open dropdown, see 5 zone options
7. **Premium level:** Open dropdown, see 4 options with "Rate to be confirmed" for premium tiers
8. **Equipment:** Check/uncheck boxes, each shows $25/day
9. **Supply chain:** Select "Extended" or "Import", warning banner appears
10. **Language toggle:** Switch FR/EN, all new labels update
11. **Submit:** Fill form and submit, check browser Network tab that new fields are sent in POST body
12. **Backward compat:** Submit without filling any new fields, request still succeeds
</verification>

<success_criteria>
- 3 new Card sections render between Complexity and Features sections
- Employee count: 3 number inputs + live total crew display
- Duration: Radio buttons (half-day/full-day/multi-day) + conditional day picker
- Geographic zone: Dropdown with 5 Quebec zones
- Premium client level: Dropdown with 4 options (standard + 3 premium with TBD pricing)
- Equipment: Checklist of 5 items with $25/day symbolic prices
- Supply chain risk: Radio buttons with yellow warning for extended/import
- All labels bilingual (FR/EN) via t.fullQuote.* keys
- New fields included in POST /estimate/hybrid request payload
- Zero TypeScript or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-new-estimation-input-fields/22-02-SUMMARY.md`
</output>
