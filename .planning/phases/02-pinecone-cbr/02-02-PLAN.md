---
phase: 02-pinecone-cbr
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/app/schemas/estimate.py
  - backend/app/routers/estimate.py
  - backend/app/main.py
  - backend/tests/test_cbr.py
autonomous: true
user_setup:
  - service: pinecone
    why: "Vector database for CBR similarity search"
    env_vars:
      - name: PINECONE_API_KEY
        source: "Pinecone Console -> API Keys"
      - name: PINECONE_INDEX_HOST
        source: "Output from upload_embeddings.py script"
    dashboard_config:
      - task: "Create Pinecone account (free tier)"
        location: "https://www.pinecone.io/"

must_haves:
  truths:
    - "POST /estimate returns similar_cases array with top 5 cases"
    - "Each similar case has case_id, similarity, category, sqft, total, per_sqft, year"
    - "similar_cases are sorted by similarity score descending"
    - "Empty similar_cases returned when Pinecone not configured"
  artifacts:
    - path: "backend/app/schemas/estimate.py"
      provides: "SimilarCase model and updated EstimateResponse"
      exports: ["SimilarCase", "EstimateResponse"]
      contains: "similar_cases"
    - path: "backend/app/routers/estimate.py"
      provides: "Updated estimate endpoint with CBR"
      exports: ["router"]
    - path: "backend/tests/test_cbr.py"
      provides: "Tests for similar cases in response"
      min_lines: 30
  key_links:
    - from: "backend/app/routers/estimate.py"
      to: "backend/app/services/embeddings.py"
      via: "import generate_query_embedding"
      pattern: "from app\\.services\\.embeddings import"
    - from: "backend/app/routers/estimate.py"
      to: "backend/app/services/pinecone_cbr.py"
      via: "import query_similar_cases"
      pattern: "from app\\.services\\.pinecone_cbr import"
    - from: "backend/app/main.py"
      to: "backend/app/services/pinecone_cbr.py"
      via: "lifespan init"
      pattern: "init_pinecone\\(\\)"
---

<objective>
Integrate Pinecone CBR into the estimate endpoint and add tests.

Purpose: Connect the Pinecone services to the estimate API so each estimate request returns the top 5 most similar historical cases for context and transparency.

Output: /estimate endpoint that returns similar_cases alongside the ML prediction, with tests verifying the integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-pinecone-cbr/02-RESEARCH.md
@.planning/phases/02-pinecone-cbr/02-01-SUMMARY.md

# Phase 1 endpoint structure
@.planning/phases/01-fastapi-foundation/01-02-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update schemas and estimate router with CBR</name>
  <files>
    backend/app/schemas/estimate.py
    backend/app/routers/estimate.py
    backend/app/main.py
  </files>
  <action>
Update backend/app/schemas/estimate.py to add SimilarCase model and update EstimateResponse:

```python
# Add to existing estimate.py:

class SimilarCase(BaseModel):
    """A similar historical case from CBR."""
    case_id: str
    similarity: float  # Cosine similarity score 0-1
    category: Optional[str] = None
    sqft: Optional[float] = None
    total: Optional[float] = None
    per_sqft: Optional[float] = None
    year: Optional[int] = None

# Update EstimateResponse to include similar_cases:
class EstimateResponse(BaseModel):
    """Response from /estimate endpoint."""
    estimate: float
    range_low: float
    range_high: float
    confidence: Literal["HIGH", "MEDIUM", "LOW"]
    model: str
    similar_cases: List[SimilarCase] = []  # NEW field
```

Make sure to add `from typing import List, Optional` if not already present.

Update backend/app/routers/estimate.py to integrate CBR:

```python
# Add imports at top:
from app.services.embeddings import generate_query_embedding, build_query_text
from app.services.pinecone_cbr import query_similar_cases
from app.schemas.estimate import SimilarCase  # Add to existing import

# Update the POST /estimate endpoint:
@router.post("/estimate", response_model=EstimateResponse)
def get_estimate(request: EstimateRequest):
    """Get price estimate with similar historical cases."""
    try:
        # Existing ML prediction
        prediction = predict(
            sqft=request.sqft,
            category=request.category,
            material_lines=request.material_lines,
            labor_lines=request.labor_lines,
            has_subs=request.has_subs,
            complexity=request.complexity
        )

        # Generate query embedding and find similar cases
        query_text = build_query_text(
            sqft=request.sqft,
            category=request.category,
            complexity=request.complexity,
            material_lines=request.material_lines,
            labor_lines=request.labor_lines
        )
        query_vector = generate_query_embedding(query_text)
        similar_cases_data = query_similar_cases(
            query_vector=query_vector,
            top_k=5,
            category_filter=None  # Don't filter by category - let similarity decide
        )

        # Convert to SimilarCase models
        similar_cases = [SimilarCase(**case) for case in similar_cases_data]

        return EstimateResponse(
            estimate=prediction["estimate"],
            range_low=prediction["range_low"],
            range_high=prediction["range_high"],
            confidence=prediction["confidence"],
            model=prediction["model"],
            similar_cases=similar_cases,
        )
    except Exception as e:
        logger.error(f"Estimate error: {e}")
        raise HTTPException(status_code=500, detail=str(e))
```

IMPORTANT: Use regular def (not async def) for the endpoint. The embedding model encode() is CPU-bound.

Update backend/app/main.py lifespan to initialize/cleanup CBR services:

```python
# Add imports:
from app.services.embeddings import load_embedding_model, unload_embedding_model
from app.services.pinecone_cbr import init_pinecone, close_pinecone

# Update lifespan context manager:
@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup
    load_models()           # ML prediction models
    load_embedding_model()  # sentence-transformers model
    init_pinecone()         # Pinecone connection
    yield
    # Shutdown
    close_pinecone()
    unload_embedding_model()
    unload_models()
```
  </action>
  <verify>
    python -c "from backend.app.schemas.estimate import SimilarCase, EstimateResponse; print('schemas OK')"
    python -c "from backend.app.routers.estimate import router; print('router OK')"
    grep "similar_cases" backend/app/schemas/estimate.py
    grep "init_pinecone" backend/app/main.py
  </verify>
  <done>SimilarCase model added, EstimateResponse updated, estimate router integrates CBR, lifespan initializes services</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for CBR integration</name>
  <files>
    backend/tests/test_cbr.py
  </files>
  <action>
Create backend/tests/test_cbr.py with tests for the CBR integration:

```python
"""Tests for CBR integration in estimate endpoint."""

import pytest
from fastapi.testclient import TestClient
from unittest.mock import patch, MagicMock


def test_estimate_includes_similar_cases(client):
    """POST /estimate response includes similar_cases array."""
    response = client.post(
        "/estimate",
        json={"sqft": 1500, "category": "Bardeaux"}
    )
    assert response.status_code == 200
    data = response.json()
    assert "similar_cases" in data
    assert isinstance(data["similar_cases"], list)


def test_similar_case_structure(client):
    """Each similar case has required fields."""
    # Mock Pinecone to return predictable data
    mock_cases = [
        {
            "case_id": "123",
            "similarity": 0.95,
            "category": "Bardeaux",
            "sqft": 1400.0,
            "total": 15000.0,
            "per_sqft": 10.71,
            "year": 2023
        }
    ]

    with patch("app.services.pinecone_cbr.query_similar_cases", return_value=mock_cases):
        response = client.post(
            "/estimate",
            json={"sqft": 1500, "category": "Bardeaux"}
        )
        assert response.status_code == 200
        data = response.json()
        assert len(data["similar_cases"]) == 1

        case = data["similar_cases"][0]
        assert case["case_id"] == "123"
        assert case["similarity"] == 0.95
        assert case["category"] == "Bardeaux"
        assert case["sqft"] == 1400.0
        assert case["total"] == 15000.0


def test_estimate_works_without_pinecone(client):
    """Estimate still works when Pinecone is not configured."""
    # query_similar_cases returns empty list when not initialized
    with patch("app.services.pinecone_cbr.query_similar_cases", return_value=[]):
        response = client.post(
            "/estimate",
            json={"sqft": 2000, "category": "Bardeaux"}
        )
        assert response.status_code == 200
        data = response.json()
        assert "estimate" in data
        assert data["similar_cases"] == []


def test_build_query_text():
    """Query text built correctly from inputs."""
    from app.services.embeddings import build_query_text

    text = build_query_text(
        sqft=1500,
        category="Bardeaux",
        complexity=15,
        material_lines=10,
        labor_lines=3
    )
    assert "Toiture Bardeaux" in text
    assert "1500" in text
    assert "complexite 15" in text
    assert "10 lignes materiaux" in text
    assert "3 lignes main-d'oeuvre" in text


def test_build_query_text_minimal():
    """Query text handles minimal inputs."""
    from app.services.embeddings import build_query_text

    text = build_query_text(
        sqft=1000,
        category="Elastomere",
        complexity=10
    )
    assert "Toiture Elastomere" in text
    assert "1000" in text
    assert "complexite 10" in text
    # Should not have material/labor lines without values
    assert "lignes materiaux" not in text


def test_embedding_model_generates_correct_dimensions():
    """Embedding model outputs 384-dim vectors."""
    from app.services.embeddings import load_embedding_model, generate_query_embedding, unload_embedding_model

    # Model should already be loaded by conftest, but ensure it is
    try:
        embedding = generate_query_embedding("Test roofing job")
        assert len(embedding) == 384
        assert all(isinstance(x, float) for x in embedding)
    except RuntimeError:
        # Model not loaded in test environment - skip
        pytest.skip("Embedding model not loaded")
```

IMPORTANT: Tests use mocking for Pinecone operations since tests may run without Pinecone credentials. The embedding model test may be skipped if model not loaded.

Update backend/tests/conftest.py to handle optional embedding model loading:

```python
# Add to existing conftest.py:
import os

@pytest.fixture(scope="session", autouse=True)
def setup_test_env():
    """Set up test environment variables."""
    # Ensure Pinecone doesn't try to connect during tests
    os.environ.setdefault("PINECONE_API_KEY", "")
    os.environ.setdefault("PINECONE_INDEX_HOST", "")
```
  </action>
  <verify>
    cd backend && python -m pytest tests/test_cbr.py -v --ignore=tests/test_estimate.py
  </verify>
  <done>CBR tests created covering similar_cases structure, mock responses, and edge cases</done>
</task>

</tasks>

<verification>
After all tasks complete, verify the success criteria from ROADMAP.md:

1. Query returns top 5 similar cases with job details:
   - Start server: cd backend && uvicorn app.main:app --reload
   - Test endpoint (requires Pinecone configured):
   curl -X POST http://localhost:8000/estimate \
     -H "Content-Type: application/json" \
     -d '{"sqft": 1500, "category": "Bardeaux"}'
   - Response should include similar_cases array with up to 5 cases

2. /estimate endpoint includes similar_cases in response:
   - Even without Pinecone, response should have "similar_cases": []
   - With Pinecone, should have similar cases with all metadata fields

3. Tests pass:
   cd backend && python -m pytest tests/ -v

Manual verification checklist:
- [ ] SimilarCase model has: case_id, similarity, category, sqft, total, per_sqft, year
- [ ] EstimateResponse.similar_cases is List[SimilarCase]
- [ ] Lifespan calls init_pinecone() and close_pinecone()
- [ ] Lifespan calls load_embedding_model() and unload_embedding_model()
- [ ] Endpoint gracefully handles missing Pinecone (returns empty similar_cases)
</verification>

<success_criteria>
- SimilarCase model exists with all required fields
- EstimateResponse includes similar_cases: List[SimilarCase]
- Estimate router imports and uses embeddings and pinecone_cbr services
- Lifespan initializes all services (ML models, embedding model, Pinecone)
- Tests pass for CBR integration
- API gracefully handles missing Pinecone credentials
</success_criteria>

<output>
After completion, create `.planning/phases/02-pinecone-cbr/02-02-SUMMARY.md`
</output>
